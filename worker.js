/**
 * flightsabove Worker (v150)
 *
 * Serves the UI from the Worker (same-origin) + API endpoints:
 *  - /opensky/states
 *  - /aero/<CALLSIGN>
 *  - /aircraft/icao24/<HEX>
 *  - /health
 *
 * Required env vars:
 *   AERODATA_KEY (Secret)
 *   AERODATA_HOST (Text)  aerodatabox.p.rapidapi.com
 *
 * OpenSky OAuth2 (recommended):
 *   OPENSKY_CLIENT_ID (Text/Secret)
 *   OPENSKY_CLIENT_SECRET (Secret)
 */

const ROUTE_TTL = 60 * 15;          // 15 min edge cache
const AIRCRAFT_TTL = 60 * 60 * 24;  // 24 h edge cache
let __openskyTokenCache = { token: null, expMs: 0 };

// Embedded static assets (base64 so we serve the exact files with no escaping issues)
const __B64_INDEX = "PCFkb2N0eXBlIGh0bWw+CjxodG1sIGxhbmc9ImVuIj4KPGhlYWQ+CiAgICA8bWV0YSBodHRwLWVxdWl2PSJDYWNoZS1Db250cm9sIiBjb250ZW50PSJuby1zdG9yZSwgbm8tY2FjaGUsIG11c3QtcmV2YWxpZGF0ZSwgbWF4LWFnZT0wIiAvPgogICAgPG1ldGEgaHR0cC1lcXVpdj0iUHJhZ21hIiBjb250ZW50PSJuby1jYWNoZSIgLz4KICAgIDxtZXRhIGh0dHAtZXF1aXY9IkV4cGlyZXMiIGNvbnRlbnQ9IjAiIC8+CiAgPG1ldGEgY2hhcnNldD0idXRmLTgiIC8+CiAgPG1ldGEgbmFtZT0idmlld3BvcnQiIGNvbnRlbnQ9IndpZHRoPWRldmljZS13aWR0aCwgaW5pdGlhbC1zY2FsZT0xIiAvPgogIDx0aXRsZT5GbGlnaHRzIEFib3ZlPC90aXRsZT4KICA8bGluayByZWw9InN0eWxlc2hlZXQiIGhyZWY9InN0eWxlLmNzcz92PTE1MCI+CiAgPHNjcmlwdD4KICAgIC8vIEJvb3QgbWFya2VyIChwcm92ZXMgbGF0ZXN0IEhUTUwpCiAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCJET01Db250ZW50TG9hZGVkIiwgKCkgPT4gewogICAgICBjb25zdCBzdCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJmdy1zdGF0dXMiKTsKICAgICAgaWYgKHN0KSBzdC50ZXh0Q29udGVudCA9ICJCb290aW5nIHYxNTDigKYiOwogICAgICBjb25zdCB2ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoImZ3LXZlcnNpb24iKTsKICAgICAgaWYgKHYpIHYudGV4dENvbnRlbnQgPSAidjE1MCI7CiAgICB9KTsKICA8L3NjcmlwdD4KPC9oZWFkPgo8Ym9keT4KICA8bWFpbiBjbGFzcz0id3JhcCI+CiAgICA8aGVhZGVyIGNsYXNzPSJ0b3BiYXIiPgogICAgICA8ZGl2IGNsYXNzPSJicmFuZCI+CiAgICAgICAgPGRpdiBjbGFzcz0iYnJhbmQtdGl0bGUiPkZMSUdIVFMgQUJPVkU8L2Rpdj4KICAgICAgICA8ZGl2IGNsYXNzPSJicmFuZC1zdWIiIGlkPSJob21lTGluZSI+4oCUPC9kaXY+CiAgICAgIDwvZGl2PgoKICAgICAgCiAgICAgIDxkaXYgY2xhc3M9ImNvbnRyb2xzIj4KICAgICAgICA8ZGl2IGNsYXNzPSJyYW5nZS1oaW50IiBpZD0icmFuZ2UtaGludCI+PC9kaXY+CiAgICAgIDwvZGl2PgoKICAgICAgICA8ZGl2IGNsYXNzPSJjb250cm9sc1JvdyI+CiAgICAgICAgICA8bGFiZWwgY2xhc3M9ImN0bENoZWNrIj4KICAgICAgICAgICAgPGlucHV0IHR5cGU9ImNoZWNrYm94IiBpZD0iY29tbWVyY2lhbE9ubHkiIGNoZWNrZWQ+CiAgICAgICAgICAgIDxzcGFuPlBBU1NFTkdFUiBBSVJMSU5FUyBPTkxZPC9zcGFuPgogICAgICAgICAgPC9sYWJlbD4KICAgICAgICAgIDxsYWJlbCBjbGFzcz0iY3RsQ2hlY2siPgogICAgICAgICAgICA8L2xhYmVsPgogICAgICAgIDwvZGl2PgoKICA8ZGl2IGNsYXNzPSJsaXZlV3JhcCI+PHNwYW4gaWQ9ImxpdmVJbmRpY2F0b3IiIGNsYXNzPSJsaXZlRG90Ij48L3NwYW4+PGRpdiBpZD0ibGFzdFVwZGF0ZSIgY2xhc3M9Imxhc3RVcGRhdGUiPkxBU1QgVVBEQVRFOiAtLTwvZGl2Pgo8L2Rpdj48L2hlYWRlcj4KCjxzZWN0aW9uIGNsYXNzPSJjYXJkIGZ3LWZhZGUiIGlkPSJjYXJkIj4KICAgICAgPGRpdiBjbGFzcz0icm93MSI+CiAgICAgICAgPGRpdiBjbGFzcz0ibG9nbyIgaWQ9ImxvZ28iIGFyaWEtbGFiZWw9IkFpcmxpbmUgbG9nbyI+4pyIPC9kaXY+CiAgICAgICAgPGRpdiBjbGFzcz0iYWlybGluZS1uYW1lIiBpZD0iYWlybGluZS1uYW1lIj7igJQ8L2Rpdj4KICAgICAgICA8ZGl2IGNsYXNzPSJhaXJsaW5lLXN1YiIgaWQ9ImFpcmxpbmUtc3ViIj4gPC9kaXY+CiAgICAgICAgPGRpdiBjbGFzcz0iY2FsbHNpZ24iIGlkPSJjcyI+4oCUPC9kaXY+CiAgICAgICAgPGRpdiBjbGFzcz0icmlnaHRCb3giPgogICAgICAgICAgPGRpdiBjbGFzcz0ibGVnZW5kIiBpZD0ibGVnZW5kIj4KICAgICAgICAgICAgPGRpdiBjbGFzcz0ibGctcm93Ij48c3BhbiBjbGFzcz0iZG90IHZlcmlmaWVkIj7inJM8L3NwYW4+PC9kaXY+CiAgICAgICAgICAgIDxkaXYgY2xhc3M9ImxnLXJvdyI+PC9kaXY+CiAgICAgICAgICA8L2Rpdj4KICAgICAgICA8L2Rpdj4KICAgICAgPC9kaXY+CgogICAgICA8ZGl2IGNsYXNzPSJyb3cyIj4KICAgICAgICA8ZGl2IGNsYXNzPSJyb3V0ZSIgaWQ9InJvdXRlIj7igJQ8L2Rpdj4KICAgICAgICA8ZGl2IGNsYXNzPSJtb2RlbCIgaWQ9Im1vZGVsIj7igJQ8L2Rpdj4KICAgICAgICA8ZGl2IGlkPSJtb2RlbDIiIGNsYXNzPSJtb2RlbDIiPjwvZGl2PgogICAgICA8L2Rpdj4KCiAgICAgIDxkaXYgY2xhc3M9InN0YXRzIj4KICAgICAgICA8ZGl2IGNsYXNzPSJrdiI+CiAgICAgICAgICA8ZGl2IGNsYXNzPSJrIj5BTFQ8L2Rpdj4KICAgICAgICAgIDxkaXYgY2xhc3M9InYiIGlkPSJhbHQiPuKAlDwvZGl2PgogICAgICAgIDwvZGl2PgogICAgICAgIDxkaXYgY2xhc3M9Imt2Ij4KICAgICAgICAgIDxkaXYgY2xhc3M9ImsiPlNQRDwvZGl2PgogICAgICAgICAgPGRpdiBjbGFzcz0idiIgaWQ9InNwZCI+4oCUPC9kaXY+CiAgICAgICAgPC9kaXY+CiAgICAgICAgPGRpdiBjbGFzcz0ia3YiPgogICAgICAgICAgPGRpdiBjbGFzcz0iayI+RElTVDwvZGl2PgogICAgICAgICAgPGRpdiBjbGFzcz0idiIgaWQ9ImRpc3QiPuKAlDwvZGl2PgogICAgICAgIDwvZGl2PgogICAgICAgIDxkaXYgY2xhc3M9Imt2Ij4KICAgICAgICAgIDxkaXYgY2xhc3M9ImsiPkRJUjwvZGl2PgogICAgICAgICAgPGRpdiBjbGFzcz0idiIgaWQ9ImRpciI+4oCUPC9kaXY+CiAgICAgICAgPC9kaXY+CiAgICAgIDwvZGl2PgoKICAgICAgPGRpdiBjbGFzcz0ibWV0YSIgaWQ9Im1ldGEiPuKAlDwvZGl2PgogICAgPC9zZWN0aW9uPgoKCiAgICA8IS0tIHY3OTogYm90dG9tIDQgY2xvc2VzdCBmbGlnaHRzIC0tPgogICAgPHNlY3Rpb24gY2xhc3M9InNlY29uZGFyeUdyaWQiIGlkPSJzZWNvbmRhcnlHcmlkIiBhcmlhLWxhYmVsPSJOZWFyYnkgZmxpZ2h0cyI+CiAgICAgIDxkaXYgY2xhc3M9InNlY29uZGFyeUJveCIgaWQ9InNlYzEiPjxkaXYgY2xhc3M9InNlY0NTIj7igJQ8L2Rpdj48ZGl2IGNsYXNzPSJzZWNNaW5pIj7igJQ8L2Rpdj48L2Rpdj4KICAgICAgPGRpdiBjbGFzcz0ic2Vjb25kYXJ5Qm94IiBpZD0ic2VjMiI+PGRpdiBjbGFzcz0ic2VjQ1MiPuKAlDwvZGl2PjxkaXYgY2xhc3M9InNlY01pbmkiPuKAlDwvZGl2PjwvZGl2PgogICAgICA8ZGl2IGNsYXNzPSJzZWNvbmRhcnlCb3giIGlkPSJzZWMzIj48ZGl2IGNsYXNzPSJzZWNDUyI+4oCUPC9kaXY+PGRpdiBjbGFzcz0ic2VjTWluaSI+4oCUPC9kaXY+PC9kaXY+CiAgICAgIDxkaXYgY2xhc3M9InNlY29uZGFyeUJveCIgaWQ9InNlYzQiPjxkaXYgY2xhc3M9InNlY0NTIj7igJQ8L2Rpdj48ZGl2IGNsYXNzPSJzZWNNaW5pIj7igJQ8L2Rpdj48L2Rpdj4KICAgIDwvc2VjdGlvbj4KCgo8Zm9vdGVyIGNsYXNzPSJmb290ZXIiPgogICAgICA8ZGl2IGNsYXNzPSJzdGF0dXMiIGlkPSJmdy1zdGF0dXMiPlN0YXJ0aW5n4oCmPC9kaXY+CiAgICAgIDxkaXYgY2xhc3M9InZlcnNpb24iIGlkPSJmdy12ZXJzaW9uIj52MTUwPC9kaXY+CiAgICA8L2Zvb3Rlcj4KCjwvZGl2PgogICAgICAgICAgPC9kaXY+PC9kaXY+CjwvZGl2PgogICAgICAgICAgPC9kaXY+PC9kaXY+CjwvZGl2PgogICAgICAgICAgPC9kaXY+PC9kaXY+CjwvZGl2PgogICAgICAgICAgPC9kaXY+PC9kaXY+CiAgICAgIDwvZGl2Pgo8L2Rpdj4KICAgICAgICA8L2Rpdj4KPC9kaXY+CiAgICAgICAgPC9kaXY+CjwvZGl2PgogICAgICAgIDwvZGl2Pgo8L2Rpdj4KICAgICAgICA8L2Rpdj4KICAgIDwvZGl2Pgo8L2Rpdj48L2Rpdj4KPC9kaXY+PC9kaXY+CjwvZGl2PjwvZGl2Pgo8L2Rpdj48L2Rpdj4KICAgIDwvZGl2PgoKICAKICAgIDwhLS0gdjc4OiBib3R0b20gNCBjbG9zZXN0IGZsaWdodHMgLS0+CiAgICAgIDxkaXYgaWQ9InN0YXR1cyIgY2xhc3M9InN0YXR1c0xpbmUiPlJhZGFyOiDigJQ8L2Rpdj4KPC9tYWluPgoKICA8L2Rpdj4KCiAgPHNjcmlwdCBzcmM9ImFwcC5qcz92PTE1MCI+PC9zY3JpcHQ+CjwvYm9keT4KPC9odG1sPgo=";
const __B64_CSS   = "LyogdjQ5IC0gYm9sZCwgd2FsbC1mcmllbmRseSwgaVBhZC1jZW50ZXJlZCAqLwo6cm9vdHsKICAtLWJnOiMwMDA3MGQ7CiAgLS1wYW5lbDojMDAxMjFjOwogIC0tcGFuZWwyOiMwMDFhMjY7CiAgLS1saW5lOiMwMGY2ZmY1NTsKICAtLXRleHQ6I2U4ZmRmZjsKICAtLW11dGVkOiM5M2RlZTY7CiAgLS1hY2NlbnQ6IzAwZjZmZjsKfQoKKnsgYm94LXNpemluZzpib3JkZXItYm94OyB9Cmh0bWwsYm9keXsgaGVpZ2h0OjEwMCU7IG1hcmdpbjowOyBiYWNrZ3JvdW5kOnZhcigtLWJnKTsgY29sb3I6dmFyKC0tdGV4dCk7IH0KYm9keXsKICBmb250LWZhbWlseTogIkFyaWFsIEJsYWNrIiwgIkF2ZW5pciBOZXh0IENvbmRlbnNlZCIsICJBdmVuaXIgTmV4dCIsIHN5c3RlbS11aSwgLWFwcGxlLXN5c3RlbSwgU2Vnb2UgVUksIFJvYm90bywgSGVsdmV0aWNhLCBBcmlhbCwgc2Fucy1zZXJpZjsKfQoKLndyYXB7CiAgbWluLWhlaWdodDoxMDAlOwogIGRpc3BsYXk6ZmxleDsKICBmbGV4LWRpcmVjdGlvbjpjb2x1bW47CiAgcGFkZGluZzoxOHB4OwogIHBhZGRpbmctYm90dG9tOjY0cHg7IC8qIHJvb20gZm9yIHRpY2tlciAqLwogIGdhcDoxNHB4OwogIG1heC13aWR0aDogMTEwMHB4OwogIG1hcmdpbjogMCBhdXRvOyAvKiBjZW50ZXIgb24gaVBhZCAqLwp9CgoudG9wYmFyewogIGRpc3BsYXk6ZmxleDsKICBhbGlnbi1pdGVtczpmbGV4LXN0YXJ0OwogIGp1c3RpZnktY29udGVudDpzcGFjZS1iZXR3ZWVuOwogIGdhcDoxNnB4OwogIHBhZGRpbmc6MTRweCAxNnB4OwogIGJvcmRlcjoxcHggc29saWQgdmFyKC0tbGluZSk7CiAgYm9yZGVyLXJhZGl1czoxOHB4OwogIGJhY2tncm91bmQ6cmdiYSgwLDE4LDI4LC43OCk7CiAgYmFja2Ryb3AtZmlsdGVyOiBibHVyKDhweCk7Cn0KCi5icmFuZC10aXRsZXsKICBmb250LXdlaWdodDo5NTA7CiAgbGV0dGVyLXNwYWNpbmc6MnB4OwogIGZvbnQtc2l6ZToyMnB4Owp9Ci5icmFuZC1zdWJ7CiAgbWFyZ2luLXRvcDo0cHg7CiAgZm9udC1mYW1pbHk6IHN5c3RlbS11aSwgLWFwcGxlLXN5c3RlbSwgU2Vnb2UgVUksIFJvYm90bywgSGVsdmV0aWNhLCBBcmlhbCwgc2Fucy1zZXJpZjsKICBmb250LXdlaWdodDo2NTA7CiAgY29sb3I6dmFyKC0tbXV0ZWQpOwogIGZvbnQtc2l6ZToxM3B4Owp9CgouY29udHJvbHN7CiAgZGlzcGxheTpmbGV4OwogIGFsaWduLWl0ZW1zOmZsZXgtZW5kOwogIGdhcDoxNHB4OwogIGZsZXgtd3JhcDp3cmFwOwogIGp1c3RpZnktY29udGVudDpmbGV4LWVuZDsKfQoKLmN0bHsKICBkaXNwbGF5OmZsZXg7CiAgYWxpZ24taXRlbXM6Y2VudGVyOwogIGdhcDoxMHB4OwogIGZvbnQtc2l6ZToxMnB4OwogIGZvbnQtd2VpZ2h0OjkwMDsKICBjb2xvcjp2YXIoLS1tdXRlZCk7CiAgbGV0dGVyLXNwYWNpbmc6MXB4Owp9Ci5jdGwgaW5wdXRbdHlwZT0icmFuZ2UiXXsgd2lkdGg6MTcwcHg7IH0KLmN0bCBzZWxlY3R7CiAgYmFja2dyb3VuZDpyZ2JhKDAsMTgsMjgsLjc1KTsKICBjb2xvcjp2YXIoLS10ZXh0KTsKICBib3JkZXI6MXB4IHNvbGlkIHZhcigtLWxpbmUpOwogIGJvcmRlci1yYWRpdXM6MTBweDsKICBwYWRkaW5nOjZweCA4cHg7CiAgZm9udC13ZWlnaHQ6OTAwOwogIGxldHRlci1zcGFjaW5nOjFweDsKfQoKLnRvZ2dsZXsgZ2FwOjhweDsgfQoKLmNhcmR7CiAgZmxleDoxOwogIGJvcmRlcjoxcHggc29saWQgdmFyKC0tbGluZSk7CiAgYm9yZGVyLXJhZGl1czoyNHB4OwogIHBhZGRpbmc6MThweCAxOHB4IDE2cHg7CiAgYmFja2dyb3VuZDpsaW5lYXItZ3JhZGllbnQoMTgwZGVnLCByZ2JhKDAsMjYsMzgsLjg2KSwgcmdiYSgwLDEwLDE1LC42OCkpOwogIGRpc3BsYXk6ZmxleDsKICBmbGV4LWRpcmVjdGlvbjpjb2x1bW47CiAgZ2FwOjEycHg7CiAgcG9zaXRpb246cmVsYXRpdmU7CiAgb3ZlcmZsb3c6aGlkZGVuOwp9Cgoucm93MXsKICBkaXNwbGF5OmZsZXg7CiAgYWxpZ24taXRlbXM6ZmxleC1zdGFydDsKICBqdXN0aWZ5LWNvbnRlbnQ6c3BhY2UtYmV0d2VlbjsKICBnYXA6MTJweDsKfQoKLmNhbGxzaWduewogIGZvbnQtd2VpZ2h0Ojk1MDsKICBmb250LXNpemU6NTZweDsKICBsZXR0ZXItc3BhY2luZzoxcHg7CiAgbGluZS1oZWlnaHQ6MTsKICB0ZXh0LXRyYW5zZm9ybTp1cHBlcmNhc2U7Cn0KCi5yaWdodEJveHsKICBkaXNwbGF5OmZsZXg7CiAgYWxpZ24taXRlbXM6ZmxleC1zdGFydDsKICBnYXA6MTJweDsKfQoKLmJhZGdlewogIHdpZHRoOjM0cHg7IGhlaWdodDozNHB4OwogIGJvcmRlci1yYWRpdXM6NTAlOwogIGRpc3BsYXk6ZmxleDsKICBhbGlnbi1pdGVtczpjZW50ZXI7CiAganVzdGlmeS1jb250ZW50OmNlbnRlcjsKICBmb250LXdlaWdodDo5NTA7CiAgZm9udC1zaXplOjE4cHg7Cn0KLmJhZGdlLnZlcmlmaWVkeyBiYWNrZ3JvdW5kOnZhcigtLWFjY2VudCk7IGNvbG9yOiMwMDEwMTg7IH0KLmJhZGdlLmVzdGltYXRlZHsgYmFja2dyb3VuZDojZmZmZmZmMjI7IGNvbG9yOiNmZmY7IH0KCi5sZWdlbmR7CiAgYm9yZGVyOjFweCBzb2xpZCAjMDBmNmZmMzM7CiAgYm9yZGVyLXJhZGl1czoxNHB4OwogIHBhZGRpbmc6OHB4IDEwcHg7CiAgYmFja2dyb3VuZDpyZ2JhKDAsMTYsMjQsLjU1KTsKICBkaXNwbGF5OmZsZXg7CiAgZmxleC1kaXJlY3Rpb246Y29sdW1uOwogIGdhcDo2cHg7Cn0KLmxnLXJvd3sKICBkaXNwbGF5OmZsZXg7CiAgYWxpZ24taXRlbXM6Y2VudGVyOwogIGdhcDo4cHg7CiAgZm9udC1mYW1pbHk6IHN5c3RlbS11aSwgLWFwcGxlLXN5c3RlbSwgU2Vnb2UgVUksIFJvYm90bywgSGVsdmV0aWNhLCBBcmlhbCwgc2Fucy1zZXJpZjsKICBmb250LXNpemU6MTJweDsKICBmb250LXdlaWdodDo4MDA7CiAgY29sb3I6dmFyKC0tbXV0ZWQpOwogIGxldHRlci1zcGFjaW5nOi42cHg7Cn0KLmRvdHsKICB3aWR0aDoxOHB4OyBoZWlnaHQ6MThweDsKICBib3JkZXItcmFkaXVzOjUwJTsKICBkaXNwbGF5OmlubGluZS1mbGV4OwogIGFsaWduLWl0ZW1zOmNlbnRlcjsKICBqdXN0aWZ5LWNvbnRlbnQ6Y2VudGVyOwogIGZvbnQtd2VpZ2h0Ojk1MDsKICBmb250LXNpemU6MTJweDsKfQouZG90LnZlcmlmaWVkeyBiYWNrZ3JvdW5kOnZhcigtLWFjY2VudCk7IGNvbG9yOiMwMDEwMTg7IH0KLmRvdC5lc3RpbWF0ZWR7IGJhY2tncm91bmQ6I2ZmZmZmZjIyOyBjb2xvcjojZmZmOyB9Cgoucm93MnsKICBkaXNwbGF5OmZsZXg7CiAgYWxpZ24taXRlbXM6YmFzZWxpbmU7CiAganVzdGlmeS1jb250ZW50OnNwYWNlLWJldHdlZW47CiAgZ2FwOjEycHg7CiAgZmxleC13cmFwOndyYXA7Cn0KLnJvdXRlewogIGZvbnQtc2l6ZTozMnB4OwogIGZvbnQtd2VpZ2h0Ojk1MDsKICBsZXR0ZXItc3BhY2luZzouNXB4Owp9Ci5tb2RlbHsKICBmb250LWZhbWlseTogc3lzdGVtLXVpLCAtYXBwbGUtc3lzdGVtLCBTZWdvZSBVSSwgUm9ib3RvLCBIZWx2ZXRpY2EsIEFyaWFsLCBzYW5zLXNlcmlmOwogIGZvbnQtc2l6ZToxNnB4OwogIGNvbG9yOnZhcigtLW11dGVkKTsKICBmb250LXdlaWdodDo3NTA7Cn0KCi5zdGF0c3sKICBkaXNwbGF5OmdyaWQ7CiAgZ3JpZC10ZW1wbGF0ZS1jb2x1bW5zOiByZXBlYXQoNCwgbWlubWF4KDAsIDFmcikpOwogIGdhcDoxNHB4OwogIG1hcmdpbi10b3A6NnB4Owp9Ci5rdnsKICBib3JkZXI6MXB4IHNvbGlkIHZhcigtLWxpbmUpOwogIGJvcmRlci1yYWRpdXM6MThweDsKICBiYWNrZ3JvdW5kOnJnYmEoMCwxNiwyNCwuNjApOwogIHBhZGRpbmc6MTRweCAxMHB4OwogIGRpc3BsYXk6ZmxleDsKICBmbGV4LWRpcmVjdGlvbjpjb2x1bW47CiAgYWxpZ24taXRlbXM6Y2VudGVyOwogIGp1c3RpZnktY29udGVudDpjZW50ZXI7CiAgZ2FwOjZweDsKfQoua3sKICBmb250LWZhbWlseTogc3lzdGVtLXVpLCAtYXBwbGUtc3lzdGVtLCBTZWdvZSBVSSwgUm9ib3RvLCBIZWx2ZXRpY2EsIEFyaWFsLCBzYW5zLXNlcmlmOwogIGZvbnQtc2l6ZToxM3B4OwogIGNvbG9yOnZhcigtLW11dGVkKTsKICBmb250LXdlaWdodDo5MDA7CiAgbGV0dGVyLXNwYWNpbmc6MS4zcHg7CiAgdGV4dC1hbGlnbjpjZW50ZXI7CiAgd2lkdGg6MTAwJTsKfQoudnsKICBmb250LXNpemU6MzBweDsKICBmb250LXdlaWdodDo5NTA7CiAgdGV4dC1hbGlnbjpjZW50ZXI7CiAgd2lkdGg6MTAwJTsKICB3aGl0ZS1zcGFjZTpub3dyYXA7Cn0KCi5tZXRhewogIGZvbnQtZmFtaWx5OiBzeXN0ZW0tdWksIC1hcHBsZS1zeXN0ZW0sIFNlZ29lIFVJLCBSb2JvdG8sIEhlbHZldGljYSwgQXJpYWwsIHNhbnMtc2VyaWY7CiAgZm9udC1zaXplOjE0cHg7CiAgY29sb3I6dmFyKC0tbXV0ZWQpOwogIGZvbnQtd2VpZ2h0OjY1MDsKfQoKLmZvb3RlcnsKICBkaXNwbGF5OmZsZXg7CiAgYWxpZ24taXRlbXM6Y2VudGVyOwogIGp1c3RpZnktY29udGVudDpzcGFjZS1iZXR3ZWVuOwogIHBhZGRpbmc6MTBweCA0cHg7CiAgY29sb3I6dmFyKC0tbXV0ZWQpOwp9Ci5zdGF0dXN7CiAgZm9udC1mYW1pbHk6IHN5c3RlbS11aSwgLWFwcGxlLXN5c3RlbSwgU2Vnb2UgVUksIFJvYm90bywgSGVsdmV0aWNhLCBBcmlhbCwgc2Fucy1zZXJpZjsKICBmb250LXdlaWdodDo4MDA7Cn0KLnZlcnNpb257CiAgZm9udC1zaXplOjEycHg7CiAgb3BhY2l0eTouNzsKICBmb250LWZhbWlseTogc3lzdGVtLXVpLCAtYXBwbGUtc3lzdGVtLCBTZWdvZSBVSSwgUm9ib3RvLCBIZWx2ZXRpY2EsIEFyaWFsLCBzYW5zLXNlcmlmOwp9CgovKiBGYWRlIGRpc2FibGVkICh2NTIpICovCi5mdy1mYWRlLWlueyBhbmltYXRpb246bm9uZSAhaW1wb3J0YW50OyB9CgovKiBUaWNrZXIgKi8KLnRpY2tlcnsKICBwb3NpdGlvbjpmaXhlZDsKICBsZWZ0OjA7IHJpZ2h0OjA7IGJvdHRvbTowOwogIGhlaWdodDo0NHB4OwogIGJvcmRlci10b3A6MXB4IHNvbGlkIHZhcigtLWxpbmUpOwogIGJhY2tncm91bmQ6cmdiYSgwLDE2LDI0LC45Mik7CiAgb3ZlcmZsb3c6aGlkZGVuOwogIGRpc3BsYXk6ZmxleDsKICBhbGlnbi1pdGVtczpjZW50ZXI7Cn0KLnRpY2tlci10cmFja3sKICBkaXNwbGF5OmlubGluZS1ibG9jazsKICB3aGl0ZS1zcGFjZTpub3dyYXA7CiAgcGFkZGluZy1sZWZ0OjEwMCU7CiAgYW5pbWF0aW9uOiB0aWNrZXIgMzBzIGxpbmVhciBpbmZpbml0ZTsKICBmb250LXdlaWdodDo5MDA7CiAgbGV0dGVyLXNwYWNpbmc6LjhweDsKICBjb2xvcjp2YXIoLS10ZXh0KTsKICBvcGFjaXR5Oi45NTsKfQpAa2V5ZnJhbWVzIHRpY2tlcnsKICAwJXsgdHJhbnNmb3JtOiB0cmFuc2xhdGVYKDApOyB9CiAgMTAwJXsgdHJhbnNmb3JtOiB0cmFuc2xhdGVYKC0xMDAlKTsgfQp9CgovKiBQaG9uZSAqLwpAbWVkaWEgKG1heC13aWR0aDogNjQwcHgpewogIC53cmFweyBwYWRkaW5nOjEycHg7IHBhZGRpbmctYm90dG9tOjY0cHg7IH0KICAuY2FsbHNpZ257IGZvbnQtc2l6ZTo0MHB4OyB9CiAgLnJvdXRleyBmb250LXNpemU6MjRweDsgfQogIC52eyBmb250LXNpemU6MjRweDsgfQogIC5zdGF0c3sgZ3JpZC10ZW1wbGF0ZS1jb2x1bW5zOiByZXBlYXQoMiwgbWlubWF4KDAsMWZyKSk7IH0KICAuY3RsIGlucHV0W3R5cGU9InJhbmdlIl17IHdpZHRoOjE1MHB4OyB9CiAgLmxlZ2VuZHsgZGlzcGxheTpub25lOyB9IC8qIGtlZXAgcGhvbmUgY2xlYW4gKi8KfQoKLyogdjUzOiByZWR1Y2UgbGF5b3V0IGppdHRlciAqLwouY2FsbHNpZ24sIC5yb3V0ZSwgLnYgeyBmb250LXZhcmlhbnQtbnVtZXJpYzogdGFidWxhci1udW1zOyB9Ci5jYWxsc2lnbiB7IG1pbi1oZWlnaHQ6IDU4cHg7IH0KLnJvdXRlIHsgbWluLWhlaWdodDogNDBweDsgfQoubWV0YSB7IG1pbi1oZWlnaHQ6IDIycHg7IH0KCi8qIHY1NDogYWlybGluZSBsb2dvIGJsb2NrICovCi5sb2dvewogIHdpZHRoOjY0cHg7CiAgaGVpZ2h0OjY0cHg7CiAgYm9yZGVyLXJhZGl1czoxOHB4OwogIGJvcmRlcjoxcHggc29saWQgdmFyKC0tbGluZSk7CiAgYmFja2dyb3VuZDpyZ2JhKDAsMTYsMjQsLjYwKTsKICBkaXNwbGF5OmZsZXg7CiAgYWxpZ24taXRlbXM6Y2VudGVyOwogIGp1c3RpZnktY29udGVudDpjZW50ZXI7CiAgZm9udC13ZWlnaHQ6OTUwOwogIGZvbnQtc2l6ZToyMnB4OwogIGxldHRlci1zcGFjaW5nOjFweDsKICBjb2xvcjp2YXIoLS10ZXh0KTsKICBmbGV4OjAgMCBhdXRvOwp9Ci5yb3cxeyBhbGlnbi1pdGVtczpjZW50ZXI7IH0KQG1lZGlhIChtYXgtd2lkdGg6IDY0MHB4KXsKICAubG9nb3sgd2lkdGg6NTJweDsgaGVpZ2h0OjUycHg7IGJvcmRlci1yYWRpdXM6MTZweDsgZm9udC1zaXplOjE4cHg7IH0KfQoKLyogdjU1OiBpbmxpbmUgU1ZHIGxvZ28gc3R5bGluZyAqLwoubG9nbyBzdmd7IHdpZHRoOiA5MCU7IGhlaWdodDogOTAlOyBkaXNwbGF5OmJsb2NrOyB9CgovKiB2NTc6IG9wZXJhdG9yIGJyYW5kaW5nIHRpbGVzIChnZW5lcmljLCBub3Qgb2ZmaWNpYWwgbG9nb3MpICovCi5sb2dveyBwb3NpdGlvbjpyZWxhdGl2ZTsgb3ZlcmZsb3c6aGlkZGVuOyB9Ci5sb2dvOjpiZWZvcmV7CiAgY29udGVudDoiIjsKICBwb3NpdGlvbjphYnNvbHV0ZTsgaW5zZXQ6LTQwJTsKICBvcGFjaXR5Oi4yMjsKICB0cmFuc2Zvcm06IHJvdGF0ZSgxOGRlZyk7CiAgYmFja2dyb3VuZDogcmVwZWF0aW5nLWxpbmVhci1ncmFkaWVudCgxMzVkZWcsIGN1cnJlbnRDb2xvciAwLCBjdXJyZW50Q29sb3IgMTBweCwgdHJhbnNwYXJlbnQgMTBweCwgdHJhbnNwYXJlbnQgMjJweCk7Cn0KLmxvZ28gPiAqeyBwb3NpdGlvbjpyZWxhdGl2ZTsgei1pbmRleDoxOyB9CgovKiB2NTg6IGRpc3RpbmN0IG9wZXJhdG9yIGJyYW5kIHRpbGVzIChnZW5lcmljLCBubyBsb2dvcykgKi8KCi8qIEJhc2UgYWxyZWFkeSBwcmVzZW50ICovCi5sb2dvW2RhdGEtYWlybGluZT0iU1dBIl17CiAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDEzNWRlZywgcmdiYSgyNTUsMjU1LDI1NSwuMTApLCByZ2JhKDI1NSwyNTUsMjU1LC4wMikpOwp9Ci5sb2dvW2RhdGEtYWlybGluZT0iU1dBIl06OmJlZm9yZXsKICBvcGFjaXR5Oi4zNTsKICBiYWNrZ3JvdW5kOiByZXBlYXRpbmctbGluZWFyLWdyYWRpZW50KDkwZGVnLCBjdXJyZW50Q29sb3IgMCwgY3VycmVudENvbG9yIDE0cHgsIHRyYW5zcGFyZW50IDE0cHgsIHRyYW5zcGFyZW50IDMwcHgpOwp9CgovKiBBbWVyaWNhbiArIEVudm95ICovCi5sb2dvW2RhdGEtYWlybGluZT0iQUFMIl0sIC5sb2dvW2RhdGEtYWlybGluZT0iRU5ZIl17CiAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDE4MGRlZywgcmdiYSgyNTUsMjU1LDI1NSwuMDgpLCByZ2JhKDI1NSwyNTUsMjU1LC4wMikpOwp9Ci5sb2dvW2RhdGEtYWlybGluZT0iQUFMIl06OmJlZm9yZSwgLmxvZ29bZGF0YS1haXJsaW5lPSJFTlkiXTo6YmVmb3JlewogIG9wYWNpdHk6LjI4OwogIGJhY2tncm91bmQ6IHJlcGVhdGluZy1saW5lYXItZ3JhZGllbnQoMGRlZywgY3VycmVudENvbG9yIDAsIGN1cnJlbnRDb2xvciA4cHgsIHRyYW5zcGFyZW50IDhweCwgdHJhbnNwYXJlbnQgMThweCk7Cn0KCi8qIERlbHRhICovCi5sb2dvW2RhdGEtYWlybGluZT0iREFMIl17CiAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDEzNWRlZywgcmdiYSgyNTUsMjU1LDI1NSwuMTApLCByZ2JhKDI1NSwyNTUsMjU1LC4wMikpOwp9Ci5sb2dvW2RhdGEtYWlybGluZT0iREFMIl06OmJlZm9yZXsKICBvcGFjaXR5Oi4zMDsKICBiYWNrZ3JvdW5kOiByZXBlYXRpbmctbGluZWFyLWdyYWRpZW50KDEzNWRlZywgY3VycmVudENvbG9yIDAsIGN1cnJlbnRDb2xvciAxMHB4LCB0cmFuc3BhcmVudCAxMHB4LCB0cmFuc3BhcmVudCAyMnB4KTsKfQoKLyogVW5pdGVkICovCi5sb2dvW2RhdGEtYWlybGluZT0iVUFMIl17CiAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDEzNWRlZywgcmdiYSgyNTUsMjU1LDI1NSwuMDgpLCByZ2JhKDI1NSwyNTUsMjU1LC4wMikpOwp9Ci5sb2dvW2RhdGEtYWlybGluZT0iVUFMIl06OmJlZm9yZXsKICBvcGFjaXR5Oi4yNjsKICBiYWNrZ3JvdW5kOiByZXBlYXRpbmctbGluZWFyLWdyYWRpZW50KDQ1ZGVnLCBjdXJyZW50Q29sb3IgMCwgY3VycmVudENvbG9yIDZweCwgdHJhbnNwYXJlbnQgNnB4LCB0cmFuc3BhcmVudCAxNHB4KTsKfQoKLyogU2t5V2VzdCAqLwoubG9nb1tkYXRhLWFpcmxpbmU9IlNLVyJdewogIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCgxODBkZWcsIHJnYmEoMjU1LDI1NSwyNTUsLjA2KSwgcmdiYSgyNTUsMjU1LDI1NSwuMDIpKTsKfQoubG9nb1tkYXRhLWFpcmxpbmU9IlNLVyJdOjpiZWZvcmV7CiAgb3BhY2l0eTouMjI7CiAgYmFja2dyb3VuZDogcmVwZWF0aW5nLWxpbmVhci1ncmFkaWVudCg5MGRlZywgY3VycmVudENvbG9yIDAsIGN1cnJlbnRDb2xvciA2cHgsIHRyYW5zcGFyZW50IDZweCwgdHJhbnNwYXJlbnQgMThweCk7Cn0KCi8qIHY1OTogYWlybGluZSBuYW1lIGFib3ZlIGNhbGxzaWduICovCi5haXJsaW5lLW5hbWV7CiAgZm9udC1zaXplOiAxOHB4OwogIGZvbnQtd2VpZ2h0OiA4MDA7CiAgbGV0dGVyLXNwYWNpbmc6IC4wOGVtOwogIHRleHQtdHJhbnNmb3JtOiB1cHBlcmNhc2U7CiAgb3BhY2l0eTogLjg1OwogIG1hcmdpbi1ib3R0b206IDJweDsKfQpAbWVkaWEgKG1heC13aWR0aDogNjQwcHgpewogIC5haXJsaW5lLW5hbWV7IGZvbnQtc2l6ZTogMTVweDsgfQp9CgovKiB2NjA6IHJlZ2lvbmFsIHN1Yi1icmFuZCAqLwouYWlybGluZS1zdWJ7CiAgZm9udC1zaXplOiAxMnB4OwogIGZvbnQtd2VpZ2h0OiA3NTA7CiAgbGV0dGVyLXNwYWNpbmc6IC4xMGVtOwogIHRleHQtdHJhbnNmb3JtOiB1cHBlcmNhc2U7CiAgb3BhY2l0eTogLjcwOwogIG1hcmdpbi10b3A6IC0ycHg7CiAgbWFyZ2luLWJvdHRvbTogMnB4OwogIGZvbnQtZmFtaWx5OiBzeXN0ZW0tdWksIC1hcHBsZS1zeXN0ZW0sIFNlZ29lIFVJLCBSb2JvdG8sIEhlbHZldGljYSwgQXJpYWwsIHNhbnMtc2VyaWY7Cn0KQG1lZGlhIChtYXgtd2lkdGg6IDY0MHB4KXsKICAuYWlybGluZS1zdWJ7IGZvbnQtc2l6ZTogMTFweDsgfQp9CgovKiB2NjE6IGhpZGUgdmVyaWZpZWQvZXN0aW1hdGVkIGJhZGdlICovCi5iYWRnZXsgZGlzcGxheTpub25lICFpbXBvcnRhbnQ7IH0KCi8qIHY2MTogYWlybGluZSBuYW1lIG1vcmUgcHJvbm91bmNlZCAqLwouYWlybGluZS1uYW1lewogIGZvbnQtc2l6ZTogMjhweCAhaW1wb3J0YW50OwogIGZvbnQtd2VpZ2h0OiA5NTAgIWltcG9ydGFudDsKICBsZXR0ZXItc3BhY2luZzogLjEwZW0gIWltcG9ydGFudDsKICBvcGFjaXR5OiAuOTUgIWltcG9ydGFudDsKICBtYXJnaW4tYm90dG9tOiA2cHggIWltcG9ydGFudDsKfQpAbWVkaWEgKG1heC13aWR0aDogNjQwcHgpewogIC5haXJsaW5lLW5hbWV7IGZvbnQtc2l6ZTogMjJweCAhaW1wb3J0YW50OyB9Cn0KCi8qIHY2MTogc2VhbWxlc3MgdGlja2VyIChubyBlbmQgY3V0b2ZmKSAqLwoudGlja2VyVHJhY2t7CiAgZGlzcGxheTogaW5saW5lLWZsZXggIWltcG9ydGFudDsKICBnYXA6IDQ4cHggIWltcG9ydGFudDsKICB3aGl0ZS1zcGFjZTogbm93cmFwICFpbXBvcnRhbnQ7CiAgd2lsbC1jaGFuZ2U6IHRyYW5zZm9ybTsKfQoudGlja2VyU3BhbnsgZGlzcGxheTppbmxpbmUtZmxleDsgZ2FwOjQ4cHg7IH0KQGtleWZyYW1lcyBmd01hcnF1ZWVTZWFtbGVzc3sKICBmcm9teyB0cmFuc2Zvcm06IHRyYW5zbGF0ZVgoMCk7IH0KICB0b3sgdHJhbnNmb3JtOiB0cmFuc2xhdGVYKC01MCUpOyB9Cn0KLnRpY2tlclRyYWNrLmZ3LXNlYW1sZXNzewogIGFuaW1hdGlvbi1uYW1lOiBmd01hcnF1ZWVTZWFtbGVzcyAhaW1wb3J0YW50OwogIGFuaW1hdGlvbi10aW1pbmctZnVuY3Rpb246IGxpbmVhciAhaW1wb3J0YW50OwogIGFuaW1hdGlvbi1pdGVyYXRpb24tY291bnQ6IGluZmluaXRlICFpbXBvcnRhbnQ7Cn0KCi8qIHY2MjogcmFuZ2Ugc2xpZGVyIGxhYmVscyAqLwoucmFuZ2UtbGFiZWxzewogIGRpc3BsYXk6ZmxleDsKICBqdXN0aWZ5LWNvbnRlbnQ6IHNwYWNlLWJldHdlZW47CiAgZm9udC1zaXplOiAxMnB4OwogIGxldHRlci1zcGFjaW5nOi4wOGVtOwogIG9wYWNpdHk6Ljc7CiAgbWFyZ2luLXRvcDo0cHg7Cn0KLnJhbmdlLWxhYmVscyAuYW55ewogIGZvbnQtd2VpZ2h0OjkwMDsKfQoKLyogdjYzOiBBTlkgcmFuZ2UgaGludCAqLwoucmFuZ2UtaGludHsKICBmb250LXNpemU6IDEycHg7CiAgbGV0dGVyLXNwYWNpbmc6IC4wNGVtOwogIG9wYWNpdHk6IC43MjsKICBtYXJnaW4tdG9wOiAycHg7CiAgbWluLWhlaWdodDogMTRweDsKfQoKLyogdjY2OiByZW1vdmUgdmVyaWZpZWQvZXN0aW1hdGVkIGJhZGdlICovCi5iYWRnZXsgZGlzcGxheTpub25lICFpbXBvcnRhbnQ7IH0KCi8qIHY2Njogc2VhbWxlc3MgdGlja2VyIChubyBqdW1wL2N1dCkgKi8KLnRpY2tlclRyYWNrewogIGRpc3BsYXk6aW5saW5lLWZsZXggIWltcG9ydGFudDsKICB3aGl0ZS1zcGFjZTogbm93cmFwICFpbXBvcnRhbnQ7CiAgd2lsbC1jaGFuZ2U6IHRyYW5zZm9ybTsKfQoudGlja2VyU3BhbnsKICBkaXNwbGF5OmlubGluZS1mbGV4OwogIGdhcDogNDhweDsKICBwYWRkaW5nLXJpZ2h0OiA0OHB4Owp9CkBrZXlmcmFtZXMgZndNYXJxdWVlU2VhbWxlc3N7CiAgZnJvbXsgdHJhbnNmb3JtOiB0cmFuc2xhdGVYKDApOyB9CiAgdG97IHRyYW5zZm9ybTogdHJhbnNsYXRlWCgtNTAlKTsgfQp9Ci50aWNrZXJUcmFjay5mdy1zZWFtbGVzc3sKICBhbmltYXRpb24tbmFtZTogZndNYXJxdWVlU2VhbWxlc3MgIWltcG9ydGFudDsKICBhbmltYXRpb24tdGltaW5nLWZ1bmN0aW9uOiBsaW5lYXIgIWltcG9ydGFudDsKICBhbmltYXRpb24taXRlcmF0aW9uLWNvdW50OiBpbmZpbml0ZSAhaW1wb3J0YW50Owp9CgovKiB2Njg6IGVuc3VyZSBiYWRnZSBuZXZlciBzaG93cyAqLwojYmFkZ2UsLmJhZGdleyBkaXNwbGF5Om5vbmUgIWltcG9ydGFudDsgfQoKLyogdjY4OiBkcm9wZG93biBjb250cm9scyAqLwouY29udHJvbHNSb3d7IGRpc3BsYXk6ZmxleDsgZ2FwOjE0cHg7IGFsaWduLWl0ZW1zOmZsZXgtZW5kOyBqdXN0aWZ5LWNvbnRlbnQ6c3BhY2UtYmV0d2VlbjsgZmxleC13cmFwOndyYXA7IH0KLmN0bHsgZGlzcGxheTpmbGV4OyBmbGV4LWRpcmVjdGlvbjpjb2x1bW47IGdhcDo2cHg7IG1pbi13aWR0aDoxNTBweDsgfQouY3RsTGFiZWx7IGZvbnQtc2l6ZToxMnB4OyBsZXR0ZXItc3BhY2luZzouMTJlbTsgb3BhY2l0eTouNzU7IGZvbnQtd2VpZ2h0OjgwMDsgfQouY3RsU2VsZWN0ewogIGJhY2tncm91bmQ6IHJnYmEoMjU1LDI1NSwyNTUsLjA4KTsKICBjb2xvcjogaW5oZXJpdDsKICBib3JkZXI6IDFweCBzb2xpZCByZ2JhKDI1NSwyNTUsMjU1LC4xOCk7CiAgYm9yZGVyLXJhZGl1czogMTBweDsKICBwYWRkaW5nOiAxMHB4IDEycHg7CiAgZm9udC1zaXplOiAxNnB4OwogIGZvbnQtd2VpZ2h0OiA4NTA7CiAgbGV0dGVyLXNwYWNpbmc6LjA0ZW07CiAgb3V0bGluZTpub25lOwp9Ci5jdGxDaGVja1Jvd3sgZGlzcGxheTpmbGV4OyBhbGlnbi1pdGVtczpjZW50ZXI7IGdhcDoxMHB4OyBmb250LXdlaWdodDo5MDA7IGxldHRlci1zcGFjaW5nOi4wNmVtOyBvcGFjaXR5Oi45OyB9Ci5jdGxDaGVjayBpbnB1dHsgd2lkdGg6MThweDsgaGVpZ2h0OjE4cHg7IH0KLnJhbmdlLWhpbnR7IGZvbnQtc2l6ZToxMnB4OyBsZXR0ZXItc3BhY2luZzouMDRlbTsgb3BhY2l0eTouNzI7IG1hcmdpbi10b3A6NnB4OyBtaW4taGVpZ2h0OjE0cHg7IH0KQG1lZGlhIChtYXgtd2lkdGg6NjQwcHgpewogIC5jdGx7IG1pbi13aWR0aDoxNDBweDsgfQogIC5jdGxTZWxlY3R7IGZvbnQtc2l6ZTogMTVweDsgcGFkZGluZzogOXB4IDEwcHg7IH0KfQoKLyogdjY4OiBzZWNvbmRhcnkgNC1mbGlnaHQgYm94ZXMgKi8KLnNlY29uZGFyeUdyaWR7CiAgZGlzcGxheTpncmlkOwogIGdyaWQtdGVtcGxhdGUtY29sdW1uczogcmVwZWF0KDQsIDFmcik7CiAgZ2FwOiAxMnB4OwogIG1hcmdpbi10b3A6IDEycHg7Cn0KLnNlY29uZGFyeUJveHsKICBib3JkZXI6IDFweCBzb2xpZCByZ2JhKDI1NSwyNTUsMjU1LC4xMik7CiAgYm9yZGVyLXJhZGl1czogMTRweDsKICBwYWRkaW5nOiAxMHB4IDEwcHggOHB4OwogIGJhY2tncm91bmQ6IHJnYmEoMjU1LDI1NSwyNTUsLjA0KTsKICBtaW4taGVpZ2h0OiA3MnB4OwogIG92ZXJmbG93OmhpZGRlbjsKfQouc2VjQ1N7CiAgZm9udC13ZWlnaHQ6IDk1MDsKICBsZXR0ZXItc3BhY2luZzouMDZlbTsKICBmb250LXNpemU6IDE4cHg7CiAgbWFyZ2luLWJvdHRvbTogNHB4Owp9Ci5zZWNSb3V0ZXsKICBmb250LXNpemU6IDEycHg7CiAgb3BhY2l0eTogLjc4OwogIGxpbmUtaGVpZ2h0OiAxLjI7CiAgbGV0dGVyLXNwYWNpbmc6LjAyZW07Cn0KQG1lZGlhIChtYXgtd2lkdGg6OTAwcHgpewogIC5zZWNvbmRhcnlHcmlkeyBncmlkLXRlbXBsYXRlLWNvbHVtbnM6IHJlcGVhdCgyLCAxZnIpOyB9Cn0KCiNiYWRnZSwuYmFkZ2UsW2RhdGEtYmFkZ2Vde2Rpc3BsYXk6bm9uZSAhaW1wb3J0YW50O30KCi8qIHY2OTogc2Vjb25kYXJ5IGJveCBzdGF0cyAqLwouc2VjVG9weyBkaXNwbGF5OmZsZXg7IGp1c3RpZnktY29udGVudDpzcGFjZS1iZXR3ZWVuOyBhbGlnbi1pdGVtczpiYXNlbGluZTsgZ2FwOjEwcHg7IH0KLnNlY01pbml7CiAgZm9udC1zaXplOiAxMXB4OwogIGZvbnQtd2VpZ2h0OiA4NTA7CiAgbGV0dGVyLXNwYWNpbmc6IC4wOGVtOwogIG9wYWNpdHk6IC44MDsKICB3aGl0ZS1zcGFjZTogbm93cmFwOwp9CgovKiB2NzA6IGtlZXAgNCBib3R0b20gYm94ZXMgdmlzaWJsZSB3aXRob3V0IHNjcm9sbGluZyAqLwouc2Vjb25kYXJ5R3JpZHsgZ3JpZC10ZW1wbGF0ZS1jb2x1bW5zOiByZXBlYXQoNCwgMWZyKSAhaW1wb3J0YW50OyB9CkBtZWRpYSAobWF4LXdpZHRoOjkwMHB4KXsgLnNlY29uZGFyeUdyaWR7IGdyaWQtdGVtcGxhdGUtY29sdW1uczogcmVwZWF0KDQsIDFmcikgIWltcG9ydGFudDsgfSB9CkBtZWRpYSAobWF4LXdpZHRoOjY0MHB4KXsgLnNlY29uZGFyeUdyaWR7IGdyaWQtdGVtcGxhdGUtY29sdW1uczogcmVwZWF0KDIsIDFmcikgIWltcG9ydGFudDsgfSB9Cgouc2Vjb25kYXJ5Qm94eyBvdmVyZmxvdzogdmlzaWJsZSAhaW1wb3J0YW50OyBtaW4taGVpZ2h0OiA4NnB4ICFpbXBvcnRhbnQ7IH0KLnNlY01pbml7CiAgd2hpdGUtc3BhY2U6IG5vcm1hbCAhaW1wb3J0YW50OwogIGxpbmUtaGVpZ2h0OiAxLjE1OwogIHRleHQtYWxpZ246IHJpZ2h0Owp9CgovKiB2NzE6IGFsd2F5cyBzaG93IDQgYm90dG9tIGJveGVzIHNpZGUtYnktc2lkZSBvbiBpUGFkICovCi5zZWNvbmRhcnlHcmlkewogIHdpZHRoOiAxMDAlICFpbXBvcnRhbnQ7CiAgZ3JpZC10ZW1wbGF0ZS1jb2x1bW5zOiByZXBlYXQoNCwgbWlubWF4KDAsIDFmcikpICFpbXBvcnRhbnQ7CiAgZ2FwOiAxMHB4ICFpbXBvcnRhbnQ7Cn0KLnNlY29uZGFyeUJveHsgbWluLXdpZHRoOjAgIWltcG9ydGFudDsgfQoKLyogT25seSBkcm9wIHRvIDIgY29sdW1ucyBvbiB2ZXJ5IHNtYWxsIHBob25lcyAqLwpAbWVkaWEgKG1heC13aWR0aDogNTIwcHgpewogIC5zZWNvbmRhcnlHcmlkeyBncmlkLXRlbXBsYXRlLWNvbHVtbnM6IHJlcGVhdCgyLCBtaW5tYXgoMCwxZnIpKSAhaW1wb3J0YW50OyB9Cn0KCi8qIHY3MTogbWFrZSBhdHRyaWJ1dGUgdGl0bGVzIChBTFQvRElTVC9TUEQpIGJpZ2dlciAqLwouaywgLmt2IC5rLCAuc3RhdEssIC5zdGF0S2V5ewogIGZvbnQtc2l6ZTogMTRweCAhaW1wb3J0YW50OwogIGZvbnQtd2VpZ2h0OiA5NTAgIWltcG9ydGFudDsKICBsZXR0ZXItc3BhY2luZzogLjEyZW0gIWltcG9ydGFudDsKfQoKLyogdjcyOiBjb21tZXJjaWFsIHRvZ2dsZSBzdHlsaW5nICovCi5jdGxDaGVja3sKICBkaXNwbGF5OmZsZXg7CiAgYWxpZ24taXRlbXM6Y2VudGVyOwogIGdhcDoxMHB4OwogIGZvbnQtd2VpZ2h0OiA5MDA7CiAgbGV0dGVyLXNwYWNpbmc6IC4xMGVtOwogIG9wYWNpdHk6Ljk7CiAgdXNlci1zZWxlY3Q6bm9uZTsKfQouY3RsQ2hlY2sgaW5wdXR7IHdpZHRoOjE4cHg7IGhlaWdodDoxOHB4OyB9CgovKiB2NzI6IGFsbG93IGZ1bGwgaVBhZCB3aWR0aCBzbyA0IGJveGVzIGZpdCAqLwoud3JhcHsKICBtYXgtd2lkdGg6IDEwMCUgIWltcG9ydGFudDsKfQoKLyogdjcyOiBmb3JjZSA0LWFjcm9zcyBib3R0b20gYm94ZXMgKGlQYWQpICovCi5zZWNvbmRhcnlHcmlkewogIGdyaWQtdGVtcGxhdGUtY29sdW1uczogcmVwZWF0KDQsIG1pbm1heCgwLCAxZnIpKSAhaW1wb3J0YW50Owp9CkBtZWRpYSAobWF4LXdpZHRoOiA1MjBweCl7CiAgLnNlY29uZGFyeUdyaWR7IGdyaWQtdGVtcGxhdGUtY29sdW1uczogcmVwZWF0KDIsIG1pbm1heCgwLDFmcikpICFpbXBvcnRhbnQ7IH0KfQoKLyogdjc2OiBmdWxsIHdpZHRoIHNvIDQgYm94ZXMgZml0IG9uIGlQYWQgQWlyICovCi53cmFweyBtYXgtd2lkdGg6IDEwMCUgIWltcG9ydGFudDsgcGFkZGluZy1sZWZ0OiAxNHB4ICFpbXBvcnRhbnQ7IHBhZGRpbmctcmlnaHQ6IDE0cHggIWltcG9ydGFudDsgfQoKLyogdjc2OiBib3R0b20gZ3JpZCAqLwouc2Vjb25kYXJ5R3JpZHsgZGlzcGxheTpncmlkOyBncmlkLXRlbXBsYXRlLWNvbHVtbnM6IHJlcGVhdCg0LCBtaW5tYXgoMCwxZnIpKSAhaW1wb3J0YW50OyBnYXA6IDEwcHggIWltcG9ydGFudDsgbWFyZ2luLXRvcDogMTBweCAhaW1wb3J0YW50OyB9CkBtZWRpYSAobWF4LXdpZHRoOjUyMHB4KXsgLnNlY29uZGFyeUdyaWR7IGdyaWQtdGVtcGxhdGUtY29sdW1uczogcmVwZWF0KDIsIG1pbm1heCgwLDFmcikpICFpbXBvcnRhbnQ7IH0gfQoKLyogdjc2OiByZW1vdmUgZGl2aWRlciBsaW5lcyBiZXR3ZWVuIHNlY3Rpb25zICovCmhyLCAuZGl2aWRlciwgLnJ1bGV7IGRpc3BsYXk6bm9uZSAhaW1wb3J0YW50OyB9CgovKiB2NzY6IGNoZWNrYm94IHJvdyAqLwouY29udHJvbHNSb3d7IGRpc3BsYXk6ZmxleDsgZ2FwOjE4cHg7IGFsaWduLWl0ZW1zOmNlbnRlcjsganVzdGlmeS1jb250ZW50OmZsZXgtc3RhcnQ7IGZsZXgtd3JhcDp3cmFwOyB9Ci5jdGxDaGVja3sgZGlzcGxheTpmbGV4OyBhbGlnbi1pdGVtczpjZW50ZXI7IGdhcDoxMHB4OyBmb250LXdlaWdodDogOTAwOyBsZXR0ZXItc3BhY2luZzouMTBlbTsgb3BhY2l0eTouOTsgdXNlci1zZWxlY3Q6bm9uZTsgfQouY3RsQ2hlY2sgaW5wdXR7IHdpZHRoOjE4cHg7IGhlaWdodDoxOHB4OyB9CgovKiB2NzY6IHNlY29uZGFyeSBib3ggdHlwb2dyYXBoeSAqLwouc2VjVG9weyBkaXNwbGF5OmZsZXg7IGp1c3RpZnktY29udGVudDpzcGFjZS1iZXR3ZWVuOyBhbGlnbi1pdGVtczpjZW50ZXI7IGdhcDoxMHB4OyB9Ci5zZWNDU3sgZm9udC13ZWlnaHQ6IDk1MDsgbGV0dGVyLXNwYWNpbmc6LjA2ZW07IGZvbnQtc2l6ZTogMThweDsgfQouc2VjTWluaXsgZm9udC1zaXplOiAxMnB4OyBmb250LXdlaWdodDogOTAwOyBsZXR0ZXItc3BhY2luZzouMDhlbTsgb3BhY2l0eTouODI7IHdoaXRlLXNwYWNlOiBub3dyYXA7IHRleHQtYWxpZ246cmlnaHQ7IH0KCi8qIHY3ODogYm90dG9tIHNlY3Rpb24gcmVzZXQgKi8KI3NlY29uZGFyeUdyaWR7IG1hcmdpbi10b3A6IDEwcHggIWltcG9ydGFudDsgfQouc2Vjb25kYXJ5R3JpZHsKICBkaXNwbGF5OmdyaWQgIWltcG9ydGFudDsKICBncmlkLXRlbXBsYXRlLWNvbHVtbnM6IHJlcGVhdCg0LCBtaW5tYXgoMCwxZnIpKSAhaW1wb3J0YW50OwogIGdhcDogMTBweCAhaW1wb3J0YW50OwogIHdpZHRoOiAxMDAlICFpbXBvcnRhbnQ7Cn0KQG1lZGlhIChtYXgtd2lkdGg6NTIwcHgpewogIC5zZWNvbmRhcnlHcmlkeyBncmlkLXRlbXBsYXRlLWNvbHVtbnM6IHJlcGVhdCgyLCBtaW5tYXgoMCwxZnIpKSAhaW1wb3J0YW50OyB9Cn0KLnNlY29uZGFyeUJveHsKICBib3JkZXI6IDFweCBzb2xpZCByZ2JhKDI1NSwyNTUsMjU1LC4xMikgIWltcG9ydGFudDsKICBib3JkZXItcmFkaXVzOiAxNHB4ICFpbXBvcnRhbnQ7CiAgcGFkZGluZzogMTBweCAxMHB4IDhweCAhaW1wb3J0YW50OwogIGJhY2tncm91bmQ6IHJnYmEoMjU1LDI1NSwyNTUsLjA0KSAhaW1wb3J0YW50OwogIG1pbi1oZWlnaHQ6IDY0cHggIWltcG9ydGFudDsKICBvdmVyZmxvdzogaGlkZGVuICFpbXBvcnRhbnQ7Cn0KLnNlY29uZGFyeUJveCAuc2VjQ1N7CiAgZm9udC13ZWlnaHQ6IDk1MCAhaW1wb3J0YW50OwogIGxldHRlci1zcGFjaW5nOi4wNmVtICFpbXBvcnRhbnQ7CiAgZm9udC1zaXplOiAxOHB4ICFpbXBvcnRhbnQ7CiAgbGluZS1oZWlnaHQ6IDEuMSAhaW1wb3J0YW50Owp9Ci5zZWNvbmRhcnlCb3ggLnNlY01pbml7CiAgbWFyZ2luLXRvcDogNnB4ICFpbXBvcnRhbnQ7CiAgZm9udC1zaXplOiAxMnB4ICFpbXBvcnRhbnQ7CiAgZm9udC13ZWlnaHQ6IDkwMCAhaW1wb3J0YW50OwogIGxldHRlci1zcGFjaW5nOiAuMDhlbSAhaW1wb3J0YW50OwogIG9wYWNpdHk6IC44MiAhaW1wb3J0YW50OwogIHdoaXRlLXNwYWNlOiBub3dyYXAgIWltcG9ydGFudDsKfQovKiBraWxsIHN0cmF5IGRpdmlkZXJzIGlmIGFueSBzdGlsbCBleGlzdCAqLwpociwuZGl2aWRlciwucnVsZXsgZGlzcGxheTpub25lICFpbXBvcnRhbnQ7IH0KLyogZW5zdXJlIHdyYXBwZXIgZG9lc24ndCBjb25zdHJhaW4gKi8KLndyYXB7IG1heC13aWR0aDogMTAwJSAhaW1wb3J0YW50OyB9CgovKiB2Nzk6IHRpZ2h0ZW4gc3BhY2UgYmV0d2VlbiBtYWluIGNhcmQgYW5kIGJvdHRvbSBncmlkICovCi5jYXJkeyBtYXJnaW4tYm90dG9tOiAxMHB4ICFpbXBvcnRhbnQ7IH0KCi8qIHY4MCAqLwojcmFuZ2UsICNyYW5nZVNlbGVjdCwgLnJhbmdlLWxhYmVscywgLnJhbmdlLWhpbnQsIC5yYW5nZVJvdywgLnJhbmdlV3JhcHtkaXNwbGF5Om5vbmUhaW1wb3J0YW50O30KCi8qIHY4NDogbGFzdCB1cGRhdGUgdGltZXN0YW1wICovCi5sYXN0VXBkYXRlewogIHBvc2l0aW9uOmFic29sdXRlOwogIHJpZ2h0OjE0cHg7CiAgdG9wOjE0cHg7CiAgZm9udC1zaXplOjEycHg7CiAgZm9udC13ZWlnaHQ6ODAwOwogIGxldHRlci1zcGFjaW5nOi4wOGVtOwogIG9wYWNpdHk6LjY1Owp9CgovKiB2ODQ6IHJhZGFyIHdhcm5pbmcgKi8KLnJhZGFyV2FybnsKICBjb2xvcjojZmZiMDAwOwogIGZvbnQtd2VpZ2h0OjkwMDsKICBsZXR0ZXItc3BhY2luZzouMDhlbTsKfQoKLyogdjg1OiBMSVZFIGluZGljYXRvciAqLwoubGl2ZVdyYXB7CiAgcG9zaXRpb246YWJzb2x1dGU7CiAgcmlnaHQ6MTRweDsKICB0b3A6MTJweDsKICBkaXNwbGF5OmZsZXg7CiAgYWxpZ24taXRlbXM6Y2VudGVyOwogIGdhcDo4cHg7Cn0KLmxpdmVEb3R7CiAgd2lkdGg6MTBweDsKICBoZWlnaHQ6MTBweDsKICBib3JkZXItcmFkaXVzOjUwJTsKICBiYWNrZ3JvdW5kOiMyZGZmNmE7CiAgYm94LXNoYWRvdzowIDAgOHB4IHJnYmEoNDUsMjU1LDEwNiwuOSk7CiAgb3BhY2l0eTouOTsKfQoubGl2ZURvdC5wdWxzZXsKICBhbmltYXRpb246IGxpdmVQdWxzZSAxLjVzIGluZmluaXRlOwp9CkBrZXlmcmFtZXMgbGl2ZVB1bHNlewogIDAleyB0cmFuc2Zvcm06c2NhbGUoLjg1KTsgb3BhY2l0eTouNjsgfQogIDUwJXsgdHJhbnNmb3JtOnNjYWxlKDEuMik7IG9wYWNpdHk6MTsgfQogIDEwMCV7IHRyYW5zZm9ybTpzY2FsZSguODUpOyBvcGFjaXR5Oi42OyB9Cn0KCi8qIHY5Mjogcm91dGUgbGluZSAqLwoucm91dGV7IG1hcmdpbi10b3A6NnB4OyBmb250LXdlaWdodDo4MDA7IGxldHRlci1zcGFjaW5nOi4wMmVtOyBvcGFjaXR5Oi45NTsgfQoKLyogdjkzOiBoaWRlIHJvdXRlIHVudGlsIGF2YWlsYWJsZSAqLwovKiB2OTc6IGFsd2F5cy12aXNpYmxlIHN0YXR1cyBsaW5lIGZvciBkZWJ1Z2dpbmcgKi8KLnN0YXR1c0xpbmV7bWFyZ2luOjEwcHggYXV0byAwO21heC13aWR0aDo5ODBweDtwYWRkaW5nOjhweCAxMnB4O2JvcmRlci1yYWRpdXM6MTBweDtmb250LXdlaWdodDo3MDA7b3BhY2l0eTouOTt0ZXh0LWFsaWduOmNlbnRlcjt9CgovKiB2MTA0OiBidWlsZCBzdGFtcCAqLwouYnVpbGRTdGFtcHtmb250LXdlaWdodDo3MDA7b3BhY2l0eTouODU7fQouc2Vwe29wYWNpdHk6LjY7bWFyZ2luOjAgNnB4O30KCi8qIHYxMDY6IHJvdXRlIGxpbmUgYWx3YXlzIHZpc2libGUgKi8KLnJvdXRle21hcmdpbi10b3A6NnB4O2ZvbnQtd2VpZ2h0OjkwMDtsZXR0ZXItc3BhY2luZzouMDJlbTtvcGFjaXR5Oi45NTt0ZXh0LWFsaWduOmNlbnRlcjt9CgovKiB2MTA4OiByZW1vdmUgc2Nyb2xsIGNvbnRyb2wgKyB0aW1lc3RhbXAgKi8KLnNjcm9sbFRvZ2dsZSwuc2Nyb2xsQ3RsLC5zY3JvbGxDb250cm9sLCNzY3JvbGxUb2dnbGUsI3Njcm9sbEN0bHtkaXNwbGF5Om5vbmUgIWltcG9ydGFudDt9Ci50aW1lc3RhbXAsI3RpbWVzdGFtcCwjbGFzdFVwZGF0ZSwubGFzdFVwZGF0ZSwuc3RhdHVzVGltZXtkaXNwbGF5Om5vbmUgIWltcG9ydGFudDt9CgovKiB2MTEzIGFpcmNyYWZ0IG1vZGVsOiBrZWVwIHJlYWRhYmxlICovCiNtb2RlbHtmb250LXdlaWdodDo5MDA7bGV0dGVyLXNwYWNpbmc6LjAyZW07fQoKLyogdjExNCBhaXJjcmFmdCBtb2RlbDIgKi8KI21vZGVsMnttYXJnaW4tdG9wOjRweDtmb250LXdlaWdodDo5MDA7b3BhY2l0eTouOTt0ZXh0LWFsaWduOmNlbnRlcjt9CgoKLyogdjE1MDogZW5zdXJlIGFpcmNyYWZ0IHJlZ2lzdHJhdGlvbiBsaW5lIGlzIHZpc2libGUgKi8KLm1vZGVsMntmb250LXNpemU6MTRweDtsZXR0ZXItc3BhY2luZzouMDhlbTtvcGFjaXR5Oi44NTttYXJnaW4tdG9wOjRweDt0ZXh0LXRyYW5zZm9ybTp1cHBlcmNhc2U7fQo=";
const __B64_JS    = "Ci8vIHYxMjU6IHN0YWJpbGl0eSBnYXRlIChwcm90ZWN0IEFlcm9EYXRhQm94IGNyZWRpdHMpCgovLyB2MTUwOiBOb3JtYWxpemUgT3BlblNreSBjYWxsc2lnbnMgKHRyaW0gc3BhY2VzIC8gdXBwZXJjYXNlIC8gc3RyaXAgbm9uLWFscGhhbnVtZXJpY3MpCmZ1bmN0aW9uIG5vcm1DYWxsc2lnbihjcyl7CiAgcmV0dXJuIChjcyB8fCAiIikKICAgIC50b1N0cmluZygpCiAgICAudHJpbSgpCiAgICAudG9VcHBlckNhc2UoKQogICAgLnJlcGxhY2UoL1teQS1aMC05XS9nLCAiIik7Cn0KY29uc3QgRldfU1RBQkxFX1JPVVRFX01TID0gMTAwMDA7IC8vIDEwcyBzdGFibGUgY2xvc2VzdCBiZWZvcmUgcm91dGUgbG9va3VwcwoKLy8gdjEyODogYWlyY3JhZnQgbG9va3VwIGdhdGUgKHBlci1oZXgpIHRvIGF2b2lkIGJ1cm5pbmcgY3JlZGl0cyBldmVuIGlmIGNsb3Nlc3Qgaml0dGVycwpjb25zdCBGV19BSVJfSEVYX0dBVEVfTVMgPSAzMCAqIDYwICogMTAwMDsgLy8gMzAgbWludXRlcwoKLy8gdjE1MDogYWRhcHRpdmUgcmFkYXIgcG9sbGluZyB0byBhdm9pZCBPcGVuU2t5IDQyOQpsZXQgX19md1JhZGFyUG9sbE1zID0gNTAwMDsgICAgICAvLyBzdGFydCBhdCA1cwpjb25zdCBfX2Z3UmFkYXJQb2xsTWluTXMgPSA0MDAwOyAvLyBmbG9vcgpjb25zdCBfX2Z3UmFkYXJQb2xsTWF4TXMgPSA2MDAwMDsvLyBjZWlsaW5nIDYwcwpsZXQgX19md1JhZGFyQ29uc2VjRXJyID0gMDsKZnVuY3Rpb24gX19md1JhZGFyQmFja29mZihoaXQ0MjkpewogIF9fZndSYWRhckNvbnNlY0VyciA9IE1hdGgubWluKDEwLCBfX2Z3UmFkYXJDb25zZWNFcnIgKyAxKTsKICBjb25zdCBmYWN0b3IgPSBoaXQ0MjkgPyAyLjIgOiAxLjY7CiAgX19md1JhZGFyUG9sbE1zID0gTWF0aC5taW4oX19md1JhZGFyUG9sbE1heE1zLCBNYXRoLm1heChfX2Z3UmFkYXJQb2xsTWluTXMsIE1hdGgucm91bmQoX19md1JhZGFyUG9sbE1zICogZmFjdG9yKSkpOwp9CmZ1bmN0aW9uIF9fZndSYWRhclJlY292ZXIoKXsKICBfX2Z3UmFkYXJDb25zZWNFcnIgPSAwOwogIF9fZndSYWRhclBvbGxNcyA9IE1hdGgubWF4KF9fZndSYWRhclBvbGxNaW5NcywgTWF0aC5yb3VuZChfX2Z3UmFkYXJQb2xsTXMgKiAwLjg1KSk7Cn0KY29uc3QgX19md0FpckhleEdhdGUgPSBuZXcgTWFwKCk7IC8vIGhleCAtPiBsYXN0QXR0ZW1wdE1zCmNvbnN0IEZXX1NUQUJMRV9BSVJfTVMgPSA1MDAwOyAgIC8vIHYxMjc6IDVzIHN0YWJsZSBjbG9zZXN0IGJlZm9yZSBhaXJjcmFmdCBsb29rdXBzCmxldCBfX2Z3U3RhYmxlU2luY2UgPSAwOwpsZXQgX19md1N0YWJsZUtleSA9ICIiOwpmdW5jdGlvbiBfX2Z3TWFya1N0YWJsZUtleShjYWxsc2lnbiwgaWNhbzI0KXsKICBjb25zdCBrID0gU3RyaW5nKGNhbGxzaWdufHwiIikgKyAifCIgKyBTdHJpbmcoaWNhbzI0fHwiIik7CiAgaWYgKGsgIT09IF9fZndTdGFibGVLZXkpeyBfX2Z3U3RhYmxlS2V5ID0gazsgX19md1N0YWJsZVNpbmNlID0gRGF0ZS5ub3coKTsgfQp9CmZ1bmN0aW9uIF9fZndJc1N0YWJsZVJvdXRlKCl7CiAgcmV0dXJuIChEYXRlLm5vdygpIC0gKF9fZndTdGFibGVTaW5jZXx8MCkpID49IEZXX1NUQUJMRV9ST1VURV9NUzsKfQpmdW5jdGlvbiBfX2Z3SXNTdGFibGVBaXIoKXsKICByZXR1cm4gKERhdGUubm93KCkgLSAoX19md1N0YWJsZVNpbmNlfHwwKSkgPj0gRldfU1RBQkxFX0FJUl9NUzsKfQoKCi8vIHYxMTg6IHRpZ2h0ZXIgT3BlblNreSBib3VuZGluZyBib3ggYXJvdW5kIGN1cnJlbnQgbG9jYXRpb24gKHBlcmZvcm1hbmNlKQpjb25zdCBGV19CQk9YX0xBVF9ERUcgPSAxLjI1OyAvLyB+ODYgbWkgbm9ydGgvc291dGgKY29uc3QgRldfQkJPWF9MT05fREVHID0gMS41MDsgLy8gfjgwLTkwIG1pIGVhc3Qvd2VzdCAodmFyaWVzIGJ5IGxhdGl0dWRlKQoKZnVuY3Rpb24gZndHZXRCYm94VjEyNShsYXQsIGxvbil7CiAgY29uc3QgbGFtaW4gPSBsYXQgLSBGV19CQk9YX0xBVF9ERUc7CiAgY29uc3QgbGFtYXggPSBsYXQgKyBGV19CQk9YX0xBVF9ERUc7CiAgY29uc3QgbG9taW4gPSBsb24gLSBGV19CQk9YX0xPTl9ERUc7CiAgY29uc3QgbG9tYXggPSBsb24gKyBGV19CQk9YX0xPTl9ERUc7CiAgcmV0dXJuIHsgbGFtaW4sIGxvbWluLCBsYW1heCwgbG9tYXggfTsKfQoKCgpmdW5jdGlvbiBfX2Z3Rml4QXJyb3cocyl7CiAgdHJ5ewogICAgY29uc3QgdCA9IFN0cmluZyhzfHwiIik7CiAgICAvLyBjb21tb24gbW9qaWJha2Ugc2VxdWVuY2UgZm9yIGFycm93CiAgICByZXR1cm4gdC5yZXBsYWNlKC/DosKGwpIvZywgIuKGkiIpLnJlcGxhY2UoL8Oi4oCg4oCZL2csICLihpIiKS5yZXBsYWNlKC9ccyvihpJccysvZywgIiDihpIgIikudHJpbSgpOwogIH1jYXRjaChlKXsgcmV0dXJuIFN0cmluZyhzfHwiIik7IH0KfQovKiBQRVJTSVNUX0NBQ0hFX1YxMTUKICAgbG9jYWxTdG9yYWdlLWJhY2tlZCBjYWNoaW5nIChzdXJ2aXZlcyByZWZyZXNoL3RhYiBjbG9zZSk6CiAgIC0gYWlyY3JhZnQgbW9kZWxzIChtYWluIHRpbGUpOiBmdy5haXJjcmFmdC48aWNhbzI0PiAoVFRMIDcgZGF5cykKICAgLSByb3V0ZXMgKGNsb3Nlc3QgY2FsbHNpZ24pOiAgIGZ3LnJvdXRlLjxjYWxsc2lnbj4gICAoVFRMIDYgaG91cnM7IDMwbSBmb3IgdW5hdmFpbGFibGUpCiAgIEZhbGxzIGJhY2sgc2lsZW50bHkgaWYgc3RvcmFnZSBpcyB1bmF2YWlsYWJsZS4KKi8KKGZ1bmN0aW9uKCl7CiAgLy8gdjE1MDogc2hvdyBhaXJjcmFmdCByZWdpc3RyYXRpb24gd2hlbiBBZXJvRGF0YUJveCBwcm92aWRlcyBpdAogIGZ1bmN0aW9uIGZ3U2V0UmVnTGluZShyZWcpewogICAgdHJ5ewogICAgICBjb25zdCBlbCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJtb2RlbDIiKTsKICAgICAgaWYgKCFlbCkgcmV0dXJuOwogICAgICBjb25zdCB2ID0gU3RyaW5nKHJlZ3x8IiIpLnRyaW0oKTsKICAgICAgZWwudGV4dENvbnRlbnQgPSB2ID8gKCJSRUcgIiArIHYpIDogIiI7CiAgICB9Y2F0Y2goZSl7fQogIH0KCiAgY29uc3QgTlMgPSAiZncuIjsKICBmdW5jdGlvbiBub3coKXsgcmV0dXJuIERhdGUubm93KCk7IH0KICBmdW5jdGlvbiBnZXQoa2V5KXsKICAgIHRyeXsKICAgICAgY29uc3QgcmF3ID0gbG9jYWxTdG9yYWdlLmdldEl0ZW0oTlMra2V5KTsKICAgICAgaWYgKCFyYXcpIHJldHVybiBudWxsOwogICAgICBjb25zdCBvYmogPSBKU09OLnBhcnNlKHJhdyk7CiAgICAgIGlmICghb2JqIHx8IHR5cGVvZiBvYmogIT09ICJvYmplY3QiKSByZXR1cm4gbnVsbDsKICAgICAgaWYgKG9iai5leHAgJiYgbm93KCkgPiBvYmouZXhwKSB7IGxvY2FsU3RvcmFnZS5yZW1vdmVJdGVtKE5TK2tleSk7IHJldHVybiBudWxsOyB9CiAgICAgIHJldHVybiAob2JqLnZhbCA9PT0gdW5kZWZpbmVkKSA/IG51bGwgOiBvYmoudmFsOwogICAgfWNhdGNoKGUpeyByZXR1cm4gbnVsbDsgfQogIH0KICBmdW5jdGlvbiBzZXQoa2V5LCB2YWwsIHR0bE1zKXsKICAgIHRyeXsKICAgICAgY29uc3QgZXhwID0gdHRsTXMgPyAobm93KCkgKyB0dGxNcykgOiAwOwogICAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbShOUytrZXksIEpTT04uc3RyaW5naWZ5KHsgZXhwLCB2YWwgfSkpOwogICAgICByZXR1cm4gdHJ1ZTsKICAgIH1jYXRjaChlKXsgcmV0dXJuIGZhbHNlOyB9CiAgfQogIGZ1bmN0aW9uIGRlbChrZXkpeyB0cnl7IGxvY2FsU3RvcmFnZS5yZW1vdmVJdGVtKE5TK2tleSk7IH1jYXRjaChlKXt9IH0KICB3aW5kb3cuX19GV19MU19fID0geyBnZXQsIHNldCwgZGVsIH07CnRyeXsgd2luZG93Ll9fRldfRk9SQ0VfUk9VVEVfUkFXX18gPSB1cGRhdGU7IHdpbmRvdy5fX0ZXX0ZPUkNFX1JPVVRFX18gPSAoKT0+eyB0cnl7IGlmKF9fZndJc1N0YWJsZVJvdXRlKCkpIHJldHVybiB3aW5kb3cuX19GV19GT1JDRV9ST1VURV9SQVdfXygpOyB9Y2F0Y2goZSl7fSB9OyB9Y2F0Y2goZSl7fSAvLyB2MTI1X3dyYXBfZm9yY2Vfcm91dGUKfSkoKTsKCgovLyBBSVJDUkFGVDogbW9kdWxlIHYxMTMgKG1haW4gdGlsZSBvbmx5KQovLyBVc2VzIHlvdXIgQ2xvdWRmbGFyZSBXb3JrZXIgYXMgYSBwcm94eTogR0VUIC9haXJjcmFmdC9pY2FvMjQvPGhleD4KLy8gRmFsbHMgYmFjayB0byBzaG93aW5nIGJhc2ljIHJhZGFyIHR5cGUgaWYgdGhlIGVuZHBvaW50IGlzbid0IGF2YWlsYWJsZSBvciB0aGUgbW9kZWwgaXMgdW5rbm93bi4KKGZ1bmN0aW9uKCl7CiAgY29uc3QgQUVST19QUk9YWV9PUklHSU4gPSAiaHR0cHM6Ly9mbGlnaHRzYWJvdmUudDJoa21oZ2J3ei53b3JrZXJzLmRldiI7CiAgY29uc3QgVFRMX01TID0gMjQgKiA2MCAqIDYwICogMTAwMDsgLy8gMjRoIChhaXJjcmFmdCBtb2RlbCBkb2Vzbid0IGNoYW5nZSBvZnRlbikKICBjb25zdCBjYWNoZSA9IG5ldyBNYXAoKTsgLy8gaWNhbzI0IC0+IHt0cywgdGV4dH0KICBsZXQgbGFzdEtleSA9ICIiOwogIGxldCBiYWNrb2ZmVW50aWwgPSAwOwoKICBmdW5jdGlvbiBub3coKXsgcmV0dXJuIERhdGUubm93KCk7IH0KICBmdW5jdGlvbiBzZXRNb2RlbExpbmVzVjExNChsaW5lMSwgbGluZTIpewogICAgY29uc3QgbDEgPSBTdHJpbmcobGluZTF8fCIiKS50cmltKCk7CiAgICBjb25zdCBsMiA9IFN0cmluZyhsaW5lMnx8IiIpLnRyaW0oKTsKICAgIGNvbnN0IGVsMSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJtb2RlbCIpOwogICAgY29uc3QgZWwyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoIm1vZGVsMiIpOwoKICAgIC8vIElmIHRoZXJlIGlzIG5vIDJuZCBsaW5lIGNvbnRhaW5lciAob3IgaXQncyBlZmZlY3RpdmVseSBub3QgdXNlZCksIG1lcmdlIGxpbmUyIGludG8gbGluZTEuCiAgICBjb25zdCBtZXJnZWQgPSAobDEgfHwgIuKAlCIpICsgKGwyID8gYCDigKIgJHtsMn1gIDogIiIpOwoKICAgIGlmIChlbDEpIGVsMS50ZXh0Q29udGVudCA9IG1lcmdlZDsKICAgIGlmIChlbDIpIGVsMi50ZXh0Q29udGVudCA9ICIiOyAvLyBrZWVwIGVtcHR5IHNvIGxheW91dCBzdGF5cyBzdGFibGUgaWYgcHJlc2VudCBidXQgdW51c2VkCiAgfQogIGZ1bmN0aW9uIGdldENhY2hlZChrZXkpewogICAgLy8gcGVyc2lzdGVudCBmaXJzdAogICAgY29uc3QgbHMgPSB3aW5kb3cuX19GV19MU19fOwogICAgY29uc3QgcCA9IChscyAmJiBscy5nZXQpID8gbHMuZ2V0KGBhaXJjcmFmdC52MTUwLiR7a2V5fWApIDogbnVsbDsKICAgIGlmIChwKXsKICAgICAgLy8gdjE1MDogaWdub3JlIHN0YWxlL2ludmFsaWQgY2FjaGVkIHNoYXBlcyBmcm9tIG9sZGVyIHZlcnNpb25zCiAgICAgIGlmIChwID09PSAiTkYiKSByZXR1cm4gbnVsbDsKICAgICAgaWYgKHR5cGVvZiBwICE9PSAib2JqZWN0IiB8fCAhKCJsaW5lMSIgaW4gcCkgJiYgISgibGluZTIiIGluIHApKSByZXR1cm4gbnVsbDsKICAgICAgcmV0dXJuIHA7CiAgICB9CgogICAgY29uc3QgaXQgPSBjYWNoZS5nZXQoa2V5KTsKICAgIGlmICghaXQpIHJldHVybiBudWxsOwogICAgaWYgKG5vdygpIC0gaXQudHMgPiBUVExfTVMpeyBjYWNoZS5kZWxldGUoa2V5KTsgcmV0dXJuIG51bGw7IH0KICAgIHJldHVybiBpdC50ZXh0OwogIH0KICBmdW5jdGlvbiBwdXROZWdDYWNoZWQoa2V5KXsKICAgIGNvbnN0IGxzID0gd2luZG93Ll9fRldfTFNfXzsKICAgIGlmIChscyAmJiBscy5zZXQpIGxzLnNldChgYWlyY3JhZnQudjE1MC4ke2tleX1gLCAiTkYiLCBQX05FR19UVExfTVMpOwogICAgY2FjaGUuc2V0KGtleSwge3RzOiBub3coKSwgdGV4dDogIk5GIn0pOwogIH0KCiAgZnVuY3Rpb24gcHV0Q2FjaGVkKGtleSwgdGV4dCl7CiAgICAvLyBwZXJzaXN0IGJlc3QtZWZmb3J0CiAgICBjb25zdCBscyA9IHdpbmRvdy5fX0ZXX0xTX187CiAgICBpZiAobHMgJiYgbHMuc2V0KSBscy5zZXQoYGFpcmNyYWZ0LnYxNTAuJHtrZXl9YCwgdGV4dCwgUF9UVExfTVMpOwoKICAgIGNhY2hlLnNldChrZXksIHt0czogbm93KCksIHRleHR9KTsKICB9CiAgZnVuY3Rpb24gY2xlYW4ocyl7CiAgICByZXR1cm4gU3RyaW5nKHN8fCIiKS5yZXBsYWNlKC9ccysvZywiICIpLnRyaW0oKTsKICB9CiAgZnVuY3Rpb24gbm9ybWFsaXplSGV4KGgpewogICAgcmV0dXJuIFN0cmluZyhofHwiIikudHJpbSgpLnRvTG93ZXJDYXNlKCk7CiAgfQogIGZ1bmN0aW9uIGZvcm1hdEFpcmNyYWZ0KGopewogICAgaWYgKCFqKSByZXR1cm4gbnVsbDsKICAgIC8vIFdvcmtlciBtYXkgcmV0dXJuIHtvaywgZm91bmQsIG1vZGVsLCBtb2RlbENvZGUsIHJlZ2lzdHJhdGlvbiwgbWFudWZhY3R1cmVyfQogICAgY29uc3Qgb2sgPSAoai5vayA9PT0gdW5kZWZpbmVkKSA/IHRydWUgOiAhIWoub2s7CiAgICBjb25zdCBmb3VuZCA9IChqLmZvdW5kID09PSB1bmRlZmluZWQpID8gdHJ1ZSA6ICEhai5mb3VuZDsKICAgIGNvbnN0IGEgPSBqLmFpcmNyYWZ0IHx8IGo7CgogICAgY29uc3QgbW9kZWwgPSBjbGVhbihhLm1vZGVsIHx8IGEudHlwZU5hbWUgfHwgYS50eXBlTmFtZUxvbmcgfHwgYS50eXBlIHx8IGEudHlwZUxvbmcgfHwgYS5tb2RlbE5hbWUgfHwgYS5haXJjcmFmdE1vZGVsIHx8ICIiKTsKICAgIGNvbnN0IG1vZGVsQ29kZSA9IGNsZWFuKGEubW9kZWxDb2RlIHx8IGEuaWNhb0NvZGUgfHwgYS5pY2FvVHlwZSB8fCBhLmljYW9UeXBlRGVzaWduYXRvciB8fCBhLmljYW8gfHwgYS52YXJpYW50IHx8IGEubW9kZWxWYXJpYW50IHx8ICIiKTsKICAgIGNvbnN0IHJlZyA9IGNsZWFuKGEucmVnaXN0cmF0aW9uIHx8IGEucmVnIHx8ICIiKTsKICAgIGNvbnN0IG1hbnUgPSBjbGVhbihhLm1hbnVmYWN0dXJlciB8fCBhLm1hbnVmYWN0dXJlck5hbWUgfHwgIiIpOwoKICAgIGlmICghb2sgfHwgIWZvdW5kKXsKICAgICAgcmV0dXJuIHsgbGluZTE6ICJBaXJjcmFmdDogdW5hdmFpbGFibGUiLCBsaW5lMjogb2sgJiYgIWZvdW5kID8gIk5vIGFpcmNyYWZ0IHJlY29yZCIgOiAiTG9va3VwIGZhaWxlZCIgfTsKICAgIH0KCiAgICAvLyBMaW5lIDE6IG1vZGVsICsgKG1vZGVsQ29kZSkgd2hlbiBib3RoIGV4aXN0IGFuZCBkaWZmZXIKICAgIGxldCBsaW5lMSA9IG1vZGVsIHx8IG1vZGVsQ29kZSB8fCAiQWlyY3JhZnQ6IHVua25vd24iOwogICAgaWYgKG1vZGVsICYmIG1vZGVsQ29kZSAmJiBtb2RlbENvZGUudG9VcHBlckNhc2UoKSAhPSBtb2RlbC50b1VwcGVyQ2FzZSgpKXsKICAgICAgbGluZTEgPSBgJHttb2RlbH0gKCR7bW9kZWxDb2RlfSlgOwogICAgfQoKICAgIC8vIExpbmUgMjogUkVHIGZpcnN0LCB0aGVuIG1hbnVmYWN0dXJlciAob3B0aW9uYWwpCiAgICBsZXQgbGluZTIgPSAiIjsKICAgIGlmIChyZWcpIGxpbmUyID0gYCR7cmVnfWA7CiAgICBpZiAobWFudSkgbGluZTIgPSBsaW5lMiA/IGAke2xpbmUyfSDigKIgJHttYW51fWAgOiBtYW51OwoKICAgIHJldHVybiB7IGxpbmUxLCBsaW5lMiB9OwogIH0KICBhc3luYyBmdW5jdGlvbiBmZXRjaEFpcmNyYWZ0QnlJY2FvMjQoaWNhbzI0KXsKICAgIGNvbnN0IGhleCA9IG5vcm1hbGl6ZUhleChpY2FvMjQpOwogICAgaWYgKCFoZXgpIHJldHVybiBudWxsOwoKICAgIGNvbnN0IGNhY2hlZCA9IGdldENhY2hlZChoZXgpOwogICAgaWYgKGNhY2hlZCAmJiB0eXBlb2YgY2FjaGVkID09PSAib2JqZWN0IikgcmV0dXJuIGNhY2hlZDsKICAgIGlmIChub3coKSA8IGJhY2tvZmZVbnRpbCkgcmV0dXJuIG51bGw7CgogICAgY29uc3QgYmFzZSA9IFN0cmluZyhBRVJPX1BST1hZX09SSUdJTnx8IiIpLnJlcGxhY2UoL1wvJC8sIiIpOwogICAgY29uc3QgdXJsID0gYCR7YmFzZX0vYWlyY3JhZnQvaWNhbzI0LyR7ZW5jb2RlVVJJQ29tcG9uZW50KGhleCl9YDsKCiAgICB0cnl7CiAgICAgIGNvbnN0IHJlcyA9IGF3YWl0IGZldGNoKHVybCwge21ldGhvZDoiR0VUIiwgY2FjaGU6Im5vLXN0b3JlIn0pOwogICAgICBpZiAocmVzLnN0YXR1cyA9PT0gNDI5KXsKICAgICAgICBiYWNrb2ZmVW50aWwgPSBub3coKSArIDIqNjAqMTAwMDsKICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgfQogICAgICBpZiAoIXJlcy5vaykgcmV0dXJuIG51bGw7CiAgICAgIGNvbnN0IGogPSBhd2FpdCByZXMuanNvbigpOwoKICAgICAgY29uc3QgZm10ID0gZm9ybWF0QWlyY3JhZnQoaik7CiAgICAgIGlmICghZm10KSByZXR1cm4gbnVsbDsKICAgICAgcHV0Q2FjaGVkKGhleCwgZm10KTsKICAgICAgcmV0dXJuIGZtdDsKICAgIH1jYXRjaChlKXsKICAgICAgcmV0dXJuIG51bGw7CiAgICB9CiAgfQoKICBhc3luYyBmdW5jdGlvbiB1cGRhdGVBaXJjcmFmdEZvckN1cnJlbnQoKXsKICAgIHRyeXsKICAgICAgY29uc3QgZiA9IHdpbmRvdy5fX0ZXX0NVUlJFTlRfRkxJR0hUIHx8IHt9OwogICAgICBjb25zdCBoZXggPSBmLmljYW8yNCB8fCBmLmljYW8gfHwgIiI7CiAgICAgIGlmICghaGV4KXsgc2V0TW9kZWxMaW5lc1YxMTQoIuKAlCIsICIiKTsgcmV0dXJuOyB9CgogICAgICBjb25zdCBrZXkgPSBub3JtYWxpemVIZXgoaGV4KTsKICAgICAgaWYgKGtleSAhPT0gbGFzdEtleSl7CiAgICAgICAgbGFzdEtleSA9IGtleTsKICAgICAgICAvLyBTaG93IHdoYXRldmVyIHdlIGFscmVhZHkgaGF2ZSBmcm9tIHJhZGFyIGltbWVkaWF0ZWx5IChpZiBhbnkpCiAgICAgICAgY29uc3QgcmFkYXJUeXBlID0gY2xlYW4oZi50eXBlIHx8IGYuYWlyY3JhZnRUeXBlIHx8IGYubW9kZWwgfHwgIiIpOwogICAgICAgIHNldE1vZGVsTGluZXNWMTE0KHJhZGFyVHlwZSB8fCAi4oCUIiwgIiIpOwogICAgICB9CgogICAgICBjb25zdCBmbXQgPSBhd2FpdCBmZXRjaEFpcmNyYWZ0QnlJY2FvMjQoa2V5KTsKICAgICAgaWYgKGZtdCkgewogICAgICAgIGNvbnN0IGN1cktleSA9IG5vcm1hbGl6ZUhleCgod2luZG93Ll9fRldfQ1VSUkVOVF9GTElHSFR8fHt9KS5pY2FvMjQpOwogICAgICAgIGNvbnN0IGxhc3RLZXkgPSAod2luZG93Ll9fRldfTEFTVF9BSVJDUkFGVF9LRVlfX3x8IiIpOwogICAgICAgIGlmIChjdXJLZXkgPT09IGtleSB8fCBsYXN0S2V5ID09PSBrZXkpIHsKICAgICAgICB0cnl7CiAgICAgICAgICBjb25zdCBjdXIgPSAod2luZG93Ll9fRldfQ1VSUkVOVF9GTElHSFR8fHt9KTsKICAgICAgICAgIGN1ci5leGFjdE1vZGVsMSA9IGZtdC5saW5lMTsKICAgICAgICAgIGN1ci5leGFjdE1vZGVsMiA9IGZtdC5saW5lMjsKICAgICAgICB9Y2F0Y2goZSl7fQogICAgICAgIHNldE1vZGVsTGluZXNWMTE0KGZtdC5saW5lMSwgZm10LmxpbmUyKTsKICAgICAgICB9CiAgICAgIH0KICAgIH1jYXRjaChlKXsKICAgICAgLy8gbm8tb3AKICAgIH0KICB9CgogIC8vIEV4cG9zZSBmb3IgdGhlIGV4aXN0aW5nIHJlbmRlci91cGRhdGUgbG9vcAogIHdpbmRvdy5fX0ZXX1VQREFURV9BSVJDUkFGVF9SQVdfXyA9IHVwZGF0ZUFpcmNyYWZ0Rm9yQ3VycmVudDsKICB3aW5kb3cuX19GV19VUERBVEVfQUlSQ1JBRlRfXyA9ICgpPT57IHRyeXsgaWYodHJ1ZSkgcmV0dXJuIHdpbmRvdy5fX0ZXX1VQREFURV9BSVJDUkFGVF9SQVdfXygpOyB9Y2F0Y2goZSl7fSB9OyAvLyB2MTI1X3dyYXBfYWlyY3JhZnQKICAvLyB2MTIwOiB0cmFjayBsYXN0IGFpcmNyYWZ0IGtleSB0byBhdm9pZCB0aW1pbmcgcmFjZXMKICB3aW5kb3cuX19GV19MQVNUX0FJUkNSQUZUX0tFWV9fID0gIiI7Cn0pKCk7CgoKLyogUk9VVEU6IHdpcmluZyB2MTEwIChzYWZlLCBpbmNsdWRlcyBkaXJlY3Rpb24gZml4KSAqLwppZiAoIXdpbmRvdy5fX0ZXX1JPVVRFX1dJUkVEX18pIHsKICB3aW5kb3cuX19GV19ST1VURV9XSVJFRF9fID0gdHJ1ZTsgLy8gcm91dGVEaXJlY3Rpb25GaXhWMTEwCgogIChmdW5jdGlvbigpewogICAgY29uc3QgX0FFUk9fT1JJR0lOID0gImh0dHBzOi8vZmxpZ2h0c2Fib3ZlLnQyaGttaGdid3oud29ya2Vycy5kZXYiOwogICAgY29uc3QgX1RUTCA9IDYwICogNjAgKiAxMDAwOwogICAgY29uc3QgX2NhY2hlID0gbmV3IE1hcCgpOwogICAgY29uc3QgX2xhc3RHb29kUm91dGVWMTIyID0gbmV3IE1hcCgpOyAvLyBjYWxsc2lnbiAtPiBsYXN0IGdvb2Qgcm91dGUgKHByZXZlbnRzIGRvd25ncmFkZSBmbGlja2VyKQogICAgbGV0IF9sYXN0ID0gIiI7CiAgICBsZXQgX2JhY2tvZmZVbnRpbCA9IDA7CgogICAgCiAgICAKICAgIGNvbnN0IFJPVVRFX1BfVFRMX01TID0gNiAqIDYwICogNjAgKiAxMDAwOyAvLyBwZXJzaXN0ZW50IDZoCiAgICBjb25zdCBST1VURV9QX05FR19UVExfTVMgPSAzMCAqIDYwICogMTAwMDsgLy8gcGVyc2lzdGVudCAzMG0gZm9yIHVuYXZhaWxhYmxlCiAgICBjb25zdCBfcm91dGVGZXRjaEdhdGUgPSBuZXcgTWFwKCk7IC8vIGNhbGxzaWduIC0+IGxhc3RGZXRjaFRzCiAgICBjb25zdCBST1VURV9SRUZSRVNIX01JTl9NUyA9IDIwICogMTAwMDsgLy8gdjExOTogZmFzdGVyIHJldHJ5IHdpbmRvdwogICAgY29uc3QgUk9VVEVfUkVUUllfU09PTl9NUyA9IDUgKiAxMDAwOyAvLyB2MTE5OiBxdWljayByZXRyeSB3aGVuIG5vIHJvdXRlCmNvbnN0IHByZXZQb3NNYXBWMTExID0gbmV3IE1hcCgpOyAvLyBpY2FvMjQgLT4ge2xhdCwgbG9uLCB0c30KZnVuY3Rpb24gX25vdygpeyByZXR1cm4gRGF0ZS5ub3coKTsgfQogICAgZnVuY3Rpb24gX2ZpeEFycm93KHMpewogICAgICByZXR1cm4gU3RyaW5nKHN8fCIiKS5yZXBsYWNlKC/DouKAoOKAmS9nLCLihpIiKS5yZXBsYWNlKC/DosKGwpIvZywi4oaSIikudHJpbSgpOwogICAgfQogICAgZnVuY3Rpb24gX2NsZWFuQ2l0eShzKXsKICAgICAgcmV0dXJuIFN0cmluZyhzfHwiIikucmVwbGFjZSgvXHMrL2csIiAiKS5yZXBsYWNlKC9cLyskL2csIiIpLnRyaW0oKTsKICAgIH0KCiAgICAvLyByb3V0ZURpcmVjdGlvbkZpeFYxMTA6IHVzZSBhaXJjcmFmdCB0cnVlIHRyYWNrIHZzIGJlYXJpbmcgdG8gYWlycG9ydHMgdG8gZGVjaWRlIGRpcmVjdGlvbgogICAgZnVuY3Rpb24gX3RvUmFkKGQpeyByZXR1cm4gZCAqIE1hdGguUEkgLyAxODA7IH0KICAgIGZ1bmN0aW9uIF90b0RlZyhyKXsgcmV0dXJuIHIgKiAxODAgLyBNYXRoLlBJOyB9CiAgICBmdW5jdGlvbiBfYmVhcmluZ0RlZyhsYXQxLCBsb24xLCBsYXQyLCBsb24yKXsKICAgICAgY29uc3Qgz4YxPV90b1JhZChsYXQxKSwgz4YyPV90b1JhZChsYXQyKTsKICAgICAgY29uc3QgzpTOuz1fdG9SYWQobG9uMi1sb24xKTsKICAgICAgY29uc3QgeT1NYXRoLnNpbijOlM67KSpNYXRoLmNvcyjPhjIpOwogICAgICBjb25zdCB4PU1hdGguY29zKM+GMSkqTWF0aC5zaW4oz4YyKSAtIE1hdGguc2luKM+GMSkqTWF0aC5jb3Moz4YyKSpNYXRoLmNvcyjOlM67KTsKICAgICAgbGV0IM64PV90b0RlZyhNYXRoLmF0YW4yKHkseCkpOwogICAgICBpZiAozrg8MCkgzrgrPTM2MDsKICAgICAgcmV0dXJuIM64OwogICAgfQogICAgZnVuY3Rpb24gX2FuZ0RpZmYoYSxiKXsKICAgICAgY29uc3QgZD1NYXRoLmFicyhhLWIpJTM2MDsKICAgICAgcmV0dXJuIGQ+MTgwID8gMzYwLWQgOiBkOwogICAgfQogICAgZnVuY3Rpb24gX2dldEZsaWdodFRyYWNrKCl7CiAgICAgIHRyeXsKICAgICAgICBjb25zdCBmID0gd2luZG93Ll9fRldfQ1VSUkVOVF9GTElHSFQgfHwge307CiAgICAgICAgLy8gUHJlZmVyIGRpcmVjdCB0cmFjay9oZWFkaW5nIGZyb20gcmFkYXIKICAgICAgICBjb25zdCByYXcgPSBOdW1iZXIoZi50cmFjayA/PyBmLmhlYWRpbmcgPz8gZi50cnVlX3RyYWNrID8/IGYudHJrKTsKICAgICAgICBjb25zdCBoYXMgPSBOdW1iZXIuaXNGaW5pdGUocmF3KTsKICAgICAgICBpZiAoaGFzKSByZXR1cm4gKChyYXclMzYwKSszNjApJTM2MDsKCiAgICAgICAgLy8gRmFsbGJhY2s6IGNvbXB1dGUgYmVhcmluZyBmcm9tIHByZXZpb3VzIHBvc2l0aW9uIChyZXF1aXJlcyBzdGFibGUgaWNhbzI0ICsgbGF0L2xvbikKICAgICAgICBjb25zdCBpY2FvID0gU3RyaW5nKGYuaWNhbzI0IHx8IGYuaWNhbyB8fCAiIikudHJpbSgpOwogICAgICAgIGNvbnN0IGxhdCA9IE51bWJlcihmLmxhdCksIGxvbiA9IE51bWJlcihmLmxvbik7CiAgICAgICAgY29uc3QgdHMgPSBEYXRlLm5vdygpOwogICAgICAgIGlmICghaWNhbyB8fCAhTnVtYmVyLmlzRmluaXRlKGxhdCkgfHwgIU51bWJlci5pc0Zpbml0ZShsb24pKSByZXR1cm4gbnVsbDsKICAgICAgICBjb25zdCBwcmV2ID0gcHJldlBvc01hcFYxMTEuZ2V0KGljYW8pOwogICAgICAgIHByZXZQb3NNYXBWMTExLnNldChpY2FvLCB7bGF0LCBsb24sIHRzfSk7CiAgICAgICAgaWYgKCFwcmV2KSByZXR1cm4gbnVsbDsKICAgICAgICAvLyBJZ25vcmUgaWYgdG9vIG9sZCBvciB0b28gY2xvc2UKICAgICAgICBpZiAodHMgLSBwcmV2LnRzID4gMio2MCoxMDAwKSByZXR1cm4gbnVsbDsKICAgICAgICBjb25zdCBkbGF0ID0gTWF0aC5hYnMobGF0IC0gcHJldi5sYXQpOwogICAgICAgIGNvbnN0IGRsb24gPSBNYXRoLmFicyhsb24gLSBwcmV2Lmxvbik7CiAgICAgICAgaWYgKGRsYXQgPCAwLjAwMDUgJiYgZGxvbiA8IDAuMDAwNSkgcmV0dXJuIG51bGw7CiAgICAgICAgcmV0dXJuIF9iZWFyaW5nRGVnKHByZXYubGF0LCBwcmV2LmxvbiwgbGF0LCBsb24pOwogICAgICB9Y2F0Y2goZSl7IHJldHVybiBudWxsOyB9CiAgICB9CiAgICBmdW5jdGlvbiBfc2V0KHQpewogICAgICBjb25zdCBlbCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJyb3V0ZSIpOwogICAgICBpZiAoIWVsKSByZXR1cm47CiAgICAgIGNvbnN0IG5leHQgPSBTdHJpbmcodHx8IiIpLnRyaW0oKTsKICAgICAgY29uc3QgY3VyID0gU3RyaW5nKGVsLnRleHRDb250ZW50fHwiIikudHJpbSgpOwogICAgICAvLyB2MTIzOiBuZXZlciBkb3duZ3JhZGUgYSBnb29kIHJvdXRlIGJhY2sgdG8gRU4gUk9VVEUvdW5hdmFpbGFibGUKICAgICAgY29uc3QgY3VySXNHb29kID0gY3VyLmluY2x1ZGVzKCLihpIiKTsKICAgICAgY29uc3QgbmV4dFVwcGVyID0gbmV4dC50b1VwcGVyQ2FzZSgpOwogICAgICBjb25zdCBuZXh0SXNGYWxsYmFjayA9ICghbmV4dCB8fCBuZXh0VXBwZXI9PT0iRU4gUk9VVEUiIHx8IG5leHRVcHBlcj09PSJVTkFWQUlMQUJMRSIgfHwgbmV4dC50b0xvd2VyQ2FzZSgpPT09InVuYXZhaWxhYmxlIik7CiAgICAgIGlmIChjdXJJc0dvb2QgJiYgbmV4dElzRmFsbGJhY2spIHJldHVybjsKICAgICAgZWwudGV4dENvbnRlbnQgPSBuZXh0OwogICAgfQogICAgZnVuY3Rpb24gX2dldENhY2hlZChjcyl7CiAgICAgIGNvbnN0IGl0ID0gX2NhY2hlLmdldChjcyk7CiAgICAgIGlmICghaXQpIHJldHVybiBudWxsOwogICAgICBpZiAoX25vdygpIC0gaXQudHMgPiBfVFRMKSB7IF9jYWNoZS5kZWxldGUoY3MpOyByZXR1cm4gbnVsbDsgfQogICAgICByZXR1cm4gaXQudGV4dDsKICAgIH0KICAgIGZ1bmN0aW9uIF9zZXRDYWNoZWQoY3MsIHR4dCl7CiAgICAgIF9jYWNoZS5zZXQoY3MsIHt0czpfbm93KCksIHRleHQ6dHh0fSk7CiAgICB9CgogICAgYXN5bmMgZnVuY3Rpb24gX2ZldGNoKGNzKXsKICAgICAgY29uc3Qga2V5ID0gU3RyaW5nKGNzfHwiIikudHJpbSgpLnRvVXBwZXJDYXNlKCk7CiAgICAgIGlmICgha2V5KSByZXR1cm4gbnVsbDsKCiAgICAgIGNvbnN0IGMgPSBfZ2V0Q2FjaGVkKGtleSk7CiAgICAgIGlmIChjKSByZXR1cm4gYzsKICAgICAgaWYgKF9ub3coKSA8IF9iYWNrb2ZmVW50aWwpIHJldHVybiBudWxsOwoKICAgICAgY29uc3QgYmFzZSA9IFN0cmluZyhfQUVST19PUklHSU4pLnJlcGxhY2UoL1wvJC8sIiIpOwogICAgICBjb25zdCB1cmwgPSBgJHtiYXNlfS9hZXJvLyR7ZW5jb2RlVVJJQ29tcG9uZW50KGtleSl9YDsKCiAgICAgIGNvbnN0IHJlcyA9IGF3YWl0IGZldGNoKHVybCwge21ldGhvZDoiR0VUIiwgY2FjaGU6Im5vLXN0b3JlIn0pOwogICAgICBpZiAocmVzLnN0YXR1cyA9PT0gNDI5KSB7IF9iYWNrb2ZmVW50aWwgPSBfbm93KCkgKyAyKjYwKjEwMDA7IHJldHVybiBudWxsOyB9CiAgICAgIGlmICghcmVzLm9rKSByZXR1cm4gbnVsbDsKCiAgICAgIGNvbnN0IGogPSBhd2FpdCByZXMuanNvbigpOwogICAgICBsZXQgdHh0ID0gIiI7CiAgICAgIC8vIFByZWZlciB3b3JrZXItcHJvdmlkZWQgcm91dGUgc3RyaW5nIChrZWVwcyBjb3JyZWN0IGRpcmVjdGlvbiksIHRoZW4gZmFsbCBiYWNrIHRvIG9iamVjdHMKICAgICAgaWYgKGogJiYgdHlwZW9mIGoucm91dGU9PT0ic3RyaW5nIiAmJiBqLnJvdXRlLnRyaW0oKSkgdHh0ID0gai5yb3V0ZTsKCiAgICAgIGlmICghdHh0ICYmIGogJiYgai5vcmlnaW4gJiYgai5kZXN0aW5hdGlvbil7CiAgICAgICAgY29uc3Qgbz1qLm9yaWdpbiwgZD1qLmRlc3RpbmF0aW9uOwogICAgICAgIGNvbnN0IG9jPV9jbGVhbkNpdHkoby5tdW5pY2lwYWxpdHlOYW1lfHxvLmNpdHl8fG8ubmFtZXx8IiIpOwogICAgICAgIGNvbnN0IGRjPV9jbGVhbkNpdHkoZC5tdW5pY2lwYWxpdHlOYW1lfHxkLmNpdHl8fGQubmFtZXx8IiIpOwogICAgICAgIGNvbnN0IG9pPShvLmlhdGF8fG8uaWNhb3x8IiIpOwogICAgICAgIGNvbnN0IGRpPShkLmlhdGF8fGQuaWNhb3x8IiIpOwogICAgICAgIGNvbnN0IGxlZnQ9KG9jJiZvaSk/YCR7b2N9ICgke29pfSlgOihvY3x8b2kpOwogICAgICAgIGNvbnN0IHJpZ2h0PShkYyYmZGkpP2Ake2RjfSAoJHtkaX0pYDooZGN8fGRpKTsKICAgICAgICBpZiAobGVmdCAmJiByaWdodCkgdHh0ID0gYCR7bGVmdH0g4oaSICR7cmlnaHR9YDsKCiAgICAgIC8vIHJvdXRlRGlyZWN0aW9uRml4VjExMDogaWYgdHJhY2sgKyBjb29yZHMgZXhpc3QsIGRlY2lkZSB3aGljaCBzaWRlIGlzIGRlc3RpbmF0aW9uCiAgICAgIHRyeXsKICAgICAgICBjb25zdCB0cmsgPSBfZ2V0RmxpZ2h0VHJhY2soKTsKICAgICAgICBjb25zdCBmID0gd2luZG93Ll9fRldfQ1VSUkVOVF9GTElHSFQgfHwge307CiAgICAgICAgY29uc3QgZmxhdCA9IE51bWJlcihmLmxhdCksIGZsb24gPSBOdW1iZXIoZi5sb24pOwogICAgICAgIGNvbnN0IG9sYXQgPSBOdW1iZXIobyAmJiBvLmxvY2F0aW9uICYmIG8ubG9jYXRpb24ubGF0KSwgb2xvbiA9IE51bWJlcihvICYmIG8ubG9jYXRpb24gJiYgby5sb2NhdGlvbi5sb24pOwogICAgICAgIGNvbnN0IGRsYXQgPSBOdW1iZXIoZCAmJiBkLmxvY2F0aW9uICYmIGQubG9jYXRpb24ubGF0KSwgZGxvbiA9IE51bWJlcihkICYmIGQubG9jYXRpb24gJiYgZC5sb2NhdGlvbi5sb24pOwogICAgICAgIGlmICh0cmshPW51bGwgJiYgTnVtYmVyLmlzRmluaXRlKGZsYXQpICYmIE51bWJlci5pc0Zpbml0ZShmbG9uKSAmJgogICAgICAgICAgICBOdW1iZXIuaXNGaW5pdGUob2xhdCkgJiYgTnVtYmVyLmlzRmluaXRlKG9sb24pICYmCiAgICAgICAgICAgIE51bWJlci5pc0Zpbml0ZShkbGF0KSAmJiBOdW1iZXIuaXNGaW5pdGUoZGxvbikpewogICAgICAgICAgY29uc3QgYlRvTyA9IF9iZWFyaW5nRGVnKGZsYXQsIGZsb24sIG9sYXQsIG9sb24pOwogICAgICAgICAgY29uc3QgYlRvRCA9IF9iZWFyaW5nRGVnKGZsYXQsIGZsb24sIGRsYXQsIGRsb24pOwogICAgICAgICAgY29uc3QgZGlmZk8gPSBfYW5nRGlmZih0cmssIGJUb08pOwogICAgICAgICAgY29uc3QgZGlmZkQgPSBfYW5nRGlmZih0cmssIGJUb0QpOwogICAgICAgICAgLy8gQWlyY3JhZnQgaXMgKHVzdWFsbHkpIGZseWluZyB0b3dhcmQgdGhlIHNtYWxsZXIgYW5ndWxhciBkaWZmZXJlbmNlLgogICAgICAgICAgY29uc3QgX2FsbG93RmxpcCA9ICh0eXBlb2Ygd2luZG93ICE9PSAndW5kZWZpbmVkJyAmJiB3aW5kb3cuX19GV19ST1VURV9BTExPV19GTElQX18pOwogICAgICAgICAgaWYgKF9hbGxvd0ZsaXAgJiYgKGRpZmZPICsgMTUgPCBkaWZmRCkpewogICAgICAgICAgICAvLyBzd2FwOiBkZXN0aW5hdGlvbiBpcyBhY3R1YWxseSBvcmlnaW4gcGVyIEFQSSAoZmxpcCBkaXNwbGF5KQogICAgICAgICAgICB0eHQgPSBgJHtyaWdodH0g4oaSICR7bGVmdH1gOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdHh0ID0gYCR7bGVmdH0g4oaSICR7cmlnaHR9YDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH1jYXRjaChlKXt9CgogICAgICB9CgogICAgICB0eHQgPSBfZml4QXJyb3codHh0KTsKICAgICAgaWYgKCF0eHQgfHwgdHh0PT09InVuYXZhaWxhYmxlIikgcmV0dXJuIG51bGw7CgogICAgICBfc2V0Q2FjaGVkKGtleSwgdHh0KTsKICAgICAgcmV0dXJuIHR4dDsKICAgIH0KCiAgICBhc3luYyBmdW5jdGlvbiB1cGRhdGUoKXsKICAgICAgdHJ5ewogICAgICAgIGNvbnN0IGYgPSB3aW5kb3cuX19GV19DVVJSRU5UX0ZMSUdIVDsKICAgICAgICBjb25zdCBjcyA9IG5vcm1DYWxsc2lnbigoZiAmJiBmLmNhbGxzaWduKSA/IGYuY2FsbHNpZ24gOiAiIik7CiAgICAgICAgLy8gdjExNTogbG9hZCBjYWNoZWQgcm91dGUgaW1tZWRpYXRlbHkgKGlmIGFueSkKICAgICAgICB0cnl7CiAgICAgICAgICBjb25zdCBscyA9IHdpbmRvdy5fX0ZXX0xTX187CiAgICAgICAgICBjb25zdCBjYWNoZWQgPSAobHMgJiYgbHMuZ2V0KSA/IGxzLmdldChgcm91dGUuJHtjc31gKSA6IG51bGw7CiAgICAgICAgICBpZiAoY2FjaGVkICYmIGNhY2hlZC5yb3V0ZSkgX3NldChfX2Z3Rml4QXJyb3coY2FjaGVkLnJvdXRlKSk7CiAgICAgICAgICAgICAgICBlbHNlIF9zZXQoIkVOIFJPVVRFIik7Cn1jYXRjaChlKXt9CiAgICAgICAgLy8gdjExNjogaWYgcm91dGUgbGluZSBpcyBlbXB0eSwgc2hvdyBFTiBST1VURSBhZnRlciBhIHNob3J0IGdyYWNlIHBlcmlvZAogICAgICAgIGNvbnN0IF9yb3V0ZUVsID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoInJvdXRlIik7CiAgICAgICAgaWYgKF9yb3V0ZUVsICYmICFfcm91dGVFbC50ZXh0Q29udGVudC50cmltKCkpewogICAgICAgICAgY29uc3QgdGhpc0NzID0gY3M7CiAgICAgICAgICBzZXRUaW1lb3V0KCgpPT57CiAgICAgICAgICAgIHRyeXsKICAgICAgICAgICAgICBpZiAoX2xhc3QgPT09IHRoaXNDcyAmJiBfcm91dGVFbCAmJiAhX3JvdXRlRWwudGV4dENvbnRlbnQudHJpbSgpKSBfc2V0KCJFTiBST1VURSIpOwogICAgICAgICAgICB9Y2F0Y2goZSl7fQogICAgICAgICAgfSwgMTgwMCk7CiAgICAgICAgfQoKICAgICAgICAvLyB2MTE2OiB0aHJvdHRsZSByZWZyZXNoIGZldGNoZXMgcGVyIGNhbGxzaWduCiAgICAgICAgY29uc3QgX2xhc3RGZXRjaCA9IF9yb3V0ZUZldGNoR2F0ZS5nZXQoY3MpIHx8IDA7CiAgICAgICAgY29uc3QgX2NhbkZldGNoID0gKERhdGUubm93KCkgLSBfbGFzdEZldGNoKSA+IFJPVVRFX1JFRlJFU0hfTUlOX01TOwogICAgICAgIC8vIHYxMTk6IGdhdGUgdGltZXN0YW1wIHNldCBhZnRlciBmZXRjaCBhdHRlbXB0CiAgICAgICAgLy8gdjExMjogZGVsYXkgYW55IGZsaXAgZGVjaXNpb24gdW50aWwgd2UndmUgc2VlbiB0aGlzIGNhbGxzaWduIGF0IGxlYXN0IHR3aWNlCiAgICAgICAgd2luZG93Ll9fRldfUk9VVEVfU0VFTl9fID0gd2luZG93Ll9fRldfUk9VVEVfU0VFTl9fIHx8IG5ldyBNYXAoKTsKICAgICAgICBjb25zdCBfc2VlbiA9IHdpbmRvdy5fX0ZXX1JPVVRFX1NFRU5fXzsKICAgICAgICBjb25zdCBfbiA9IChfc2Vlbi5nZXQoY3MpIHx8IDApICsgMTsKICAgICAgICBfc2Vlbi5zZXQoY3MsIF9uKTsKICAgICAgICB3aW5kb3cuX19GV19ST1VURV9BTExPV19GTElQX18gPSAoX24gPj0gMik7CiAgICAgICAgaWYgKCFjcyl7IF9zZXQoIkVOIFJPVVRFIik7IHJldHVybjsgfQogICAgICAgIGlmIChjcyAhPT0gX2xhc3QpewogICAgICAgICAgX2xhc3QgPSBjczsKICAgICAgICAgIHRyeXsKICAgICAgICAgICAgY29uc3QgbHMgPSB3aW5kb3cuX19GV19MU19fOwogICAgICAgICAgICBjb25zdCBjYWNoZWQgPSAobHMgJiYgbHMuZ2V0KSA/IGxzLmdldChgcm91dGUuJHtjc31gKSA6IG51bGw7CiAgICAgICAgICAgIGNvbnN0IGNhY2hlZFJvdXRlID0gY2FjaGVkICYmIGNhY2hlZC5yb3V0ZSA/IF9fZndGaXhBcnJvdyhjYWNoZWQucm91dGUpIDogbnVsbDsKICAgICAgICAgICAgY29uc3QgbGFzdEdvb2QgPSBfbGFzdEdvb2RSb3V0ZVYxMjIuZ2V0KGNzKSB8fCBudWxsOwogICAgICAgICAgICBpZiAoY2FjaGVkUm91dGUgJiYgY2FjaGVkUm91dGUuaW5jbHVkZXMoIuKGkiIpKSB7CiAgICAgICAgICAgICAgX3NldChjYWNoZWRSb3V0ZSk7CiAgICAgICAgICAgICAgX2xhc3RHb29kUm91dGVWMTIyLnNldChjcywgY2FjaGVkUm91dGUpOwogICAgICAgICAgICB9IGVsc2UgaWYgKGxhc3RHb29kICYmIGxhc3RHb29kLmluY2x1ZGVzKCLihpIiKSkgewogICAgICAgICAgICAgIF9zZXQobGFzdEdvb2QpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIF9zZXQoIkVOIFJPVVRFIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH1jYXRjaChlKXsgX3NldCgiRU4gUk9VVEUiKTsgfQogICAgICAgIH0KICAgICAgICBsZXQgdHh0ID0gbnVsbDsKICAgICAgICBpZiAoX2NhbkZldGNoKSB7CiAgICAgICAgICBfcm91dGVGZXRjaEdhdGUuc2V0KGNzLCBEYXRlLm5vdygpKTsKICAgICAgICAgIHR4dCA9IGF3YWl0IF9mZXRjaChjcyk7CiAgICAgICAgICBpZiAoIXR4dCkgewogICAgICAgICAgICAvLyBhbGxvdyBhIHF1aWNrZXIgcmV0cnkgaWYgdXBzdHJlYW0gd2FzIHNsb3cvZW1wdHkKICAgICAgICAgICAgX3JvdXRlRmV0Y2hHYXRlLnNldChjcywgRGF0ZS5ub3coKSAtIChST1VURV9SRUZSRVNIX01JTl9NUyAtIFJPVVRFX1JFVFJZX1NPT05fTVMpKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKHR4dCAmJiBfbGFzdCA9PT0gY3MpIHsKICAgICAgICAgIF9zZXQoX19md0ZpeEFycm93KHR4dCkpOwogICAgICAgICAgLy8gdjExNTogcGVyc2lzdCByb3V0ZSBiZXN0LWVmZm9ydAogICAgICAgICAgdHJ5ewogICAgICAgICAgICBjb25zdCBsczIgPSB3aW5kb3cuX19GV19MU19fOwogICAgICAgICAgICBpZiAobHMyICYmIGxzMi5zZXQpewogICAgICAgICAgICAgIGNvbnN0IG5lZyA9ICghdHh0IHx8IHR4dD09PSJ1bmF2YWlsYWJsZSIgfHwgdHh0PT09ImVuIHJvdXRlIik7CiAgICAgICAgICAgICAgbHMyLnNldChgcm91dGUuJHtjc31gLCB7cm91dGU6IHR4dCwgdHM6IERhdGUubm93KCl9LCBuZWcgPyBST1VURV9QX05FR19UVExfTVMgOiBST1VURV9QX1RUTF9NUyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH1jYXRjaChlKXt9CiAgICAgICAgfSBlbHNlIGlmIChfbGFzdCA9PT0gY3MpIHsKICAgICAgICAgIF9zZXQoIkVOIFJPVVRFIik7CiAgICAgICAgfQogICAgICB9IGNhdGNoKGUpIHsKICAgICAgICBfc2V0KCJFTiBST1VURSIpOwogICAgICB9CiAgICB9CgogICAgd2luZG93Ll9fRldfVVBEQVRFX1JPVVRFX18gPSB1cGRhdGU7CiAgfSkoKTsKfQoKCi8vIHYxMDQ6IHZpc2libGUgYnVpbGQgc3RhbXAgKGhlbHBzIGNvbmZpcm0gY2FjaGUgaXMgdXBkYXRlZCkKY29uc3QgRldfQlVJTERfU1RBTVAgPSAiMjAyNi0wMi0wMiAyMToyNiBVVEMiOwoKCgpmdW5jdGlvbiBzZXRWZXJzaW9uU3RhbXAoKXsKICB0cnl7CiAgICBjb25zdCB2RWwgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgiZnctdmVyc2lvbiIpOwogICAgaWYgKHZFbCkgdkVsLnRleHRDb250ZW50ID0gInYxNTAiOwogICAgY29uc3QgYkVsID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoImZ3LWJ1aWxkIik7CiAgICBpZiAoYkVsKSBiRWwudGV4dENvbnRlbnQgPSBGV19CVUlMRF9TVEFNUDsKICB9Y2F0Y2goZSl7fQp9CnNldFZlcnNpb25TdGFtcCgpOwoKZnVuY3Rpb24gc2V0U3RhdHVzTGluZSh0ZXh0KXsKICBjb25zdCBlbCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJzdGF0dXMiKTsKICBpZiAoIWVsKSByZXR1cm47CiAgZWwudGV4dENvbnRlbnQgPSB0ZXh0IHx8ICJSYWRhcjog4oCUIjsKfQoKCi8vIHY5MjogY2xvc2VzdC1mbGlnaHQgcm91dGUgbG9va3VwIChBZXJvRGF0YUJveCBXb3JrZXIpCmNvbnN0IEFFUk9fUFJPWFlfT1JJR0lOID0gImh0dHBzOi8vZmxpZ2h0c2Fib3ZlLnQyaGttaGdid3oud29ya2Vycy5kZXYiOwpjb25zdCBST1VURV9DQUNIRV9UVExfTVMgPSA2MCAqIDYwICogMTAwMDsgLy8gNjAgbWluCmNvbnN0IHJvdXRlQ2FjaGUgPSBuZXcgTWFwKCk7IC8vIGNhbGxzaWduIC0+IHt0cywgdGV4dH0KbGV0IGxhc3RSb3V0ZUtleSA9ICIiOwpsZXQgcm91dGVCYWNrb2ZmVW50aWwgPSAwOwoKZnVuY3Rpb24gX25vdygpeyByZXR1cm4gRGF0ZS5ub3coKTsgfQpmdW5jdGlvbiByb3V0ZUNhY2hlR2V0KGtleSl7CiAgY29uc3QgaXQgPSByb3V0ZUNhY2hlLmdldChrZXkpOwogIGlmICghaXQpIHJldHVybiBudWxsOwogIGlmIChfbm93KCkgLSBpdC50cyA+IFJPVVRFX0NBQ0hFX1RUTF9NUykgeyByb3V0ZUNhY2hlLmRlbGV0ZShrZXkpOyByZXR1cm4gbnVsbDsgfQogIHJldHVybiBpdC50ZXh0Owp9CmZ1bmN0aW9uIHJvdXRlQ2FjaGVTZXQoa2V5LCB0ZXh0KXsKICByb3V0ZUNhY2hlLnNldChrZXksIHt0czpfbm93KCksIHRleHR9KTsKfQpmdW5jdGlvbiBmaXhBcnJvdyhzKXsKICAvLyBGaXggY29tbW9uIG1vamliYWtlIGFycm93cyAtPiAi4oaSIgogIHJldHVybiBTdHJpbmcoc3x8IiIpCiAgICAucmVwbGFjZSgvw6LigKDigJkvZywgIuKGkiIpCiAgICAucmVwbGFjZSgvw6LChsKSL2csICLihpIiKQogICAgLnRyaW0oKTsKfQpmdW5jdGlvbiBjbGVhbkNpdHkocyl7CiAgLy8gU29tZSBtdW5pY2lwYWxpdHkvY2l0eSBzdHJpbmdzIGNhbiBlbmQgd2l0aCAiLyIgb3IgY29udGFpbiBvZGQgc3BhY2luZy4KICByZXR1cm4gU3RyaW5nKHN8fCIiKS5yZXBsYWNlKC9ccysvZywgIiAiKS5yZXBsYWNlKC9cLyskL2csICIiKS50cmltKCk7Cn0KZnVuY3Rpb24gc2V0Um91dGVMaW5lKHRleHQpewogIGNvbnN0IGVsID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoInJvdXRlIik7CiAgaWYgKCFlbCkgcmV0dXJuOwogIGNvbnN0IHQgPSBTdHJpbmcodGV4dHx8IiIpLnRyaW0oKTsKICAvLyBBbHdheXMgc2hvdyBzb21ldGhpbmcgc28geW91IGNhbiB0ZWxsIGl0J3MgYWxpdmUKICBlbC50ZXh0Q29udGVudCA9IHQgPyB0IDogIkVOIFJPVVRFIjsKfQoKYXN5bmMgZnVuY3Rpb24gZmV0Y2hSb3V0ZVRleHRGb3JDYWxsc2lnbihjYWxsc2lnbil7CiAgY29uc3QgY3MgPSBub3JtQ2FsbHNpZ24oY2FsbHNpZ24pOwogIGlmICghY3MpIHJldHVybiBudWxsOwoKICBjb25zdCBjYWNoZWQgPSByb3V0ZUNhY2hlR2V0KGNzKTsKICBpZiAoY2FjaGVkKSByZXR1cm4gY2FjaGVkOwoKICBpZiAoX25vdygpIDwgcm91dGVCYWNrb2ZmVW50aWwpIHJldHVybiBudWxsOwoKICBjb25zdCBiYXNlID0gU3RyaW5nKEFFUk9fUFJPWFlfT1JJR0lOfHwiIikucmVwbGFjZSgvXC8kLywgIiIpOwogIGlmICghYmFzZSkgcmV0dXJuIG51bGw7CgogIGNvbnN0IHVybCA9IGAke2Jhc2V9L2Flcm8vJHtlbmNvZGVVUklDb21wb25lbnQoY3MpfWA7CiAgdHJ5ewogICAgY29uc3QgcmVzID0gYXdhaXQgZmV0Y2godXJsLCB7bWV0aG9kOiJHRVQiLCBjYWNoZToibm8tc3RvcmUifSk7CiAgICBpZiAocmVzLnN0YXR1cyA9PT0gNDI5KXsKICAgICAgcm91dGVCYWNrb2ZmVW50aWwgPSBfbm93KCkgKyAyKjYwKjEwMDA7CiAgICAgIHJldHVybiBudWxsOwogICAgfQogICAgaWYgKCFyZXMub2spIHJldHVybiBudWxsOwoKICAgIGNvbnN0IGogPSBhd2FpdCByZXMuanNvbigpOwogICAgbGV0IHR4dCA9ICIiOwogICAgLy8gUHJlZmVyIGNvbnN0cnVjdGluZyBmcm9tIG9yaWdpbi9kZXN0aW5hdGlvbiAoYXZvaWRzIGVuY29kaW5nIGlzc3VlcyBpbiBqLnJvdXRlKQogICAgaWYgKGogJiYgai5vcmlnaW4gJiYgai5kZXN0aW5hdGlvbil7CiAgICAgIGNvbnN0IG8gPSBqLm9yaWdpbiwgZCA9IGouZGVzdGluYXRpb247CiAgICAgIGNvbnN0IG9jID0gY2xlYW5DaXR5KG8ubXVuaWNpcGFsaXR5TmFtZSB8fCBvLmNpdHkgfHwgby5uYW1lIHx8ICIiKTsKICAgICAgY29uc3QgZGMgPSBjbGVhbkNpdHkoZC5tdW5pY2lwYWxpdHlOYW1lIHx8IGQuY2l0eSB8fCBkLm5hbWUgfHwgIiIpOwogICAgICBjb25zdCBvaSA9IChvLmlhdGEgfHwgby5pY2FvIHx8ICIiKTsKICAgICAgY29uc3QgZGkgPSAoZC5pYXRhIHx8IGQuaWNhbyB8fCAiIik7CiAgICAgIGNvbnN0IGxlZnQgPSAob2MgJiYgb2kpID8gYCR7b2N9ICgke29pfSlgIDogKG9jIHx8IG9pKTsKICAgICAgY29uc3QgcmlnaHQgPSAoZGMgJiYgZGkpID8gYCR7ZGN9ICgke2RpfSlgIDogKGRjIHx8IGRpKTsKICAgICAgaWYgKGxlZnQgJiYgcmlnaHQpIHR4dCA9IGAke2xlZnR9IOKGkiAke3JpZ2h0fWA7CiAgICB9CiAgICAvLyBJZiBzdGlsbCBlbXB0eSwgZmFsbCBiYWNrIHRvIHRoZSBzdHJpbmcgcm91dGUgZmllbGQKICAgIGlmICghdHh0ICYmIGogJiYgdHlwZW9mIGoucm91dGUgPT09ICJzdHJpbmciICYmIGoucm91dGUudHJpbSgpKSB0eHQgPSBqLnJvdXRlOwoKICAgIGlmICghdHh0ICYmIGogJiYgai5vcmlnaW4gJiYgai5kZXN0aW5hdGlvbil7CiAgICAgIGNvbnN0IG8gPSBqLm9yaWdpbiwgZCA9IGouZGVzdGluYXRpb247CiAgICAgIGNvbnN0IG9jID0gY2xlYW5DaXR5KG8ubXVuaWNpcGFsaXR5TmFtZSB8fCBvLmNpdHkgfHwgby5uYW1lIHx8ICIiKTsKICAgICAgY29uc3QgZGMgPSBjbGVhbkNpdHkoZC5tdW5pY2lwYWxpdHlOYW1lIHx8IGQuY2l0eSB8fCBkLm5hbWUgfHwgIiIpOwogICAgICBjb25zdCBvaSA9IChvLmlhdGEgfHwgby5pY2FvIHx8ICIiKTsKICAgICAgY29uc3QgZGkgPSAoZC5pYXRhIHx8IGQuaWNhbyB8fCAiIik7CiAgICAgIGNvbnN0IGxlZnQgPSAob2MgJiYgb2kpID8gYCR7b2N9ICgke29pfSlgIDogKG9jIHx8IG9pKTsKICAgICAgY29uc3QgcmlnaHQgPSAoZGMgJiYgZGkpID8gYCR7ZGN9ICgke2RpfSlgIDogKGRjIHx8IGRpKTsKICAgICAgaWYgKGxlZnQgJiYgcmlnaHQpIHR4dCA9IGAke2xlZnR9IOKGkiAke3JpZ2h0fWA7CiAgICB9CgogICAgdHh0ID0gZml4QXJyb3codHh0KTsKICAgIHR4dCA9IHR4dC5yZXBsYWNlKC9cL1wrXHMqXCgvZywgIiAoIikucmVwbGFjZSgvXC9cK1xzKuKGki9nLCAiIOKGkiIpLnJlcGxhY2UoL+KGklxzKlwvXCtccyovZywgIuKGkiAiKTsKICAgIGlmICghdHh0KSByZXR1cm4gbnVsbDsKICAgIHJvdXRlQ2FjaGVTZXQoY3MsIHR4dCk7CiAgICByZXR1cm4gdHh0OwogIH1jYXRjaChlKXsKICAgIHJldHVybiBudWxsOwogIH0KfQpsZXQgU0NST0xMNSA9IGZhbHNlOwovLyB2MTUwIFVJIHVwZ3JhZGUgb24gdG9wIG9mIHY0OCBiYXNlbGluZQpjb25zdCBQUk9YWSA9ICJodHRwczovL2ZsaWdodHNhYm92ZS50MmhrbWhnYnd6LndvcmtlcnMuZGV2LyI7CgoKLy8gdjU0OiBjaXR5IG5hbWVzICsgYWlybGluZSBsb2dvcyArIGJlc3QtZWZmb3J0IGFpcmNyYWZ0IG1vZGVsCmNvbnN0IEFJUlBPUlRfQ0lUWSA9IHsKICAvLyBOb3J0aHdlc3QgQXJrYW5zYXMgKyBuZWFyYnkKICBYTkE6IkZheWV0dGV2aWxsZS9CZW50b252aWxsZSwgQVIiLCBGWVY6IkZheWV0dGV2aWxsZSwgQVIiLCBST0c6IlJvZ2VycywgQVIiLCBCVlg6IkJhdGVzdmlsbGUsIEFSIiwKICBGU006IkZvcnQgU21pdGgsIEFSIiwgTElUOiJMaXR0bGUgUm9jaywgQVIiLCBUVUw6IlR1bHNhLCBPSyIsIE1LTzoiTXVza29nZWUsIE9LIiwgT0tDOiJPa2xhaG9tYSBDaXR5LCBPSyIsCiAgSUNUOiJXaWNoaXRhLCBLUyIsIE1DSToiS2Fuc2FzIENpdHksIE1PIiwgSkxOOiJKb3BsaW4sIE1PIiwgU0dGOiJTcHJpbmdmaWVsZCwgTU8iLCBTVEw6IlN0LiBMb3VpcywgTU8iLAogIE1FTToiTWVtcGhpcywgVE4iLCBCTkE6Ik5hc2h2aWxsZSwgVE4iLCBNU1k6Ik5ldyBPcmxlYW5zLCBMQSIsCiAgLy8gTWFqb3IgVVMgaHVicyBhbmQgcG9wdWxhciBkZXN0aW5hdGlvbnMKICBBVEw6IkF0bGFudGEsIEdBIiwgT1JEOiJDaGljYWdvLCBJTCIsIE1EVzoiQ2hpY2FnbyAoTWlkd2F5KSwgSUwiLCBERU46IkRlbnZlciwgQ08iLAogIERGVzoiRGFsbGFz4oCTRm9ydCBXb3J0aCwgVFgiLCBEQUw6IkRhbGxhcyAoTG92ZSksIFRYIiwgSUFIOiJIb3VzdG9uLCBUWCIsIEhPVToiSG91c3RvbiAoSG9iYnkpLCBUWCIsCiAgUEhYOiJQaG9lbml4LCBBWiIsIExBUzoiTGFzIFZlZ2FzLCBOViIsIFNMQzoiU2FsdCBMYWtlIENpdHksIFVUIiwKICBMQVg6IkxvcyBBbmdlbGVzLCBDQSIsIFNGTzoiU2FuIEZyYW5jaXNjbywgQ0EiLCBPQUs6Ik9ha2xhbmQsIENBIiwgU0FOOiJTYW4gRGllZ28sIENBIiwgU0pDOiJTYW4gSm9zZSwgQ0EiLAogIFNOQToiT3JhbmdlIENvdW50eSwgQ0EiLCBCVVI6IkJ1cmJhbmssIENBIiwgU01GOiJTYWNyYW1lbnRvLCBDQSIsIFNFQToiU2VhdHRsZSwgV0EiLCBQRFg6IlBvcnRsYW5kLCBPUiIsCiAgSkZLOiJOZXcgWW9yaywgTlkiLCBMR0E6Ik5ldyBZb3JrIChMYUd1YXJkaWEpLCBOWSIsIEVXUjoiTmV3YXJrLCBOSiIsIEJPUzoiQm9zdG9uLCBNQSIsCiAgSUFEOiJXYXNoaW5ndG9uIER1bGxlcywgVkEiLCBEQ0E6Ildhc2hpbmd0b24gTmF0aW9uYWwsIERDIiwgUEhMOiJQaGlsYWRlbHBoaWEsIFBBIiwgQldJOiJCYWx0aW1vcmUsIE1EIiwKICBDTFQ6IkNoYXJsb3R0ZSwgTkMiLCBSRFU6IlJhbGVpZ2gtRHVyaGFtLCBOQyIsIE1DTzoiT3JsYW5kbywgRkwiLCBUUEE6IlRhbXBhLCBGTCIsCiAgTUlBOiJNaWFtaSwgRkwiLCBGTEw6IkZvcnQgTGF1ZGVyZGFsZSwgRkwiLCBSU1c6IkZvcnQgTXllcnMsIEZMIiwgU1JROiJTYXJhc290YSwgRkwiLAogIFBOUzoiUGVuc2Fjb2xhLCBGTCIsIFZQUzoiRGVzdGluL0Z0IFdhbHRvbiBCZWFjaCwgRkwiLAogIE1TUDoiTWlubmVhcG9saXPigJNTdC4gUGF1bCwgTU4iLCBEVFc6IkRldHJvaXQsIE1JIiwgQ0xFOiJDbGV2ZWxhbmQsIE9IIiwgQ1ZHOiJDaW5jaW5uYXRpLCBPSCIsCiAgLy8gTWV4aWNvIC8gQ2FyaWJiZWFuCiAgQ1VOOiJDYW5jw7puLCBNWCIsIENaTToiQ296dW1lbCwgTVgiLCBTSkQ6IlNhbiBKb3PDqSBkZWwgQ2FibywgTVgiLCBQVlI6IlB1ZXJ0byBWYWxsYXJ0YSwgTVgiLAogIE1FWDoiTWV4aWNvIENpdHksIE1YIiwgR0RMOiJHdWFkYWxhamFyYSwgTVgiLCBQVUo6IlB1bnRhIENhbmEsIERPIiwgTUJKOiJNb250ZWdvIEJheSwgSk0iLAogIE5BUzoiTmFzc2F1LCBCUyIsIEFVQToiQXJ1YmEsIEFXIiwgU0pVOiJTYW4gSnVhbiwgUFIiLCBTVFQ6IlN0LiBUaG9tYXMsIFZJIiwgU1RYOiJTdC4gQ3JvaXgsIFZJIgp9OwoKY29uc3QgQUlSTElORV9OQU1FID0gewogIEFBTDoiQW1lcmljYW4iLCBFTlk6IkVudm95IiwgSklBOiJQU0EiLCBSUEE6IlJlcHVibGljIiwKICBEQUw6IkRlbHRhIiwgRURWOiJFbmRlYXZvciIsIFNLVzoiU2t5V2VzdCIsCiAgVUFMOiJVbml0ZWQiLCBVQ0E6IkNvbW11dGVBaXIiLAogIFNXQToiU291dGh3ZXN0IiwgTktTOiJTcGlyaXQiLCBKQlU6IkpldEJsdWUiLCBGRlQ6IkZyb250aWVyIiwgQVNBOiJBbGFza2EiLCBBQVk6IkFsbGVnaWFudCIsCiAgV0pBOiJXZXN0SmV0IiwKICBFSkE6Ik5ldEpldHMiLAogIEZEWDoiRmVkRXgiLAogIFVQUzoiVVBTIiwKICBRWEU6Ikhvcml6b24iLAogIEFXSToiQWlyIFdpc2NvbnNpbiIsCn07CgovLyBTaW1wbGUsIG9yaWdpbmFsIFNWRyBtYXJrcyAobm90IG9mZmljaWFsIGxvZ29zKSBmb3IgcmVhZGFiaWxpdHkuCmNvbnN0IFVTRV9NRURJQV9LSVRfTE9HT1MgPSBmYWxzZTsgLy8gbGF0ZXI6IHNldCB0cnVlIGFuZCBhZGQgYXNzZXRzL2xvZ29zLyBmb3Igb2ZmaWNpYWwgbWFya3MKCmNvbnN0IEFJUkxJTkVfU1ZHID0gewogIEFBTDogYDxzdmcgdmlld0JveD0iMCAwIDEwMCAxMDAiIGFyaWEtbGFiZWw9IkFtZXJpY2FuIj48cmVjdCB4PSI2IiB5PSI2IiB3aWR0aD0iODgiIGhlaWdodD0iODgiIHJ4PSIxOCIgZmlsbD0ibm9uZSIgc3Ryb2tlPSJjdXJyZW50Q29sb3IiIHN0cm9rZS13aWR0aD0iNiIvPjx0ZXh0IHg9IjUwIiB5PSI2MCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZm9udC1zaXplPSIzNCIgZm9udC13ZWlnaHQ9Ijk1MCIgZmlsbD0iY3VycmVudENvbG9yIj5BQTwvdGV4dD48L3N2Zz5gLAogIERBTDogYDxzdmcgdmlld0JveD0iMCAwIDEwMCAxMDAiIGFyaWEtbGFiZWw9IkRlbHRhIj48cmVjdCB4PSI2IiB5PSI2IiB3aWR0aD0iODgiIGhlaWdodD0iODgiIHJ4PSIxOCIgZmlsbD0ibm9uZSIgc3Ryb2tlPSJjdXJyZW50Q29sb3IiIHN0cm9rZS13aWR0aD0iNiIvPjx0ZXh0IHg9IjUwIiB5PSI2MCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZm9udC1zaXplPSIzNCIgZm9udC13ZWlnaHQ9Ijk1MCIgZmlsbD0iY3VycmVudENvbG9yIj5ETDwvdGV4dD48L3N2Zz5gLAogIFVBTDogYDxzdmcgdmlld0JveD0iMCAwIDEwMCAxMDAiIGFyaWEtbGFiZWw9IlVuaXRlZCI+PHJlY3QgeD0iNiIgeT0iNiIgd2lkdGg9Ijg4IiBoZWlnaHQ9Ijg4IiByeD0iMTgiIGZpbGw9Im5vbmUiIHN0cm9rZT0iY3VycmVudENvbG9yIiBzdHJva2Utd2lkdGg9IjYiLz48dGV4dCB4PSI1MCIgeT0iNjAiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZvbnQtc2l6ZT0iMzQiIGZvbnQtd2VpZ2h0PSI5NTAiIGZpbGw9ImN1cnJlbnRDb2xvciI+VUE8L3RleHQ+PC9zdmc+YCwKICBTV0E6IGA8c3ZnIHZpZXdCb3g9IjAgMCAxMDAgMTAwIiBhcmlhLWxhYmVsPSJTb3V0aHdlc3QiPjxyZWN0IHg9IjYiIHk9IjYiIHdpZHRoPSI4OCIgaGVpZ2h0PSI4OCIgcng9IjE4IiBmaWxsPSJub25lIiBzdHJva2U9ImN1cnJlbnRDb2xvciIgc3Ryb2tlLXdpZHRoPSI2Ii8+PHRleHQgeD0iNTAiIHk9IjYwIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmb250LXNpemU9IjM0IiBmb250LXdlaWdodD0iOTUwIiBmaWxsPSJjdXJyZW50Q29sb3IiPldOPC90ZXh0Pjwvc3ZnPmAsCiAgSkJVOiBgPHN2ZyB2aWV3Qm94PSIwIDAgMTAwIDEwMCIgYXJpYS1sYWJlbD0iSmV0Qmx1ZSI+PHJlY3QgeD0iNiIgeT0iNiIgd2lkdGg9Ijg4IiBoZWlnaHQ9Ijg4IiByeD0iMTgiIGZpbGw9Im5vbmUiIHN0cm9rZT0iY3VycmVudENvbG9yIiBzdHJva2Utd2lkdGg9IjYiLz48dGV4dCB4PSI1MCIgeT0iNjAiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZvbnQtc2l6ZT0iMzQiIGZvbnQtd2VpZ2h0PSI5NTAiIGZpbGw9ImN1cnJlbnRDb2xvciI+QjY8L3RleHQ+PC9zdmc+YCwKICBGRlQ6IGA8c3ZnIHZpZXdCb3g9IjAgMCAxMDAgMTAwIiBhcmlhLWxhYmVsPSJGcm9udGllciI+PHJlY3QgeD0iNiIgeT0iNiIgd2lkdGg9Ijg4IiBoZWlnaHQ9Ijg4IiByeD0iMTgiIGZpbGw9Im5vbmUiIHN0cm9rZT0iY3VycmVudENvbG9yIiBzdHJva2Utd2lkdGg9IjYiLz48dGV4dCB4PSI1MCIgeT0iNjAiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZvbnQtc2l6ZT0iMzQiIGZvbnQtd2VpZ2h0PSI5NTAiIGZpbGw9ImN1cnJlbnRDb2xvciI+Rjk8L3RleHQ+PC9zdmc+YCwKICBOS1M6IGA8c3ZnIHZpZXdCb3g9IjAgMCAxMDAgMTAwIiBhcmlhLWxhYmVsPSJTcGlyaXQiPjxyZWN0IHg9IjYiIHk9IjYiIHdpZHRoPSI4OCIgaGVpZ2h0PSI4OCIgcng9IjE4IiBmaWxsPSJub25lIiBzdHJva2U9ImN1cnJlbnRDb2xvciIgc3Ryb2tlLXdpZHRoPSI2Ii8+PHRleHQgeD0iNTAiIHk9IjYwIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmb250LXNpemU9IjM0IiBmb250LXdlaWdodD0iOTUwIiBmaWxsPSJjdXJyZW50Q29sb3IiPk5LPC90ZXh0Pjwvc3ZnPmAsCiAgQVNBOiBgPHN2ZyB2aWV3Qm94PSIwIDAgMTAwIDEwMCIgYXJpYS1sYWJlbD0iQWxhc2thIj48cmVjdCB4PSI2IiB5PSI2IiB3aWR0aD0iODgiIGhlaWdodD0iODgiIHJ4PSIxOCIgZmlsbD0ibm9uZSIgc3Ryb2tlPSJjdXJyZW50Q29sb3IiIHN0cm9rZS13aWR0aD0iNiIvPjx0ZXh0IHg9IjUwIiB5PSI2MCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZm9udC1zaXplPSIzNCIgZm9udC13ZWlnaHQ9Ijk1MCIgZmlsbD0iY3VycmVudENvbG9yIj5BUzwvdGV4dD48L3N2Zz5gLAogIEFBWTogYDxzdmcgdmlld0JveD0iMCAwIDEwMCAxMDAiIGFyaWEtbGFiZWw9IkFsbGVnaWFudCI+PHJlY3QgeD0iNiIgeT0iNiIgd2lkdGg9Ijg4IiBoZWlnaHQ9Ijg4IiByeD0iMTgiIGZpbGw9Im5vbmUiIHN0cm9rZT0iY3VycmVudENvbG9yIiBzdHJva2Utd2lkdGg9IjYiLz48dGV4dCB4PSI1MCIgeT0iNjAiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZvbnQtc2l6ZT0iMzQiIGZvbnQtd2VpZ2h0PSI5NTAiIGZpbGw9ImN1cnJlbnRDb2xvciI+RzQ8L3RleHQ+PC9zdmc+YCwKICBFTlk6IGA8c3ZnIHZpZXdCb3g9IjAgMCAxMDAgMTAwIiBhcmlhLWxhYmVsPSJFbnZveSI+PHJlY3QgeD0iNiIgeT0iNiIgd2lkdGg9Ijg4IiBoZWlnaHQ9Ijg4IiByeD0iMTgiIGZpbGw9Im5vbmUiIHN0cm9rZT0iY3VycmVudENvbG9yIiBzdHJva2Utd2lkdGg9IjYiLz48dGV4dCB4PSI1MCIgeT0iNjAiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZvbnQtc2l6ZT0iMzQiIGZvbnQtd2VpZ2h0PSI5NTAiIGZpbGw9ImN1cnJlbnRDb2xvciI+RU48L3RleHQ+PC9zdmc+YCwKICBTS1c6IGA8c3ZnIHZpZXdCb3g9IjAgMCAxMDAgMTAwIiBhcmlhLWxhYmVsPSJTa3lXZXN0Ij48cmVjdCB4PSI2IiB5PSI2IiB3aWR0aD0iODgiIGhlaWdodD0iODgiIHJ4PSIxOCIgZmlsbD0ibm9uZSIgc3Ryb2tlPSJjdXJyZW50Q29sb3IiIHN0cm9rZS13aWR0aD0iNiIvPjx0ZXh0IHg9IjUwIiB5PSI2MCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZm9udC1zaXplPSIzNCIgZm9udC13ZWlnaHQ9Ijk1MCIgZmlsbD0iY3VycmVudENvbG9yIj5PTzwvdGV4dD48L3N2Zz5gCn07CgovLyB2NjA6IGdyb3VwIHJlZ2lvbmFsIGNhcnJpZXJzIHVuZGVyIHBhcmVudCBicmFuZHMgKGJlc3QtZWZmb3J0KQovLyBrZXlzIGFyZSBvcGVyYXRvci9jYWxsc2lnbiBwcmVmaXhlcyB3ZSBzZWUgaW4gdGhlIGZlZWQKY29uc3QgUkVHSU9OQUxfUEFSRU5UID0gewogIC8vIEFtZXJpY2FuICsgQW1lcmljYW4gRWFnbGUgbmV0d29yaywKICBFTlk6IkFBTCIsIEpJQToiQUFMIiwgUlBBOiJBQUwiLCBQRFQ6IkFBTCIsIEFTSDoiQUFMIiwKICAvLyBEZWx0YSBDb25uZWN0aW9uLAogIEVEVjoiREFMIiwgQ1BaOiJEQUwiLAogIC8vIFVuaXRlZCBFeHByZXNzLAogIFVDQToiVUFMIiwgR0pTOiJVQUwiLCBBU1E6IlVBTCIsCiAgUVhFOiJBU0EiLAogIEFXSToiVUFMIiwKICBGRFg6IkZEWCIsCiAgVVBTOiJVUFMiLAogIEVKQToiRUpBIiwKICBXSkE6IldKQSIsCn07CgovLyBPcHRpb25hbCBsYWJlbCBmb3IgdGhlIHJlZ2lvbmFsIG9wZXJhdG9yIGl0c2VsZgpjb25zdCBSRUdJT05BTF9OQU1FID0gewogIEVOWToiRW52b3kiLCBKSUE6IlBTQSIsIFJQQToiUmVwdWJsaWMiLCBQRFQ6IlBpZWRtb250IiwgQVNIOiJNZXNhIiwKICBFRFY6IkVuZGVhdm9yIiwgQ1BaOiJDb21wYXNzIiwgVUNBOiJDb21tdXRlQWlyIiwgR0pTOiJHb0pldCIsIEFTUToiRXhwcmVzc0pldCIsIFNLVzoiU2t5V2VzdCIsCiAgUVhFOiJIb3Jpem9uIiwKICBBV0k6IkFpciBXaXNjb25zaW4iLAogIFdKQToiV2VzdEpldCIsCiAgRUpBOiJOZXRKZXRzIiwKICBGRFg6IkZlZEV4IiwKICBVUFM6IlVQUyIsCn07CgpmdW5jdGlvbiBwYXJlbnRCcmFuZENvZGVGcm9tUHJlZml4KHByZWZpeCl7CiAgaWYgKCFwcmVmaXgpIHJldHVybiAiIjsKICByZXR1cm4gUkVHSU9OQUxfUEFSRU5UW3ByZWZpeF0gfHwgcHJlZml4Owp9CgpmdW5jdGlvbiBwYXJlbnRCcmFuZE5hbWVGcm9tQ29kZShjb2RlKXsKICBpZiAoIWNvZGUpIHJldHVybiAi4oCUIjsKICBjb25zdCBuYW1lcyA9IHsgQUFMOiJBbWVyaWNhbiIsIERBTDoiRGVsdGEiLCBVQUw6IlVuaXRlZCIsIFNXQToiU291dGh3ZXN0IiB9OwogIHJldHVybiBuYW1lc1tjb2RlXSB8fCBBSVJMSU5FX05BTUVbY29kZV0gfHwgY29kZTsKfQoKZnVuY3Rpb24gcmVnaW9uYWxTdWJMYWJlbChwcmVmaXgsIHBhcmVudENvZGUpewogIGlmICghcHJlZml4IHx8ICFwYXJlbnRDb2RlKSByZXR1cm4gIiI7CiAgaWYgKHByZWZpeCA9PT0gcGFyZW50Q29kZSkgcmV0dXJuICIiOwogIGNvbnN0IHIgPSBSRUdJT05BTF9OQU1FW3ByZWZpeF0gfHwgcHJlZml4OwogIGlmIChwYXJlbnRDb2RlID09PSAiQUFMIikgcmV0dXJuIGBFQUdMRSDigKIgJHtyfWA7CiAgaWYgKHBhcmVudENvZGUgPT09ICJEQUwiKSByZXR1cm4gYENPTk5FQ1RJT04g4oCiICR7cn1gOwogIGlmIChwYXJlbnRDb2RlID09PSAiVUFMIikgcmV0dXJuIGBFWFBSRVNTIOKAoiAke3J9YDsKICBpZiAocGFyZW50Q29kZSA9PT0gIkFTQSIpIHJldHVybiBgSE9SSVpPTiDigKIgJHtyfWA7CiAgcmV0dXJuIHI7Cn0KCi8vIFJvdWdoIGFpcmNyYWZ0IGZhbWlseSBoaW50cyBieSBjb21tb24gb3BlcmF0b3IgKGJlc3QtZWZmb3J0IG9ubHkpCmNvbnN0IEFJUkxJTkVfRkxFRVRfSElOVCA9IHsKICBTV0E6IkI3MzctZmFtaWx5IiwgQUFMOiJBMzIwL0I3MzcgbWl4IiwgREFMOiJBMzIwL0I3MzcgbWl4IiwgVUFMOiJBMzIwL0I3MzcgbWl4IiwKICBFTlk6IkUxNzUvQ1JKIiwgSklBOiJDUkoiLCBSUEE6IkUxNzUiLCBTS1c6IkUxNzUvQ1JKIiwgRURWOiJDUkoiCn07CgovLyBBRFNCREIgbG9va3VwcyBjYW4gYmUgcmF0ZSBsaW1pdGVkOyB3ZSBkbyBPTkUgbG9va3VwIHBlciAzMHMgbWF4IGFuZCBiYWNrIG9mZiBvbiA0MjkuCmxldCBhZHNiQ2FjaGUgPSBuZXcgTWFwKCk7IC8vIGNhbGxzaWduIC0+IHt0cyxkYXRhfQpsZXQgYWRzYk5leHRBbGxvd2VkVHMgPSAwOwpsZXQgYWRzYkJhY2tvZmZVbnRpbCA9IDA7CgpmdW5jdGlvbiBhaXJwb3J0TGFiZWwoY29kZSl7CiAgaWYgKCFjb2RlKSByZXR1cm4gIuKAlCI7CiAgY29uc3QgYyA9IFN0cmluZyhjb2RlKS50b1VwcGVyQ2FzZSgpOwogIGNvbnN0IGNpdHkgPSBBSVJQT1JUX0NJVFlbY107CiAgcmV0dXJuIGNpdHkgPyBgJHtjfSAoJHtjaXR5fSlgIDogYzsKfQoKZnVuY3Rpb24gYWlybGluZUNvZGVGcm9tQ2FsbHNpZ24oY2FsbHNpZ24pewogIGlmICghY2FsbHNpZ24pIHJldHVybiAiIjsKICBjb25zdCBjcyA9IFN0cmluZyhjYWxsc2lnbikudHJpbSgpLnRvVXBwZXJDYXNlKCk7CiAgY29uc3QgbSA9IGNzLm1hdGNoKC9eKFtBLVpdezN9KS8pOwogIHJldHVybiBtID8gbVsxXSA6ICIiOwp9CiAgICAgICAgICAgIAovLyB2ODA6IHBhc3NlbmdlciBhaXJsaW5lIElDQU8gY29kZSBhbGxvd2xpc3QgKDMtbGV0dGVyIHByZWZpeGVzKQpjb25zdCBQQVNTRU5HRVJfSUNBT19DT0RFUyA9IG5ldyBTZXQoWwogICJBQUwiLCJEQUwiLCJVQUwiLCJTV0EiLCJBU0EiLCJKQlUiLCJGRlQiLCJOS1MiLCJBQVkiLCJTS1ciLCJNWFkiLAogICJFTlkiLCJKSUEiLCJSUEEiLCJQRFQiLCJFRFYiLCJBV0kiLCJBU0giLCJDUFoiLCJHSlMiLCJRWEUiLAogICJXSkEiLCJBQ0EiLCJXRU4iLCJST1UiLCJBTVgiLCJWT0kiLCJWSVYiLCJDTVAiLAogICJCQVciLCJWSVIiLCJBRlIiLCJETEgiLCJLTE0iLCJJQkUiLCJUQVAiLCJTQVMiLCJTSUEiLCJFVkEiLCJBTkEiLCJKQUwiLCJLQUwiLCJBQVIiLCJRVFIiLCJVQUUiLCJFVEQiLCJUSFkiCl0pOwoKCgogICAgCi8vIHY4OTogbm9uLXBhc3NlbmdlciBvcGVyYXRvcnMgdG8gZXhjbHVkZSB3aGVuICJQYXNzZW5nZXIgQWlybGluZXMgT25seSIgaXMgZW5hYmxlZApjb25zdCBOT05fUEFTU0VOR0VSX0lDQU8gPSBuZXcgU2V0KFsKICAiQ0FQIiwgLy8gQ2l2aWwgQWlyIFBhdHJvbAogICJUUkYiLCAvLyBUcmFkZWZsaWdodCAoY2FyZ28vY2hhcnRlcikKICAiRkRYIiwgLy8gRmVkRXgKICAiVVBTIiwgLy8gVVBTCiAgIkFCWCIsIC8vIEFpcmJvcm5lIEV4cHJlc3MKICAiR1RJIiwgLy8gQXRsYXMgQWlyCiAgIkNLUyIsIC8vIEthbGl0dGEgQWlyCiAgIkFKVCIsIC8vIEFtZXJpamV0CiAgIktPVyIsIC8vIGNvbW1vbiBjYXJnby9jaGFydGVyIGluIGFyZWEKCiAgIkpUWiIsIC8vIG5vbi1zY2hlZHVsZWQvY2hhcnRlcgogICJKVEwiLCAvLyBub24tc2NoZWR1bGVkL2NoYXJ0ZXIKICAiRUpBIiwgLy8gbm9uLXNjaGVkdWxlZC9jaGFydGVyCiAgIlhPSiIsIC8vIG5vbi1zY2hlZHVsZWQvY2hhcnRlcgogICJMWEoiLCAvLyBub24tc2NoZWR1bGVkL2NoYXJ0ZXIKICAiTkpFIiwgLy8gbm9uLXNjaGVkdWxlZC9jaGFydGVyCl0pOwovLyB2NjY6IGNvbW1lcmNpYWwgZmlsdGVyaW5nIChrZWVwIHBhc3Nlbmdlci9yZWdpb25hbC9jYXJnbzsgZHJvcCBwcml2YXRlL0dBL21pbCkKLy8gTk9URTogVGhpcyBpcyBoZXVyaXN0aWM6IGl0IHVzZXMgY2FsbHNpZ24gcHJlZml4ZXMsIHdoaWNoIGlzIHdoYXQgd2UgcmVsaWFibHkgaGF2ZS4KY29uc3QgQ09NTUVSQ0lBTF9DQVJSSUVSX0NPREVTID0gbmV3IFNldChbCiAgIlNXQSIsIkFBTCIsIkRBTCIsIlVBTCIsIkFTQSIsIkpCVSIsIkZGVCIsIk5LUyIsIkFBWSIsCiAgLy8gUmVnaW9uYWwKICAiRU5ZIiwiU0tXIiwiSklBIiwiUlBBIiwiRURWIiwiVUNBIiwiR0pTIiwiQVNRIiwiUERUIiwiQVNIIiwKICAvLyBDYXJnbwogICJGRFgiLCJVUFMiLCJBQlgiCl0pOwoKY29uc3QgUFJJVkFURV9QUkVGSVhFUyA9IG5ldyBTZXQoWyJDQVAiLCJLT1ciLCJFSkEiXSk7IC8vIENBUD1DaXZpbCBBaXIgUGF0cm9sLCBFSkE9TmV0SmV0cyAocHJpdmF0ZSkKZnVuY3Rpb24gaXNDb21tZXJjaWFsQ2FsbHNpZ24oY2FsbHNpZ24pewogIGlmICghY2FsbHNpZ24pIHJldHVybiBmYWxzZTsKICBjb25zdCBjcyA9IFN0cmluZyhjYWxsc2lnbikudHJpbSgpLnRvVXBwZXJDYXNlKCk7CiAgaWYgKC9eTlxkLy50ZXN0KGNzKSkgcmV0dXJuIGZhbHNlOyAvLyBHQS9wcml2YXRlIHRhaWwgbnVtYmVycwogIGNvbnN0IG5zID0gY3MucmVwbGFjZSgvXHMrL2csICIiKTsKICBjb25zdCBtID0gbnMubWF0Y2goL14oW0EtWl17M30pXGQvKTsKICBpZiAoIW0pIHJldHVybiBmYWxzZTsKICBjb25zdCBwcmVmID0gbVsxXTsKICBpZiAoTk9OX1BBU1NFTkdFUl9JQ0FPLmhhcyhwcmVmKSkgcmV0dXJuIGZhbHNlOwogIC8vIFBhc3NlbmdlciBhaXJsaW5lcyBhbGxvd2xpc3QgKG1heSBiZSBDT01NRVJDSUFMX0NBUlJJRVJfQ09ERVMgaW4gb2xkZXIgYnVpbGRzKQogIGlmICh0eXBlb2YgUEFTU0VOR0VSX0lDQU9fQ09ERVMgIT09ICJ1bmRlZmluZWQiKSByZXR1cm4gUEFTU0VOR0VSX0lDQU9fQ09ERVMuaGFzKHByZWYpOwogIGlmICh0eXBlb2YgQ09NTUVSQ0lBTF9DQVJSSUVSX0NPREVTICE9PSAidW5kZWZpbmVkIikgcmV0dXJuIENPTU1FUkNJQUxfQ0FSUklFUl9DT0RFUy5oYXMocHJlZik7CiAgcmV0dXJuIGZhbHNlOwp9CgpmdW5jdGlvbiBvcGVyYXRvckJyYW5kU1ZHKGNzKXsKICBjb25zdCBjb2RlID0gYWlybGluZUNvZGVGcm9tQ2FsbHNpZ24oY3MpIHx8ICLinIgiOwogIGNvbnN0IG5hbWUgPSBBSVJMSU5FX05BTUVbY29kZV0gfHwgY29kZTsKICByZXR1cm4gYDxzdmcgdmlld0JveD0iMCAwIDEwMCAxMDAiIGFyaWEtbGFiZWw9IiR7bmFtZX0iPgogICAgPHJlY3QgeD0iNiIgeT0iNiIgd2lkdGg9Ijg4IiBoZWlnaHQ9Ijg4IiByeD0iMTgiIGZpbGw9Im5vbmUiIHN0cm9rZT0iY3VycmVudENvbG9yIiBzdHJva2Utd2lkdGg9IjYiLz4KICAgIDx0ZXh0IHg9IjUwIiB5PSI1NiIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZm9udC1zaXplPSIzNCIgZm9udC13ZWlnaHQ9Ijk1MCIgZmlsbD0iY3VycmVudENvbG9yIj4ke2NvZGUuc2xpY2UoMCwzKX08L3RleHQ+CiAgICA8dGV4dCB4PSI1MCIgeT0iNzgiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZvbnQtc2l6ZT0iMTIiIGZvbnQtd2VpZ2h0PSI4MDAiIGZpbGw9ImN1cnJlbnRDb2xvciI+JHtuYW1lLnJlcGxhY2UoLyYvZywiYW5kIikuc2xpY2UoMCwxNCl9PC90ZXh0PgogIDwvc3ZnPmA7Cn0KCmZ1bmN0aW9uIGxvZ29TVkdGcm9tQ2FsbHNpZ24oY3MpewogIGNvbnN0IGNvZGUgPSBhaXJsaW5lQ29kZUZyb21DYWxsc2lnbihjcyk7CiAgaWYgKGNvZGUgJiYgQUlSTElORV9TVkdbY29kZV0pIHJldHVybiBBSVJMSU5FX1NWR1tjb2RlXTsKICBjb25zdCBsYWJlbCA9IGNvZGUgfHwgIuKciCI7CiAgcmV0dXJuIGA8c3ZnIHZpZXdCb3g9IjAgMCAxMDAgMTAwIiBhcmlhLWxhYmVsPSIke2xhYmVsfSI+PHJlY3QgeD0iNiIgeT0iNiIgd2lkdGg9Ijg4IiBoZWlnaHQ9Ijg4IiByeD0iMTgiIGZpbGw9Im5vbmUiIHN0cm9rZT0iY3VycmVudENvbG9yIiBzdHJva2Utd2lkdGg9IjYiLz48dGV4dCB4PSI1MCIgeT0iNjAiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZvbnQtc2l6ZT0iMzQiIGZvbnQtd2VpZ2h0PSI5NTAiIGZpbGw9ImN1cnJlbnRDb2xvciI+JHtsYWJlbH08L3RleHQ+PC9zdmc+YDsKfQoKZnVuY3Rpb24gbG9nb1RleHRGcm9tQ2FsbHNpZ24oY3MpewogIGNvbnN0IGNvZGUgPSBhaXJsaW5lQ29kZUZyb21DYWxsc2lnbihjcyk7CiAgcmV0dXJuIGNvZGUgfHwgIuKciCI7Cn0KCmZ1bmN0aW9uIG1vZGVsSGludEZyb21DYWxsc2lnbihjcyl7CiAgY29uc3QgY29kZSA9IGFpcmxpbmVDb2RlRnJvbUNhbGxzaWduKGNzKTsKICBpZiAoIWNvZGUpIHJldHVybiAi4oCUIjsKICBjb25zdCBoaW50UmF3ID0gQUlSTElORV9GTEVFVF9ISU5UW2NvZGVdIHx8ICIiOwogIGNvbnN0IGhpbnQgPSBTdHJpbmcoaGludFJhdykucmVwbGFjZSgiL0VSSiIsIiIpLnRyaW0oKTsgLy8gdjE1MDogYXZvaWQgRVJKIG5vaXNlCiAgLy8gUHJlZmVyIGFpcmNyYWZ0IGhpbnQ7IGZhbGwgYmFjayB0byBhaXJsaW5lIGNvZGUgaWYgd2UgaGF2ZSBub3RoaW5nCiAgcmV0dXJuIGhpbnQgfHwgKEFJUkxJTkVfTkFNRVtjb2RlXSB8fCBjb2RlKTsKfQoKYXN5bmMgZnVuY3Rpb24gZmV0Y2hBZHNiZGJGb3JDYWxsc2lnbihjYWxsc2lnbil7CiAgY29uc3Qgbm93ID0gRGF0ZS5ub3coKTsKICBjb25zdCBrZXkgPSAoY2FsbHNpZ258fCIiKS50cmltKCkudG9VcHBlckNhc2UoKTsKICBpZiAoIWtleSkgcmV0dXJuIG51bGw7CgogIC8vIGNhY2hlIDEwIG1pbnV0ZXMKICBjb25zdCBjYWNoZWQgPSBhZHNiQ2FjaGUuZ2V0KGtleSk7CiAgaWYgKGNhY2hlZCAmJiAobm93IC0gY2FjaGVkLnRzKSA8IDEwKjYwKjEwMDApIHJldHVybiBjYWNoZWQuZGF0YTsKCiAgaWYgKG5vdyA8IGFkc2JCYWNrb2ZmVW50aWwpIHJldHVybiBudWxsOwogIGlmIChub3cgPCBhZHNiTmV4dEFsbG93ZWRUcykgcmV0dXJuIG51bGw7CgogIGFkc2JOZXh0QWxsb3dlZFRzID0gbm93ICsgMzAqMTAwMDsgLy8gb25lIGNhbGwgcGVyIDMwcwoKICBjb25zdCB1cmwgPSBgJHtQUk9YWX1hZHNiLyR7ZW5jb2RlVVJJQ29tcG9uZW50KGtleSl9YDsKCiAgdHJ5ewogICAgY29uc3QgcmVzID0gYXdhaXQgZmV0Y2hXaXRoVGltZW91dCh1cmwsIDY1MDApOwogICAgaWYgKHJlcy5zdGF0dXMgPT09IDQyOSl7CiAgICAgIGFkc2JCYWNrb2ZmVW50aWwgPSBub3cgKyA1KjYwKjEwMDA7CiAgICAgIHJldHVybiBudWxsOwogICAgfQogICAgaWYgKCFyZXMub2spIHJldHVybiBudWxsOwogICAgY29uc3QganMgPSBhd2FpdCByZXMuanNvbigpOwoKICAgIC8vIHYxNTA6IG5vcm1hbGl6ZSByb3V0ZS9haXJwb3J0IGZpZWxkcyBmcm9tIFdvcmtlciAoL2Fkc2IvKiBha2EgL2Flcm8vKikKICAgIHRyeXsKICAgICAgaWYgKGpzICYmIHR5cGVvZiBqcyA9PT0gIm9iamVjdCIpewogICAgICAgIGlmICghanMucm91dGUgJiYganMucm91dGVQcmV0dHkpIGpzLnJvdXRlID0ganMucm91dGVQcmV0dHk7CiAgICAgICAgaWYgKCFqcy5vcmlnaW4gJiYganMuZGVwYXJ0dXJlKSBqcy5vcmlnaW4gPSBqcy5kZXBhcnR1cmU7CiAgICAgICAgaWYgKCFqcy5kZXN0aW5hdGlvbiAmJiBqcy5hcnJpdmFsKSBqcy5kZXN0aW5hdGlvbiA9IGpzLmFycml2YWw7CiAgICAgICAgaWYgKCFqcy5yb3V0ZSAmJiBqcy5vcmlnaW4gJiYganMuZGVzdGluYXRpb24pewogICAgICAgICAgY29uc3Qgb2kgPSBqcy5vcmlnaW4uaWF0YSB8fCBqcy5vcmlnaW4uaWNhbyB8fCAiIjsKICAgICAgICAgIGNvbnN0IGRpID0ganMuZGVzdGluYXRpb24uaWF0YSB8fCBqcy5kZXN0aW5hdGlvbi5pY2FvIHx8ICIiOwogICAgICAgICAgaWYgKG9pICYmIGRpKXsKICAgICAgICAgICAganMucm91dGUgPSBgJHthaXJwb3J0TGFiZWwob2kpfSDihpIgJHthaXJwb3J0TGFiZWwoZGkpfWA7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIC8vIEFsd2F5cyBwcm92aWRlIHRoZSBmaWVsZCB0aGUgVUkgdXNlcwogICAgICAgIGlmIChqcy5yb3V0ZSkganMucm91dGVQcmV0dHkgPSBqcy5yb3V0ZTsKICAgICAgfQogICAgfWNhdGNoKF9lKXt9CgogICAgYWRzYkNhY2hlLnNldChrZXksIHt0czogbm93LCBkYXRhOiBqc30pOwogICAgcmV0dXJuIGpzOwogIH1jYXRjaChlKXsKICAgIHJldHVybiBudWxsOwogIH0KfQoKY29uc3QgWE5BX0ZBTExCQUNLID0geyBsYXQ6IDM2LjI4MTksIGxvbjogLTk0LjMwNjggfTsKCmxldCBIT01FX0xBVCA9IFhOQV9GQUxMQkFDSy5sYXQ7CmxldCBIT01FX0xPTiA9IFhOQV9GQUxMQkFDSy5sb247CgovLyB2OTg6IElmIGxvY2F0aW9uIHBlcm1pc3Npb24gaXMgYmxvY2tlZC9mYWlsZWQsIGZhbGwgYmFjayB0byBYTkEgYXJlYSBzbyByYWRhciBpcyBuZXZlciAiMCIganVzdCBkdWUgdG8gY29vcmRzLgpjb25zdCBERUZBVUxUX0xBVCA9IDM2LjI4MTk7ICAgLy8gWE5BIChOb3J0aHdlc3QgQXJrYW5zYXMgTmF0aW9uYWwgQWlycG9ydCkKY29uc3QgREVGQVVMVF9MT04gPSAtOTQuMzA2ODsKZnVuY3Rpb24gZW5zdXJlSG9tZUNvb3JkcygpewogIGNvbnN0IGxhdE9rID0gTnVtYmVyLmlzRmluaXRlKEhPTUVfTEFUKSAmJiBNYXRoLmFicyhIT01FX0xBVCkgPiAxOwogIGNvbnN0IGxvbk9rID0gTnVtYmVyLmlzRmluaXRlKEhPTUVfTE9OKSAmJiBNYXRoLmFicyhIT01FX0xPTikgPiAxOwogIGlmICghbGF0T2sgfHwgIWxvbk9rKXsKICAgIEhPTUVfTEFUID0gREVGQVVMVF9MQVQ7CiAgICBIT01FX0xPTiA9IERFRkFVTFRfTE9OOwogICAgcmV0dXJuICJkZWZhdWx0IChYTkEpIjsKICB9CiAgcmV0dXJuICJncHMiOwp9CgoKbGV0IFJBTkdFX01JID0gSW5maW5pdHk7CmxldCBDT01NRVJDSUFMX09OTFkgPSB0cnVlOwoKbGV0IGZsaWdodHMgPSBbXTsKbGV0IGN1cnJlbnRJbmRleCA9IDA7CmxldCBjdXJyZW50ID0gbnVsbDsKCmxldCBzY3JvbGxNb2RlID0gInJvdGF0ZSI7IC8vIHJvdGF0ZSB8IGNsb3Nlc3QKbGV0IHJvdGF0ZUV2ZXJ5TXMgPSA3MDAwOwpsZXQgcm90YXRlVGltZXIgPSBudWxsOwpsZXQgbGFzdERpc3BsYXllZEtleSA9IG51bGw7CmxldCBoYXNSZW5kZXJlZE9uY2UgPSBmYWxzZTsKCgpmdW5jdGlvbiBzZXRUZXh0KGlkLCB2YWx1ZSl7CiAgY29uc3QgZWwgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChpZCk7CiAgY29uc3QgdiA9ICh2YWx1ZSA9PT0gdW5kZWZpbmVkIHx8IHZhbHVlID09PSBudWxsKSA/ICIiIDogU3RyaW5nKHZhbHVlKTsKICBpZiAoZWwgJiYgZWwudGV4dENvbnRlbnQgIT09IHYpIGVsLnRleHRDb250ZW50ID0gdjsKfQoKZnVuY3Rpb24gc2V0SFRNTChpZCwgaHRtbCl7CiAgY29uc3QgZWwgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChpZCk7CiAgY29uc3QgaCA9IChodG1sID09PSB1bmRlZmluZWQgfHwgaHRtbCA9PT0gbnVsbCkgPyAiIiA6IFN0cmluZyhodG1sKTsKICBpZiAoZWwgJiYgZWwuaW5uZXJIVE1MICE9PSBoKSBlbC5pbm5lckhUTUwgPSBoOwp9CgpmdW5jdGlvbiBzZXRDbGFzcyhpZCwgY2xzKXsKICBjb25zdCBlbCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGlkKTsKICBpZiAoIWVsKSByZXR1cm47CiAgaWYgKGVsLmNsYXNzTmFtZSAhPT0gY2xzKSBlbC5jbGFzc05hbWUgPSBjbHM7Cn0KCmZ1bmN0aW9uIHNldFN0YXR1cyhtc2cpewogIGNvbnN0IGVsID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoImZ3LXN0YXR1cyIpOwogIGlmIChlbCAmJiBlbC50ZXh0Q29udGVudCAhPT0gbXNnKSBlbC50ZXh0Q29udGVudCA9IG1zZzsKfQoKZnVuY3Rpb24gaG9tZVBsYWNlTGFiZWwoKXsKICBjb25zdCBkVG9YTkEgPSBoYXZlcnNpbmVNaShIT01FX0xBVCwgSE9NRV9MT04sIFhOQV9GQUxMQkFDSy5sYXQsIFhOQV9GQUxMQkFDSy5sb24pOwogIGlmIChkVG9YTkEgPD0gNjApIHJldHVybiAiRmF5ZXR0ZXZpbGxlL0JlbnRvbnZpbGxlLCBBUiAoWE5BIGFyZWEpIjsKICByZXR1cm4gYCR7SE9NRV9MQVQudG9GaXhlZCgzKX0sICR7SE9NRV9MT04udG9GaXhlZCgzKX1gOwp9CgpmdW5jdGlvbiBzZXRIb21lTGluZSgpewogIGNvbnN0IGVsID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoImhvbWVMaW5lIik7CiAgaWYgKCFlbCkgcmV0dXJuOwogIGVsLnRleHRDb250ZW50ID0gYEhPTUU6ICR7aG9tZVBsYWNlTGFiZWwoKX1gOwp9CmZ1bmN0aW9uIHNldEZhZGUoKXsgLyogZGlzYWJsZWQgaW4gdjUyICovIH0KZnVuY3Rpb24gZGVnMnJhZChkKXsgcmV0dXJuIGQqTWF0aC5QSS8xODA7IH0KZnVuY3Rpb24gaGF2ZXJzaW5lTWkobGF0MSwgbG9uMSwgbGF0MiwgbG9uMil7CiAgY29uc3QgUiA9IDM5NTguNzYxMzsKICBjb25zdCBkTGF0ID0gZGVnMnJhZChsYXQyLWxhdDEpOwogIGNvbnN0IGRMb24gPSBkZWcycmFkKGxvbjItbG9uMSk7CiAgY29uc3QgYSA9IE1hdGguc2luKGRMYXQvMikqKjIgKyBNYXRoLmNvcyhkZWcycmFkKGxhdDEpKSpNYXRoLmNvcyhkZWcycmFkKGxhdDIpKSpNYXRoLnNpbihkTG9uLzIpKioyOwogIHJldHVybiAyKlIqTWF0aC5hc2luKE1hdGguc3FydChhKSk7Cn0KZnVuY3Rpb24gYmVhcmluZyhsYXQxLCBsb24xLCBsYXQyLCBsb24yKXsKICBjb25zdCDPhjE9ZGVnMnJhZChsYXQxKSwgz4YyPWRlZzJyYWQobGF0Mik7CiAgY29uc3QgeT1NYXRoLnNpbihkZWcycmFkKGxvbjItbG9uMSkpKk1hdGguY29zKM+GMik7CiAgY29uc3QgeD1NYXRoLmNvcyjPhjEpKk1hdGguc2luKM+GMiktTWF0aC5zaW4oz4YxKSpNYXRoLmNvcyjPhjIpKk1hdGguY29zKGRlZzJyYWQobG9uMi1sb24xKSk7CiAgcmV0dXJuIChNYXRoLmF0YW4yKHkseCkqMTgwL01hdGguUEkrMzYwKSUzNjA7Cn0KZnVuY3Rpb24gZGlyVGV4dChkZWcpewogIGlmICghTnVtYmVyLmlzRmluaXRlKGRlZykpIHJldHVybiAi4oCUIjsKICBjb25zdCBkaXJzPVsiTiIsIk5FIiwiRSIsIlNFIiwiUyIsIlNXIiwiVyIsIk5XIiwiTiJdOwogIHJldHVybiBkaXJzW01hdGgucm91bmQoZGVnLzQ1KV07Cn0KYXN5bmMgZnVuY3Rpb24gZmV0Y2hXaXRoVGltZW91dCh1cmwsIG1zPTY1MDApewogIGNvbnN0IGN0cmwgPSBuZXcgQWJvcnRDb250cm9sbGVyKCk7CiAgY29uc3QgdCA9IHNldFRpbWVvdXQoKCk9PmN0cmwuYWJvcnQoKSwgbXMpOwogIHRyeXsKICAgIGNvbnN0IHJlcyA9IGF3YWl0IGZldGNoKHVybCwgeyBzaWduYWw6IGN0cmwuc2lnbmFsLCBjYWNoZTogIm5vLXN0b3JlIiB9KTsKICAgIGNsZWFyVGltZW91dCh0KTsKICAgIHJldHVybiByZXM7CiAgfWNhdGNoKGUpewogICAgY2xlYXJUaW1lb3V0KHQpOwogICAgdGhyb3cgZTsKICB9Cn0KZnVuY3Rpb24gbWlsZXNUb0RlZ0xhdChtaSl7IHJldHVybiBtaS82OS4wOyB9CmZ1bmN0aW9uIG1pbGVzVG9EZWdMb24obWksIGxhdCl7IHJldHVybiBtaS8oTWF0aC5jb3MoZGVnMnJhZChsYXQpKSo2OS4xNzIpOyB9CmZ1bmN0aW9uIGxvb2tzQ29tbWVyY2lhbChjcyl7CiAgaWYgKCFjcykgcmV0dXJuIGZhbHNlOwogIGNvbnN0IHMgPSBjcy50cmltKCkudG9VcHBlckNhc2UoKTsKICBpZiAocy5sZW5ndGggPCAzKSByZXR1cm4gZmFsc2U7CiAgcmV0dXJuIC9eW0EtWl17MiwzfVxkezEsNX1bQS1aXT8kLy50ZXN0KHMpOwp9CmZ1bmN0aW9uIHJlYWRTdGF0ZVJvdyhyb3cpewogIGNvbnN0IGNhbGxzaWduID0gbm9ybUNhbGxzaWduKHJvd1sxXSk7CiAgY29uc3QgbGF0ID0gcm93WzZdLCBsb24gPSByb3dbNV07CiAgaWYgKCFOdW1iZXIuaXNGaW5pdGUobGF0KSB8fCAhTnVtYmVyLmlzRmluaXRlKGxvbikpIHJldHVybiBudWxsOwogIGNvbnN0IGRpc3QgPSBoYXZlcnNpbmVNaShIT01FX0xBVCwgSE9NRV9MT04sIGxhdCwgbG9uKTsKICBjb25zdCB2ZWxNcyA9IHJvd1s5XTsKICBjb25zdCB0cmsgPSByb3dbMTBdOwogIGNvbnN0IGFsdE0gPSAoTnVtYmVyLmlzRmluaXRlKHJvd1sxM10pID8gcm93WzEzXSA6IHJvd1s3XSk7CiAgcmV0dXJuIHsKICAgIGNhbGxzaWduLAogICAgbGF0LCBsb24sCiAgICBkaXN0LAogICAgdHJrLAogICAgc3BkTXBoOiBOdW1iZXIuaXNGaW5pdGUodmVsTXMpID8gdmVsTXMqMi4yMzY5MzYgOiBudWxsLAogICAgYWx0RnQ6IE51bWJlci5pc0Zpbml0ZShhbHRNKSA/IGFsdE0qMy4yODA4NCA6IG51bGwsCiAgICBvcmlnaW5Db3VudHJ5OiByb3dbMl0gfHwgIiIsCiAgICBpY2FvMjQ6IHJvd1swXSB8fCAiIgogIH07Cn0KCmZ1bmN0aW9uIHVwZGF0ZVRpY2tlcigpeyAvKiB2Njg6IHRpY2tlciByZW1vdmVkICovIH0KCmZ1bmN0aW9uIHBpY2tDdXJyZW50KCl7CiAgaWYgKCFmbGlnaHRzLmxlbmd0aCkgcmV0dXJuIG51bGw7CiAgaWYgKHNjcm9sbE1vZGUgPT09ICJjbG9zZXN0IikgcmV0dXJuIGZsaWdodHNbMF07CiAgY3VycmVudEluZGV4ID0gKGN1cnJlbnRJbmRleCAlIGZsaWdodHMubGVuZ3RoICsgZmxpZ2h0cy5sZW5ndGgpICUgZmxpZ2h0cy5sZW5ndGg7CiAgcmV0dXJuIGZsaWdodHNbY3VycmVudEluZGV4XTsKfQoKZnVuY3Rpb24gcmVuZGVyKCl7CiAgdHJ5eyB1cGRhdGVMYXN0VXBkYXRlKCk7IH1jYXRjaChlKXt9CgogIHNldEhvbWVMaW5lKCk7CgogIGNvbnN0IGNzRWwgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgiY3MiKTsKICBjb25zdCByb3V0ZUVsID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoInJvdXRlIik7CiAgY29uc3QgbW9kZWxFbCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJtb2RlbCIpOwogIGNvbnN0IGFsdEVsID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoImFsdCIpOwogIGNvbnN0IHNwZEVsID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoInNwZCIpOwogIGNvbnN0IGRpc3RFbCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJkaXN0Iik7CiAgY29uc3QgZGlyRWwgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgiZGlyIik7CiAgY29uc3QgbWV0YUVsID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoIm1ldGEiKTsKICBjb25zdCBhaXJsaW5lTmFtZUVsID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoImFpcmxpbmUtbmFtZSIpOwogIGNvbnN0IGFpcmxpbmVTdWJFbCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJhaXJsaW5lLXN1YiIpOwogIGNvbnN0IGxvZ29FbCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJsb2dvIik7CgogIGlmICghY3VycmVudCl7CiAgICBzZXRUZXh0KCJjcyIsIuKAlCIpOwogICAgc2V0VGV4dCgicm91dGUiLCJOTyBORUFSQlkgRkxJR0hUUyIpOwogICAgc2V0VGV4dCgibW9kZWwiLCLigJQiKTsKICAgIHNldFRleHQoImFsdCIsIuKAlCIpOwogICAgc2V0VGV4dCgic3BkIiwi4oCUIik7CiAgICBzZXRUZXh0KCJkaXN0Iiwi4oCUIik7CiAgICBzZXRUZXh0KCJkaXIiLCLigJQiKTsKICAgIHNldFRleHQoIm1ldGEiLCJBZGp1c3QgcmFuZ2Ugb3IgdHVybiBvZmYgY29tbWVyY2lhbC1vbmx5IHRvIHNlZSBtb3JlIHRyYWZmaWMuIik7OwogICAgaWYgKGxvZ29FbCl7CiAgICAgIGlmIChsb2dvRWwuZ2V0QXR0cmlidXRlKCJkYXRhLWFpcmxpbmUiKSAhPT0gIiIpIGxvZ29FbC5zZXRBdHRyaWJ1dGUoImRhdGEtYWlybGluZSIsIiIpOwogICAgICBzZXRIVE1MKCJsb2dvIiwgbG9nb1NWR0Zyb21DYWxsc2lnbigiIikpOyAKICAgIH0KICAgIHJldHVybjsKICB9CgogIGNvbnN0IG9wID0gYWlybGluZUNvZGVGcm9tQ2FsbHNpZ24oY3VycmVudC5jYWxsc2lnbik7CiAgY29uc3QgcGFyZW50ID0gcGFyZW50QnJhbmRDb2RlRnJvbVByZWZpeChvcCk7CiAgY29uc3QgYWlybGluZU5hbWUgPSBwYXJlbnRCcmFuZE5hbWVGcm9tQ29kZShwYXJlbnQpOwogIGlmIChhaXJsaW5lTmFtZUVsKSBzZXRUZXh0KCJhaXJsaW5lLW5hbWUiLCBhaXJsaW5lTmFtZSk7CiAgaWYgKGFpcmxpbmVTdWJFbCkgc2V0VGV4dCgiYWlybGluZS1zdWIiLCByZWdpb25hbFN1YkxhYmVsKG9wLCBwYXJlbnQpIHx8ICIgIik7CiAgc2V0VGV4dCgiY3MiLChjdXJyZW50LmNhbGxzaWduIHx8ICJVTktOT1dOIikpOwogIHRyeXsgdXBkYXRlU2Vjb25kYXJ5Qm94ZXMoZmxpZ2h0cywgY3VycmVudEluZGV4KTsgfWNhdGNoKGUpe30KICBpZiAobG9nb0VsKXsKICAgIGNvbnN0IG9wQ29kZSA9IGFpcmxpbmVDb2RlRnJvbUNhbGxzaWduKGN1cnJlbnQuY2FsbHNpZ24pIHx8ICIiOwogICAgY29uc3QgY29kZSA9IHBhcmVudEJyYW5kQ29kZUZyb21QcmVmaXgob3BDb2RlKSB8fCBvcENvZGU7CiAgICBpZiAobG9nb0VsLmdldEF0dHJpYnV0ZSgiZGF0YS1haXJsaW5lIikgIT09IGNvZGUpIGxvZ29FbC5zZXRBdHRyaWJ1dGUoImRhdGEtYWlybGluZSIsIGNvZGUpOwogICAgc2V0SFRNTCgibG9nbyIsIGxvZ29TVkdGcm9tQ2FsbHNpZ24oY3VycmVudC5jYWxsc2lnbikpOwogIH0KICBpZiAoY3VycmVudC5leGFjdE1vZGVsMSl7CiAgICBzZXRNb2RlbExpbmVzVjExNChjdXJyZW50LmV4YWN0TW9kZWwxLCBjdXJyZW50LmV4YWN0TW9kZWwyfHwiIik7CiAgfSBlbHNlIHsKICAgIHNldFRleHQoIm1vZGVsIiwgbW9kZWxIaW50RnJvbUNhbGxzaWduKGN1cnJlbnQuY2FsbHNpZ24pKTsKICB9CiAgc2V0VGV4dCgicm91dGUiLCBjdXJyZW50LnJvdXRlUHJldHR5IHx8ICLigJQiKTsKCiAgc2V0VGV4dCgiYWx0IiwgY3VycmVudC5hbHRGdCA/IGAke01hdGgucm91bmQoY3VycmVudC5hbHRGdCkudG9Mb2NhbGVTdHJpbmcoKX0gRlRgIDogIuKAlCIpOwogIHNldFRleHQoInNwZCIsIGN1cnJlbnQuc3BkTXBoID8gYCR7TWF0aC5yb3VuZChjdXJyZW50LnNwZE1waCl9IE1QSGAgOiAi4oCUIik7CiAgc2V0VGV4dCgiZGlzdCIsIGAke2N1cnJlbnQuZGlzdC50b0ZpeGVkKDEpfSBNSWApOwoKICBjb25zdCBiID0gYmVhcmluZyhIT01FX0xBVCwgSE9NRV9MT04sIGN1cnJlbnQubGF0LCBjdXJyZW50Lmxvbik7CiAgc2V0VGV4dCgiZGlyIiwgYCR7ZGlyVGV4dChiKX0gJHtNYXRoLnJvdW5kKGIpfcKwYCk7CgogIHNldFRleHQoIm1ldGEiLCBjdXJyZW50Lm1ldGFQcmV0dHkgfHwgYENPVU5UUlk6ICR7Y3VycmVudC5vcmlnaW5Db3VudHJ5IHx8ICLigJQifSDigKIgSUNBTzI0OiAke2N1cnJlbnQuaWNhbzI0IHx8ICLigJQifWApOwogIGlmICh3aW5kb3cuX19GV19VUERBVEVfUk9VVEVfXykgd2luZG93Ll9fRldfVVBEQVRFX1JPVVRFX18oKTsKICBpZiAod2luZG93Ll9fRldfVVBEQVRFX0FJUkNSQUZUX18pIHdpbmRvdy5fX0ZXX1VQREFURV9BSVJDUkFGVF9fKCk7Cn0KCgoKYXN5bmMgZnVuY3Rpb24gbG9hZEZsaWdodHMoKXsKICAvLyB2OTU6IFJBTkdFX01JIGNhbiBiZSBJbmZpbml0eSAoImFueSIpLiBPcGVuU2t5IG5lZWRzIGEgZmluaXRlIGJib3guCiAgY29uc3QgY29vcmRTb3VyY2UgPSBlbnN1cmVIb21lQ29vcmRzKCk7CiAgY29uc3QgcXVlcnlSYWRpdXNNaSA9IE51bWJlci5pc0Zpbml0ZShSQU5HRV9NSSkgPyBSQU5HRV9NSSA6IDI1MDsgLy8gcXVlcnkgfjI1MG1pIGJveCwgc3RpbGwgc2hvdyBjbG9zZXN0IG92ZXJhbGwKCiAgLy8gdjExODogZml4ZWQtc2l6ZSBiYm94IGFyb3VuZCBjdXJyZW50IGxvY2F0aW9uIChwZXJmb3JtYW5jZSk7IG5vIHJhbmdlIGxvZ2ljCiAgY29uc3QgYmIgPSBmd0dldEJib3hWMTI1KEhPTUVfTEFULCBIT01FX0xPTik7CiAgY29uc3QgbGFtaW4gPSBiYi5sYW1pbi50b0ZpeGVkKDQpOwogIGNvbnN0IGxhbWF4ID0gYmIubGFtYXgudG9GaXhlZCg0KTsKICBjb25zdCBsb21pbiA9IGJiLmxvbWluLnRvRml4ZWQoNCk7CiAgY29uc3QgbG9tYXggPSBiYi5sb21heC50b0ZpeGVkKDQpOwoKICBjb25zdCB1cmwgPSBgJHtQUk9YWX1vcGVuc2t5L3N0YXRlcz9sYW1pbj0ke2xhbWlufSZsb21pbj0ke2xvbWlufSZsYW1heD0ke2xhbWF4fSZsb21heD0ke2xvbWF4fWA7CiAgY29uc3QgcmVzID0gYXdhaXQgZmV0Y2hXaXRoVGltZW91dCh1cmwsIDY1MDApOwogIGlmICghcmVzLm9rKSB0aHJvdyBuZXcgRXJyb3IoYE9wZW5Ta3kgJHtyZXMuc3RhdHVzfWApOwogIGNvbnN0IGpzID0gYXdhaXQgcmVzLmpzb24oKTsKCiAgY29uc3Qgcm93cyA9IEFycmF5LmlzQXJyYXkoanM/LnN0YXRlcykgPyBqcy5zdGF0ZXMgOiBbXTsKICBjb25zdCByYXdDb3VudCA9IHJvd3MubGVuZ3RoOwogIGNvbnN0IHBhcnNlZCA9IFtdOwogIGZvciAoY29uc3QgciBvZiByb3dzKXsKICAgIGNvbnN0IGYgPSByZWFkU3RhdGVSb3cocik7CiAgICBpZiAoIWYpIGNvbnRpbnVlOwogICAgLy8gSWYgUkFOR0VfTUkgaXMgZmluaXRlLCBmaWx0ZXIgYnkgaXQuIElmICJhbnkiIChJbmZpbml0eSksIGRvIG5vdCBmaWx0ZXIgYnkgZGlzdGFuY2UuCiAgICBpZiAoTnVtYmVyLmlzRmluaXRlKFJBTkdFX01JKSAmJiBmLmRpc3QgPiBSQU5HRV9NSSkgY29udGludWU7CiAgICBpZiAoQ09NTUVSQ0lBTF9PTkxZICYmICFpc0NvbW1lcmNpYWxDYWxsc2lnbihmLmNhbGxzaWduKSkgY29udGludWU7CiAgICBwYXJzZWQucHVzaChmKTsKICB9CiAgcGFyc2VkLnNvcnQoKGEsYik9PmEuZGlzdC1iLmRpc3QpOwogIGZsaWdodHMgPSBwYXJzZWQuc2xpY2UoMCwgNSk7CiAgdHJ5eyBzZXRTdGF0dXNMaW5lKGBSYWRhcjogJHtyYXdDb3VudH0gZmxpZ2h0cyDigKIgU2hvd2luZzogJHtmbGlnaHRzLmxlbmd0aH0g4oCiIExvYzogJHtjb29yZFNvdXJjZX0gKCR7SE9NRV9MQVQudG9GaXhlZCgzKX0sICR7SE9NRV9MT04udG9GaXhlZCgzKX0pYCk7IH1jYXRjaChlKXt9CiAgY3VycmVudCA9IHBpY2tDdXJyZW50KCk7CiAgd2luZG93Ll9fRldfQ1VSUkVOVF9GTElHSFQgPSBjdXJyZW50OwogIHRyeXsgX19md01hcmtTdGFibGVLZXkoY3VycmVudCAmJiBjdXJyZW50LmNhbGxzaWduLCBjdXJyZW50ICYmIGN1cnJlbnQuaWNhbzI0KTsgfWNhdGNoKGUpe30KICAvLyB2MTIwOiByZS1raWNrIGVucmljaGVycyBzaG9ydGx5IGFmdGVyIHRvIGF2b2lkIHJhY2Ugb24gZmFzdCByZWZyZXNoCiAgdHJ5ewogICAgY29uc3QgX2NzID0gU3RyaW5nKChjdXJyZW50ICYmIGN1cnJlbnQuY2FsbHNpZ24pID8gY3VycmVudC5jYWxsc2lnbiA6ICIiKTsKICAgIGNvbnN0IF9oeCA9IFN0cmluZygoY3VycmVudCAmJiBjdXJyZW50LmljYW8yNCkgPyBjdXJyZW50LmljYW8yNCA6ICIiKTsKICAgIHNldFRpbWVvdXQoKCk9PnsKICAgICAgdHJ5eyBpZiAod2luZG93Ll9fRldfQ1VSUkVOVF9GTElHSFQgJiYgU3RyaW5nKHdpbmRvdy5fX0ZXX0NVUlJFTlRfRkxJR0hULmNhbGxzaWdufHwiIik9PT1fY3MgJiYgd2luZG93Ll9fRldfRk9SQ0VfUk9VVEVfXykgd2luZG93Ll9fRldfRk9SQ0VfUk9VVEVfXygpOyB9Y2F0Y2goZSl7fQogICAgICB0cnl7IGlmICh3aW5kb3cuX19GV19DVVJSRU5UX0ZMSUdIVCAmJiBTdHJpbmcod2luZG93Ll9fRldfQ1VSUkVOVF9GTElHSFQuaWNhbzI0fHwiIik9PT1faHggJiYgd2luZG93Ll9fRldfVVBEQVRFX0FJUkNSQUZUX18pIHdpbmRvdy5fX0ZXX1VQREFURV9BSVJDUkFGVF9fKCk7IH1jYXRjaChlKXt9CiAgICB9LCA4NTApOwogIH1jYXRjaChlKXt9CiAgLy8gdjExNzoga2ljayBvZmYgZW5yaWNoZXJzIGltbWVkaWF0ZWx5IG9uIG1haW4tdGlsZSBjaGFuZ2UKICB0cnl7IGlmICh3aW5kb3cuX19GV19GT1JDRV9ST1VURV9fKSB3aW5kb3cuX19GV19GT1JDRV9ST1VURV9fKCk7IH1jYXRjaChlKXt9CiAgdHJ5eyBpZiAod2luZG93Ll9fRldfVVBEQVRFX0FJUkNSQUZUX18pIHdpbmRvdy5fX0ZXX1VQREFURV9BSVJDUkFGVF9fKCk7IH1jYXRjaChlKXt9CiAgaWYgKHdpbmRvdy5fX0ZXX1VQREFURV9BSVJDUkFGVF9fKSB3aW5kb3cuX19GV19VUERBVEVfQUlSQ1JBRlRfXygpOwogIGlmICh3aW5kb3cuX19GV19VUERBVEVfUk9VVEVfXykgd2luZG93Ll9fRldfVVBEQVRFX1JPVVRFX18oKTsKICB0cnl7IHNldFN0YXR1c0xpbmUoYFJhZGFyOiAke3Jhd0NvdW50fSBmbGlnaHRzIOKAoiBTaG93aW5nOiAke2ZsaWdodHMubGVuZ3RofSDigKIgTG9jOiAke2Nvb3JkU291cmNlfSAoJHtIT01FX0xBVC50b0ZpeGVkKDMpfSwgJHtIT01FX0xPTi50b0ZpeGVkKDMpfSlgKTsgfWNhdGNoKGUpe30KICBpZiAoY3VycmVudCl7IGN1cnJlbnQucm91dGVQcmV0dHkgPSBudWxsOyBjdXJyZW50Lm1ldGFQcmV0dHkgPSBudWxsOyB9CiAgdXBkYXRlVGlja2VyKCk7CiAgd2luZG93Ll9fRldfQ1VSUkVOVF9GTElHSFQgPSBjdXJyZW50OwogIHRyeXsgX19md01hcmtTdGFibGVLZXkoY3VycmVudCAmJiBjdXJyZW50LmNhbGxzaWduLCBjdXJyZW50ICYmIGN1cnJlbnQuaWNhbzI0KTsgfWNhdGNoKGUpe30KICAvLyB2MTIwOiByZS1raWNrIGVucmljaGVycyBzaG9ydGx5IGFmdGVyIHRvIGF2b2lkIHJhY2Ugb24gZmFzdCByZWZyZXNoCiAgdHJ5ewogICAgY29uc3QgX2NzID0gU3RyaW5nKChjdXJyZW50ICYmIGN1cnJlbnQuY2FsbHNpZ24pID8gY3VycmVudC5jYWxsc2lnbiA6ICIiKTsKICAgIGNvbnN0IF9oeCA9IFN0cmluZygoY3VycmVudCAmJiBjdXJyZW50LmljYW8yNCkgPyBjdXJyZW50LmljYW8yNCA6ICIiKTsKICAgIHNldFRpbWVvdXQoKCk9PnsKICAgICAgdHJ5eyBpZiAod2luZG93Ll9fRldfQ1VSUkVOVF9GTElHSFQgJiYgU3RyaW5nKHdpbmRvdy5fX0ZXX0NVUlJFTlRfRkxJR0hULmNhbGxzaWdufHwiIik9PT1fY3MgJiYgd2luZG93Ll9fRldfRk9SQ0VfUk9VVEVfXykgd2luZG93Ll9fRldfRk9SQ0VfUk9VVEVfXygpOyB9Y2F0Y2goZSl7fQogICAgICB0cnl7IGlmICh3aW5kb3cuX19GV19DVVJSRU5UX0ZMSUdIVCAmJiBTdHJpbmcod2luZG93Ll9fRldfQ1VSUkVOVF9GTElHSFQuaWNhbzI0fHwiIik9PT1faHggJiYgd2luZG93Ll9fRldfVVBEQVRFX0FJUkNSQUZUX18pIHdpbmRvdy5fX0ZXX1VQREFURV9BSVJDUkFGVF9fKCk7IH1jYXRjaChlKXt9CiAgICB9LCA4NTApOwogIH1jYXRjaChlKXt9CiAgLy8gdjExNzoga2ljayBvZmYgZW5yaWNoZXJzIGltbWVkaWF0ZWx5IG9uIG1haW4tdGlsZSBjaGFuZ2UKICB0cnl7IGlmICh3aW5kb3cuX19GV19GT1JDRV9ST1VURV9fKSB3aW5kb3cuX19GV19GT1JDRV9ST1VURV9fKCk7IH1jYXRjaChlKXt9CiAgdHJ5eyBpZiAod2luZG93Ll9fRldfVVBEQVRFX0FJUkNSQUZUX18pIHdpbmRvdy5fX0ZXX1VQREFURV9BSVJDUkFGVF9fKCk7IH1jYXRjaChlKXt9CiAgaWYgKHdpbmRvdy5fX0ZXX1VQREFURV9BSVJDUkFGVF9fKSB3aW5kb3cuX19GV19VUERBVEVfQUlSQ1JBRlRfXygpOwogIGlmICh3aW5kb3cuX19GV19VUERBVEVfUk9VVEVfXykgd2luZG93Ll9fRldfVVBEQVRFX1JPVVRFX18oKTsKfQoKZnVuY3Rpb24gZGV0ZWN0TG9jYXRpb24oKXsKICBpZiAoIW5hdmlnYXRvci5nZW9sb2NhdGlvbikgcmV0dXJuOwogIGxldCBkb25lID0gZmFsc2U7CiAgY29uc3QgdCA9IHNldFRpbWVvdXQoKCk9PnsgZG9uZT10cnVlOyB9LCAzMDAwKTsKICBuYXZpZ2F0b3IuZ2VvbG9jYXRpb24uZ2V0Q3VycmVudFBvc2l0aW9uKAogICAgKHBvcyk9PnsKICAgICAgaWYgKGRvbmUpIHJldHVybjsKICAgICAgZG9uZSA9IHRydWU7IGNsZWFyVGltZW91dCh0KTsKICAgICAgSE9NRV9MQVQgPSBwb3MuY29vcmRzLmxhdGl0dWRlOwogICAgICBIT01FX0xPTiA9IHBvcy5jb29yZHMubG9uZ2l0dWRlOwogICAgICBzZXRIb21lTGluZSgpOwogICAgfSwKICAgICgpPT57IGRvbmU9dHJ1ZTsgY2xlYXJUaW1lb3V0KHQpOyB9LAogICAgeyBlbmFibGVIaWdoQWNjdXJhY3k6ZmFsc2UsIG1heGltdW1BZ2U6NjAwMDAwLCB0aW1lb3V0OjMwMDAgfQogICk7Cn0KCmZ1bmN0aW9uIGhvb2tDb250cm9scygpewogIGNvbnN0IHJzID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoInJhbmdlU2VsZWN0Iik7CiAgY29uc3QgbXMgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgibW9kZVNlbGVjdCIpOwogIGNvbnN0IGhpbnQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgicmFuZ2UtaGludCIpOwogIGNvbnN0IGMgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgiY29tbWVyY2lhbE9ubHkiKTsKCiAgZnVuY3Rpb24gYXBwbHlSYW5nZSgpewogICAgaWYgKCFycykgcmV0dXJuOwogICAgY29uc3QgdiA9IHJzLnZhbHVlOwogICAgUkFOR0VfTUkgPSAodiA9PT0gImFueSIpID8gSW5maW5pdHkgOiBOdW1iZXIodik7CiAgICBpZiAoaGludCkgaGludC50ZXh0Q29udGVudCA9ICh2ID09PSAiYW55IikgPyAiQU5ZOiBzaG93aW5nIHRoZSBjbG9zZXN0IGFpcmNyYWZ0IGFueXdoZXJlIiA6ICIiOwogICAgc2V0U3RhdHVzKCJTQ0FOTklORyBBSVJTUEFDReKApiIpOwogICAgc2V0SG9tZUxpbmUoKTsKICB9CgogIGZ1bmN0aW9uIGFwcGx5TW9kZSgpewogICAgaWYgKCFtcykgcmV0dXJuOwogICAgc2Nyb2xsTW9kZSA9IChtcy52YWx1ZSA9PT0gInJvdGF0ZTUiKSA/ICJyb3RhdGUiIDogImNsb3Nlc3QiOwogICAgY3VycmVudEluZGV4ID0gMDsKICAgIGN1cnJlbnQgPSBwaWNrQ3VycmVudCgpOwogICAgcmVuZGVyKCk7CiAgICByZXN0YXJ0Um90YXRlKCk7CiAgfQoKICBpZiAocnMpIHJzLmFkZEV2ZW50TGlzdGVuZXIoImNoYW5nZSIsICgpPT57IGFwcGx5UmFuZ2UoKTsgfSk7CiAgaWYgKG1zKSBtcy5hZGRFdmVudExpc3RlbmVyKCJjaGFuZ2UiLCAoKT0+eyBhcHBseU1vZGUoKTsgfSk7CgogIGlmIChjKXsKICAgIGMuY2hlY2tlZCA9IENPTU1FUkNJQUxfT05MWTsKICAgIGMuYWRkRXZlbnRMaXN0ZW5lcigiY2hhbmdlIiwgKCk9PnsKICAgICAgQ09NTUVSQ0lBTF9PTkxZID0gISFjLmNoZWNrZWQ7CiAgICAgIHNldFN0YXR1cygiU0NBTk5JTkcgQUlSU1BBQ0XigKYiKTsKICAgIH0pOwogIH0KCiAgLy8gZGVmYXVsdHMKICBpZiAocnMpeyBycy52YWx1ZSA9ICIyNSI7IH0KICBpZiAobXMpeyBtcy52YWx1ZSA9ICJjbG9zZXN0IjsgfQogIGFwcGx5UmFuZ2UoKTsKICBhcHBseU1vZGUoKTsKfQoKZnVuY3Rpb24gcmVzdGFydFJvdGF0ZSgpewogIHRyeXsgaWYgKHJvdGF0ZVRpbWVyKSB7IGNsZWFySW50ZXJ2YWwocm90YXRlVGltZXIpOyByb3RhdGVUaW1lciA9IG51bGw7IH0gfWNhdGNoKGUpe30KICB0cnl7IHJlbmRlcigpOyB9Y2F0Y2goZSl7fQogIGlmIChzY3JvbGxNb2RlID09PSAicm90YXRlIil7CiAgICByb3RhdGVUaW1lciA9IHNldEludGVydmFsKCgpPT57CiAgICAgIGlmICghZmxpZ2h0cyB8fCAhZmxpZ2h0cy5sZW5ndGgpIHJldHVybjsKICAgICAgY3VycmVudEluZGV4ID0gKGN1cnJlbnRJbmRleCArIDEpICUgZmxpZ2h0cy5sZW5ndGg7CiAgICAgIHJlbmRlcigpOwogICAgfSwgcm90YXRlRXZlcnlNcyk7CiAgfQp9CgpsZXQgdGlja2luZyA9IGZhbHNlOwphc3luYyBmdW5jdGlvbiB0aWNrKCl7CiAgaWYgKHRpY2tpbmcpIHJldHVybjsKICB0aWNraW5nID0gdHJ1ZTsKICB0cnl7CiAgICBhd2FpdCBsb2FkRmxpZ2h0cygpOwoKICAgIC8vIE9wdGlvbmFsOiBlbnJpY2ggT05MWSB0aGUgZGlzcGxheWVkIGZsaWdodCAocm91dGUgKyBleGFjdCBtb2RlbCkgd2l0aCBiYWNrb2ZmLXNhZmUgbG9va3VwCiAgICBpZiAoY3VycmVudCAmJiBjdXJyZW50LmNhbGxzaWduKXsKICAgICAgY29uc3QgZXh0cmEgPSBhd2FpdCBmZXRjaEFkc2JkYkZvckNhbGxzaWduKGN1cnJlbnQuY2FsbHNpZ24pOwogICAgICBpZiAoZXh0cmEgJiYgKGV4dHJhLm9yaWdpbiB8fCBleHRyYS5kZXN0aW5hdGlvbiB8fCBleHRyYS5yb3V0ZSkpewogICAgICAgIGNvbnN0IG8gPSBleHRyYS5vcmlnaW4/LmlhdGEgfHwgZXh0cmEub3JpZ2luPy5pY2FvIHx8ICIiOwogICAgICAgIGNvbnN0IGQgPSBleHRyYS5kZXN0aW5hdGlvbj8uaWF0YSB8fCBleHRyYS5kZXN0aW5hdGlvbj8uaWNhbyB8fCAiIjsKICAgICAgICBpZiAobyAmJiBkKXsKICAgICAgICAgIGNvbnN0IG9MYmwgPSBhaXJwb3J0TGFiZWwobyk7CiAgICAgICAgICBjb25zdCBkTGJsID0gYWlycG9ydExhYmVsKGQpOwogICAgICAgICAgY3VycmVudC5yb3V0ZVByZXR0eSA9IGAke29MYmx9IOKGkiAke2RMYmx9YDsKICAgICAgICAgIGNvbnN0IHJlZyA9IGV4dHJhLnJlZ2lzdHJhdGlvbiA/IGBSRUc6ICR7ZXh0cmEucmVnaXN0cmF0aW9ufSDigKIgYCA6ICIiOwogICAgICAgICAgY29uc3QgbWRsID0gZXh0cmEubW9kZWwgPyBgTU9ERUw6ICR7ZXh0cmEubW9kZWx9YCA6ICIiOwogICAgICAgICAgY3VycmVudC5tZXRhUHJldHR5ID0gYFNPVVJDRTogQURTQkRCIOKAoiAke3JlZ30ke21kbH1gLnRyaW0oKTsKICAgICAgICAgIGlmIChleHRyYS5tb2RlbCkgc2V0VGV4dCgibW9kZWwiLCBleHRyYS5tb2RlbCk7CiAgICAgICAgfQogICAgICB9CiAgICB9CgogICAgLy8gT25seSBhbmltYXRlIHdoZW4gdGhlIGRpc3BsYXllZCBmbGlnaHQgY2hhbmdlcyAocHJldmVudHMgZmxhc2hpbmcpCiAgICBjb25zdCBrZXkgPSAoY3VycmVudCAmJiBjdXJyZW50LmNhbGxzaWduKSA/IGN1cnJlbnQuY2FsbHNpZ24gOiBTdHJpbmcoY3VycmVudEluZGV4KTsKICAgIGlmIChrZXkgIT09IGxhc3REaXNwbGF5ZWRLZXkpeyBsYXN0RGlzcGxheWVkS2V5ID0ga2V5OyBpZiAoaGFzUmVuZGVyZWRPbmNlKSBzZXRGYWRlKCk7IH0KCiAgICBpZiAoZmxpZ2h0cy5sZW5ndGgpewogICAgICBzZXRTdGF0dXMoYFRSQUNLSU5HICR7ZmxpZ2h0cy5sZW5ndGh9IENMT1NFU1QgRkxJR0hUJHtmbGlnaHRzLmxlbmd0aD09PTE/IiI6IlMifeKApmApOwogICAgfSBlbHNlIHsKICAgICAgc2V0U3RhdHVzKCJOTyBORUFSQlkgRkxJR0hUUyIpOwogICAgfQogICAgc2V0RmFkZSgpOwogICAgcmVuZGVyKCk7CiAgICBoYXNSZW5kZXJlZE9uY2UgPSB0cnVlOwogIH1jYXRjaChlKXsKICAgIHNldFN0YXR1cygiUkFEQVIgVEVNUE9SQVJJTFkgVU5BVkFJTEFCTEUiKTsKICAgIHRyeXsKICAgICAgY29uc3QgY3VyID0gKHdpbmRvdy5fX0ZXX0NVUlJFTlRfRkxJR0hUfHxudWxsKTsKICAgICAgaWYgKGN1ciAmJiBjdXIuY2FsbHNpZ24pewogICAgICAgIGNvbnN0IGV4dHJhID0gYXdhaXQgZmV0Y2hBZHNiZGJGb3JDYWxsc2lnbihjdXIuY2FsbHNpZ24pOwogICAgICAgIGlmIChleHRyYSAmJiAoZXh0cmEub3JpZ2luIHx8IGV4dHJhLmRlc3RpbmF0aW9uIHx8IGV4dHJhLnJvdXRlKSl7CiAgICAgICAgICBjb25zdCBvID0gZXh0cmEub3JpZ2luPy5pYXRhIHx8IGV4dHJhLm9yaWdpbj8uaWNhbyB8fCAiIjsKICAgICAgICAgIGNvbnN0IGQgPSBleHRyYS5kZXN0aW5hdGlvbj8uaWF0YSB8fCBleHRyYS5kZXN0aW5hdGlvbj8uaWNhbyB8fCAiIjsKICAgICAgICAgIGlmIChvICYmIGQpewogICAgICAgICAgICBjb25zdCBvTGJsID0gYWlycG9ydExhYmVsKG8pOwogICAgICAgICAgICBjb25zdCBkTGJsID0gYWlycG9ydExhYmVsKGQpOwogICAgICAgICAgICBjdXIucm91dGVQcmV0dHkgPSBgJHtvTGJsfSDihpIgJHtkTGJsfWA7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICAgIGlmICh0eXBlb2Ygd2luZG93Ll9fRldfVVBEQVRFX0FJUkNSQUZUX1JBV19fID09PSAiZnVuY3Rpb24iKXsKICAgICAgICBhd2FpdCB3aW5kb3cuX19GV19VUERBVEVfQUlSQ1JBRlRfUkFXX18oKTsKICAgICAgfQogICAgfWNhdGNoKF9lKXt9CiAgICByZW5kZXIoKTsKICB9ZmluYWxseXsKICAgIHRpY2tpbmcgPSBmYWxzZTsKICB9Cn0KCmZ1bmN0aW9uIHN0YXJ0KCl7CiAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoImZ3LXZlcnNpb24iKS50ZXh0Q29udGVudCA9ICJ2MTUwIjsKICBob29rQ29udHJvbHMoKTsKICBkZXRlY3RMb2NhdGlvbigpOyAvLyBkb2Vzbid0IGJsb2NrCiAgc2V0U3RhdHVzKCJTQ0FOTklORyBBSVJTUEFDReKApiIpOwogIHJlbmRlcigpOwogIHRpY2soKTsKICBzZXRJbnRlcnZhbCh0aWNrLCAzMDAwKTsKICByZXN0YXJ0Um90YXRlKCk7Cn0KCmRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoIkRPTUNvbnRlbnRMb2FkZWQiLCBzdGFydCk7CgoKLy8gdjYyOiBoaWdobGlnaHQgQU5ZIGxhYmVsIHdoZW4gbWF4IHNlbGVjdGVkCihmdW5jdGlvbigpewogIGNvbnN0IHNsaWRlciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJyYW5nZSIpOwogIGNvbnN0IGxhYmVscyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJyYW5nZS1sYWJlbHMiKTsKICBpZiAoIXNsaWRlciB8fCAhbGFiZWxzKSByZXR1cm47CiAgY29uc3QgYW55RWwgPSBsYWJlbHMucXVlcnlTZWxlY3RvcigiLmFueSIpOwogIGZ1bmN0aW9uIHVwZGF0ZSgpewogICAgaWYgKE51bWJlcihzbGlkZXIudmFsdWUpID49IE51bWJlcihzbGlkZXIubWF4KSkgewogICAgICBhbnlFbC5zdHlsZS5vcGFjaXR5ID0gIjEiOwogICAgfSBlbHNlIHsKICAgICAgYW55RWwuc3R5bGUub3BhY2l0eSA9ICIuNyI7CiAgICB9CiAgfQogIHNsaWRlci5hZGRFdmVudExpc3RlbmVyKCJpbnB1dCIsIHVwZGF0ZSk7CiAgdXBkYXRlKCk7Cn0pKCk7CgoKLy8gdjYzOiBzaG93IGhpbnQgd2hlbiByYW5nZSBpcyBBTlkKKGZ1bmN0aW9uKCl7CiAgY29uc3Qgc2xpZGVyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoInJhbmdlIik7CiAgY29uc3QgaGludCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJyYW5nZS1oaW50Iik7CiAgaWYgKCFzbGlkZXIgfHwgIWhpbnQpIHJldHVybjsKICBmdW5jdGlvbiB1cGRhdGUoKXsKICAgIGlmIChOdW1iZXIoc2xpZGVyLnZhbHVlKSA+PSBOdW1iZXIoc2xpZGVyLm1heCkpIHsKICAgICAgaGludC50ZXh0Q29udGVudCA9ICJBTlk6IHNob3dpbmcgdGhlIGNsb3Nlc3QgYWlyY3JhZnQgYW55d2hlcmUiOwogICAgfSBlbHNlIHsKICAgICAgaGludC50ZXh0Q29udGVudCA9ICIiOwogICAgfQogIH0KICBzbGlkZXIuYWRkRXZlbnRMaXN0ZW5lcigiaW5wdXQiLCB1cGRhdGUpOwogIHVwZGF0ZSgpOwp9KSgpOwoKCi8vIHY2NjogcmFuZ2UgVUkgKEFOWSBsYWJlbCArIGhpbnQpCmZ1bmN0aW9uIHVwZGF0ZVJhbmdlVUkoKXsgLyogdjgwIHJlbW92ZWQgKi8gfQoKCi8vIHY2ODogc2hvdyBuZXh0IDQgZmxpZ2h0cyBhcyBib3hlcyB1bmRlciBtYWluIGNhcmQgKG5vIHRpY2tlcikKZnVuY3Rpb24gdXBkYXRlU2Vjb25kYXJ5Qm94ZXMocXVldWUsIGN1cnJlbnRJbmRleCl7CiAgY29uc3QgaWRzID0gWyJzZWMxIiwic2VjMiIsInNlYzMiLCJzZWM0Il07CiAgZm9yIChsZXQgaT0wO2k8NDtpKyspewogICAgY29uc3QgZWwgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChpZHNbaV0pOwogICAgaWYgKCFlbCkgY29udGludWU7CiAgICBjb25zdCBjc0VsID0gZWwucXVlcnlTZWxlY3RvcigiLnNlY0NTIik7CiAgICBjb25zdCBtaW5pRWwgPSBlbC5xdWVyeVNlbGVjdG9yKCIuc2VjTWluaSIpOwoKICAgIGlmICghcXVldWUgfHwgcXVldWUubGVuZ3RoIDwgMil7CiAgICAgIGlmIChjc0VsKSBjc0VsLnRleHRDb250ZW50ID0gIuKAlCI7CiAgICAgIGlmIChtaW5pRWwpIG1pbmlFbC50ZXh0Q29udGVudCA9ICLigJQiOwogICAgICBjb250aW51ZTsKICAgIH0KICAgIGNvbnN0IGYgPSBxdWV1ZVsoY3VycmVudEluZGV4ICsgMSArIGkpICUgcXVldWUubGVuZ3RoXTsKICAgIGlmICghZil7CiAgICAgIGlmIChjc0VsKSBjc0VsLnRleHRDb250ZW50ID0gIuKAlCI7CiAgICAgIGlmIChtaW5pRWwpIG1pbmlFbC50ZXh0Q29udGVudCA9ICLigJQiOwogICAgICBjb250aW51ZTsKICAgIH0KICAgIGNvbnN0IGNzID0gZi5jYWxsc2lnbiB8fCAi4oCUIjsKICAgIGNvbnN0IGRpc3QgPSBOdW1iZXIuaXNGaW5pdGUoZi5kaXN0KSA/IGAke01hdGgucm91bmQoZi5kaXN0KX1NSWAgOiAi4oCUIjsKICAgIGNvbnN0IGJyZyA9IE51bWJlci5pc0Zpbml0ZShmLnRyaykgPyBkaXJUZXh0KGYudHJrKSA6ICLigJQiOwogICAgY29uc3QgYWx0ID0gTnVtYmVyLmlzRmluaXRlKGYuYWx0RnQpID8gYCR7TWF0aC5yb3VuZChmLmFsdEZ0KX1GVGAgOiAi4oCUIjsKICAgIGNvbnN0IHNwZCA9IE51bWJlci5pc0Zpbml0ZShmLnNwZE1waCkgPyBgJHtNYXRoLnJvdW5kKGYuc3BkTXBoKX1NUEhgIDogIuKAlCI7CiAgICBjb25zdCBtaW5pID0gYCR7ZGlzdH0gJHticmd9IOKAoiAke2FsdH0g4oCiICR7c3BkfWA7CgogICAgaWYgKGNzRWwgJiYgY3NFbC50ZXh0Q29udGVudCAhPT0gY3MpIGNzRWwudGV4dENvbnRlbnQgPSBjczsKICAgIGlmIChtaW5pRWwgJiYgbWluaUVsLnRleHRDb250ZW50ICE9PSBtaW5pKSBtaW5pRWwudGV4dENvbnRlbnQgPSBtaW5pOwogIH0KfQoKCi8vIHY2OTogYmVhcmluZyB0byBjb21wYXNzCmZ1bmN0aW9uIGNvbXBhc3NGcm9tQmVhcmluZyhkZWcpewogIGlmICghaXNGaW5pdGUoZGVnKSkgcmV0dXJuICLigJQiOwogIGNvbnN0IGRpcnMgPSBbIk4iLCJORSIsIkUiLCJTRSIsIlMiLCJTVyIsIlciLCJOVyJdOwogIGNvbnN0IGlkeCA9IE1hdGgucm91bmQoKChkZWcgJSAzNjApIC8gNDUpKSAlIDg7CiAgcmV0dXJuIGRpcnNbaWR4XTsKfQoKCmZ1bmN0aW9uIHJvdGF0ZVN0ZXAoKXsKICBpZiAoIXF1ZXVlIHx8ICFxdWV1ZS5sZW5ndGgpIHJldHVybjsKICBjdXJyZW50SW5kZXggPSAoY3VycmVudEluZGV4ICsgMSkgJSBxdWV1ZS5sZW5ndGg7CiAgcmVuZGVyQ3VycmVudCgpOwp9CgoKLy8gdjgwOiB0b2dnbGVzIChwYXNzZW5nZXIgYWlybGluZXMgb25seSArIHNjcm9sbDUpCihmdW5jdGlvbigpewogIGNvbnN0IGMgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgiY29tbWVyY2lhbE9ubHkiKTsKICBjb25zdCBzID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoInNjcm9sbDUiKTsKICBmdW5jdGlvbiBzeW5jKCl7CiAgICBDT01NRVJDSUFMX09OTFkgPSBjID8gISFjLmNoZWNrZWQgOiB0cnVlOwogICAgU0NST0xMNSA9IHMgPyAhIXMuY2hlY2tlZCA6IGZhbHNlOwogICAgc2Nyb2xsTW9kZSA9IFNDUk9MTDUgPyAicm90YXRlIiA6ICJjbG9zZXN0IjsKICAgIGN1cnJlbnRJbmRleCA9IDA7CiAgICByZXN0YXJ0Um90YXRlKCk7CiAgfQogIGlmIChjKSBjLmFkZEV2ZW50TGlzdGVuZXIoImNoYW5nZSIsIHN5bmMpOwogIGlmIChzKSBzLmFkZEV2ZW50TGlzdGVuZXIoImNoYW5nZSIsIHN5bmMpOwogIHN5bmMoKTsKfSkoKTsKCgpmdW5jdGlvbiBhcHBseUZpbHRlcnNBbmRMaW1pdCgpewogIC8vIHY5NDogc2hvdyBjb3VudHMgKyBmYWxsYmFjayBzbyB0aGUgc2NyZWVuIG5ldmVyIGdvZXMgYmxhbmsgZHVlIHRvIGZpbHRlcmluZwogIGNvbnN0IHN0YXR1c0VsID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoInN0YXR1cyIpOwogIGNvbnN0IHJhdyA9ICh0eXBlb2Ygd2luZG93Ll9fZndfcmF3RmxpZ2h0cyAhPT0gInVuZGVmaW5lZCIgJiYgd2luZG93Ll9fZndfcmF3RmxpZ2h0cykgPyB3aW5kb3cuX19md19yYXdGbGlnaHRzIDogKHdpbmRvdy5fX2Z3X3Jhd0ZsaWdodHMgfHwgW10pOwogIHdpbmRvdy5fX2Z3X3Jhd0ZsaWdodHMgPSByYXc7CgogIGNvbnN0IHBhc3Nlbmdlck9ubHkgPSAhISh3aW5kb3cuRldfU1RBVEUgJiYgd2luZG93LkZXX1NUQVRFLnBhc3Nlbmdlck9ubHkpOwogIGxldCBmaWx0ZXJlZCA9IHJhdzsKCiAgaWYgKHBhc3Nlbmdlck9ubHkpIHsKICAgIGNvbnN0IHBhc3Nlbmdlck1hdGNoZXMgPSByYXcuZmlsdGVyKGYgPT4gaXNDb21tZXJjaWFsQ2FsbHNpZ24oZiAmJiBmLmNhbGxzaWduKSk7CiAgICBmaWx0ZXJlZCA9IHBhc3Nlbmdlck1hdGNoZXM7CgogICAgaWYgKHBhc3Nlbmdlck1hdGNoZXMubGVuZ3RoID09PSAwICYmIHJhdy5sZW5ndGggPiAwKSB7CiAgICAgIC8vIGZhbGxiYWNrIHNvIHVzZXIgc2VlcyAqc29tZXRoaW5nKiAoY2FsbHNpZ25zIG1heSBiZSBtaXNzaW5nIG9yIG1peCBpcyBub24tcGFzc2VuZ2VyKQogICAgICBmaWx0ZXJlZCA9IHJhdzsKICAgICAgaWYgKHN0YXR1c0VsKSBzdGF0dXNFbC50ZXh0Q29udGVudCA9IGBSYWRhcjogJHtyYXcubGVuZ3RofSBmbGlnaHRzIChubyBwYXNzZW5nZXIgbWF0Y2hlcyDigJQgc2hvd2luZyBjbG9zZXN0IG92ZXJhbGwpYDsKICAgIH0gZWxzZSB7CiAgICAgIGlmIChzdGF0dXNFbCkgc3RhdHVzRWwudGV4dENvbnRlbnQgPSBgUmFkYXI6ICR7cmF3Lmxlbmd0aH0gZmxpZ2h0cyDigKIgU2hvd2luZyBwYXNzZW5nZXI6ICR7TWF0aC5taW4oNSwgcGFzc2VuZ2VyTWF0Y2hlcy5sZW5ndGgpfWA7CiAgICB9CiAgfSBlbHNlIHsKICAgIGlmIChzdGF0dXNFbCkgc3RhdHVzRWwudGV4dENvbnRlbnQgPSBgUmFkYXI6ICR7cmF3Lmxlbmd0aH0gZmxpZ2h0cyDigKIgU2hvd2luZzogJHtNYXRoLm1pbig1LCByYXcubGVuZ3RoKX1gOwogIH0KCiAgLy8gU29ydCBieSBkaXN0YW5jZSBpZiBwcmVzZW50CiAgZmlsdGVyZWQgPSBmaWx0ZXJlZC5zbGljZSgpLnNvcnQoKGEsYik9PiAoYT8uZGlzdGFuY2VfbWkgPz8gYT8uZGlzdGFuY2UgPz8gMWU5KSAtIChiPy5kaXN0YW5jZV9taSA/PyBiPy5kaXN0YW5jZSA/PyAxZTkpKTsKCiAgZmxpZ2h0cyA9IGZpbHRlcmVkLnNsaWNlKDAsIDUpOwp9CgovLyB2ODM6IHJlZ2lvbmFsIGFpcmxpbmUgZ3JvdXBpbmcKY29uc3QgUkVHSU9OQUxfUEFSRU5UX01BUCA9IHsKICAnRU5ZJzonQW1lcmljYW4nLCAnSklBJzonQW1lcmljYW4nLCAnUERUJzonQW1lcmljYW4nLCAnUlBBJzonQW1lcmljYW4nLAogICdFRFYnOidEZWx0YScsICdHSlMnOidEZWx0YScsICdTS1cnOidEZWx0YScsCiAgJ0FTSCc6J1VuaXRlZCcsICdBV0knOidVbml0ZWQnLCAnQ1BaJzonVW5pdGVkJywKICAnUVhFJzonQWxhc2thJwp9OwoKZnVuY3Rpb24gcmVzb2x2ZUFpcmxpbmVOYW1lKGYpewogIGNvbnN0IGNzID0gKGYuY2FsbHNpZ258fCcnKS50b1VwcGVyQ2FzZSgpOwogIGNvbnN0IHByZWYgPSBjcy5zbGljZSgwLDMpOwogIGlmIChSRUdJT05BTF9QQVJFTlRfTUFQW3ByZWZdKSByZXR1cm4gUkVHSU9OQUxfUEFSRU5UX01BUFtwcmVmXTsKICByZXR1cm4gZi5haXJsaW5lIHx8IHByZWYgfHwgJ+KAlCc7Cn0KCgpmdW5jdGlvbiB1cGRhdGVMYXN0VXBkYXRlKCl7CiAgY29uc3QgZWwgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgibGFzdFVwZGF0ZSIpOwogIGNvbnN0IGRvdCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJsaXZlSW5kaWNhdG9yIik7CiAgaWYgKCFlbCkgcmV0dXJuOwogIGNvbnN0IGQgPSBuZXcgRGF0ZSgpOwogIGVsLnRleHRDb250ZW50ID0gIkxBU1QgVVBEQVRFOiAiICsgZC50b0xvY2FsZVRpbWVTdHJpbmcoW10sIHtob3VyOicyLWRpZ2l0JywgbWludXRlOicyLWRpZ2l0Jywgc2Vjb25kOicyLWRpZ2l0J30pOwogIGlmIChkb3QpewogICAgZG90LmNsYXNzTGlzdC5yZW1vdmUoInB1bHNlIik7CiAgICB2b2lkIGRvdC5vZmZzZXRXaWR0aDsgLy8gcmVzdGFydCBhbmltYXRpb24KICAgIGRvdC5jbGFzc0xpc3QuYWRkKCJwdWxzZSIpOwogIH0KfQ==";

function b64DecodeUtf8(b64) {
  const bin = atob(b64);
  // Convert binary string to Uint8Array then decode
  const bytes = new Uint8Array(bin.length);
  for (let i = 0; i < bin.length; i++) bytes[i] = bin.charCodeAt(i);
  return new TextDecoder("utf-8").decode(bytes);
}


function pickBestFlight(data){
  if (!Array.isArray(data)) return data;
  // Prefer entries that contain both departure & arrival airport objects.
  const withAirports = data.filter(f => f?.departure?.airport && f?.arrival?.airport);
  const pool = withAirports.length ? withAirports : data;
  const score = (f) => {
    const s = String(f?.status || f?.flightStatus || "").toLowerCase();
    const active = (s.includes("enroute") || s.includes("en route") || s.includes("active") || s.includes("airborne")) ? 1000 : 0;
    const t =
      Date.parse(f?.lastUpdatedUtc || f?.lastUpdated || "") ||
      Date.parse(f?.departure?.actualTimeUtc || "") ||
      Date.parse(f?.departure?.scheduledTimeUtc || "") ||
      Date.parse(f?.departure?.scheduledTimeLocal || "") ||
      0;
    return active + (t/1000);
  };
  let best = pool[0];
  let bestScore = -1;
  for (const f of pool){
    const sc = score(f);
    if (sc > bestScore){
      bestScore = sc;
      best = f;
    }
  }
  return best;
}
function fmtEnd(airport){
  if (!airport || typeof airport !== "object") return "";
  const city = (airport.municipalityName || airport.city || "").toString().trim();
  const code = (airport.iata || airport.icao || "").toString().trim();
  const name = (airport.name || "").toString().trim();
  const bestCity = city || (name ? name.split(" ")[0] : "");
  if (bestCity && code) return `${bestCity} (${code})`;
  return bestCity || code || "";
}

export default {
  async fetch(request, env, ctx) {
    const url = new URL(request.url);
    const parts = url.pathname.split("/").filter(Boolean);
    const cache = caches.default;

    const corsHeaders = {
      "Access-Control-Allow-Origin": "*",
      "Access-Control-Allow-Methods": "GET,HEAD,OPTIONS",
      "Access-Control-Allow-Headers": "Content-Type, Authorization",
      "Access-Control-Max-Age": "86400",
      "Vary": "Origin"
    };

    if (request.method === "OPTIONS") {
      return new Response(null, { status: 204, headers: corsHeaders });
    }

    // ---------- Static UI ----------
    if (url.pathname === "/" || url.pathname === "/index.html") {
      return new Response(b64DecodeUtf8(__B64_INDEX), {
        status: 200,
        headers: {
          "Content-Type": "text/html; charset=utf-8",
          "Cache-Control": "no-store"
        }
      });
    }
    if (url.pathname === "/style.css") {
      return new Response(b64DecodeUtf8(__B64_CSS), {
        status: 200,
        headers: {
          "Content-Type": "text/css; charset=utf-8",
          "Cache-Control": "public, max-age=3600"
        }
      });
    }
    if (url.pathname === "/app.js") {
      return new Response(b64DecodeUtf8(__B64_JS), {
        status: 200,
        headers: {
          "Content-Type": "application/javascript; charset=utf-8",
          "Cache-Control": "public, max-age=3600"
        }
      });
    }

    // ---------- Health ----------
    if (url.pathname === "/health") {
      return json({ ok: true, ts: new Date().toISOString(), version: "v150" }, 200, corsHeaders);
    }

    // ---------- OpenSky proxy ----------
    if (parts[0] === "opensky" && parts[1] === "states") {
      const lamin = url.searchParams.get("lamin");
      const lomin = url.searchParams.get("lomin");
      const lamax = url.searchParams.get("lamax");
      const lomax = url.searchParams.get("lomax");

      if (!lamin || !lomin || !lamax || !lomax) {
        return json({ ok:false, error:"missing bbox params", hint:"lamin,lomin,lamax,lomax required" }, 400, corsHeaders);
      }

      const upstream = new URL("https://opensky-network.org/api/states/all");
      upstream.searchParams.set("lamin", lamin);
      upstream.searchParams.set("lomin", lomin);
      upstream.searchParams.set("lamax", lamax);
      upstream.searchParams.set("lomax", lomax);

      const headers = { "Accept": "application/json" };

      try {
        if (env.OPENSKY_CLIENT_ID && env.OPENSKY_CLIENT_SECRET) {
          const bearer = await getOpenSkyBearer(env);
          headers["Authorization"] = `Bearer ${bearer}`;
        }
      } catch (e) {
        return json({ ok:false, error:"opensky_token_fetch_failed", detail: (e && e.message) ? e.message : "unknown" }, 502, corsHeaders);
      }

      try {
        const res = await fetch(upstream.toString(), { method:"GET", headers });
        const text = await res.text();
        if (!res.ok) {
          return json({ ok:false, error:"opensky_upstream_error", status: res.status, detail: text.slice(0,300) }, 502, corsHeaders);
        }

        return new Response(text, {
          status: 200,
          headers: {
            ...corsHeaders,
            "Content-Type": "application/json; charset=utf-8",
            "Cache-Control": "public, max-age=2, s-maxage=8"
          }
        });
      } catch (err) {
        return json({ ok:false, error:"opensky_fetch_failed", detail: (err && err.message) ? err.message : "unknown" }, 502, corsHeaders);
      }
    }

    // ---------- AeroDataBox route lookup (EDGE CACHED) ----------
    if (parts[0] === "aero") {
      const callsign = (parts[1] || url.searchParams.get("callsign") || "").trim().toUpperCase();
      if (!callsign) {
        return json({ ok:false, error:"missing callsign", hint:"Use /aero/ENY3861" }, 400, corsHeaders);
      }
      if (!env.AERODATA_KEY || !env.AERODATA_HOST) {
        return json({ ok:false, error:"aerodata_not_configured", hint:"Set AERODATA_KEY and AERODATA_HOST" }, 500, corsHeaders);
      }

      const cacheKey = new Request(`https://edgecache/route/${callsign}`);
      const hit = await cache.match(cacheKey);
      if (hit) return hit;

      const upstreamUrl = `https://${env.AERODATA_HOST}/flights/callsign/${encodeURIComponent(callsign)}`;
      try {
        const res = await fetch(upstreamUrl, {
          method: "GET",
          headers: {
            "Accept": "application/json",
            "X-RapidAPI-Key": String(env.AERODATA_KEY),
            "X-RapidAPI-Host": String(env.AERODATA_HOST),
          }
        });

        const text = await res.text();
        if (res.status === 429) {
          return json({ ok:false, callsign, error:"rate_limited", status: 429 }, 429, corsHeaders);
        }
        if (!res.ok) {
          return json({ ok:false, callsign, error:"aerodata_upstream_error", status: res.status, detail: text.slice(0,200) }, 502, corsHeaders);
        }

        let data;
        try { data = JSON.parse(text); }
        catch { return json({ ok:false, callsign, error:"aerodata_non_json" }, 502, corsHeaders); }

        const f = pickBestFlight(data);
        const origin = f?.departure?.airport || null;
        const destination = f?.arrival?.airport || null;

        const body = JSON.stringify({
          ok: true,
          callsign,
          origin,
          destination,
          route: ((origin && destination) ? (fmtEnd(origin) + " \u2192 " + fmtEnd(destination)) : "unavailable"),
          source: "aerodatabox"
        });

        const resp = new Response(body, {
          status: 200,
          headers: {
            ...corsHeaders,
            "Content-Type": "application/json; charset=utf-8",
            "Cache-Control": `private, max-age=${ROUTE_TTL}`
          }
        });

        ctx.waitUntil(cache.put(cacheKey, resp.clone()));
        return resp;

      } catch (err) {
        return json({ ok:false, callsign, error:"aerodata_fetch_failed", detail: (err && err.message) ? err.message : "unknown" }, 502, corsHeaders);
      }
    }

    // ---------- AeroDataBox aircraft details (EDGE CACHED) ----------
    if (parts[0] === "aircraft" && parts[1] === "icao24") {
      const hex = (parts[2] || "").trim().toLowerCase();
      if (!hex) {
        return json({ ok:false, error:"missing icao24", hint:"Use /aircraft/icao24/a26b4a" }, 400, corsHeaders);
      }
      if (!env.AERODATA_KEY || !env.AERODATA_HOST) {
        return json({ ok:false, error:"aerodata_not_configured", hint:"Set AERODATA_KEY and AERODATA_HOST" }, 500, corsHeaders);
      }

      const cacheKey = new Request(`https://edgecache/aircraft/${hex}`);
      const hit = await cache.match(cacheKey);
      if (hit) return hit;

      const upstreamUrl = `https://${env.AERODATA_HOST}/aircrafts/icao24/${encodeURIComponent(hex)}`;

      try {
        const res = await fetch(upstreamUrl, {
          method: "GET",
          headers: {
            "Accept": "application/json",
            "X-RapidAPI-Key": String(env.AERODATA_KEY),
            "X-RapidAPI-Host": String(env.AERODATA_HOST),
          }
        });

        if (res.status === 204) {
          const resp = new Response(JSON.stringify({ ok: true, found: false, icao24: hex }), {
            status: 200,
            headers: {
              ...corsHeaders,
              "Content-Type": "application/json; charset=utf-8",
              "Cache-Control": `private, max-age=${60*60}`
            }
          });
          ctx.waitUntil(cache.put(cacheKey, resp.clone()));
          return resp;
        }

        const text = await res.text();

        if (res.status === 429) {
          return json({ ok:false, icao24: hex, error:"rate_limited", status: 429 }, 429, corsHeaders);
        }
        if (!res.ok) {
          return json({ ok:false, icao24: hex, error:"aerodata_upstream_error", status: res.status, detail: text.slice(0,200) }, 502, corsHeaders);
        }

        let raw = null;
        try { raw = JSON.parse(text); } catch { raw = null; }
        const a = raw?.aircraft ? raw.aircraft : raw;

        const payload = {
          ok: true,
          found: true,
          icao24: hex,
          model: a?.model || a?.typeName || a?.aircraftModel || null,
          modelCode: a?.modelCode || null,
          registration: a?.registration || a?.reg || null,
          manufacturer: a?.manufacturer || null,
          source: "aerodatabox"
        };

        const resp = new Response(JSON.stringify(payload), {
          status: 200,
          headers: {
            ...corsHeaders,
            "Content-Type": "application/json; charset=utf-8",
            "Cache-Control": `private, max-age=${AIRCRAFT_TTL}`
          }
        });

        ctx.waitUntil(cache.put(cacheKey, resp.clone()));
        return resp;

      } catch (err) {
        return json({ ok:false, icao24: hex, error:"aerodata_fetch_failed", detail: (err && err.message) ? err.message : "unknown" }, 502, corsHeaders);
      }
    }

    return new Response("not found", { status: 404, headers: corsHeaders });
  }
};

async function getOpenSkyBearer(env) {
  const now = Date.now();
  if (__openskyTokenCache.token && now < (__openskyTokenCache.expMs - 60_000)) {
    return __openskyTokenCache.token;
  }

  const tokenUrl = "https://auth.opensky-network.org/auth/realms/opensky-network/protocol/openid-connect/token";

  const body = new URLSearchParams();
  body.set("grant_type", "client_credentials");
  body.set("client_id", String(env.OPENSKY_CLIENT_ID));
  body.set("client_secret", String(env.OPENSKY_CLIENT_SECRET));

  const res = await fetch(tokenUrl, {
    method: "POST",
    headers: { "Content-Type": "application/x-www-form-urlencoded" },
    body
  });

  const text = await res.text();
  if (!res.ok) {
    throw new Error(`opensky_token_error ${res.status}: ${text.slice(0,200)}`);
  }

  const data = JSON.parse(text);
  __openskyTokenCache.token = data.access_token;
  __openskyTokenCache.expMs = now + Number(data.expires_in || 1800) * 1000;
  return __openskyTokenCache.token;
}

function json(obj, status, corsHeaders) {
  return new Response(JSON.stringify(obj), {
    status,
    headers: {
      ...corsHeaders,
      "Content-Type": "application/json; charset=utf-8",
      "Cache-Control": "no-store"
    }
  });
}
