/**
 * flightsabove Worker (v149)
 *
 * Serves the UI from the Worker (same-origin) + API endpoints:
 *  - /opensky/states
 *  - /aero/<CALLSIGN>
 *  - /aircraft/icao24/<HEX>
 *  - /health
 *
 * Required env vars:
 *   AERODATA_KEY (Secret)
 *   AERODATA_HOST (Text)  aerodatabox.p.rapidapi.com
 *
 * OpenSky OAuth2 (recommended):
 *   OPENSKY_CLIENT_ID (Text/Secret)
 *   OPENSKY_CLIENT_SECRET (Secret)
 */

const ROUTE_TTL = 60 * 15;          // 15 min edge cache
const AIRCRAFT_TTL = 60 * 60 * 24;  // 24 h edge cache
let __openskyTokenCache = { token: null, expMs: 0 };

// Embedded static assets (base64 so we serve the exact files with no escaping issues)
const __B64_INDEX = "PCFkb2N0eXBlIGh0bWw+CjxodG1sIGxhbmc9ImVuIj4KPGhlYWQ+CiAgICA8bWV0YSBodHRwLWVxdWl2PSJDYWNoZS1Db250cm9sIiBjb250ZW50PSJuby1zdG9yZSwgbm8tY2FjaGUsIG11c3QtcmV2YWxpZGF0ZSwgbWF4LWFnZT0wIiAvPgogICAgPG1ldGEgaHR0cC1lcXVpdj0iUHJhZ21hIiBjb250ZW50PSJuby1jYWNoZSIgLz4KICAgIDxtZXRhIGh0dHAtZXF1aXY9IkV4cGlyZXMiIGNvbnRlbnQ9IjAiIC8+CiAgPG1ldGEgY2hhcnNldD0idXRmLTgiIC8+CiAgPG1ldGEgbmFtZT0idmlld3BvcnQiIGNvbnRlbnQ9IndpZHRoPWRldmljZS13aWR0aCwgaW5pdGlhbC1zY2FsZT0xIiAvPgogIDx0aXRsZT5GbGlnaHRzIEFib3ZlPC90aXRsZT4KICA8bGluayByZWw9InN0eWxlc2hlZXQiIGhyZWY9InN0eWxlLmNzcz92PTE0OSI+CiAgPHNjcmlwdD4KICAgIC8vIEJvb3QgbWFya2VyIChwcm92ZXMgbGF0ZXN0IEhUTUwpCiAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCJET01Db250ZW50TG9hZGVkIiwgKCkgPT4gewogICAgICBjb25zdCBzdCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJmdy1zdGF0dXMiKTsKICAgICAgaWYgKHN0KSBzdC50ZXh0Q29udGVudCA9ICJCb290aW5nIHYxNDnigKYiOwogICAgICBjb25zdCB2ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoImZ3LXZlcnNpb24iKTsKICAgICAgaWYgKHYpIHYudGV4dENvbnRlbnQgPSAidjE0OSI7CiAgICB9KTsKICA8L3NjcmlwdD4KPC9oZWFkPgo8Ym9keT4KICA8bWFpbiBjbGFzcz0id3JhcCI+CiAgICA8aGVhZGVyIGNsYXNzPSJ0b3BiYXIiPgogICAgICA8ZGl2IGNsYXNzPSJicmFuZCI+CiAgICAgICAgPGRpdiBjbGFzcz0iYnJhbmQtdGl0bGUiPkZMSUdIVFMgQUJPVkU8L2Rpdj4KICAgICAgICA8ZGl2IGNsYXNzPSJicmFuZC1zdWIiIGlkPSJob21lTGluZSI+4oCUPC9kaXY+CiAgICAgIDwvZGl2PgoKICAgICAgCiAgICAgIDxkaXYgY2xhc3M9ImNvbnRyb2xzIj4KICAgICAgICA8ZGl2IGNsYXNzPSJyYW5nZS1oaW50IiBpZD0icmFuZ2UtaGludCI+PC9kaXY+CiAgICAgIDwvZGl2PgoKICAgICAgICA8ZGl2IGNsYXNzPSJjb250cm9sc1JvdyI+CiAgICAgICAgICA8bGFiZWwgY2xhc3M9ImN0bENoZWNrIj4KICAgICAgICAgICAgPGlucHV0IHR5cGU9ImNoZWNrYm94IiBpZD0iY29tbWVyY2lhbE9ubHkiIGNoZWNrZWQ+CiAgICAgICAgICAgIDxzcGFuPlBBU1NFTkdFUiBBSVJMSU5FUyBPTkxZPC9zcGFuPgogICAgICAgICAgPC9sYWJlbD4KICAgICAgICAgIDxsYWJlbCBjbGFzcz0iY3RsQ2hlY2siPgogICAgICAgICAgICA8L2xhYmVsPgogICAgICAgIDwvZGl2PgoKICA8ZGl2IGNsYXNzPSJsaXZlV3JhcCI+PHNwYW4gaWQ9ImxpdmVJbmRpY2F0b3IiIGNsYXNzPSJsaXZlRG90Ij48L3NwYW4+PGRpdiBpZD0ibGFzdFVwZGF0ZSIgY2xhc3M9Imxhc3RVcGRhdGUiPkxBU1QgVVBEQVRFOiAtLTwvZGl2Pgo8L2Rpdj48L2hlYWRlcj4KCjxzZWN0aW9uIGNsYXNzPSJjYXJkIGZ3LWZhZGUiIGlkPSJjYXJkIj4KICAgICAgPGRpdiBjbGFzcz0icm93MSI+CiAgICAgICAgPGRpdiBjbGFzcz0ibG9nbyIgaWQ9ImxvZ28iIGFyaWEtbGFiZWw9IkFpcmxpbmUgbG9nbyI+4pyIPC9kaXY+CiAgICAgICAgPGRpdiBjbGFzcz0iYWlybGluZS1uYW1lIiBpZD0iYWlybGluZS1uYW1lIj7igJQ8L2Rpdj4KICAgICAgICA8ZGl2IGNsYXNzPSJhaXJsaW5lLXN1YiIgaWQ9ImFpcmxpbmUtc3ViIj4gPC9kaXY+CiAgICAgICAgPGRpdiBjbGFzcz0iY2FsbHNpZ24iIGlkPSJjcyI+4oCUPC9kaXY+CiAgICAgICAgPGRpdiBjbGFzcz0icmlnaHRCb3giPgogICAgICAgICAgPGRpdiBjbGFzcz0ibGVnZW5kIiBpZD0ibGVnZW5kIj4KICAgICAgICAgICAgPGRpdiBjbGFzcz0ibGctcm93Ij48c3BhbiBjbGFzcz0iZG90IHZlcmlmaWVkIj7inJM8L3NwYW4+PC9kaXY+CiAgICAgICAgICAgIDxkaXYgY2xhc3M9ImxnLXJvdyI+PC9kaXY+CiAgICAgICAgICA8L2Rpdj4KICAgICAgICA8L2Rpdj4KICAgICAgPC9kaXY+CgogICAgICA8ZGl2IGNsYXNzPSJyb3cyIj4KICAgICAgICA8ZGl2IGNsYXNzPSJyb3V0ZSIgaWQ9InJvdXRlIj7igJQ8L2Rpdj4KICAgICAgICA8ZGl2IGNsYXNzPSJtb2RlbCIgaWQ9Im1vZGVsIj7igJQ8L2Rpdj4KICAgICAgICA8ZGl2IGlkPSJtb2RlbDIiIGNsYXNzPSJtb2RlbDIiPjwvZGl2PgogICAgICA8L2Rpdj4KCiAgICAgIDxkaXYgY2xhc3M9InN0YXRzIj4KICAgICAgICA8ZGl2IGNsYXNzPSJrdiI+CiAgICAgICAgICA8ZGl2IGNsYXNzPSJrIj5BTFQ8L2Rpdj4KICAgICAgICAgIDxkaXYgY2xhc3M9InYiIGlkPSJhbHQiPuKAlDwvZGl2PgogICAgICAgIDwvZGl2PgogICAgICAgIDxkaXYgY2xhc3M9Imt2Ij4KICAgICAgICAgIDxkaXYgY2xhc3M9ImsiPlNQRDwvZGl2PgogICAgICAgICAgPGRpdiBjbGFzcz0idiIgaWQ9InNwZCI+4oCUPC9kaXY+CiAgICAgICAgPC9kaXY+CiAgICAgICAgPGRpdiBjbGFzcz0ia3YiPgogICAgICAgICAgPGRpdiBjbGFzcz0iayI+RElTVDwvZGl2PgogICAgICAgICAgPGRpdiBjbGFzcz0idiIgaWQ9ImRpc3QiPuKAlDwvZGl2PgogICAgICAgIDwvZGl2PgogICAgICAgIDxkaXYgY2xhc3M9Imt2Ij4KICAgICAgICAgIDxkaXYgY2xhc3M9ImsiPkRJUjwvZGl2PgogICAgICAgICAgPGRpdiBjbGFzcz0idiIgaWQ9ImRpciI+4oCUPC9kaXY+CiAgICAgICAgPC9kaXY+CiAgICAgIDwvZGl2PgoKICAgICAgPGRpdiBjbGFzcz0ibWV0YSIgaWQ9Im1ldGEiPuKAlDwvZGl2PgogICAgPC9zZWN0aW9uPgoKCiAgICA8IS0tIHY3OTogYm90dG9tIDQgY2xvc2VzdCBmbGlnaHRzIC0tPgogICAgPHNlY3Rpb24gY2xhc3M9InNlY29uZGFyeUdyaWQiIGlkPSJzZWNvbmRhcnlHcmlkIiBhcmlhLWxhYmVsPSJOZWFyYnkgZmxpZ2h0cyI+CiAgICAgIDxkaXYgY2xhc3M9InNlY29uZGFyeUJveCIgaWQ9InNlYzEiPjxkaXYgY2xhc3M9InNlY0NTIj7igJQ8L2Rpdj48ZGl2IGNsYXNzPSJzZWNNaW5pIj7igJQ8L2Rpdj48L2Rpdj4KICAgICAgPGRpdiBjbGFzcz0ic2Vjb25kYXJ5Qm94IiBpZD0ic2VjMiI+PGRpdiBjbGFzcz0ic2VjQ1MiPuKAlDwvZGl2PjxkaXYgY2xhc3M9InNlY01pbmkiPuKAlDwvZGl2PjwvZGl2PgogICAgICA8ZGl2IGNsYXNzPSJzZWNvbmRhcnlCb3giIGlkPSJzZWMzIj48ZGl2IGNsYXNzPSJzZWNDUyI+4oCUPC9kaXY+PGRpdiBjbGFzcz0ic2VjTWluaSI+4oCUPC9kaXY+PC9kaXY+CiAgICAgIDxkaXYgY2xhc3M9InNlY29uZGFyeUJveCIgaWQ9InNlYzQiPjxkaXYgY2xhc3M9InNlY0NTIj7igJQ8L2Rpdj48ZGl2IGNsYXNzPSJzZWNNaW5pIj7igJQ8L2Rpdj48L2Rpdj4KICAgIDwvc2VjdGlvbj4KCgo8Zm9vdGVyIGNsYXNzPSJmb290ZXIiPgogICAgICA8ZGl2IGNsYXNzPSJzdGF0dXMiIGlkPSJmdy1zdGF0dXMiPlN0YXJ0aW5n4oCmPC9kaXY+CiAgICAgIDxkaXYgY2xhc3M9InZlcnNpb24iIGlkPSJmdy12ZXJzaW9uIj52MTQ5PC9kaXY+CiAgICA8L2Zvb3Rlcj4KCjwvZGl2PgogICAgICAgICAgPC9kaXY+PC9kaXY+CjwvZGl2PgogICAgICAgICAgPC9kaXY+PC9kaXY+CjwvZGl2PgogICAgICAgICAgPC9kaXY+PC9kaXY+CjwvZGl2PgogICAgICAgICAgPC9kaXY+PC9kaXY+CiAgICAgIDwvZGl2Pgo8L2Rpdj4KICAgICAgICA8L2Rpdj4KPC9kaXY+CiAgICAgICAgPC9kaXY+CjwvZGl2PgogICAgICAgIDwvZGl2Pgo8L2Rpdj4KICAgICAgICA8L2Rpdj4KICAgIDwvZGl2Pgo8L2Rpdj48L2Rpdj4KPC9kaXY+PC9kaXY+CjwvZGl2PjwvZGl2Pgo8L2Rpdj48L2Rpdj4KICAgIDwvZGl2PgoKICAKICAgIDwhLS0gdjc4OiBib3R0b20gNCBjbG9zZXN0IGZsaWdodHMgLS0+CiAgICAgIDxkaXYgaWQ9InN0YXR1cyIgY2xhc3M9InN0YXR1c0xpbmUiPlJhZGFyOiDigJQ8L2Rpdj4KPC9tYWluPgoKICA8L2Rpdj4KCiAgPHNjcmlwdCBzcmM9ImFwcC5qcz92PTE0OSI+PC9zY3JpcHQ+CjwvYm9keT4KPC9odG1sPgo=";
const __B64_CSS   = "LyogdjQ5IC0gYm9sZCwgd2FsbC1mcmllbmRseSwgaVBhZC1jZW50ZXJlZCAqLwo6cm9vdHsKICAtLWJnOiMwMDA3MGQ7CiAgLS1wYW5lbDojMDAxMjFjOwogIC0tcGFuZWwyOiMwMDFhMjY7CiAgLS1saW5lOiMwMGY2ZmY1NTsKICAtLXRleHQ6I2U4ZmRmZjsKICAtLW11dGVkOiM5M2RlZTY7CiAgLS1hY2NlbnQ6IzAwZjZmZjsKfQoKKnsgYm94LXNpemluZzpib3JkZXItYm94OyB9Cmh0bWwsYm9keXsgaGVpZ2h0OjEwMCU7IG1hcmdpbjowOyBiYWNrZ3JvdW5kOnZhcigtLWJnKTsgY29sb3I6dmFyKC0tdGV4dCk7IH0KYm9keXsKICBmb250LWZhbWlseTogIkFyaWFsIEJsYWNrIiwgIkF2ZW5pciBOZXh0IENvbmRlbnNlZCIsICJBdmVuaXIgTmV4dCIsIHN5c3RlbS11aSwgLWFwcGxlLXN5c3RlbSwgU2Vnb2UgVUksIFJvYm90bywgSGVsdmV0aWNhLCBBcmlhbCwgc2Fucy1zZXJpZjsKfQoKLndyYXB7CiAgbWluLWhlaWdodDoxMDAlOwogIGRpc3BsYXk6ZmxleDsKICBmbGV4LWRpcmVjdGlvbjpjb2x1bW47CiAgcGFkZGluZzoxOHB4OwogIHBhZGRpbmctYm90dG9tOjY0cHg7IC8qIHJvb20gZm9yIHRpY2tlciAqLwogIGdhcDoxNHB4OwogIG1heC13aWR0aDogMTEwMHB4OwogIG1hcmdpbjogMCBhdXRvOyAvKiBjZW50ZXIgb24gaVBhZCAqLwp9CgoudG9wYmFyewogIGRpc3BsYXk6ZmxleDsKICBhbGlnbi1pdGVtczpmbGV4LXN0YXJ0OwogIGp1c3RpZnktY29udGVudDpzcGFjZS1iZXR3ZWVuOwogIGdhcDoxNnB4OwogIHBhZGRpbmc6MTRweCAxNnB4OwogIGJvcmRlcjoxcHggc29saWQgdmFyKC0tbGluZSk7CiAgYm9yZGVyLXJhZGl1czoxOHB4OwogIGJhY2tncm91bmQ6cmdiYSgwLDE4LDI4LC43OCk7CiAgYmFja2Ryb3AtZmlsdGVyOiBibHVyKDhweCk7Cn0KCi5icmFuZC10aXRsZXsKICBmb250LXdlaWdodDo5NTA7CiAgbGV0dGVyLXNwYWNpbmc6MnB4OwogIGZvbnQtc2l6ZToyMnB4Owp9Ci5icmFuZC1zdWJ7CiAgbWFyZ2luLXRvcDo0cHg7CiAgZm9udC1mYW1pbHk6IHN5c3RlbS11aSwgLWFwcGxlLXN5c3RlbSwgU2Vnb2UgVUksIFJvYm90bywgSGVsdmV0aWNhLCBBcmlhbCwgc2Fucy1zZXJpZjsKICBmb250LXdlaWdodDo2NTA7CiAgY29sb3I6dmFyKC0tbXV0ZWQpOwogIGZvbnQtc2l6ZToxM3B4Owp9CgouY29udHJvbHN7CiAgZGlzcGxheTpmbGV4OwogIGFsaWduLWl0ZW1zOmZsZXgtZW5kOwogIGdhcDoxNHB4OwogIGZsZXgtd3JhcDp3cmFwOwogIGp1c3RpZnktY29udGVudDpmbGV4LWVuZDsKfQoKLmN0bHsKICBkaXNwbGF5OmZsZXg7CiAgYWxpZ24taXRlbXM6Y2VudGVyOwogIGdhcDoxMHB4OwogIGZvbnQtc2l6ZToxMnB4OwogIGZvbnQtd2VpZ2h0OjkwMDsKICBjb2xvcjp2YXIoLS1tdXRlZCk7CiAgbGV0dGVyLXNwYWNpbmc6MXB4Owp9Ci5jdGwgaW5wdXRbdHlwZT0icmFuZ2UiXXsgd2lkdGg6MTcwcHg7IH0KLmN0bCBzZWxlY3R7CiAgYmFja2dyb3VuZDpyZ2JhKDAsMTgsMjgsLjc1KTsKICBjb2xvcjp2YXIoLS10ZXh0KTsKICBib3JkZXI6MXB4IHNvbGlkIHZhcigtLWxpbmUpOwogIGJvcmRlci1yYWRpdXM6MTBweDsKICBwYWRkaW5nOjZweCA4cHg7CiAgZm9udC13ZWlnaHQ6OTAwOwogIGxldHRlci1zcGFjaW5nOjFweDsKfQoKLnRvZ2dsZXsgZ2FwOjhweDsgfQoKLmNhcmR7CiAgZmxleDoxOwogIGJvcmRlcjoxcHggc29saWQgdmFyKC0tbGluZSk7CiAgYm9yZGVyLXJhZGl1czoyNHB4OwogIHBhZGRpbmc6MThweCAxOHB4IDE2cHg7CiAgYmFja2dyb3VuZDpsaW5lYXItZ3JhZGllbnQoMTgwZGVnLCByZ2JhKDAsMjYsMzgsLjg2KSwgcmdiYSgwLDEwLDE1LC42OCkpOwogIGRpc3BsYXk6ZmxleDsKICBmbGV4LWRpcmVjdGlvbjpjb2x1bW47CiAgZ2FwOjEycHg7CiAgcG9zaXRpb246cmVsYXRpdmU7CiAgb3ZlcmZsb3c6aGlkZGVuOwp9Cgoucm93MXsKICBkaXNwbGF5OmZsZXg7CiAgYWxpZ24taXRlbXM6ZmxleC1zdGFydDsKICBqdXN0aWZ5LWNvbnRlbnQ6c3BhY2UtYmV0d2VlbjsKICBnYXA6MTJweDsKfQoKLmNhbGxzaWduewogIGZvbnQtd2VpZ2h0Ojk1MDsKICBmb250LXNpemU6NTZweDsKICBsZXR0ZXItc3BhY2luZzoxcHg7CiAgbGluZS1oZWlnaHQ6MTsKICB0ZXh0LXRyYW5zZm9ybTp1cHBlcmNhc2U7Cn0KCi5yaWdodEJveHsKICBkaXNwbGF5OmZsZXg7CiAgYWxpZ24taXRlbXM6ZmxleC1zdGFydDsKICBnYXA6MTJweDsKfQoKLmJhZGdlewogIHdpZHRoOjM0cHg7IGhlaWdodDozNHB4OwogIGJvcmRlci1yYWRpdXM6NTAlOwogIGRpc3BsYXk6ZmxleDsKICBhbGlnbi1pdGVtczpjZW50ZXI7CiAganVzdGlmeS1jb250ZW50OmNlbnRlcjsKICBmb250LXdlaWdodDo5NTA7CiAgZm9udC1zaXplOjE4cHg7Cn0KLmJhZGdlLnZlcmlmaWVkeyBiYWNrZ3JvdW5kOnZhcigtLWFjY2VudCk7IGNvbG9yOiMwMDEwMTg7IH0KLmJhZGdlLmVzdGltYXRlZHsgYmFja2dyb3VuZDojZmZmZmZmMjI7IGNvbG9yOiNmZmY7IH0KCi5sZWdlbmR7CiAgYm9yZGVyOjFweCBzb2xpZCAjMDBmNmZmMzM7CiAgYm9yZGVyLXJhZGl1czoxNHB4OwogIHBhZGRpbmc6OHB4IDEwcHg7CiAgYmFja2dyb3VuZDpyZ2JhKDAsMTYsMjQsLjU1KTsKICBkaXNwbGF5OmZsZXg7CiAgZmxleC1kaXJlY3Rpb246Y29sdW1uOwogIGdhcDo2cHg7Cn0KLmxnLXJvd3sKICBkaXNwbGF5OmZsZXg7CiAgYWxpZ24taXRlbXM6Y2VudGVyOwogIGdhcDo4cHg7CiAgZm9udC1mYW1pbHk6IHN5c3RlbS11aSwgLWFwcGxlLXN5c3RlbSwgU2Vnb2UgVUksIFJvYm90bywgSGVsdmV0aWNhLCBBcmlhbCwgc2Fucy1zZXJpZjsKICBmb250LXNpemU6MTJweDsKICBmb250LXdlaWdodDo4MDA7CiAgY29sb3I6dmFyKC0tbXV0ZWQpOwogIGxldHRlci1zcGFjaW5nOi42cHg7Cn0KLmRvdHsKICB3aWR0aDoxOHB4OyBoZWlnaHQ6MThweDsKICBib3JkZXItcmFkaXVzOjUwJTsKICBkaXNwbGF5OmlubGluZS1mbGV4OwogIGFsaWduLWl0ZW1zOmNlbnRlcjsKICBqdXN0aWZ5LWNvbnRlbnQ6Y2VudGVyOwogIGZvbnQtd2VpZ2h0Ojk1MDsKICBmb250LXNpemU6MTJweDsKfQouZG90LnZlcmlmaWVkeyBiYWNrZ3JvdW5kOnZhcigtLWFjY2VudCk7IGNvbG9yOiMwMDEwMTg7IH0KLmRvdC5lc3RpbWF0ZWR7IGJhY2tncm91bmQ6I2ZmZmZmZjIyOyBjb2xvcjojZmZmOyB9Cgoucm93MnsKICBkaXNwbGF5OmZsZXg7CiAgYWxpZ24taXRlbXM6YmFzZWxpbmU7CiAganVzdGlmeS1jb250ZW50OnNwYWNlLWJldHdlZW47CiAgZ2FwOjEycHg7CiAgZmxleC13cmFwOndyYXA7Cn0KLnJvdXRlewogIGZvbnQtc2l6ZTozMnB4OwogIGZvbnQtd2VpZ2h0Ojk1MDsKICBsZXR0ZXItc3BhY2luZzouNXB4Owp9Ci5tb2RlbHsKICBmb250LWZhbWlseTogc3lzdGVtLXVpLCAtYXBwbGUtc3lzdGVtLCBTZWdvZSBVSSwgUm9ib3RvLCBIZWx2ZXRpY2EsIEFyaWFsLCBzYW5zLXNlcmlmOwogIGZvbnQtc2l6ZToxNnB4OwogIGNvbG9yOnZhcigtLW11dGVkKTsKICBmb250LXdlaWdodDo3NTA7Cn0KCi5zdGF0c3sKICBkaXNwbGF5OmdyaWQ7CiAgZ3JpZC10ZW1wbGF0ZS1jb2x1bW5zOiByZXBlYXQoNCwgbWlubWF4KDAsIDFmcikpOwogIGdhcDoxNHB4OwogIG1hcmdpbi10b3A6NnB4Owp9Ci5rdnsKICBib3JkZXI6MXB4IHNvbGlkIHZhcigtLWxpbmUpOwogIGJvcmRlci1yYWRpdXM6MThweDsKICBiYWNrZ3JvdW5kOnJnYmEoMCwxNiwyNCwuNjApOwogIHBhZGRpbmc6MTRweCAxMHB4OwogIGRpc3BsYXk6ZmxleDsKICBmbGV4LWRpcmVjdGlvbjpjb2x1bW47CiAgYWxpZ24taXRlbXM6Y2VudGVyOwogIGp1c3RpZnktY29udGVudDpjZW50ZXI7CiAgZ2FwOjZweDsKfQoua3sKICBmb250LWZhbWlseTogc3lzdGVtLXVpLCAtYXBwbGUtc3lzdGVtLCBTZWdvZSBVSSwgUm9ib3RvLCBIZWx2ZXRpY2EsIEFyaWFsLCBzYW5zLXNlcmlmOwogIGZvbnQtc2l6ZToxM3B4OwogIGNvbG9yOnZhcigtLW11dGVkKTsKICBmb250LXdlaWdodDo5MDA7CiAgbGV0dGVyLXNwYWNpbmc6MS4zcHg7CiAgdGV4dC1hbGlnbjpjZW50ZXI7CiAgd2lkdGg6MTAwJTsKfQoudnsKICBmb250LXNpemU6MzBweDsKICBmb250LXdlaWdodDo5NTA7CiAgdGV4dC1hbGlnbjpjZW50ZXI7CiAgd2lkdGg6MTAwJTsKICB3aGl0ZS1zcGFjZTpub3dyYXA7Cn0KCi5tZXRhewogIGZvbnQtZmFtaWx5OiBzeXN0ZW0tdWksIC1hcHBsZS1zeXN0ZW0sIFNlZ29lIFVJLCBSb2JvdG8sIEhlbHZldGljYSwgQXJpYWwsIHNhbnMtc2VyaWY7CiAgZm9udC1zaXplOjE0cHg7CiAgY29sb3I6dmFyKC0tbXV0ZWQpOwogIGZvbnQtd2VpZ2h0OjY1MDsKfQoKLmZvb3RlcnsKICBkaXNwbGF5OmZsZXg7CiAgYWxpZ24taXRlbXM6Y2VudGVyOwogIGp1c3RpZnktY29udGVudDpzcGFjZS1iZXR3ZWVuOwogIHBhZGRpbmc6MTBweCA0cHg7CiAgY29sb3I6dmFyKC0tbXV0ZWQpOwp9Ci5zdGF0dXN7CiAgZm9udC1mYW1pbHk6IHN5c3RlbS11aSwgLWFwcGxlLXN5c3RlbSwgU2Vnb2UgVUksIFJvYm90bywgSGVsdmV0aWNhLCBBcmlhbCwgc2Fucy1zZXJpZjsKICBmb250LXdlaWdodDo4MDA7Cn0KLnZlcnNpb257CiAgZm9udC1zaXplOjEycHg7CiAgb3BhY2l0eTouNzsKICBmb250LWZhbWlseTogc3lzdGVtLXVpLCAtYXBwbGUtc3lzdGVtLCBTZWdvZSBVSSwgUm9ib3RvLCBIZWx2ZXRpY2EsIEFyaWFsLCBzYW5zLXNlcmlmOwp9CgovKiBGYWRlIGRpc2FibGVkICh2NTIpICovCi5mdy1mYWRlLWlueyBhbmltYXRpb246bm9uZSAhaW1wb3J0YW50OyB9CgovKiBUaWNrZXIgKi8KLnRpY2tlcnsKICBwb3NpdGlvbjpmaXhlZDsKICBsZWZ0OjA7IHJpZ2h0OjA7IGJvdHRvbTowOwogIGhlaWdodDo0NHB4OwogIGJvcmRlci10b3A6MXB4IHNvbGlkIHZhcigtLWxpbmUpOwogIGJhY2tncm91bmQ6cmdiYSgwLDE2LDI0LC45Mik7CiAgb3ZlcmZsb3c6aGlkZGVuOwogIGRpc3BsYXk6ZmxleDsKICBhbGlnbi1pdGVtczpjZW50ZXI7Cn0KLnRpY2tlci10cmFja3sKICBkaXNwbGF5OmlubGluZS1ibG9jazsKICB3aGl0ZS1zcGFjZTpub3dyYXA7CiAgcGFkZGluZy1sZWZ0OjEwMCU7CiAgYW5pbWF0aW9uOiB0aWNrZXIgMzBzIGxpbmVhciBpbmZpbml0ZTsKICBmb250LXdlaWdodDo5MDA7CiAgbGV0dGVyLXNwYWNpbmc6LjhweDsKICBjb2xvcjp2YXIoLS10ZXh0KTsKICBvcGFjaXR5Oi45NTsKfQpAa2V5ZnJhbWVzIHRpY2tlcnsKICAwJXsgdHJhbnNmb3JtOiB0cmFuc2xhdGVYKDApOyB9CiAgMTAwJXsgdHJhbnNmb3JtOiB0cmFuc2xhdGVYKC0xMDAlKTsgfQp9CgovKiBQaG9uZSAqLwpAbWVkaWEgKG1heC13aWR0aDogNjQwcHgpewogIC53cmFweyBwYWRkaW5nOjEycHg7IHBhZGRpbmctYm90dG9tOjY0cHg7IH0KICAuY2FsbHNpZ257IGZvbnQtc2l6ZTo0MHB4OyB9CiAgLnJvdXRleyBmb250LXNpemU6MjRweDsgfQogIC52eyBmb250LXNpemU6MjRweDsgfQogIC5zdGF0c3sgZ3JpZC10ZW1wbGF0ZS1jb2x1bW5zOiByZXBlYXQoMiwgbWlubWF4KDAsMWZyKSk7IH0KICAuY3RsIGlucHV0W3R5cGU9InJhbmdlIl17IHdpZHRoOjE1MHB4OyB9CiAgLmxlZ2VuZHsgZGlzcGxheTpub25lOyB9IC8qIGtlZXAgcGhvbmUgY2xlYW4gKi8KfQoKLyogdjUzOiByZWR1Y2UgbGF5b3V0IGppdHRlciAqLwouY2FsbHNpZ24sIC5yb3V0ZSwgLnYgeyBmb250LXZhcmlhbnQtbnVtZXJpYzogdGFidWxhci1udW1zOyB9Ci5jYWxsc2lnbiB7IG1pbi1oZWlnaHQ6IDU4cHg7IH0KLnJvdXRlIHsgbWluLWhlaWdodDogNDBweDsgfQoubWV0YSB7IG1pbi1oZWlnaHQ6IDIycHg7IH0KCi8qIHY1NDogYWlybGluZSBsb2dvIGJsb2NrICovCi5sb2dvewogIHdpZHRoOjY0cHg7CiAgaGVpZ2h0OjY0cHg7CiAgYm9yZGVyLXJhZGl1czoxOHB4OwogIGJvcmRlcjoxcHggc29saWQgdmFyKC0tbGluZSk7CiAgYmFja2dyb3VuZDpyZ2JhKDAsMTYsMjQsLjYwKTsKICBkaXNwbGF5OmZsZXg7CiAgYWxpZ24taXRlbXM6Y2VudGVyOwogIGp1c3RpZnktY29udGVudDpjZW50ZXI7CiAgZm9udC13ZWlnaHQ6OTUwOwogIGZvbnQtc2l6ZToyMnB4OwogIGxldHRlci1zcGFjaW5nOjFweDsKICBjb2xvcjp2YXIoLS10ZXh0KTsKICBmbGV4OjAgMCBhdXRvOwp9Ci5yb3cxeyBhbGlnbi1pdGVtczpjZW50ZXI7IH0KQG1lZGlhIChtYXgtd2lkdGg6IDY0MHB4KXsKICAubG9nb3sgd2lkdGg6NTJweDsgaGVpZ2h0OjUycHg7IGJvcmRlci1yYWRpdXM6MTZweDsgZm9udC1zaXplOjE4cHg7IH0KfQoKLyogdjU1OiBpbmxpbmUgU1ZHIGxvZ28gc3R5bGluZyAqLwoubG9nbyBzdmd7IHdpZHRoOiA5MCU7IGhlaWdodDogOTAlOyBkaXNwbGF5OmJsb2NrOyB9CgovKiB2NTc6IG9wZXJhdG9yIGJyYW5kaW5nIHRpbGVzIChnZW5lcmljLCBub3Qgb2ZmaWNpYWwgbG9nb3MpICovCi5sb2dveyBwb3NpdGlvbjpyZWxhdGl2ZTsgb3ZlcmZsb3c6aGlkZGVuOyB9Ci5sb2dvOjpiZWZvcmV7CiAgY29udGVudDoiIjsKICBwb3NpdGlvbjphYnNvbHV0ZTsgaW5zZXQ6LTQwJTsKICBvcGFjaXR5Oi4yMjsKICB0cmFuc2Zvcm06IHJvdGF0ZSgxOGRlZyk7CiAgYmFja2dyb3VuZDogcmVwZWF0aW5nLWxpbmVhci1ncmFkaWVudCgxMzVkZWcsIGN1cnJlbnRDb2xvciAwLCBjdXJyZW50Q29sb3IgMTBweCwgdHJhbnNwYXJlbnQgMTBweCwgdHJhbnNwYXJlbnQgMjJweCk7Cn0KLmxvZ28gPiAqeyBwb3NpdGlvbjpyZWxhdGl2ZTsgei1pbmRleDoxOyB9CgovKiB2NTg6IGRpc3RpbmN0IG9wZXJhdG9yIGJyYW5kIHRpbGVzIChnZW5lcmljLCBubyBsb2dvcykgKi8KCi8qIEJhc2UgYWxyZWFkeSBwcmVzZW50ICovCi5sb2dvW2RhdGEtYWlybGluZT0iU1dBIl17CiAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDEzNWRlZywgcmdiYSgyNTUsMjU1LDI1NSwuMTApLCByZ2JhKDI1NSwyNTUsMjU1LC4wMikpOwp9Ci5sb2dvW2RhdGEtYWlybGluZT0iU1dBIl06OmJlZm9yZXsKICBvcGFjaXR5Oi4zNTsKICBiYWNrZ3JvdW5kOiByZXBlYXRpbmctbGluZWFyLWdyYWRpZW50KDkwZGVnLCBjdXJyZW50Q29sb3IgMCwgY3VycmVudENvbG9yIDE0cHgsIHRyYW5zcGFyZW50IDE0cHgsIHRyYW5zcGFyZW50IDMwcHgpOwp9CgovKiBBbWVyaWNhbiArIEVudm95ICovCi5sb2dvW2RhdGEtYWlybGluZT0iQUFMIl0sIC5sb2dvW2RhdGEtYWlybGluZT0iRU5ZIl17CiAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDE4MGRlZywgcmdiYSgyNTUsMjU1LDI1NSwuMDgpLCByZ2JhKDI1NSwyNTUsMjU1LC4wMikpOwp9Ci5sb2dvW2RhdGEtYWlybGluZT0iQUFMIl06OmJlZm9yZSwgLmxvZ29bZGF0YS1haXJsaW5lPSJFTlkiXTo6YmVmb3JlewogIG9wYWNpdHk6LjI4OwogIGJhY2tncm91bmQ6IHJlcGVhdGluZy1saW5lYXItZ3JhZGllbnQoMGRlZywgY3VycmVudENvbG9yIDAsIGN1cnJlbnRDb2xvciA4cHgsIHRyYW5zcGFyZW50IDhweCwgdHJhbnNwYXJlbnQgMThweCk7Cn0KCi8qIERlbHRhICovCi5sb2dvW2RhdGEtYWlybGluZT0iREFMIl17CiAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDEzNWRlZywgcmdiYSgyNTUsMjU1LDI1NSwuMTApLCByZ2JhKDI1NSwyNTUsMjU1LC4wMikpOwp9Ci5sb2dvW2RhdGEtYWlybGluZT0iREFMIl06OmJlZm9yZXsKICBvcGFjaXR5Oi4zMDsKICBiYWNrZ3JvdW5kOiByZXBlYXRpbmctbGluZWFyLWdyYWRpZW50KDEzNWRlZywgY3VycmVudENvbG9yIDAsIGN1cnJlbnRDb2xvciAxMHB4LCB0cmFuc3BhcmVudCAxMHB4LCB0cmFuc3BhcmVudCAyMnB4KTsKfQoKLyogVW5pdGVkICovCi5sb2dvW2RhdGEtYWlybGluZT0iVUFMIl17CiAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDEzNWRlZywgcmdiYSgyNTUsMjU1LDI1NSwuMDgpLCByZ2JhKDI1NSwyNTUsMjU1LC4wMikpOwp9Ci5sb2dvW2RhdGEtYWlybGluZT0iVUFMIl06OmJlZm9yZXsKICBvcGFjaXR5Oi4yNjsKICBiYWNrZ3JvdW5kOiByZXBlYXRpbmctbGluZWFyLWdyYWRpZW50KDQ1ZGVnLCBjdXJyZW50Q29sb3IgMCwgY3VycmVudENvbG9yIDZweCwgdHJhbnNwYXJlbnQgNnB4LCB0cmFuc3BhcmVudCAxNHB4KTsKfQoKLyogU2t5V2VzdCAqLwoubG9nb1tkYXRhLWFpcmxpbmU9IlNLVyJdewogIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCgxODBkZWcsIHJnYmEoMjU1LDI1NSwyNTUsLjA2KSwgcmdiYSgyNTUsMjU1LDI1NSwuMDIpKTsKfQoubG9nb1tkYXRhLWFpcmxpbmU9IlNLVyJdOjpiZWZvcmV7CiAgb3BhY2l0eTouMjI7CiAgYmFja2dyb3VuZDogcmVwZWF0aW5nLWxpbmVhci1ncmFkaWVudCg5MGRlZywgY3VycmVudENvbG9yIDAsIGN1cnJlbnRDb2xvciA2cHgsIHRyYW5zcGFyZW50IDZweCwgdHJhbnNwYXJlbnQgMThweCk7Cn0KCi8qIHY1OTogYWlybGluZSBuYW1lIGFib3ZlIGNhbGxzaWduICovCi5haXJsaW5lLW5hbWV7CiAgZm9udC1zaXplOiAxOHB4OwogIGZvbnQtd2VpZ2h0OiA4MDA7CiAgbGV0dGVyLXNwYWNpbmc6IC4wOGVtOwogIHRleHQtdHJhbnNmb3JtOiB1cHBlcmNhc2U7CiAgb3BhY2l0eTogLjg1OwogIG1hcmdpbi1ib3R0b206IDJweDsKfQpAbWVkaWEgKG1heC13aWR0aDogNjQwcHgpewogIC5haXJsaW5lLW5hbWV7IGZvbnQtc2l6ZTogMTVweDsgfQp9CgovKiB2NjA6IHJlZ2lvbmFsIHN1Yi1icmFuZCAqLwouYWlybGluZS1zdWJ7CiAgZm9udC1zaXplOiAxMnB4OwogIGZvbnQtd2VpZ2h0OiA3NTA7CiAgbGV0dGVyLXNwYWNpbmc6IC4xMGVtOwogIHRleHQtdHJhbnNmb3JtOiB1cHBlcmNhc2U7CiAgb3BhY2l0eTogLjcwOwogIG1hcmdpbi10b3A6IC0ycHg7CiAgbWFyZ2luLWJvdHRvbTogMnB4OwogIGZvbnQtZmFtaWx5OiBzeXN0ZW0tdWksIC1hcHBsZS1zeXN0ZW0sIFNlZ29lIFVJLCBSb2JvdG8sIEhlbHZldGljYSwgQXJpYWwsIHNhbnMtc2VyaWY7Cn0KQG1lZGlhIChtYXgtd2lkdGg6IDY0MHB4KXsKICAuYWlybGluZS1zdWJ7IGZvbnQtc2l6ZTogMTFweDsgfQp9CgovKiB2NjE6IGhpZGUgdmVyaWZpZWQvZXN0aW1hdGVkIGJhZGdlICovCi5iYWRnZXsgZGlzcGxheTpub25lICFpbXBvcnRhbnQ7IH0KCi8qIHY2MTogYWlybGluZSBuYW1lIG1vcmUgcHJvbm91bmNlZCAqLwouYWlybGluZS1uYW1lewogIGZvbnQtc2l6ZTogMjhweCAhaW1wb3J0YW50OwogIGZvbnQtd2VpZ2h0OiA5NTAgIWltcG9ydGFudDsKICBsZXR0ZXItc3BhY2luZzogLjEwZW0gIWltcG9ydGFudDsKICBvcGFjaXR5OiAuOTUgIWltcG9ydGFudDsKICBtYXJnaW4tYm90dG9tOiA2cHggIWltcG9ydGFudDsKfQpAbWVkaWEgKG1heC13aWR0aDogNjQwcHgpewogIC5haXJsaW5lLW5hbWV7IGZvbnQtc2l6ZTogMjJweCAhaW1wb3J0YW50OyB9Cn0KCi8qIHY2MTogc2VhbWxlc3MgdGlja2VyIChubyBlbmQgY3V0b2ZmKSAqLwoudGlja2VyVHJhY2t7CiAgZGlzcGxheTogaW5saW5lLWZsZXggIWltcG9ydGFudDsKICBnYXA6IDQ4cHggIWltcG9ydGFudDsKICB3aGl0ZS1zcGFjZTogbm93cmFwICFpbXBvcnRhbnQ7CiAgd2lsbC1jaGFuZ2U6IHRyYW5zZm9ybTsKfQoudGlja2VyU3BhbnsgZGlzcGxheTppbmxpbmUtZmxleDsgZ2FwOjQ4cHg7IH0KQGtleWZyYW1lcyBmd01hcnF1ZWVTZWFtbGVzc3sKICBmcm9teyB0cmFuc2Zvcm06IHRyYW5zbGF0ZVgoMCk7IH0KICB0b3sgdHJhbnNmb3JtOiB0cmFuc2xhdGVYKC01MCUpOyB9Cn0KLnRpY2tlclRyYWNrLmZ3LXNlYW1sZXNzewogIGFuaW1hdGlvbi1uYW1lOiBmd01hcnF1ZWVTZWFtbGVzcyAhaW1wb3J0YW50OwogIGFuaW1hdGlvbi10aW1pbmctZnVuY3Rpb246IGxpbmVhciAhaW1wb3J0YW50OwogIGFuaW1hdGlvbi1pdGVyYXRpb24tY291bnQ6IGluZmluaXRlICFpbXBvcnRhbnQ7Cn0KCi8qIHY2MjogcmFuZ2Ugc2xpZGVyIGxhYmVscyAqLwoucmFuZ2UtbGFiZWxzewogIGRpc3BsYXk6ZmxleDsKICBqdXN0aWZ5LWNvbnRlbnQ6IHNwYWNlLWJldHdlZW47CiAgZm9udC1zaXplOiAxMnB4OwogIGxldHRlci1zcGFjaW5nOi4wOGVtOwogIG9wYWNpdHk6Ljc7CiAgbWFyZ2luLXRvcDo0cHg7Cn0KLnJhbmdlLWxhYmVscyAuYW55ewogIGZvbnQtd2VpZ2h0OjkwMDsKfQoKLyogdjYzOiBBTlkgcmFuZ2UgaGludCAqLwoucmFuZ2UtaGludHsKICBmb250LXNpemU6IDEycHg7CiAgbGV0dGVyLXNwYWNpbmc6IC4wNGVtOwogIG9wYWNpdHk6IC43MjsKICBtYXJnaW4tdG9wOiAycHg7CiAgbWluLWhlaWdodDogMTRweDsKfQoKLyogdjY2OiByZW1vdmUgdmVyaWZpZWQvZXN0aW1hdGVkIGJhZGdlICovCi5iYWRnZXsgZGlzcGxheTpub25lICFpbXBvcnRhbnQ7IH0KCi8qIHY2Njogc2VhbWxlc3MgdGlja2VyIChubyBqdW1wL2N1dCkgKi8KLnRpY2tlclRyYWNrewogIGRpc3BsYXk6aW5saW5lLWZsZXggIWltcG9ydGFudDsKICB3aGl0ZS1zcGFjZTogbm93cmFwICFpbXBvcnRhbnQ7CiAgd2lsbC1jaGFuZ2U6IHRyYW5zZm9ybTsKfQoudGlja2VyU3BhbnsKICBkaXNwbGF5OmlubGluZS1mbGV4OwogIGdhcDogNDhweDsKICBwYWRkaW5nLXJpZ2h0OiA0OHB4Owp9CkBrZXlmcmFtZXMgZndNYXJxdWVlU2VhbWxlc3N7CiAgZnJvbXsgdHJhbnNmb3JtOiB0cmFuc2xhdGVYKDApOyB9CiAgdG97IHRyYW5zZm9ybTogdHJhbnNsYXRlWCgtNTAlKTsgfQp9Ci50aWNrZXJUcmFjay5mdy1zZWFtbGVzc3sKICBhbmltYXRpb24tbmFtZTogZndNYXJxdWVlU2VhbWxlc3MgIWltcG9ydGFudDsKICBhbmltYXRpb24tdGltaW5nLWZ1bmN0aW9uOiBsaW5lYXIgIWltcG9ydGFudDsKICBhbmltYXRpb24taXRlcmF0aW9uLWNvdW50OiBpbmZpbml0ZSAhaW1wb3J0YW50Owp9CgovKiB2Njg6IGVuc3VyZSBiYWRnZSBuZXZlciBzaG93cyAqLwojYmFkZ2UsLmJhZGdleyBkaXNwbGF5Om5vbmUgIWltcG9ydGFudDsgfQoKLyogdjY4OiBkcm9wZG93biBjb250cm9scyAqLwouY29udHJvbHNSb3d7IGRpc3BsYXk6ZmxleDsgZ2FwOjE0cHg7IGFsaWduLWl0ZW1zOmZsZXgtZW5kOyBqdXN0aWZ5LWNvbnRlbnQ6c3BhY2UtYmV0d2VlbjsgZmxleC13cmFwOndyYXA7IH0KLmN0bHsgZGlzcGxheTpmbGV4OyBmbGV4LWRpcmVjdGlvbjpjb2x1bW47IGdhcDo2cHg7IG1pbi13aWR0aDoxNTBweDsgfQouY3RsTGFiZWx7IGZvbnQtc2l6ZToxMnB4OyBsZXR0ZXItc3BhY2luZzouMTJlbTsgb3BhY2l0eTouNzU7IGZvbnQtd2VpZ2h0OjgwMDsgfQouY3RsU2VsZWN0ewogIGJhY2tncm91bmQ6IHJnYmEoMjU1LDI1NSwyNTUsLjA4KTsKICBjb2xvcjogaW5oZXJpdDsKICBib3JkZXI6IDFweCBzb2xpZCByZ2JhKDI1NSwyNTUsMjU1LC4xOCk7CiAgYm9yZGVyLXJhZGl1czogMTBweDsKICBwYWRkaW5nOiAxMHB4IDEycHg7CiAgZm9udC1zaXplOiAxNnB4OwogIGZvbnQtd2VpZ2h0OiA4NTA7CiAgbGV0dGVyLXNwYWNpbmc6LjA0ZW07CiAgb3V0bGluZTpub25lOwp9Ci5jdGxDaGVja1Jvd3sgZGlzcGxheTpmbGV4OyBhbGlnbi1pdGVtczpjZW50ZXI7IGdhcDoxMHB4OyBmb250LXdlaWdodDo5MDA7IGxldHRlci1zcGFjaW5nOi4wNmVtOyBvcGFjaXR5Oi45OyB9Ci5jdGxDaGVjayBpbnB1dHsgd2lkdGg6MThweDsgaGVpZ2h0OjE4cHg7IH0KLnJhbmdlLWhpbnR7IGZvbnQtc2l6ZToxMnB4OyBsZXR0ZXItc3BhY2luZzouMDRlbTsgb3BhY2l0eTouNzI7IG1hcmdpbi10b3A6NnB4OyBtaW4taGVpZ2h0OjE0cHg7IH0KQG1lZGlhIChtYXgtd2lkdGg6NjQwcHgpewogIC5jdGx7IG1pbi13aWR0aDoxNDBweDsgfQogIC5jdGxTZWxlY3R7IGZvbnQtc2l6ZTogMTVweDsgcGFkZGluZzogOXB4IDEwcHg7IH0KfQoKLyogdjY4OiBzZWNvbmRhcnkgNC1mbGlnaHQgYm94ZXMgKi8KLnNlY29uZGFyeUdyaWR7CiAgZGlzcGxheTpncmlkOwogIGdyaWQtdGVtcGxhdGUtY29sdW1uczogcmVwZWF0KDQsIDFmcik7CiAgZ2FwOiAxMnB4OwogIG1hcmdpbi10b3A6IDEycHg7Cn0KLnNlY29uZGFyeUJveHsKICBib3JkZXI6IDFweCBzb2xpZCByZ2JhKDI1NSwyNTUsMjU1LC4xMik7CiAgYm9yZGVyLXJhZGl1czogMTRweDsKICBwYWRkaW5nOiAxMHB4IDEwcHggOHB4OwogIGJhY2tncm91bmQ6IHJnYmEoMjU1LDI1NSwyNTUsLjA0KTsKICBtaW4taGVpZ2h0OiA3MnB4OwogIG92ZXJmbG93OmhpZGRlbjsKfQouc2VjQ1N7CiAgZm9udC13ZWlnaHQ6IDk1MDsKICBsZXR0ZXItc3BhY2luZzouMDZlbTsKICBmb250LXNpemU6IDE4cHg7CiAgbWFyZ2luLWJvdHRvbTogNHB4Owp9Ci5zZWNSb3V0ZXsKICBmb250LXNpemU6IDEycHg7CiAgb3BhY2l0eTogLjc4OwogIGxpbmUtaGVpZ2h0OiAxLjI7CiAgbGV0dGVyLXNwYWNpbmc6LjAyZW07Cn0KQG1lZGlhIChtYXgtd2lkdGg6OTAwcHgpewogIC5zZWNvbmRhcnlHcmlkeyBncmlkLXRlbXBsYXRlLWNvbHVtbnM6IHJlcGVhdCgyLCAxZnIpOyB9Cn0KCiNiYWRnZSwuYmFkZ2UsW2RhdGEtYmFkZ2Vde2Rpc3BsYXk6bm9uZSAhaW1wb3J0YW50O30KCi8qIHY2OTogc2Vjb25kYXJ5IGJveCBzdGF0cyAqLwouc2VjVG9weyBkaXNwbGF5OmZsZXg7IGp1c3RpZnktY29udGVudDpzcGFjZS1iZXR3ZWVuOyBhbGlnbi1pdGVtczpiYXNlbGluZTsgZ2FwOjEwcHg7IH0KLnNlY01pbml7CiAgZm9udC1zaXplOiAxMXB4OwogIGZvbnQtd2VpZ2h0OiA4NTA7CiAgbGV0dGVyLXNwYWNpbmc6IC4wOGVtOwogIG9wYWNpdHk6IC44MDsKICB3aGl0ZS1zcGFjZTogbm93cmFwOwp9CgovKiB2NzA6IGtlZXAgNCBib3R0b20gYm94ZXMgdmlzaWJsZSB3aXRob3V0IHNjcm9sbGluZyAqLwouc2Vjb25kYXJ5R3JpZHsgZ3JpZC10ZW1wbGF0ZS1jb2x1bW5zOiByZXBlYXQoNCwgMWZyKSAhaW1wb3J0YW50OyB9CkBtZWRpYSAobWF4LXdpZHRoOjkwMHB4KXsgLnNlY29uZGFyeUdyaWR7IGdyaWQtdGVtcGxhdGUtY29sdW1uczogcmVwZWF0KDQsIDFmcikgIWltcG9ydGFudDsgfSB9CkBtZWRpYSAobWF4LXdpZHRoOjY0MHB4KXsgLnNlY29uZGFyeUdyaWR7IGdyaWQtdGVtcGxhdGUtY29sdW1uczogcmVwZWF0KDIsIDFmcikgIWltcG9ydGFudDsgfSB9Cgouc2Vjb25kYXJ5Qm94eyBvdmVyZmxvdzogdmlzaWJsZSAhaW1wb3J0YW50OyBtaW4taGVpZ2h0OiA4NnB4ICFpbXBvcnRhbnQ7IH0KLnNlY01pbml7CiAgd2hpdGUtc3BhY2U6IG5vcm1hbCAhaW1wb3J0YW50OwogIGxpbmUtaGVpZ2h0OiAxLjE1OwogIHRleHQtYWxpZ246IHJpZ2h0Owp9CgovKiB2NzE6IGFsd2F5cyBzaG93IDQgYm90dG9tIGJveGVzIHNpZGUtYnktc2lkZSBvbiBpUGFkICovCi5zZWNvbmRhcnlHcmlkewogIHdpZHRoOiAxMDAlICFpbXBvcnRhbnQ7CiAgZ3JpZC10ZW1wbGF0ZS1jb2x1bW5zOiByZXBlYXQoNCwgbWlubWF4KDAsIDFmcikpICFpbXBvcnRhbnQ7CiAgZ2FwOiAxMHB4ICFpbXBvcnRhbnQ7Cn0KLnNlY29uZGFyeUJveHsgbWluLXdpZHRoOjAgIWltcG9ydGFudDsgfQoKLyogT25seSBkcm9wIHRvIDIgY29sdW1ucyBvbiB2ZXJ5IHNtYWxsIHBob25lcyAqLwpAbWVkaWEgKG1heC13aWR0aDogNTIwcHgpewogIC5zZWNvbmRhcnlHcmlkeyBncmlkLXRlbXBsYXRlLWNvbHVtbnM6IHJlcGVhdCgyLCBtaW5tYXgoMCwxZnIpKSAhaW1wb3J0YW50OyB9Cn0KCi8qIHY3MTogbWFrZSBhdHRyaWJ1dGUgdGl0bGVzIChBTFQvRElTVC9TUEQpIGJpZ2dlciAqLwouaywgLmt2IC5rLCAuc3RhdEssIC5zdGF0S2V5ewogIGZvbnQtc2l6ZTogMTRweCAhaW1wb3J0YW50OwogIGZvbnQtd2VpZ2h0OiA5NTAgIWltcG9ydGFudDsKICBsZXR0ZXItc3BhY2luZzogLjEyZW0gIWltcG9ydGFudDsKfQoKLyogdjcyOiBjb21tZXJjaWFsIHRvZ2dsZSBzdHlsaW5nICovCi5jdGxDaGVja3sKICBkaXNwbGF5OmZsZXg7CiAgYWxpZ24taXRlbXM6Y2VudGVyOwogIGdhcDoxMHB4OwogIGZvbnQtd2VpZ2h0OiA5MDA7CiAgbGV0dGVyLXNwYWNpbmc6IC4xMGVtOwogIG9wYWNpdHk6Ljk7CiAgdXNlci1zZWxlY3Q6bm9uZTsKfQouY3RsQ2hlY2sgaW5wdXR7IHdpZHRoOjE4cHg7IGhlaWdodDoxOHB4OyB9CgovKiB2NzI6IGFsbG93IGZ1bGwgaVBhZCB3aWR0aCBzbyA0IGJveGVzIGZpdCAqLwoud3JhcHsKICBtYXgtd2lkdGg6IDEwMCUgIWltcG9ydGFudDsKfQoKLyogdjcyOiBmb3JjZSA0LWFjcm9zcyBib3R0b20gYm94ZXMgKGlQYWQpICovCi5zZWNvbmRhcnlHcmlkewogIGdyaWQtdGVtcGxhdGUtY29sdW1uczogcmVwZWF0KDQsIG1pbm1heCgwLCAxZnIpKSAhaW1wb3J0YW50Owp9CkBtZWRpYSAobWF4LXdpZHRoOiA1MjBweCl7CiAgLnNlY29uZGFyeUdyaWR7IGdyaWQtdGVtcGxhdGUtY29sdW1uczogcmVwZWF0KDIsIG1pbm1heCgwLDFmcikpICFpbXBvcnRhbnQ7IH0KfQoKLyogdjc2OiBmdWxsIHdpZHRoIHNvIDQgYm94ZXMgZml0IG9uIGlQYWQgQWlyICovCi53cmFweyBtYXgtd2lkdGg6IDEwMCUgIWltcG9ydGFudDsgcGFkZGluZy1sZWZ0OiAxNHB4ICFpbXBvcnRhbnQ7IHBhZGRpbmctcmlnaHQ6IDE0cHggIWltcG9ydGFudDsgfQoKLyogdjc2OiBib3R0b20gZ3JpZCAqLwouc2Vjb25kYXJ5R3JpZHsgZGlzcGxheTpncmlkOyBncmlkLXRlbXBsYXRlLWNvbHVtbnM6IHJlcGVhdCg0LCBtaW5tYXgoMCwxZnIpKSAhaW1wb3J0YW50OyBnYXA6IDEwcHggIWltcG9ydGFudDsgbWFyZ2luLXRvcDogMTBweCAhaW1wb3J0YW50OyB9CkBtZWRpYSAobWF4LXdpZHRoOjUyMHB4KXsgLnNlY29uZGFyeUdyaWR7IGdyaWQtdGVtcGxhdGUtY29sdW1uczogcmVwZWF0KDIsIG1pbm1heCgwLDFmcikpICFpbXBvcnRhbnQ7IH0gfQoKLyogdjc2OiByZW1vdmUgZGl2aWRlciBsaW5lcyBiZXR3ZWVuIHNlY3Rpb25zICovCmhyLCAuZGl2aWRlciwgLnJ1bGV7IGRpc3BsYXk6bm9uZSAhaW1wb3J0YW50OyB9CgovKiB2NzY6IGNoZWNrYm94IHJvdyAqLwouY29udHJvbHNSb3d7IGRpc3BsYXk6ZmxleDsgZ2FwOjE4cHg7IGFsaWduLWl0ZW1zOmNlbnRlcjsganVzdGlmeS1jb250ZW50OmZsZXgtc3RhcnQ7IGZsZXgtd3JhcDp3cmFwOyB9Ci5jdGxDaGVja3sgZGlzcGxheTpmbGV4OyBhbGlnbi1pdGVtczpjZW50ZXI7IGdhcDoxMHB4OyBmb250LXdlaWdodDogOTAwOyBsZXR0ZXItc3BhY2luZzouMTBlbTsgb3BhY2l0eTouOTsgdXNlci1zZWxlY3Q6bm9uZTsgfQouY3RsQ2hlY2sgaW5wdXR7IHdpZHRoOjE4cHg7IGhlaWdodDoxOHB4OyB9CgovKiB2NzY6IHNlY29uZGFyeSBib3ggdHlwb2dyYXBoeSAqLwouc2VjVG9weyBkaXNwbGF5OmZsZXg7IGp1c3RpZnktY29udGVudDpzcGFjZS1iZXR3ZWVuOyBhbGlnbi1pdGVtczpjZW50ZXI7IGdhcDoxMHB4OyB9Ci5zZWNDU3sgZm9udC13ZWlnaHQ6IDk1MDsgbGV0dGVyLXNwYWNpbmc6LjA2ZW07IGZvbnQtc2l6ZTogMThweDsgfQouc2VjTWluaXsgZm9udC1zaXplOiAxMnB4OyBmb250LXdlaWdodDogOTAwOyBsZXR0ZXItc3BhY2luZzouMDhlbTsgb3BhY2l0eTouODI7IHdoaXRlLXNwYWNlOiBub3dyYXA7IHRleHQtYWxpZ246cmlnaHQ7IH0KCi8qIHY3ODogYm90dG9tIHNlY3Rpb24gcmVzZXQgKi8KI3NlY29uZGFyeUdyaWR7IG1hcmdpbi10b3A6IDEwcHggIWltcG9ydGFudDsgfQouc2Vjb25kYXJ5R3JpZHsKICBkaXNwbGF5OmdyaWQgIWltcG9ydGFudDsKICBncmlkLXRlbXBsYXRlLWNvbHVtbnM6IHJlcGVhdCg0LCBtaW5tYXgoMCwxZnIpKSAhaW1wb3J0YW50OwogIGdhcDogMTBweCAhaW1wb3J0YW50OwogIHdpZHRoOiAxMDAlICFpbXBvcnRhbnQ7Cn0KQG1lZGlhIChtYXgtd2lkdGg6NTIwcHgpewogIC5zZWNvbmRhcnlHcmlkeyBncmlkLXRlbXBsYXRlLWNvbHVtbnM6IHJlcGVhdCgyLCBtaW5tYXgoMCwxZnIpKSAhaW1wb3J0YW50OyB9Cn0KLnNlY29uZGFyeUJveHsKICBib3JkZXI6IDFweCBzb2xpZCByZ2JhKDI1NSwyNTUsMjU1LC4xMikgIWltcG9ydGFudDsKICBib3JkZXItcmFkaXVzOiAxNHB4ICFpbXBvcnRhbnQ7CiAgcGFkZGluZzogMTBweCAxMHB4IDhweCAhaW1wb3J0YW50OwogIGJhY2tncm91bmQ6IHJnYmEoMjU1LDI1NSwyNTUsLjA0KSAhaW1wb3J0YW50OwogIG1pbi1oZWlnaHQ6IDY0cHggIWltcG9ydGFudDsKICBvdmVyZmxvdzogaGlkZGVuICFpbXBvcnRhbnQ7Cn0KLnNlY29uZGFyeUJveCAuc2VjQ1N7CiAgZm9udC13ZWlnaHQ6IDk1MCAhaW1wb3J0YW50OwogIGxldHRlci1zcGFjaW5nOi4wNmVtICFpbXBvcnRhbnQ7CiAgZm9udC1zaXplOiAxOHB4ICFpbXBvcnRhbnQ7CiAgbGluZS1oZWlnaHQ6IDEuMSAhaW1wb3J0YW50Owp9Ci5zZWNvbmRhcnlCb3ggLnNlY01pbml7CiAgbWFyZ2luLXRvcDogNnB4ICFpbXBvcnRhbnQ7CiAgZm9udC1zaXplOiAxMnB4ICFpbXBvcnRhbnQ7CiAgZm9udC13ZWlnaHQ6IDkwMCAhaW1wb3J0YW50OwogIGxldHRlci1zcGFjaW5nOiAuMDhlbSAhaW1wb3J0YW50OwogIG9wYWNpdHk6IC44MiAhaW1wb3J0YW50OwogIHdoaXRlLXNwYWNlOiBub3dyYXAgIWltcG9ydGFudDsKfQovKiBraWxsIHN0cmF5IGRpdmlkZXJzIGlmIGFueSBzdGlsbCBleGlzdCAqLwpociwuZGl2aWRlciwucnVsZXsgZGlzcGxheTpub25lICFpbXBvcnRhbnQ7IH0KLyogZW5zdXJlIHdyYXBwZXIgZG9lc24ndCBjb25zdHJhaW4gKi8KLndyYXB7IG1heC13aWR0aDogMTAwJSAhaW1wb3J0YW50OyB9CgovKiB2Nzk6IHRpZ2h0ZW4gc3BhY2UgYmV0d2VlbiBtYWluIGNhcmQgYW5kIGJvdHRvbSBncmlkICovCi5jYXJkeyBtYXJnaW4tYm90dG9tOiAxMHB4ICFpbXBvcnRhbnQ7IH0KCi8qIHY4MCAqLwojcmFuZ2UsICNyYW5nZVNlbGVjdCwgLnJhbmdlLWxhYmVscywgLnJhbmdlLWhpbnQsIC5yYW5nZVJvdywgLnJhbmdlV3JhcHtkaXNwbGF5Om5vbmUhaW1wb3J0YW50O30KCi8qIHY4NDogbGFzdCB1cGRhdGUgdGltZXN0YW1wICovCi5sYXN0VXBkYXRlewogIHBvc2l0aW9uOmFic29sdXRlOwogIHJpZ2h0OjE0cHg7CiAgdG9wOjE0cHg7CiAgZm9udC1zaXplOjEycHg7CiAgZm9udC13ZWlnaHQ6ODAwOwogIGxldHRlci1zcGFjaW5nOi4wOGVtOwogIG9wYWNpdHk6LjY1Owp9CgovKiB2ODQ6IHJhZGFyIHdhcm5pbmcgKi8KLnJhZGFyV2FybnsKICBjb2xvcjojZmZiMDAwOwogIGZvbnQtd2VpZ2h0OjkwMDsKICBsZXR0ZXItc3BhY2luZzouMDhlbTsKfQoKLyogdjg1OiBMSVZFIGluZGljYXRvciAqLwoubGl2ZVdyYXB7CiAgcG9zaXRpb246YWJzb2x1dGU7CiAgcmlnaHQ6MTRweDsKICB0b3A6MTJweDsKICBkaXNwbGF5OmZsZXg7CiAgYWxpZ24taXRlbXM6Y2VudGVyOwogIGdhcDo4cHg7Cn0KLmxpdmVEb3R7CiAgd2lkdGg6MTBweDsKICBoZWlnaHQ6MTBweDsKICBib3JkZXItcmFkaXVzOjUwJTsKICBiYWNrZ3JvdW5kOiMyZGZmNmE7CiAgYm94LXNoYWRvdzowIDAgOHB4IHJnYmEoNDUsMjU1LDEwNiwuOSk7CiAgb3BhY2l0eTouOTsKfQoubGl2ZURvdC5wdWxzZXsKICBhbmltYXRpb246IGxpdmVQdWxzZSAxLjVzIGluZmluaXRlOwp9CkBrZXlmcmFtZXMgbGl2ZVB1bHNlewogIDAleyB0cmFuc2Zvcm06c2NhbGUoLjg1KTsgb3BhY2l0eTouNjsgfQogIDUwJXsgdHJhbnNmb3JtOnNjYWxlKDEuMik7IG9wYWNpdHk6MTsgfQogIDEwMCV7IHRyYW5zZm9ybTpzY2FsZSguODUpOyBvcGFjaXR5Oi42OyB9Cn0KCi8qIHY5Mjogcm91dGUgbGluZSAqLwoucm91dGV7IG1hcmdpbi10b3A6NnB4OyBmb250LXdlaWdodDo4MDA7IGxldHRlci1zcGFjaW5nOi4wMmVtOyBvcGFjaXR5Oi45NTsgfQoKLyogdjkzOiBoaWRlIHJvdXRlIHVudGlsIGF2YWlsYWJsZSAqLwovKiB2OTc6IGFsd2F5cy12aXNpYmxlIHN0YXR1cyBsaW5lIGZvciBkZWJ1Z2dpbmcgKi8KLnN0YXR1c0xpbmV7bWFyZ2luOjEwcHggYXV0byAwO21heC13aWR0aDo5ODBweDtwYWRkaW5nOjhweCAxMnB4O2JvcmRlci1yYWRpdXM6MTBweDtmb250LXdlaWdodDo3MDA7b3BhY2l0eTouOTt0ZXh0LWFsaWduOmNlbnRlcjt9CgovKiB2MTA0OiBidWlsZCBzdGFtcCAqLwouYnVpbGRTdGFtcHtmb250LXdlaWdodDo3MDA7b3BhY2l0eTouODU7fQouc2Vwe29wYWNpdHk6LjY7bWFyZ2luOjAgNnB4O30KCi8qIHYxMDY6IHJvdXRlIGxpbmUgYWx3YXlzIHZpc2libGUgKi8KLnJvdXRle21hcmdpbi10b3A6NnB4O2ZvbnQtd2VpZ2h0OjkwMDtsZXR0ZXItc3BhY2luZzouMDJlbTtvcGFjaXR5Oi45NTt0ZXh0LWFsaWduOmNlbnRlcjt9CgovKiB2MTA4OiByZW1vdmUgc2Nyb2xsIGNvbnRyb2wgKyB0aW1lc3RhbXAgKi8KLnNjcm9sbFRvZ2dsZSwuc2Nyb2xsQ3RsLC5zY3JvbGxDb250cm9sLCNzY3JvbGxUb2dnbGUsI3Njcm9sbEN0bHtkaXNwbGF5Om5vbmUgIWltcG9ydGFudDt9Ci50aW1lc3RhbXAsI3RpbWVzdGFtcCwjbGFzdFVwZGF0ZSwubGFzdFVwZGF0ZSwuc3RhdHVzVGltZXtkaXNwbGF5Om5vbmUgIWltcG9ydGFudDt9CgovKiB2MTEzIGFpcmNyYWZ0IG1vZGVsOiBrZWVwIHJlYWRhYmxlICovCiNtb2RlbHtmb250LXdlaWdodDo5MDA7bGV0dGVyLXNwYWNpbmc6LjAyZW07fQoKLyogdjExNCBhaXJjcmFmdCBtb2RlbDIgKi8KI21vZGVsMnttYXJnaW4tdG9wOjRweDtmb250LXdlaWdodDo5MDA7b3BhY2l0eTouOTt0ZXh0LWFsaWduOmNlbnRlcjt9CgoKLyogdjE0OTogZW5zdXJlIGFpcmNyYWZ0IHJlZ2lzdHJhdGlvbiBsaW5lIGlzIHZpc2libGUgKi8KLm1vZGVsMntmb250LXNpemU6MTRweDtsZXR0ZXItc3BhY2luZzouMDhlbTtvcGFjaXR5Oi44NTttYXJnaW4tdG9wOjRweDt0ZXh0LXRyYW5zZm9ybTp1cHBlcmNhc2U7fQo=";
const __B64_JS    = "Ci8vIHYxMjU6IHN0YWJpbGl0eSBnYXRlIChwcm90ZWN0IEFlcm9EYXRhQm94IGNyZWRpdHMpCgovLyB2MTQ5OiBOb3JtYWxpemUgT3BlblNreSBjYWxsc2lnbnMgKHRyaW0gc3BhY2VzIC8gdXBwZXJjYXNlIC8gc3RyaXAgbm9uLWFscGhhbnVtZXJpY3MpCmZ1bmN0aW9uIG5vcm1DYWxsc2lnbihjcyl7CiAgcmV0dXJuIChjcyB8fCAiIikKICAgIC50b1N0cmluZygpCiAgICAudHJpbSgpCiAgICAudG9VcHBlckNhc2UoKQogICAgLnJlcGxhY2UoL1teQS1aMC05XS9nLCAiIik7Cn0KY29uc3QgRldfU1RBQkxFX1JPVVRFX01TID0gMTAwMDA7IC8vIDEwcyBzdGFibGUgY2xvc2VzdCBiZWZvcmUgcm91dGUgbG9va3VwcwoKLy8gdjEyODogYWlyY3JhZnQgbG9va3VwIGdhdGUgKHBlci1oZXgpIHRvIGF2b2lkIGJ1cm5pbmcgY3JlZGl0cyBldmVuIGlmIGNsb3Nlc3Qgaml0dGVycwpjb25zdCBGV19BSVJfSEVYX0dBVEVfTVMgPSAzMCAqIDYwICogMTAwMDsgLy8gMzAgbWludXRlcwoKLy8gdjE0OTogYWRhcHRpdmUgcmFkYXIgcG9sbGluZyB0byBhdm9pZCBPcGVuU2t5IDQyOQpsZXQgX19md1JhZGFyUG9sbE1zID0gNTAwMDsgICAgICAvLyBzdGFydCBhdCA1cwpjb25zdCBfX2Z3UmFkYXJQb2xsTWluTXMgPSA0MDAwOyAvLyBmbG9vcgpjb25zdCBfX2Z3UmFkYXJQb2xsTWF4TXMgPSA2MDAwMDsvLyBjZWlsaW5nIDYwcwpsZXQgX19md1JhZGFyQ29uc2VjRXJyID0gMDsKZnVuY3Rpb24gX19md1JhZGFyQmFja29mZihoaXQ0MjkpewogIF9fZndSYWRhckNvbnNlY0VyciA9IE1hdGgubWluKDEwLCBfX2Z3UmFkYXJDb25zZWNFcnIgKyAxKTsKICBjb25zdCBmYWN0b3IgPSBoaXQ0MjkgPyAyLjIgOiAxLjY7CiAgX19md1JhZGFyUG9sbE1zID0gTWF0aC5taW4oX19md1JhZGFyUG9sbE1heE1zLCBNYXRoLm1heChfX2Z3UmFkYXJQb2xsTWluTXMsIE1hdGgucm91bmQoX19md1JhZGFyUG9sbE1zICogZmFjdG9yKSkpOwp9CmZ1bmN0aW9uIF9fZndSYWRhclJlY292ZXIoKXsKICBfX2Z3UmFkYXJDb25zZWNFcnIgPSAwOwogIF9fZndSYWRhclBvbGxNcyA9IE1hdGgubWF4KF9fZndSYWRhclBvbGxNaW5NcywgTWF0aC5yb3VuZChfX2Z3UmFkYXJQb2xsTXMgKiAwLjg1KSk7Cn0KY29uc3QgX19md0FpckhleEdhdGUgPSBuZXcgTWFwKCk7IC8vIGhleCAtPiBsYXN0QXR0ZW1wdE1zCmNvbnN0IEZXX1NUQUJMRV9BSVJfTVMgPSA1MDAwOyAgIC8vIHYxMjc6IDVzIHN0YWJsZSBjbG9zZXN0IGJlZm9yZSBhaXJjcmFmdCBsb29rdXBzCmxldCBfX2Z3U3RhYmxlU2luY2UgPSAwOwpsZXQgX19md1N0YWJsZUtleSA9ICIiOwpmdW5jdGlvbiBfX2Z3TWFya1N0YWJsZUtleShjYWxsc2lnbiwgaWNhbzI0KXsKICBjb25zdCBrID0gU3RyaW5nKGNhbGxzaWdufHwiIikgKyAifCIgKyBTdHJpbmcoaWNhbzI0fHwiIik7CiAgaWYgKGsgIT09IF9fZndTdGFibGVLZXkpeyBfX2Z3U3RhYmxlS2V5ID0gazsgX19md1N0YWJsZVNpbmNlID0gRGF0ZS5ub3coKTsgfQp9CmZ1bmN0aW9uIF9fZndJc1N0YWJsZVJvdXRlKCl7CiAgcmV0dXJuIChEYXRlLm5vdygpIC0gKF9fZndTdGFibGVTaW5jZXx8MCkpID49IEZXX1NUQUJMRV9ST1VURV9NUzsKfQpmdW5jdGlvbiBfX2Z3SXNTdGFibGVBaXIoKXsKICByZXR1cm4gKERhdGUubm93KCkgLSAoX19md1N0YWJsZVNpbmNlfHwwKSkgPj0gRldfU1RBQkxFX0FJUl9NUzsKfQoKCi8vIHYxMTg6IHRpZ2h0ZXIgT3BlblNreSBib3VuZGluZyBib3ggYXJvdW5kIGN1cnJlbnQgbG9jYXRpb24gKHBlcmZvcm1hbmNlKQpjb25zdCBGV19CQk9YX0xBVF9ERUcgPSAxLjI1OyAvLyB+ODYgbWkgbm9ydGgvc291dGgKY29uc3QgRldfQkJPWF9MT05fREVHID0gMS41MDsgLy8gfjgwLTkwIG1pIGVhc3Qvd2VzdCAodmFyaWVzIGJ5IGxhdGl0dWRlKQoKZnVuY3Rpb24gZndHZXRCYm94VjEyNShsYXQsIGxvbil7CiAgY29uc3QgbGFtaW4gPSBsYXQgLSBGV19CQk9YX0xBVF9ERUc7CiAgY29uc3QgbGFtYXggPSBsYXQgKyBGV19CQk9YX0xBVF9ERUc7CiAgY29uc3QgbG9taW4gPSBsb24gLSBGV19CQk9YX0xPTl9ERUc7CiAgY29uc3QgbG9tYXggPSBsb24gKyBGV19CQk9YX0xPTl9ERUc7CiAgcmV0dXJuIHsgbGFtaW4sIGxvbWluLCBsYW1heCwgbG9tYXggfTsKfQoKCgpmdW5jdGlvbiBfX2Z3Rml4QXJyb3cocyl7CiAgdHJ5ewogICAgY29uc3QgdCA9IFN0cmluZyhzfHwiIik7CiAgICAvLyBjb21tb24gbW9qaWJha2Ugc2VxdWVuY2UgZm9yIGFycm93CiAgICByZXR1cm4gdC5yZXBsYWNlKC/DosKGwpIvZywgIuKGkiIpLnJlcGxhY2UoL8Oi4oCg4oCZL2csICLihpIiKS5yZXBsYWNlKC9ccyvihpJccysvZywgIiDihpIgIikudHJpbSgpOwogIH1jYXRjaChlKXsgcmV0dXJuIFN0cmluZyhzfHwiIik7IH0KfQovKiBQRVJTSVNUX0NBQ0hFX1YxMTUKICAgbG9jYWxTdG9yYWdlLWJhY2tlZCBjYWNoaW5nIChzdXJ2aXZlcyByZWZyZXNoL3RhYiBjbG9zZSk6CiAgIC0gYWlyY3JhZnQgbW9kZWxzIChtYWluIHRpbGUpOiBmdy5haXJjcmFmdC48aWNhbzI0PiAoVFRMIDcgZGF5cykKICAgLSByb3V0ZXMgKGNsb3Nlc3QgY2FsbHNpZ24pOiAgIGZ3LnJvdXRlLjxjYWxsc2lnbj4gICAoVFRMIDYgaG91cnM7IDMwbSBmb3IgdW5hdmFpbGFibGUpCiAgIEZhbGxzIGJhY2sgc2lsZW50bHkgaWYgc3RvcmFnZSBpcyB1bmF2YWlsYWJsZS4KKi8KKGZ1bmN0aW9uKCl7CiAgLy8gdjE0OTogc2hvdyBhaXJjcmFmdCByZWdpc3RyYXRpb24gd2hlbiBBZXJvRGF0YUJveCBwcm92aWRlcyBpdAogIGZ1bmN0aW9uIGZ3U2V0UmVnTGluZShyZWcpewogICAgdHJ5ewogICAgICBjb25zdCBlbCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJtb2RlbDIiKTsKICAgICAgaWYgKCFlbCkgcmV0dXJuOwogICAgICBjb25zdCB2ID0gU3RyaW5nKHJlZ3x8IiIpLnRyaW0oKTsKICAgICAgZWwudGV4dENvbnRlbnQgPSB2ID8gKCJSRUcgIiArIHYpIDogIiI7CiAgICB9Y2F0Y2goZSl7fQogIH0KCiAgY29uc3QgTlMgPSAiZncuIjsKICBmdW5jdGlvbiBub3coKXsgcmV0dXJuIERhdGUubm93KCk7IH0KICBmdW5jdGlvbiBnZXQoa2V5KXsKICAgIHRyeXsKICAgICAgY29uc3QgcmF3ID0gbG9jYWxTdG9yYWdlLmdldEl0ZW0oTlMra2V5KTsKICAgICAgaWYgKCFyYXcpIHJldHVybiBudWxsOwogICAgICBjb25zdCBvYmogPSBKU09OLnBhcnNlKHJhdyk7CiAgICAgIGlmICghb2JqIHx8IHR5cGVvZiBvYmogIT09ICJvYmplY3QiKSByZXR1cm4gbnVsbDsKICAgICAgaWYgKG9iai5leHAgJiYgbm93KCkgPiBvYmouZXhwKSB7IGxvY2FsU3RvcmFnZS5yZW1vdmVJdGVtKE5TK2tleSk7IHJldHVybiBudWxsOyB9CiAgICAgIHJldHVybiAob2JqLnZhbCA9PT0gdW5kZWZpbmVkKSA/IG51bGwgOiBvYmoudmFsOwogICAgfWNhdGNoKGUpeyByZXR1cm4gbnVsbDsgfQogIH0KICBmdW5jdGlvbiBzZXQoa2V5LCB2YWwsIHR0bE1zKXsKICAgIHRyeXsKICAgICAgY29uc3QgZXhwID0gdHRsTXMgPyAobm93KCkgKyB0dGxNcykgOiAwOwogICAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbShOUytrZXksIEpTT04uc3RyaW5naWZ5KHsgZXhwLCB2YWwgfSkpOwogICAgICByZXR1cm4gdHJ1ZTsKICAgIH1jYXRjaChlKXsgcmV0dXJuIGZhbHNlOyB9CiAgfQogIGZ1bmN0aW9uIGRlbChrZXkpeyB0cnl7IGxvY2FsU3RvcmFnZS5yZW1vdmVJdGVtKE5TK2tleSk7IH1jYXRjaChlKXt9IH0KICB3aW5kb3cuX19GV19MU19fID0geyBnZXQsIHNldCwgZGVsIH07CnRyeXsgd2luZG93Ll9fRldfRk9SQ0VfUk9VVEVfUkFXX18gPSB1cGRhdGU7IHdpbmRvdy5fX0ZXX0ZPUkNFX1JPVVRFX18gPSAoKT0+eyB0cnl7IGlmKF9fZndJc1N0YWJsZVJvdXRlKCkpIHJldHVybiB3aW5kb3cuX19GV19GT1JDRV9ST1VURV9SQVdfXygpOyB9Y2F0Y2goZSl7fSB9OyB9Y2F0Y2goZSl7fSAvLyB2MTI1X3dyYXBfZm9yY2Vfcm91dGUKfSkoKTsKCgovLyBBSVJDUkFGVDogbW9kdWxlIHYxMTMgKG1haW4gdGlsZSBvbmx5KQovLyBVc2VzIHlvdXIgQ2xvdWRmbGFyZSBXb3JrZXIgYXMgYSBwcm94eTogR0VUIC9haXJjcmFmdC9pY2FvMjQvPGhleD4KLy8gRmFsbHMgYmFjayB0byBzaG93aW5nIGJhc2ljIHJhZGFyIHR5cGUgaWYgdGhlIGVuZHBvaW50IGlzbid0IGF2YWlsYWJsZSBvciB0aGUgbW9kZWwgaXMgdW5rbm93bi4KKGZ1bmN0aW9uKCl7CiAgY29uc3QgQUVST19QUk9YWV9PUklHSU4gPSAiaHR0cHM6Ly9mbGlnaHRzYWJvdmUudDJoa21oZ2J3ei53b3JrZXJzLmRldiI7CiAgY29uc3QgVFRMX01TID0gMjQgKiA2MCAqIDYwICogMTAwMDsgLy8gMjRoIChhaXJjcmFmdCBtb2RlbCBkb2Vzbid0IGNoYW5nZSBvZnRlbikKICBjb25zdCBjYWNoZSA9IG5ldyBNYXAoKTsgLy8gaWNhbzI0IC0+IHt0cywgdGV4dH0KICBsZXQgbGFzdEtleSA9ICIiOwogIGxldCBiYWNrb2ZmVW50aWwgPSAwOwoKICBmdW5jdGlvbiBub3coKXsgcmV0dXJuIERhdGUubm93KCk7IH0KICBmdW5jdGlvbiBzZXRNb2RlbExpbmVzVjExNChsaW5lMSwgbGluZTIpewogICAgY29uc3QgZWwxID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoIm1vZGVsIik7CiAgICBpZiAoZWwxKSBlbDEudGV4dENvbnRlbnQgPSBTdHJpbmcobGluZTF8fCIiKS50cmltKCkgfHwgIuKAlCI7CiAgICBjb25zdCBlbDIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgibW9kZWwyIik7CiAgICBpZiAoZWwyKSBlbDIudGV4dENvbnRlbnQgPSBTdHJpbmcobGluZTJ8fCIiKS50cmltKCkgfHwgIiI7CiAgfQogIGZ1bmN0aW9uIGdldENhY2hlZChrZXkpewogICAgLy8gcGVyc2lzdGVudCBmaXJzdAogICAgY29uc3QgbHMgPSB3aW5kb3cuX19GV19MU19fOwogICAgY29uc3QgcCA9IChscyAmJiBscy5nZXQpID8gbHMuZ2V0KGBhaXJjcmFmdC52MTQ5LiR7a2V5fWApIDogbnVsbDsKICAgIGlmIChwKXsKICAgICAgLy8gdjE0OTogaWdub3JlIHN0YWxlL2ludmFsaWQgY2FjaGVkIHNoYXBlcyBmcm9tIG9sZGVyIHZlcnNpb25zCiAgICAgIGlmIChwID09PSAiTkYiKSByZXR1cm4gbnVsbDsKICAgICAgaWYgKHR5cGVvZiBwICE9PSAib2JqZWN0IiB8fCAhKCJsaW5lMSIgaW4gcCkgJiYgISgibGluZTIiIGluIHApKSByZXR1cm4gbnVsbDsKICAgICAgcmV0dXJuIHA7CiAgICB9CgogICAgY29uc3QgaXQgPSBjYWNoZS5nZXQoa2V5KTsKICAgIGlmICghaXQpIHJldHVybiBudWxsOwogICAgaWYgKG5vdygpIC0gaXQudHMgPiBUVExfTVMpeyBjYWNoZS5kZWxldGUoa2V5KTsgcmV0dXJuIG51bGw7IH0KICAgIHJldHVybiBpdC50ZXh0OwogIH0KICBmdW5jdGlvbiBwdXROZWdDYWNoZWQoa2V5KXsKICAgIGNvbnN0IGxzID0gd2luZG93Ll9fRldfTFNfXzsKICAgIGlmIChscyAmJiBscy5zZXQpIGxzLnNldChgYWlyY3JhZnQudjE0OS4ke2tleX1gLCAiTkYiLCBQX05FR19UVExfTVMpOwogICAgY2FjaGUuc2V0KGtleSwge3RzOiBub3coKSwgdGV4dDogIk5GIn0pOwogIH0KCiAgZnVuY3Rpb24gcHV0Q2FjaGVkKGtleSwgdGV4dCl7CiAgICAvLyBwZXJzaXN0IGJlc3QtZWZmb3J0CiAgICBjb25zdCBscyA9IHdpbmRvdy5fX0ZXX0xTX187CiAgICBpZiAobHMgJiYgbHMuc2V0KSBscy5zZXQoYGFpcmNyYWZ0LnYxNDkuJHtrZXl9YCwgdGV4dCwgUF9UVExfTVMpOwoKICAgIGNhY2hlLnNldChrZXksIHt0czogbm93KCksIHRleHR9KTsKICB9CiAgZnVuY3Rpb24gY2xlYW4ocyl7CiAgICByZXR1cm4gU3RyaW5nKHN8fCIiKS5yZXBsYWNlKC9ccysvZywiICIpLnRyaW0oKTsKICB9CiAgZnVuY3Rpb24gbm9ybWFsaXplSGV4KGgpewogICAgcmV0dXJuIFN0cmluZyhofHwiIikudHJpbSgpLnRvTG93ZXJDYXNlKCk7CiAgfQogIGZ1bmN0aW9uIGZvcm1hdEFpcmNyYWZ0KGopewogICAgaWYgKCFqKSByZXR1cm4gbnVsbDsKICAgIC8vIFdvcmtlciBtYXkgcmV0dXJuIHtvaywgZm91bmQsIG1vZGVsLCBtb2RlbENvZGUsIHJlZ2lzdHJhdGlvbiwgbWFudWZhY3R1cmVyfQogICAgY29uc3Qgb2sgPSAoai5vayA9PT0gdW5kZWZpbmVkKSA/IHRydWUgOiAhIWoub2s7CiAgICBjb25zdCBmb3VuZCA9IChqLmZvdW5kID09PSB1bmRlZmluZWQpID8gdHJ1ZSA6ICEhai5mb3VuZDsKICAgIGNvbnN0IGEgPSBqLmFpcmNyYWZ0IHx8IGo7CgogICAgY29uc3QgbW9kZWwgPSBjbGVhbihhLm1vZGVsIHx8IGEudHlwZU5hbWUgfHwgYS50eXBlTmFtZUxvbmcgfHwgYS50eXBlIHx8IGEudHlwZUxvbmcgfHwgYS5tb2RlbE5hbWUgfHwgYS5haXJjcmFmdE1vZGVsIHx8ICIiKTsKICAgIGNvbnN0IG1vZGVsQ29kZSA9IGNsZWFuKGEubW9kZWxDb2RlIHx8IGEuaWNhb0NvZGUgfHwgYS5pY2FvVHlwZSB8fCBhLmljYW9UeXBlRGVzaWduYXRvciB8fCBhLmljYW8gfHwgYS52YXJpYW50IHx8IGEubW9kZWxWYXJpYW50IHx8ICIiKTsKICAgIGNvbnN0IHJlZyA9IGNsZWFuKGEucmVnaXN0cmF0aW9uIHx8IGEucmVnIHx8ICIiKTsKICAgIGNvbnN0IG1hbnUgPSBjbGVhbihhLm1hbnVmYWN0dXJlciB8fCBhLm1hbnVmYWN0dXJlck5hbWUgfHwgIiIpOwoKICAgIGlmICghb2sgfHwgIWZvdW5kKXsKICAgICAgcmV0dXJuIHsgbGluZTE6ICJBaXJjcmFmdDogdW5hdmFpbGFibGUiLCBsaW5lMjogb2sgJiYgIWZvdW5kID8gIk5vIGFpcmNyYWZ0IHJlY29yZCIgOiAiTG9va3VwIGZhaWxlZCIgfTsKICAgIH0KCiAgICAvLyBMaW5lIDE6IG1vZGVsICsgKG1vZGVsQ29kZSkgd2hlbiBib3RoIGV4aXN0IGFuZCBkaWZmZXIKICAgIGxldCBsaW5lMSA9IG1vZGVsIHx8IG1vZGVsQ29kZSB8fCAiQWlyY3JhZnQ6IHVua25vd24iOwogICAgaWYgKG1vZGVsICYmIG1vZGVsQ29kZSAmJiBtb2RlbENvZGUudG9VcHBlckNhc2UoKSAhPSBtb2RlbC50b1VwcGVyQ2FzZSgpKXsKICAgICAgbGluZTEgPSBgJHttb2RlbH0gKCR7bW9kZWxDb2RlfSlgOwogICAgfQoKICAgIC8vIExpbmUgMjogUkVHIGZpcnN0LCB0aGVuIG1hbnVmYWN0dXJlciAob3B0aW9uYWwpCiAgICBsZXQgbGluZTIgPSAiIjsKICAgIGlmIChyZWcpIGxpbmUyID0gYFJFRyAke3JlZ31gOwogICAgaWYgKG1hbnUpIGxpbmUyID0gbGluZTIgPyBgJHtsaW5lMn0g4oCiICR7bWFudX1gIDogbWFudTsKCiAgICByZXR1cm4geyBsaW5lMSwgbGluZTIgfTsKICB9CiAgYXN5bmMgZnVuY3Rpb24gZmV0Y2hBaXJjcmFmdEJ5SWNhbzI0KGljYW8yNCl7CiAgICBjb25zdCBoZXggPSBub3JtYWxpemVIZXgoaWNhbzI0KTsKICAgIGlmICghaGV4KSByZXR1cm4gbnVsbDsKCiAgICBjb25zdCBjYWNoZWQgPSBnZXRDYWNoZWQoaGV4KTsKICAgIGlmIChjYWNoZWQgJiYgdHlwZW9mIGNhY2hlZCA9PT0gIm9iamVjdCIpIHJldHVybiBjYWNoZWQ7CiAgICBpZiAobm93KCkgPCBiYWNrb2ZmVW50aWwpIHJldHVybiBudWxsOwoKICAgIGNvbnN0IGJhc2UgPSBTdHJpbmcoQUVST19QUk9YWV9PUklHSU58fCIiKS5yZXBsYWNlKC9cLyQvLCIiKTsKICAgIGNvbnN0IHVybCA9IGAke2Jhc2V9L2FpcmNyYWZ0L2ljYW8yNC8ke2VuY29kZVVSSUNvbXBvbmVudChoZXgpfWA7CgogICAgdHJ5ewogICAgICBjb25zdCByZXMgPSBhd2FpdCBmZXRjaCh1cmwsIHttZXRob2Q6IkdFVCIsIGNhY2hlOiJuby1zdG9yZSJ9KTsKICAgICAgaWYgKHJlcy5zdGF0dXMgPT09IDQyOSl7CiAgICAgICAgYmFja29mZlVudGlsID0gbm93KCkgKyAyKjYwKjEwMDA7CiAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgIH0KICAgICAgaWYgKCFyZXMub2spIHJldHVybiBudWxsOwogICAgICBjb25zdCBqID0gYXdhaXQgcmVzLmpzb24oKTsKCiAgICAgIGNvbnN0IGZtdCA9IGZvcm1hdEFpcmNyYWZ0KGopOwogICAgICBpZiAoIWZtdCkgcmV0dXJuIG51bGw7CiAgICAgIHB1dENhY2hlZChoZXgsIGZtdCk7CiAgICAgIHJldHVybiBmbXQ7CiAgICB9Y2F0Y2goZSl7CiAgICAgIHJldHVybiBudWxsOwogICAgfQogIH0KCiAgYXN5bmMgZnVuY3Rpb24gdXBkYXRlQWlyY3JhZnRGb3JDdXJyZW50KCl7CiAgICB0cnl7CiAgICAgIGNvbnN0IGYgPSB3aW5kb3cuX19GV19DVVJSRU5UX0ZMSUdIVCB8fCB7fTsKICAgICAgY29uc3QgaGV4ID0gZi5pY2FvMjQgfHwgZi5pY2FvIHx8ICIiOwogICAgICBpZiAoIWhleCl7IHNldE1vZGVsTGluZXNWMTE0KCLigJQiLCAiIik7IHJldHVybjsgfQoKICAgICAgY29uc3Qga2V5ID0gbm9ybWFsaXplSGV4KGhleCk7CiAgICAgIGlmIChrZXkgIT09IGxhc3RLZXkpewogICAgICAgIGxhc3RLZXkgPSBrZXk7CiAgICAgICAgLy8gU2hvdyB3aGF0ZXZlciB3ZSBhbHJlYWR5IGhhdmUgZnJvbSByYWRhciBpbW1lZGlhdGVseSAoaWYgYW55KQogICAgICAgIGNvbnN0IHJhZGFyVHlwZSA9IGNsZWFuKGYudHlwZSB8fCBmLmFpcmNyYWZ0VHlwZSB8fCBmLm1vZGVsIHx8ICIiKTsKICAgICAgICBzZXRNb2RlbExpbmVzVjExNChyYWRhclR5cGUgfHwgIuKAlCIsICIiKTsKICAgICAgfQoKICAgICAgY29uc3QgZm10ID0gYXdhaXQgZmV0Y2hBaXJjcmFmdEJ5SWNhbzI0KGtleSk7CiAgICAgIGlmIChmbXQpIHsKICAgICAgICBjb25zdCBjdXJLZXkgPSBub3JtYWxpemVIZXgoKHdpbmRvdy5fX0ZXX0NVUlJFTlRfRkxJR0hUfHx7fSkuaWNhbzI0KTsKICAgICAgICBjb25zdCBsYXN0S2V5ID0gKHdpbmRvdy5fX0ZXX0xBU1RfQUlSQ1JBRlRfS0VZX198fCIiKTsKICAgICAgICBpZiAoY3VyS2V5ID09PSBrZXkgfHwgbGFzdEtleSA9PT0ga2V5KSB7CiAgICAgICAgdHJ5ewogICAgICAgICAgY29uc3QgY3VyID0gKHdpbmRvdy5fX0ZXX0NVUlJFTlRfRkxJR0hUfHx7fSk7CiAgICAgICAgICBjdXIuZXhhY3RNb2RlbDEgPSBmbXQubGluZTE7CiAgICAgICAgICBjdXIuZXhhY3RNb2RlbDIgPSBmbXQubGluZTI7CiAgICAgICAgfWNhdGNoKGUpe30KICAgICAgICBzZXRNb2RlbExpbmVzVjExNChmbXQubGluZTEsIGZtdC5saW5lMik7CiAgICAgICAgfQogICAgICB9CiAgICB9Y2F0Y2goZSl7CiAgICAgIC8vIG5vLW9wCiAgICB9CiAgfQoKICAvLyBFeHBvc2UgZm9yIHRoZSBleGlzdGluZyByZW5kZXIvdXBkYXRlIGxvb3AKICB3aW5kb3cuX19GV19VUERBVEVfQUlSQ1JBRlRfUkFXX18gPSB1cGRhdGVBaXJjcmFmdEZvckN1cnJlbnQ7CiAgd2luZG93Ll9fRldfVVBEQVRFX0FJUkNSQUZUX18gPSAoKT0+eyB0cnl7IGlmKHRydWUpIHJldHVybiB3aW5kb3cuX19GV19VUERBVEVfQUlSQ1JBRlRfUkFXX18oKTsgfWNhdGNoKGUpe30gfTsgLy8gdjEyNV93cmFwX2FpcmNyYWZ0CiAgLy8gdjEyMDogdHJhY2sgbGFzdCBhaXJjcmFmdCBrZXkgdG8gYXZvaWQgdGltaW5nIHJhY2VzCiAgd2luZG93Ll9fRldfTEFTVF9BSVJDUkFGVF9LRVlfXyA9ICIiOwp9KSgpOwoKCi8qIFJPVVRFOiB3aXJpbmcgdjExMCAoc2FmZSwgaW5jbHVkZXMgZGlyZWN0aW9uIGZpeCkgKi8KaWYgKCF3aW5kb3cuX19GV19ST1VURV9XSVJFRF9fKSB7CiAgd2luZG93Ll9fRldfUk9VVEVfV0lSRURfXyA9IHRydWU7IC8vIHJvdXRlRGlyZWN0aW9uRml4VjExMAoKICAoZnVuY3Rpb24oKXsKICAgIGNvbnN0IF9BRVJPX09SSUdJTiA9ICJodHRwczovL2ZsaWdodHNhYm92ZS50MmhrbWhnYnd6LndvcmtlcnMuZGV2IjsKICAgIGNvbnN0IF9UVEwgPSA2MCAqIDYwICogMTAwMDsKICAgIGNvbnN0IF9jYWNoZSA9IG5ldyBNYXAoKTsKICAgIGNvbnN0IF9sYXN0R29vZFJvdXRlVjEyMiA9IG5ldyBNYXAoKTsgLy8gY2FsbHNpZ24gLT4gbGFzdCBnb29kIHJvdXRlIChwcmV2ZW50cyBkb3duZ3JhZGUgZmxpY2tlcikKICAgIGxldCBfbGFzdCA9ICIiOwogICAgbGV0IF9iYWNrb2ZmVW50aWwgPSAwOwoKICAgIAogICAgCiAgICBjb25zdCBST1VURV9QX1RUTF9NUyA9IDYgKiA2MCAqIDYwICogMTAwMDsgLy8gcGVyc2lzdGVudCA2aAogICAgY29uc3QgUk9VVEVfUF9ORUdfVFRMX01TID0gMzAgKiA2MCAqIDEwMDA7IC8vIHBlcnNpc3RlbnQgMzBtIGZvciB1bmF2YWlsYWJsZQogICAgY29uc3QgX3JvdXRlRmV0Y2hHYXRlID0gbmV3IE1hcCgpOyAvLyBjYWxsc2lnbiAtPiBsYXN0RmV0Y2hUcwogICAgY29uc3QgUk9VVEVfUkVGUkVTSF9NSU5fTVMgPSAyMCAqIDEwMDA7IC8vIHYxMTk6IGZhc3RlciByZXRyeSB3aW5kb3cKICAgIGNvbnN0IFJPVVRFX1JFVFJZX1NPT05fTVMgPSA1ICogMTAwMDsgLy8gdjExOTogcXVpY2sgcmV0cnkgd2hlbiBubyByb3V0ZQpjb25zdCBwcmV2UG9zTWFwVjExMSA9IG5ldyBNYXAoKTsgLy8gaWNhbzI0IC0+IHtsYXQsIGxvbiwgdHN9CmZ1bmN0aW9uIF9ub3coKXsgcmV0dXJuIERhdGUubm93KCk7IH0KICAgIGZ1bmN0aW9uIF9maXhBcnJvdyhzKXsKICAgICAgcmV0dXJuIFN0cmluZyhzfHwiIikucmVwbGFjZSgvw6LigKDigJkvZywi4oaSIikucmVwbGFjZSgvw6LChsKSL2csIuKGkiIpLnRyaW0oKTsKICAgIH0KICAgIGZ1bmN0aW9uIF9jbGVhbkNpdHkocyl7CiAgICAgIHJldHVybiBTdHJpbmcoc3x8IiIpLnJlcGxhY2UoL1xzKy9nLCIgIikucmVwbGFjZSgvXC8rJC9nLCIiKS50cmltKCk7CiAgICB9CgogICAgLy8gcm91dGVEaXJlY3Rpb25GaXhWMTEwOiB1c2UgYWlyY3JhZnQgdHJ1ZSB0cmFjayB2cyBiZWFyaW5nIHRvIGFpcnBvcnRzIHRvIGRlY2lkZSBkaXJlY3Rpb24KICAgIGZ1bmN0aW9uIF90b1JhZChkKXsgcmV0dXJuIGQgKiBNYXRoLlBJIC8gMTgwOyB9CiAgICBmdW5jdGlvbiBfdG9EZWcocil7IHJldHVybiByICogMTgwIC8gTWF0aC5QSTsgfQogICAgZnVuY3Rpb24gX2JlYXJpbmdEZWcobGF0MSwgbG9uMSwgbGF0MiwgbG9uMil7CiAgICAgIGNvbnN0IM+GMT1fdG9SYWQobGF0MSksIM+GMj1fdG9SYWQobGF0Mik7CiAgICAgIGNvbnN0IM6Uzrs9X3RvUmFkKGxvbjItbG9uMSk7CiAgICAgIGNvbnN0IHk9TWF0aC5zaW4ozpTOuykqTWF0aC5jb3Moz4YyKTsKICAgICAgY29uc3QgeD1NYXRoLmNvcyjPhjEpKk1hdGguc2luKM+GMikgLSBNYXRoLnNpbijPhjEpKk1hdGguY29zKM+GMikqTWF0aC5jb3MozpTOuyk7CiAgICAgIGxldCDOuD1fdG9EZWcoTWF0aC5hdGFuMih5LHgpKTsKICAgICAgaWYgKM64PDApIM64Kz0zNjA7CiAgICAgIHJldHVybiDOuDsKICAgIH0KICAgIGZ1bmN0aW9uIF9hbmdEaWZmKGEsYil7CiAgICAgIGNvbnN0IGQ9TWF0aC5hYnMoYS1iKSUzNjA7CiAgICAgIHJldHVybiBkPjE4MCA/IDM2MC1kIDogZDsKICAgIH0KICAgIGZ1bmN0aW9uIF9nZXRGbGlnaHRUcmFjaygpewogICAgICB0cnl7CiAgICAgICAgY29uc3QgZiA9IHdpbmRvdy5fX0ZXX0NVUlJFTlRfRkxJR0hUIHx8IHt9OwogICAgICAgIC8vIFByZWZlciBkaXJlY3QgdHJhY2svaGVhZGluZyBmcm9tIHJhZGFyCiAgICAgICAgY29uc3QgcmF3ID0gTnVtYmVyKGYudHJhY2sgPz8gZi5oZWFkaW5nID8/IGYudHJ1ZV90cmFjayA/PyBmLnRyayk7CiAgICAgICAgY29uc3QgaGFzID0gTnVtYmVyLmlzRmluaXRlKHJhdyk7CiAgICAgICAgaWYgKGhhcykgcmV0dXJuICgocmF3JTM2MCkrMzYwKSUzNjA7CgogICAgICAgIC8vIEZhbGxiYWNrOiBjb21wdXRlIGJlYXJpbmcgZnJvbSBwcmV2aW91cyBwb3NpdGlvbiAocmVxdWlyZXMgc3RhYmxlIGljYW8yNCArIGxhdC9sb24pCiAgICAgICAgY29uc3QgaWNhbyA9IFN0cmluZyhmLmljYW8yNCB8fCBmLmljYW8gfHwgIiIpLnRyaW0oKTsKICAgICAgICBjb25zdCBsYXQgPSBOdW1iZXIoZi5sYXQpLCBsb24gPSBOdW1iZXIoZi5sb24pOwogICAgICAgIGNvbnN0IHRzID0gRGF0ZS5ub3coKTsKICAgICAgICBpZiAoIWljYW8gfHwgIU51bWJlci5pc0Zpbml0ZShsYXQpIHx8ICFOdW1iZXIuaXNGaW5pdGUobG9uKSkgcmV0dXJuIG51bGw7CiAgICAgICAgY29uc3QgcHJldiA9IHByZXZQb3NNYXBWMTExLmdldChpY2FvKTsKICAgICAgICBwcmV2UG9zTWFwVjExMS5zZXQoaWNhbywge2xhdCwgbG9uLCB0c30pOwogICAgICAgIGlmICghcHJldikgcmV0dXJuIG51bGw7CiAgICAgICAgLy8gSWdub3JlIGlmIHRvbyBvbGQgb3IgdG9vIGNsb3NlCiAgICAgICAgaWYgKHRzIC0gcHJldi50cyA+IDIqNjAqMTAwMCkgcmV0dXJuIG51bGw7CiAgICAgICAgY29uc3QgZGxhdCA9IE1hdGguYWJzKGxhdCAtIHByZXYubGF0KTsKICAgICAgICBjb25zdCBkbG9uID0gTWF0aC5hYnMobG9uIC0gcHJldi5sb24pOwogICAgICAgIGlmIChkbGF0IDwgMC4wMDA1ICYmIGRsb24gPCAwLjAwMDUpIHJldHVybiBudWxsOwogICAgICAgIHJldHVybiBfYmVhcmluZ0RlZyhwcmV2LmxhdCwgcHJldi5sb24sIGxhdCwgbG9uKTsKICAgICAgfWNhdGNoKGUpeyByZXR1cm4gbnVsbDsgfQogICAgfQogICAgZnVuY3Rpb24gX3NldCh0KXsKICAgICAgY29uc3QgZWwgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgicm91dGUiKTsKICAgICAgaWYgKCFlbCkgcmV0dXJuOwogICAgICBjb25zdCBuZXh0ID0gU3RyaW5nKHR8fCIiKS50cmltKCk7CiAgICAgIGNvbnN0IGN1ciA9IFN0cmluZyhlbC50ZXh0Q29udGVudHx8IiIpLnRyaW0oKTsKICAgICAgLy8gdjEyMzogbmV2ZXIgZG93bmdyYWRlIGEgZ29vZCByb3V0ZSBiYWNrIHRvIEVOIFJPVVRFL3VuYXZhaWxhYmxlCiAgICAgIGNvbnN0IGN1cklzR29vZCA9IGN1ci5pbmNsdWRlcygi4oaSIik7CiAgICAgIGNvbnN0IG5leHRVcHBlciA9IG5leHQudG9VcHBlckNhc2UoKTsKICAgICAgY29uc3QgbmV4dElzRmFsbGJhY2sgPSAoIW5leHQgfHwgbmV4dFVwcGVyPT09IkVOIFJPVVRFIiB8fCBuZXh0VXBwZXI9PT0iVU5BVkFJTEFCTEUiIHx8IG5leHQudG9Mb3dlckNhc2UoKT09PSJ1bmF2YWlsYWJsZSIpOwogICAgICBpZiAoY3VySXNHb29kICYmIG5leHRJc0ZhbGxiYWNrKSByZXR1cm47CiAgICAgIGVsLnRleHRDb250ZW50ID0gbmV4dDsKICAgIH0KICAgIGZ1bmN0aW9uIF9nZXRDYWNoZWQoY3MpewogICAgICBjb25zdCBpdCA9IF9jYWNoZS5nZXQoY3MpOwogICAgICBpZiAoIWl0KSByZXR1cm4gbnVsbDsKICAgICAgaWYgKF9ub3coKSAtIGl0LnRzID4gX1RUTCkgeyBfY2FjaGUuZGVsZXRlKGNzKTsgcmV0dXJuIG51bGw7IH0KICAgICAgcmV0dXJuIGl0LnRleHQ7CiAgICB9CiAgICBmdW5jdGlvbiBfc2V0Q2FjaGVkKGNzLCB0eHQpewogICAgICBfY2FjaGUuc2V0KGNzLCB7dHM6X25vdygpLCB0ZXh0OnR4dH0pOwogICAgfQoKICAgIGFzeW5jIGZ1bmN0aW9uIF9mZXRjaChjcyl7CiAgICAgIGNvbnN0IGtleSA9IFN0cmluZyhjc3x8IiIpLnRyaW0oKS50b1VwcGVyQ2FzZSgpOwogICAgICBpZiAoIWtleSkgcmV0dXJuIG51bGw7CgogICAgICBjb25zdCBjID0gX2dldENhY2hlZChrZXkpOwogICAgICBpZiAoYykgcmV0dXJuIGM7CiAgICAgIGlmIChfbm93KCkgPCBfYmFja29mZlVudGlsKSByZXR1cm4gbnVsbDsKCiAgICAgIGNvbnN0IGJhc2UgPSBTdHJpbmcoX0FFUk9fT1JJR0lOKS5yZXBsYWNlKC9cLyQvLCIiKTsKICAgICAgY29uc3QgdXJsID0gYCR7YmFzZX0vYWVyby8ke2VuY29kZVVSSUNvbXBvbmVudChrZXkpfWA7CgogICAgICBjb25zdCByZXMgPSBhd2FpdCBmZXRjaCh1cmwsIHttZXRob2Q6IkdFVCIsIGNhY2hlOiJuby1zdG9yZSJ9KTsKICAgICAgaWYgKHJlcy5zdGF0dXMgPT09IDQyOSkgeyBfYmFja29mZlVudGlsID0gX25vdygpICsgMio2MCoxMDAwOyByZXR1cm4gbnVsbDsgfQogICAgICBpZiAoIXJlcy5vaykgcmV0dXJuIG51bGw7CgogICAgICBjb25zdCBqID0gYXdhaXQgcmVzLmpzb24oKTsKICAgICAgbGV0IHR4dCA9ICIiOwogICAgICAvLyBQcmVmZXIgd29ya2VyLXByb3ZpZGVkIHJvdXRlIHN0cmluZyAoa2VlcHMgY29ycmVjdCBkaXJlY3Rpb24pLCB0aGVuIGZhbGwgYmFjayB0byBvYmplY3RzCiAgICAgIGlmIChqICYmIHR5cGVvZiBqLnJvdXRlPT09InN0cmluZyIgJiYgai5yb3V0ZS50cmltKCkpIHR4dCA9IGoucm91dGU7CgogICAgICBpZiAoIXR4dCAmJiBqICYmIGoub3JpZ2luICYmIGouZGVzdGluYXRpb24pewogICAgICAgIGNvbnN0IG89ai5vcmlnaW4sIGQ9ai5kZXN0aW5hdGlvbjsKICAgICAgICBjb25zdCBvYz1fY2xlYW5DaXR5KG8ubXVuaWNpcGFsaXR5TmFtZXx8by5jaXR5fHxvLm5hbWV8fCIiKTsKICAgICAgICBjb25zdCBkYz1fY2xlYW5DaXR5KGQubXVuaWNpcGFsaXR5TmFtZXx8ZC5jaXR5fHxkLm5hbWV8fCIiKTsKICAgICAgICBjb25zdCBvaT0oby5pYXRhfHxvLmljYW98fCIiKTsKICAgICAgICBjb25zdCBkaT0oZC5pYXRhfHxkLmljYW98fCIiKTsKICAgICAgICBjb25zdCBsZWZ0PShvYyYmb2kpP2Ake29jfSAoJHtvaX0pYDoob2N8fG9pKTsKICAgICAgICBjb25zdCByaWdodD0oZGMmJmRpKT9gJHtkY30gKCR7ZGl9KWA6KGRjfHxkaSk7CiAgICAgICAgaWYgKGxlZnQgJiYgcmlnaHQpIHR4dCA9IGAke2xlZnR9IOKGkiAke3JpZ2h0fWA7CgogICAgICAvLyByb3V0ZURpcmVjdGlvbkZpeFYxMTA6IGlmIHRyYWNrICsgY29vcmRzIGV4aXN0LCBkZWNpZGUgd2hpY2ggc2lkZSBpcyBkZXN0aW5hdGlvbgogICAgICB0cnl7CiAgICAgICAgY29uc3QgdHJrID0gX2dldEZsaWdodFRyYWNrKCk7CiAgICAgICAgY29uc3QgZiA9IHdpbmRvdy5fX0ZXX0NVUlJFTlRfRkxJR0hUIHx8IHt9OwogICAgICAgIGNvbnN0IGZsYXQgPSBOdW1iZXIoZi5sYXQpLCBmbG9uID0gTnVtYmVyKGYubG9uKTsKICAgICAgICBjb25zdCBvbGF0ID0gTnVtYmVyKG8gJiYgby5sb2NhdGlvbiAmJiBvLmxvY2F0aW9uLmxhdCksIG9sb24gPSBOdW1iZXIobyAmJiBvLmxvY2F0aW9uICYmIG8ubG9jYXRpb24ubG9uKTsKICAgICAgICBjb25zdCBkbGF0ID0gTnVtYmVyKGQgJiYgZC5sb2NhdGlvbiAmJiBkLmxvY2F0aW9uLmxhdCksIGRsb24gPSBOdW1iZXIoZCAmJiBkLmxvY2F0aW9uICYmIGQubG9jYXRpb24ubG9uKTsKICAgICAgICBpZiAodHJrIT1udWxsICYmIE51bWJlci5pc0Zpbml0ZShmbGF0KSAmJiBOdW1iZXIuaXNGaW5pdGUoZmxvbikgJiYKICAgICAgICAgICAgTnVtYmVyLmlzRmluaXRlKG9sYXQpICYmIE51bWJlci5pc0Zpbml0ZShvbG9uKSAmJgogICAgICAgICAgICBOdW1iZXIuaXNGaW5pdGUoZGxhdCkgJiYgTnVtYmVyLmlzRmluaXRlKGRsb24pKXsKICAgICAgICAgIGNvbnN0IGJUb08gPSBfYmVhcmluZ0RlZyhmbGF0LCBmbG9uLCBvbGF0LCBvbG9uKTsKICAgICAgICAgIGNvbnN0IGJUb0QgPSBfYmVhcmluZ0RlZyhmbGF0LCBmbG9uLCBkbGF0LCBkbG9uKTsKICAgICAgICAgIGNvbnN0IGRpZmZPID0gX2FuZ0RpZmYodHJrLCBiVG9PKTsKICAgICAgICAgIGNvbnN0IGRpZmZEID0gX2FuZ0RpZmYodHJrLCBiVG9EKTsKICAgICAgICAgIC8vIEFpcmNyYWZ0IGlzICh1c3VhbGx5KSBmbHlpbmcgdG93YXJkIHRoZSBzbWFsbGVyIGFuZ3VsYXIgZGlmZmVyZW5jZS4KICAgICAgICAgIGNvbnN0IF9hbGxvd0ZsaXAgPSAodHlwZW9mIHdpbmRvdyAhPT0gJ3VuZGVmaW5lZCcgJiYgd2luZG93Ll9fRldfUk9VVEVfQUxMT1dfRkxJUF9fKTsKICAgICAgICAgIGlmIChfYWxsb3dGbGlwICYmIChkaWZmTyArIDE1IDwgZGlmZkQpKXsKICAgICAgICAgICAgLy8gc3dhcDogZGVzdGluYXRpb24gaXMgYWN0dWFsbHkgb3JpZ2luIHBlciBBUEkgKGZsaXAgZGlzcGxheSkKICAgICAgICAgICAgdHh0ID0gYCR7cmlnaHR9IOKGkiAke2xlZnR9YDsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHR4dCA9IGAke2xlZnR9IOKGkiAke3JpZ2h0fWA7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9Y2F0Y2goZSl7fQoKICAgICAgfQoKICAgICAgdHh0ID0gX2ZpeEFycm93KHR4dCk7CiAgICAgIGlmICghdHh0IHx8IHR4dD09PSJ1bmF2YWlsYWJsZSIpIHJldHVybiBudWxsOwoKICAgICAgX3NldENhY2hlZChrZXksIHR4dCk7CiAgICAgIHJldHVybiB0eHQ7CiAgICB9CgogICAgYXN5bmMgZnVuY3Rpb24gdXBkYXRlKCl7CiAgICAgIHRyeXsKICAgICAgICBjb25zdCBmID0gd2luZG93Ll9fRldfQ1VSUkVOVF9GTElHSFQ7CiAgICAgICAgY29uc3QgY3MgPSBub3JtQ2FsbHNpZ24oKGYgJiYgZi5jYWxsc2lnbikgPyBmLmNhbGxzaWduIDogIiIpOwogICAgICAgIC8vIHYxMTU6IGxvYWQgY2FjaGVkIHJvdXRlIGltbWVkaWF0ZWx5IChpZiBhbnkpCiAgICAgICAgdHJ5ewogICAgICAgICAgY29uc3QgbHMgPSB3aW5kb3cuX19GV19MU19fOwogICAgICAgICAgY29uc3QgY2FjaGVkID0gKGxzICYmIGxzLmdldCkgPyBscy5nZXQoYHJvdXRlLiR7Y3N9YCkgOiBudWxsOwogICAgICAgICAgaWYgKGNhY2hlZCAmJiBjYWNoZWQucm91dGUpIF9zZXQoX19md0ZpeEFycm93KGNhY2hlZC5yb3V0ZSkpOwogICAgICAgICAgICAgICAgZWxzZSBfc2V0KCJFTiBST1VURSIpOwp9Y2F0Y2goZSl7fQogICAgICAgIC8vIHYxMTY6IGlmIHJvdXRlIGxpbmUgaXMgZW1wdHksIHNob3cgRU4gUk9VVEUgYWZ0ZXIgYSBzaG9ydCBncmFjZSBwZXJpb2QKICAgICAgICBjb25zdCBfcm91dGVFbCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJyb3V0ZSIpOwogICAgICAgIGlmIChfcm91dGVFbCAmJiAhX3JvdXRlRWwudGV4dENvbnRlbnQudHJpbSgpKXsKICAgICAgICAgIGNvbnN0IHRoaXNDcyA9IGNzOwogICAgICAgICAgc2V0VGltZW91dCgoKT0+ewogICAgICAgICAgICB0cnl7CiAgICAgICAgICAgICAgaWYgKF9sYXN0ID09PSB0aGlzQ3MgJiYgX3JvdXRlRWwgJiYgIV9yb3V0ZUVsLnRleHRDb250ZW50LnRyaW0oKSkgX3NldCgiRU4gUk9VVEUiKTsKICAgICAgICAgICAgfWNhdGNoKGUpe30KICAgICAgICAgIH0sIDE4MDApOwogICAgICAgIH0KCiAgICAgICAgLy8gdjExNjogdGhyb3R0bGUgcmVmcmVzaCBmZXRjaGVzIHBlciBjYWxsc2lnbgogICAgICAgIGNvbnN0IF9sYXN0RmV0Y2ggPSBfcm91dGVGZXRjaEdhdGUuZ2V0KGNzKSB8fCAwOwogICAgICAgIGNvbnN0IF9jYW5GZXRjaCA9IChEYXRlLm5vdygpIC0gX2xhc3RGZXRjaCkgPiBST1VURV9SRUZSRVNIX01JTl9NUzsKICAgICAgICAvLyB2MTE5OiBnYXRlIHRpbWVzdGFtcCBzZXQgYWZ0ZXIgZmV0Y2ggYXR0ZW1wdAogICAgICAgIC8vIHYxMTI6IGRlbGF5IGFueSBmbGlwIGRlY2lzaW9uIHVudGlsIHdlJ3ZlIHNlZW4gdGhpcyBjYWxsc2lnbiBhdCBsZWFzdCB0d2ljZQogICAgICAgIHdpbmRvdy5fX0ZXX1JPVVRFX1NFRU5fXyA9IHdpbmRvdy5fX0ZXX1JPVVRFX1NFRU5fXyB8fCBuZXcgTWFwKCk7CiAgICAgICAgY29uc3QgX3NlZW4gPSB3aW5kb3cuX19GV19ST1VURV9TRUVOX187CiAgICAgICAgY29uc3QgX24gPSAoX3NlZW4uZ2V0KGNzKSB8fCAwKSArIDE7CiAgICAgICAgX3NlZW4uc2V0KGNzLCBfbik7CiAgICAgICAgd2luZG93Ll9fRldfUk9VVEVfQUxMT1dfRkxJUF9fID0gKF9uID49IDIpOwogICAgICAgIGlmICghY3MpeyBfc2V0KCJFTiBST1VURSIpOyByZXR1cm47IH0KICAgICAgICBpZiAoY3MgIT09IF9sYXN0KXsKICAgICAgICAgIF9sYXN0ID0gY3M7CiAgICAgICAgICB0cnl7CiAgICAgICAgICAgIGNvbnN0IGxzID0gd2luZG93Ll9fRldfTFNfXzsKICAgICAgICAgICAgY29uc3QgY2FjaGVkID0gKGxzICYmIGxzLmdldCkgPyBscy5nZXQoYHJvdXRlLiR7Y3N9YCkgOiBudWxsOwogICAgICAgICAgICBjb25zdCBjYWNoZWRSb3V0ZSA9IGNhY2hlZCAmJiBjYWNoZWQucm91dGUgPyBfX2Z3Rml4QXJyb3coY2FjaGVkLnJvdXRlKSA6IG51bGw7CiAgICAgICAgICAgIGNvbnN0IGxhc3RHb29kID0gX2xhc3RHb29kUm91dGVWMTIyLmdldChjcykgfHwgbnVsbDsKICAgICAgICAgICAgaWYgKGNhY2hlZFJvdXRlICYmIGNhY2hlZFJvdXRlLmluY2x1ZGVzKCLihpIiKSkgewogICAgICAgICAgICAgIF9zZXQoY2FjaGVkUm91dGUpOwogICAgICAgICAgICAgIF9sYXN0R29vZFJvdXRlVjEyMi5zZXQoY3MsIGNhY2hlZFJvdXRlKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChsYXN0R29vZCAmJiBsYXN0R29vZC5pbmNsdWRlcygi4oaSIikpIHsKICAgICAgICAgICAgICBfc2V0KGxhc3RHb29kKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBfc2V0KCJFTiBST1VURSIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9Y2F0Y2goZSl7IF9zZXQoIkVOIFJPVVRFIik7IH0KICAgICAgICB9CiAgICAgICAgbGV0IHR4dCA9IG51bGw7CiAgICAgICAgaWYgKF9jYW5GZXRjaCkgewogICAgICAgICAgX3JvdXRlRmV0Y2hHYXRlLnNldChjcywgRGF0ZS5ub3coKSk7CiAgICAgICAgICB0eHQgPSBhd2FpdCBfZmV0Y2goY3MpOwogICAgICAgICAgaWYgKCF0eHQpIHsKICAgICAgICAgICAgLy8gYWxsb3cgYSBxdWlja2VyIHJldHJ5IGlmIHVwc3RyZWFtIHdhcyBzbG93L2VtcHR5CiAgICAgICAgICAgIF9yb3V0ZUZldGNoR2F0ZS5zZXQoY3MsIERhdGUubm93KCkgLSAoUk9VVEVfUkVGUkVTSF9NSU5fTVMgLSBST1VURV9SRVRSWV9TT09OX01TKSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmICh0eHQgJiYgX2xhc3QgPT09IGNzKSB7CiAgICAgICAgICBfc2V0KF9fZndGaXhBcnJvdyh0eHQpKTsKICAgICAgICAgIC8vIHYxMTU6IHBlcnNpc3Qgcm91dGUgYmVzdC1lZmZvcnQKICAgICAgICAgIHRyeXsKICAgICAgICAgICAgY29uc3QgbHMyID0gd2luZG93Ll9fRldfTFNfXzsKICAgICAgICAgICAgaWYgKGxzMiAmJiBsczIuc2V0KXsKICAgICAgICAgICAgICBjb25zdCBuZWcgPSAoIXR4dCB8fCB0eHQ9PT0idW5hdmFpbGFibGUiIHx8IHR4dD09PSJlbiByb3V0ZSIpOwogICAgICAgICAgICAgIGxzMi5zZXQoYHJvdXRlLiR7Y3N9YCwge3JvdXRlOiB0eHQsIHRzOiBEYXRlLm5vdygpfSwgbmVnID8gUk9VVEVfUF9ORUdfVFRMX01TIDogUk9VVEVfUF9UVExfTVMpOwogICAgICAgICAgICB9CiAgICAgICAgICB9Y2F0Y2goZSl7fQogICAgICAgIH0gZWxzZSBpZiAoX2xhc3QgPT09IGNzKSB7CiAgICAgICAgICBfc2V0KCJFTiBST1VURSIpOwogICAgICAgIH0KICAgICAgfSBjYXRjaChlKSB7CiAgICAgICAgX3NldCgiRU4gUk9VVEUiKTsKICAgICAgfQogICAgfQoKICAgIHdpbmRvdy5fX0ZXX1VQREFURV9ST1VURV9fID0gdXBkYXRlOwogIH0pKCk7Cn0KCgovLyB2MTA0OiB2aXNpYmxlIGJ1aWxkIHN0YW1wIChoZWxwcyBjb25maXJtIGNhY2hlIGlzIHVwZGF0ZWQpCmNvbnN0IEZXX0JVSUxEX1NUQU1QID0gIjIwMjYtMDItMDIgMjE6MjYgVVRDIjsKCgoKZnVuY3Rpb24gc2V0VmVyc2lvblN0YW1wKCl7CiAgdHJ5ewogICAgY29uc3QgdkVsID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoImZ3LXZlcnNpb24iKTsKICAgIGlmICh2RWwpIHZFbC50ZXh0Q29udGVudCA9ICJ2MTQ5IjsKICAgIGNvbnN0IGJFbCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJmdy1idWlsZCIpOwogICAgaWYgKGJFbCkgYkVsLnRleHRDb250ZW50ID0gRldfQlVJTERfU1RBTVA7CiAgfWNhdGNoKGUpe30KfQpzZXRWZXJzaW9uU3RhbXAoKTsKCmZ1bmN0aW9uIHNldFN0YXR1c0xpbmUodGV4dCl7CiAgY29uc3QgZWwgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgic3RhdHVzIik7CiAgaWYgKCFlbCkgcmV0dXJuOwogIGVsLnRleHRDb250ZW50ID0gdGV4dCB8fCAiUmFkYXI6IOKAlCI7Cn0KCgovLyB2OTI6IGNsb3Nlc3QtZmxpZ2h0IHJvdXRlIGxvb2t1cCAoQWVyb0RhdGFCb3ggV29ya2VyKQpjb25zdCBBRVJPX1BST1hZX09SSUdJTiA9ICJodHRwczovL2ZsaWdodHNhYm92ZS50MmhrbWhnYnd6LndvcmtlcnMuZGV2IjsKY29uc3QgUk9VVEVfQ0FDSEVfVFRMX01TID0gNjAgKiA2MCAqIDEwMDA7IC8vIDYwIG1pbgpjb25zdCByb3V0ZUNhY2hlID0gbmV3IE1hcCgpOyAvLyBjYWxsc2lnbiAtPiB7dHMsIHRleHR9CmxldCBsYXN0Um91dGVLZXkgPSAiIjsKbGV0IHJvdXRlQmFja29mZlVudGlsID0gMDsKCmZ1bmN0aW9uIF9ub3coKXsgcmV0dXJuIERhdGUubm93KCk7IH0KZnVuY3Rpb24gcm91dGVDYWNoZUdldChrZXkpewogIGNvbnN0IGl0ID0gcm91dGVDYWNoZS5nZXQoa2V5KTsKICBpZiAoIWl0KSByZXR1cm4gbnVsbDsKICBpZiAoX25vdygpIC0gaXQudHMgPiBST1VURV9DQUNIRV9UVExfTVMpIHsgcm91dGVDYWNoZS5kZWxldGUoa2V5KTsgcmV0dXJuIG51bGw7IH0KICByZXR1cm4gaXQudGV4dDsKfQpmdW5jdGlvbiByb3V0ZUNhY2hlU2V0KGtleSwgdGV4dCl7CiAgcm91dGVDYWNoZS5zZXQoa2V5LCB7dHM6X25vdygpLCB0ZXh0fSk7Cn0KZnVuY3Rpb24gZml4QXJyb3cocyl7CiAgLy8gRml4IGNvbW1vbiBtb2ppYmFrZSBhcnJvd3MgLT4gIuKGkiIKICByZXR1cm4gU3RyaW5nKHN8fCIiKQogICAgLnJlcGxhY2UoL8Oi4oCg4oCZL2csICLihpIiKQogICAgLnJlcGxhY2UoL8OiwobCki9nLCAi4oaSIikKICAgIC50cmltKCk7Cn0KZnVuY3Rpb24gY2xlYW5DaXR5KHMpewogIC8vIFNvbWUgbXVuaWNpcGFsaXR5L2NpdHkgc3RyaW5ncyBjYW4gZW5kIHdpdGggIi8iIG9yIGNvbnRhaW4gb2RkIHNwYWNpbmcuCiAgcmV0dXJuIFN0cmluZyhzfHwiIikucmVwbGFjZSgvXHMrL2csICIgIikucmVwbGFjZSgvXC8rJC9nLCAiIikudHJpbSgpOwp9CmZ1bmN0aW9uIHNldFJvdXRlTGluZSh0ZXh0KXsKICBjb25zdCBlbCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJyb3V0ZSIpOwogIGlmICghZWwpIHJldHVybjsKICBjb25zdCB0ID0gU3RyaW5nKHRleHR8fCIiKS50cmltKCk7CiAgLy8gQWx3YXlzIHNob3cgc29tZXRoaW5nIHNvIHlvdSBjYW4gdGVsbCBpdCdzIGFsaXZlCiAgZWwudGV4dENvbnRlbnQgPSB0ID8gdCA6ICJFTiBST1VURSI7Cn0KCmFzeW5jIGZ1bmN0aW9uIGZldGNoUm91dGVUZXh0Rm9yQ2FsbHNpZ24oY2FsbHNpZ24pewogIGNvbnN0IGNzID0gbm9ybUNhbGxzaWduKGNhbGxzaWduKTsKICBpZiAoIWNzKSByZXR1cm4gbnVsbDsKCiAgY29uc3QgY2FjaGVkID0gcm91dGVDYWNoZUdldChjcyk7CiAgaWYgKGNhY2hlZCkgcmV0dXJuIGNhY2hlZDsKCiAgaWYgKF9ub3coKSA8IHJvdXRlQmFja29mZlVudGlsKSByZXR1cm4gbnVsbDsKCiAgY29uc3QgYmFzZSA9IFN0cmluZyhBRVJPX1BST1hZX09SSUdJTnx8IiIpLnJlcGxhY2UoL1wvJC8sICIiKTsKICBpZiAoIWJhc2UpIHJldHVybiBudWxsOwoKICBjb25zdCB1cmwgPSBgJHtiYXNlfS9hZXJvLyR7ZW5jb2RlVVJJQ29tcG9uZW50KGNzKX1gOwogIHRyeXsKICAgIGNvbnN0IHJlcyA9IGF3YWl0IGZldGNoKHVybCwge21ldGhvZDoiR0VUIiwgY2FjaGU6Im5vLXN0b3JlIn0pOwogICAgaWYgKHJlcy5zdGF0dXMgPT09IDQyOSl7CiAgICAgIHJvdXRlQmFja29mZlVudGlsID0gX25vdygpICsgMio2MCoxMDAwOwogICAgICByZXR1cm4gbnVsbDsKICAgIH0KICAgIGlmICghcmVzLm9rKSByZXR1cm4gbnVsbDsKCiAgICBjb25zdCBqID0gYXdhaXQgcmVzLmpzb24oKTsKICAgIGxldCB0eHQgPSAiIjsKICAgIC8vIFByZWZlciBjb25zdHJ1Y3RpbmcgZnJvbSBvcmlnaW4vZGVzdGluYXRpb24gKGF2b2lkcyBlbmNvZGluZyBpc3N1ZXMgaW4gai5yb3V0ZSkKICAgIGlmIChqICYmIGoub3JpZ2luICYmIGouZGVzdGluYXRpb24pewogICAgICBjb25zdCBvID0gai5vcmlnaW4sIGQgPSBqLmRlc3RpbmF0aW9uOwogICAgICBjb25zdCBvYyA9IGNsZWFuQ2l0eShvLm11bmljaXBhbGl0eU5hbWUgfHwgby5jaXR5IHx8IG8ubmFtZSB8fCAiIik7CiAgICAgIGNvbnN0IGRjID0gY2xlYW5DaXR5KGQubXVuaWNpcGFsaXR5TmFtZSB8fCBkLmNpdHkgfHwgZC5uYW1lIHx8ICIiKTsKICAgICAgY29uc3Qgb2kgPSAoby5pYXRhIHx8IG8uaWNhbyB8fCAiIik7CiAgICAgIGNvbnN0IGRpID0gKGQuaWF0YSB8fCBkLmljYW8gfHwgIiIpOwogICAgICBjb25zdCBsZWZ0ID0gKG9jICYmIG9pKSA/IGAke29jfSAoJHtvaX0pYCA6IChvYyB8fCBvaSk7CiAgICAgIGNvbnN0IHJpZ2h0ID0gKGRjICYmIGRpKSA/IGAke2RjfSAoJHtkaX0pYCA6IChkYyB8fCBkaSk7CiAgICAgIGlmIChsZWZ0ICYmIHJpZ2h0KSB0eHQgPSBgJHtsZWZ0fSDihpIgJHtyaWdodH1gOwogICAgfQogICAgLy8gSWYgc3RpbGwgZW1wdHksIGZhbGwgYmFjayB0byB0aGUgc3RyaW5nIHJvdXRlIGZpZWxkCiAgICBpZiAoIXR4dCAmJiBqICYmIHR5cGVvZiBqLnJvdXRlID09PSAic3RyaW5nIiAmJiBqLnJvdXRlLnRyaW0oKSkgdHh0ID0gai5yb3V0ZTsKCiAgICBpZiAoIXR4dCAmJiBqICYmIGoub3JpZ2luICYmIGouZGVzdGluYXRpb24pewogICAgICBjb25zdCBvID0gai5vcmlnaW4sIGQgPSBqLmRlc3RpbmF0aW9uOwogICAgICBjb25zdCBvYyA9IGNsZWFuQ2l0eShvLm11bmljaXBhbGl0eU5hbWUgfHwgby5jaXR5IHx8IG8ubmFtZSB8fCAiIik7CiAgICAgIGNvbnN0IGRjID0gY2xlYW5DaXR5KGQubXVuaWNpcGFsaXR5TmFtZSB8fCBkLmNpdHkgfHwgZC5uYW1lIHx8ICIiKTsKICAgICAgY29uc3Qgb2kgPSAoby5pYXRhIHx8IG8uaWNhbyB8fCAiIik7CiAgICAgIGNvbnN0IGRpID0gKGQuaWF0YSB8fCBkLmljYW8gfHwgIiIpOwogICAgICBjb25zdCBsZWZ0ID0gKG9jICYmIG9pKSA/IGAke29jfSAoJHtvaX0pYCA6IChvYyB8fCBvaSk7CiAgICAgIGNvbnN0IHJpZ2h0ID0gKGRjICYmIGRpKSA/IGAke2RjfSAoJHtkaX0pYCA6IChkYyB8fCBkaSk7CiAgICAgIGlmIChsZWZ0ICYmIHJpZ2h0KSB0eHQgPSBgJHtsZWZ0fSDihpIgJHtyaWdodH1gOwogICAgfQoKICAgIHR4dCA9IGZpeEFycm93KHR4dCk7CiAgICB0eHQgPSB0eHQucmVwbGFjZSgvXC9cK1xzKlwoL2csICIgKCIpLnJlcGxhY2UoL1wvXCtccyrihpIvZywgIiDihpIiKS5yZXBsYWNlKC/ihpJccypcL1wrXHMqL2csICLihpIgIik7CiAgICBpZiAoIXR4dCkgcmV0dXJuIG51bGw7CiAgICByb3V0ZUNhY2hlU2V0KGNzLCB0eHQpOwogICAgcmV0dXJuIHR4dDsKICB9Y2F0Y2goZSl7CiAgICByZXR1cm4gbnVsbDsKICB9Cn0KbGV0IFNDUk9MTDUgPSBmYWxzZTsKLy8gdjE0OSBVSSB1cGdyYWRlIG9uIHRvcCBvZiB2NDggYmFzZWxpbmUKY29uc3QgUFJPWFkgPSAiaHR0cHM6Ly9mbGlnaHRzYWJvdmUudDJoa21oZ2J3ei53b3JrZXJzLmRldi8iOwoKCi8vIHY1NDogY2l0eSBuYW1lcyArIGFpcmxpbmUgbG9nb3MgKyBiZXN0LWVmZm9ydCBhaXJjcmFmdCBtb2RlbApjb25zdCBBSVJQT1JUX0NJVFkgPSB7CiAgLy8gTm9ydGh3ZXN0IEFya2Fuc2FzICsgbmVhcmJ5CiAgWE5BOiJGYXlldHRldmlsbGUvQmVudG9udmlsbGUsIEFSIiwgRllWOiJGYXlldHRldmlsbGUsIEFSIiwgUk9HOiJSb2dlcnMsIEFSIiwgQlZYOiJCYXRlc3ZpbGxlLCBBUiIsCiAgRlNNOiJGb3J0IFNtaXRoLCBBUiIsIExJVDoiTGl0dGxlIFJvY2ssIEFSIiwgVFVMOiJUdWxzYSwgT0siLCBNS086Ik11c2tvZ2VlLCBPSyIsIE9LQzoiT2tsYWhvbWEgQ2l0eSwgT0siLAogIElDVDoiV2ljaGl0YSwgS1MiLCBNQ0k6IkthbnNhcyBDaXR5LCBNTyIsIEpMTjoiSm9wbGluLCBNTyIsIFNHRjoiU3ByaW5nZmllbGQsIE1PIiwgU1RMOiJTdC4gTG91aXMsIE1PIiwKICBNRU06Ik1lbXBoaXMsIFROIiwgQk5BOiJOYXNodmlsbGUsIFROIiwgTVNZOiJOZXcgT3JsZWFucywgTEEiLAogIC8vIE1ham9yIFVTIGh1YnMgYW5kIHBvcHVsYXIgZGVzdGluYXRpb25zCiAgQVRMOiJBdGxhbnRhLCBHQSIsIE9SRDoiQ2hpY2FnbywgSUwiLCBNRFc6IkNoaWNhZ28gKE1pZHdheSksIElMIiwgREVOOiJEZW52ZXIsIENPIiwKICBERlc6IkRhbGxhc+KAk0ZvcnQgV29ydGgsIFRYIiwgREFMOiJEYWxsYXMgKExvdmUpLCBUWCIsIElBSDoiSG91c3RvbiwgVFgiLCBIT1U6IkhvdXN0b24gKEhvYmJ5KSwgVFgiLAogIFBIWDoiUGhvZW5peCwgQVoiLCBMQVM6IkxhcyBWZWdhcywgTlYiLCBTTEM6IlNhbHQgTGFrZSBDaXR5LCBVVCIsCiAgTEFYOiJMb3MgQW5nZWxlcywgQ0EiLCBTRk86IlNhbiBGcmFuY2lzY28sIENBIiwgT0FLOiJPYWtsYW5kLCBDQSIsIFNBTjoiU2FuIERpZWdvLCBDQSIsIFNKQzoiU2FuIEpvc2UsIENBIiwKICBTTkE6Ik9yYW5nZSBDb3VudHksIENBIiwgQlVSOiJCdXJiYW5rLCBDQSIsIFNNRjoiU2FjcmFtZW50bywgQ0EiLCBTRUE6IlNlYXR0bGUsIFdBIiwgUERYOiJQb3J0bGFuZCwgT1IiLAogIEpGSzoiTmV3IFlvcmssIE5ZIiwgTEdBOiJOZXcgWW9yayAoTGFHdWFyZGlhKSwgTlkiLCBFV1I6Ik5ld2FyaywgTkoiLCBCT1M6IkJvc3RvbiwgTUEiLAogIElBRDoiV2FzaGluZ3RvbiBEdWxsZXMsIFZBIiwgRENBOiJXYXNoaW5ndG9uIE5hdGlvbmFsLCBEQyIsIFBITDoiUGhpbGFkZWxwaGlhLCBQQSIsIEJXSToiQmFsdGltb3JlLCBNRCIsCiAgQ0xUOiJDaGFybG90dGUsIE5DIiwgUkRVOiJSYWxlaWdoLUR1cmhhbSwgTkMiLCBNQ086Ik9ybGFuZG8sIEZMIiwgVFBBOiJUYW1wYSwgRkwiLAogIE1JQToiTWlhbWksIEZMIiwgRkxMOiJGb3J0IExhdWRlcmRhbGUsIEZMIiwgUlNXOiJGb3J0IE15ZXJzLCBGTCIsIFNSUToiU2FyYXNvdGEsIEZMIiwKICBQTlM6IlBlbnNhY29sYSwgRkwiLCBWUFM6IkRlc3Rpbi9GdCBXYWx0b24gQmVhY2gsIEZMIiwKICBNU1A6Ik1pbm5lYXBvbGlz4oCTU3QuIFBhdWwsIE1OIiwgRFRXOiJEZXRyb2l0LCBNSSIsIENMRToiQ2xldmVsYW5kLCBPSCIsIENWRzoiQ2luY2lubmF0aSwgT0giLAogIC8vIE1leGljbyAvIENhcmliYmVhbgogIENVTjoiQ2FuY8O6biwgTVgiLCBDWk06IkNvenVtZWwsIE1YIiwgU0pEOiJTYW4gSm9zw6kgZGVsIENhYm8sIE1YIiwgUFZSOiJQdWVydG8gVmFsbGFydGEsIE1YIiwKICBNRVg6Ik1leGljbyBDaXR5LCBNWCIsIEdETDoiR3VhZGFsYWphcmEsIE1YIiwgUFVKOiJQdW50YSBDYW5hLCBETyIsIE1CSjoiTW9udGVnbyBCYXksIEpNIiwKICBOQVM6Ik5hc3NhdSwgQlMiLCBBVUE6IkFydWJhLCBBVyIsIFNKVToiU2FuIEp1YW4sIFBSIiwgU1RUOiJTdC4gVGhvbWFzLCBWSSIsIFNUWDoiU3QuIENyb2l4LCBWSSIKfTsKCmNvbnN0IEFJUkxJTkVfTkFNRSA9IHsKICBBQUw6IkFtZXJpY2FuIiwgRU5ZOiJFbnZveSIsIEpJQToiUFNBIiwgUlBBOiJSZXB1YmxpYyIsCiAgREFMOiJEZWx0YSIsIEVEVjoiRW5kZWF2b3IiLCBTS1c6IlNreVdlc3QiLAogIFVBTDoiVW5pdGVkIiwgVUNBOiJDb21tdXRlQWlyIiwKICBTV0E6IlNvdXRod2VzdCIsIE5LUzoiU3Bpcml0IiwgSkJVOiJKZXRCbHVlIiwgRkZUOiJGcm9udGllciIsIEFTQToiQWxhc2thIiwgQUFZOiJBbGxlZ2lhbnQiLAogIFdKQToiV2VzdEpldCIsCiAgRUpBOiJOZXRKZXRzIiwKICBGRFg6IkZlZEV4IiwKICBVUFM6IlVQUyIsCiAgUVhFOiJIb3Jpem9uIiwKICBBV0k6IkFpciBXaXNjb25zaW4iLAp9OwoKLy8gU2ltcGxlLCBvcmlnaW5hbCBTVkcgbWFya3MgKG5vdCBvZmZpY2lhbCBsb2dvcykgZm9yIHJlYWRhYmlsaXR5Lgpjb25zdCBVU0VfTUVESUFfS0lUX0xPR09TID0gZmFsc2U7IC8vIGxhdGVyOiBzZXQgdHJ1ZSBhbmQgYWRkIGFzc2V0cy9sb2dvcy8gZm9yIG9mZmljaWFsIG1hcmtzCgpjb25zdCBBSVJMSU5FX1NWRyA9IHsKICBBQUw6IGA8c3ZnIHZpZXdCb3g9IjAgMCAxMDAgMTAwIiBhcmlhLWxhYmVsPSJBbWVyaWNhbiI+PHJlY3QgeD0iNiIgeT0iNiIgd2lkdGg9Ijg4IiBoZWlnaHQ9Ijg4IiByeD0iMTgiIGZpbGw9Im5vbmUiIHN0cm9rZT0iY3VycmVudENvbG9yIiBzdHJva2Utd2lkdGg9IjYiLz48dGV4dCB4PSI1MCIgeT0iNjAiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZvbnQtc2l6ZT0iMzQiIGZvbnQtd2VpZ2h0PSI5NTAiIGZpbGw9ImN1cnJlbnRDb2xvciI+QUE8L3RleHQ+PC9zdmc+YCwKICBEQUw6IGA8c3ZnIHZpZXdCb3g9IjAgMCAxMDAgMTAwIiBhcmlhLWxhYmVsPSJEZWx0YSI+PHJlY3QgeD0iNiIgeT0iNiIgd2lkdGg9Ijg4IiBoZWlnaHQ9Ijg4IiByeD0iMTgiIGZpbGw9Im5vbmUiIHN0cm9rZT0iY3VycmVudENvbG9yIiBzdHJva2Utd2lkdGg9IjYiLz48dGV4dCB4PSI1MCIgeT0iNjAiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZvbnQtc2l6ZT0iMzQiIGZvbnQtd2VpZ2h0PSI5NTAiIGZpbGw9ImN1cnJlbnRDb2xvciI+REw8L3RleHQ+PC9zdmc+YCwKICBVQUw6IGA8c3ZnIHZpZXdCb3g9IjAgMCAxMDAgMTAwIiBhcmlhLWxhYmVsPSJVbml0ZWQiPjxyZWN0IHg9IjYiIHk9IjYiIHdpZHRoPSI4OCIgaGVpZ2h0PSI4OCIgcng9IjE4IiBmaWxsPSJub25lIiBzdHJva2U9ImN1cnJlbnRDb2xvciIgc3Ryb2tlLXdpZHRoPSI2Ii8+PHRleHQgeD0iNTAiIHk9IjYwIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmb250LXNpemU9IjM0IiBmb250LXdlaWdodD0iOTUwIiBmaWxsPSJjdXJyZW50Q29sb3IiPlVBPC90ZXh0Pjwvc3ZnPmAsCiAgU1dBOiBgPHN2ZyB2aWV3Qm94PSIwIDAgMTAwIDEwMCIgYXJpYS1sYWJlbD0iU291dGh3ZXN0Ij48cmVjdCB4PSI2IiB5PSI2IiB3aWR0aD0iODgiIGhlaWdodD0iODgiIHJ4PSIxOCIgZmlsbD0ibm9uZSIgc3Ryb2tlPSJjdXJyZW50Q29sb3IiIHN0cm9rZS13aWR0aD0iNiIvPjx0ZXh0IHg9IjUwIiB5PSI2MCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZm9udC1zaXplPSIzNCIgZm9udC13ZWlnaHQ9Ijk1MCIgZmlsbD0iY3VycmVudENvbG9yIj5XTjwvdGV4dD48L3N2Zz5gLAogIEpCVTogYDxzdmcgdmlld0JveD0iMCAwIDEwMCAxMDAiIGFyaWEtbGFiZWw9IkpldEJsdWUiPjxyZWN0IHg9IjYiIHk9IjYiIHdpZHRoPSI4OCIgaGVpZ2h0PSI4OCIgcng9IjE4IiBmaWxsPSJub25lIiBzdHJva2U9ImN1cnJlbnRDb2xvciIgc3Ryb2tlLXdpZHRoPSI2Ii8+PHRleHQgeD0iNTAiIHk9IjYwIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmb250LXNpemU9IjM0IiBmb250LXdlaWdodD0iOTUwIiBmaWxsPSJjdXJyZW50Q29sb3IiPkI2PC90ZXh0Pjwvc3ZnPmAsCiAgRkZUOiBgPHN2ZyB2aWV3Qm94PSIwIDAgMTAwIDEwMCIgYXJpYS1sYWJlbD0iRnJvbnRpZXIiPjxyZWN0IHg9IjYiIHk9IjYiIHdpZHRoPSI4OCIgaGVpZ2h0PSI4OCIgcng9IjE4IiBmaWxsPSJub25lIiBzdHJva2U9ImN1cnJlbnRDb2xvciIgc3Ryb2tlLXdpZHRoPSI2Ii8+PHRleHQgeD0iNTAiIHk9IjYwIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmb250LXNpemU9IjM0IiBmb250LXdlaWdodD0iOTUwIiBmaWxsPSJjdXJyZW50Q29sb3IiPkY5PC90ZXh0Pjwvc3ZnPmAsCiAgTktTOiBgPHN2ZyB2aWV3Qm94PSIwIDAgMTAwIDEwMCIgYXJpYS1sYWJlbD0iU3Bpcml0Ij48cmVjdCB4PSI2IiB5PSI2IiB3aWR0aD0iODgiIGhlaWdodD0iODgiIHJ4PSIxOCIgZmlsbD0ibm9uZSIgc3Ryb2tlPSJjdXJyZW50Q29sb3IiIHN0cm9rZS13aWR0aD0iNiIvPjx0ZXh0IHg9IjUwIiB5PSI2MCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZm9udC1zaXplPSIzNCIgZm9udC13ZWlnaHQ9Ijk1MCIgZmlsbD0iY3VycmVudENvbG9yIj5OSzwvdGV4dD48L3N2Zz5gLAogIEFTQTogYDxzdmcgdmlld0JveD0iMCAwIDEwMCAxMDAiIGFyaWEtbGFiZWw9IkFsYXNrYSI+PHJlY3QgeD0iNiIgeT0iNiIgd2lkdGg9Ijg4IiBoZWlnaHQ9Ijg4IiByeD0iMTgiIGZpbGw9Im5vbmUiIHN0cm9rZT0iY3VycmVudENvbG9yIiBzdHJva2Utd2lkdGg9IjYiLz48dGV4dCB4PSI1MCIgeT0iNjAiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZvbnQtc2l6ZT0iMzQiIGZvbnQtd2VpZ2h0PSI5NTAiIGZpbGw9ImN1cnJlbnRDb2xvciI+QVM8L3RleHQ+PC9zdmc+YCwKICBBQVk6IGA8c3ZnIHZpZXdCb3g9IjAgMCAxMDAgMTAwIiBhcmlhLWxhYmVsPSJBbGxlZ2lhbnQiPjxyZWN0IHg9IjYiIHk9IjYiIHdpZHRoPSI4OCIgaGVpZ2h0PSI4OCIgcng9IjE4IiBmaWxsPSJub25lIiBzdHJva2U9ImN1cnJlbnRDb2xvciIgc3Ryb2tlLXdpZHRoPSI2Ii8+PHRleHQgeD0iNTAiIHk9IjYwIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmb250LXNpemU9IjM0IiBmb250LXdlaWdodD0iOTUwIiBmaWxsPSJjdXJyZW50Q29sb3IiPkc0PC90ZXh0Pjwvc3ZnPmAsCiAgRU5ZOiBgPHN2ZyB2aWV3Qm94PSIwIDAgMTAwIDEwMCIgYXJpYS1sYWJlbD0iRW52b3kiPjxyZWN0IHg9IjYiIHk9IjYiIHdpZHRoPSI4OCIgaGVpZ2h0PSI4OCIgcng9IjE4IiBmaWxsPSJub25lIiBzdHJva2U9ImN1cnJlbnRDb2xvciIgc3Ryb2tlLXdpZHRoPSI2Ii8+PHRleHQgeD0iNTAiIHk9IjYwIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmb250LXNpemU9IjM0IiBmb250LXdlaWdodD0iOTUwIiBmaWxsPSJjdXJyZW50Q29sb3IiPkVOPC90ZXh0Pjwvc3ZnPmAsCiAgU0tXOiBgPHN2ZyB2aWV3Qm94PSIwIDAgMTAwIDEwMCIgYXJpYS1sYWJlbD0iU2t5V2VzdCI+PHJlY3QgeD0iNiIgeT0iNiIgd2lkdGg9Ijg4IiBoZWlnaHQ9Ijg4IiByeD0iMTgiIGZpbGw9Im5vbmUiIHN0cm9rZT0iY3VycmVudENvbG9yIiBzdHJva2Utd2lkdGg9IjYiLz48dGV4dCB4PSI1MCIgeT0iNjAiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZvbnQtc2l6ZT0iMzQiIGZvbnQtd2VpZ2h0PSI5NTAiIGZpbGw9ImN1cnJlbnRDb2xvciI+T088L3RleHQ+PC9zdmc+YAp9OwoKLy8gdjYwOiBncm91cCByZWdpb25hbCBjYXJyaWVycyB1bmRlciBwYXJlbnQgYnJhbmRzIChiZXN0LWVmZm9ydCkKLy8ga2V5cyBhcmUgb3BlcmF0b3IvY2FsbHNpZ24gcHJlZml4ZXMgd2Ugc2VlIGluIHRoZSBmZWVkCmNvbnN0IFJFR0lPTkFMX1BBUkVOVCA9IHsKICAvLyBBbWVyaWNhbiArIEFtZXJpY2FuIEVhZ2xlIG5ldHdvcmssCiAgRU5ZOiJBQUwiLCBKSUE6IkFBTCIsIFJQQToiQUFMIiwgUERUOiJBQUwiLCBBU0g6IkFBTCIsCiAgLy8gRGVsdGEgQ29ubmVjdGlvbiwKICBFRFY6IkRBTCIsIENQWjoiREFMIiwKICAvLyBVbml0ZWQgRXhwcmVzcywKICBVQ0E6IlVBTCIsIEdKUzoiVUFMIiwgQVNROiJVQUwiLAogIFFYRToiQVNBIiwKICBBV0k6IlVBTCIsCiAgRkRYOiJGRFgiLAogIFVQUzoiVVBTIiwKICBFSkE6IkVKQSIsCiAgV0pBOiJXSkEiLAp9OwoKLy8gT3B0aW9uYWwgbGFiZWwgZm9yIHRoZSByZWdpb25hbCBvcGVyYXRvciBpdHNlbGYKY29uc3QgUkVHSU9OQUxfTkFNRSA9IHsKICBFTlk6IkVudm95IiwgSklBOiJQU0EiLCBSUEE6IlJlcHVibGljIiwgUERUOiJQaWVkbW9udCIsIEFTSDoiTWVzYSIsCiAgRURWOiJFbmRlYXZvciIsIENQWjoiQ29tcGFzcyIsIFVDQToiQ29tbXV0ZUFpciIsIEdKUzoiR29KZXQiLCBBU1E6IkV4cHJlc3NKZXQiLCBTS1c6IlNreVdlc3QiLAogIFFYRToiSG9yaXpvbiIsCiAgQVdJOiJBaXIgV2lzY29uc2luIiwKICBXSkE6Ildlc3RKZXQiLAogIEVKQToiTmV0SmV0cyIsCiAgRkRYOiJGZWRFeCIsCiAgVVBTOiJVUFMiLAp9OwoKZnVuY3Rpb24gcGFyZW50QnJhbmRDb2RlRnJvbVByZWZpeChwcmVmaXgpewogIGlmICghcHJlZml4KSByZXR1cm4gIiI7CiAgcmV0dXJuIFJFR0lPTkFMX1BBUkVOVFtwcmVmaXhdIHx8IHByZWZpeDsKfQoKZnVuY3Rpb24gcGFyZW50QnJhbmROYW1lRnJvbUNvZGUoY29kZSl7CiAgaWYgKCFjb2RlKSByZXR1cm4gIuKAlCI7CiAgY29uc3QgbmFtZXMgPSB7IEFBTDoiQW1lcmljYW4iLCBEQUw6IkRlbHRhIiwgVUFMOiJVbml0ZWQiLCBTV0E6IlNvdXRod2VzdCIgfTsKICByZXR1cm4gbmFtZXNbY29kZV0gfHwgQUlSTElORV9OQU1FW2NvZGVdIHx8IGNvZGU7Cn0KCmZ1bmN0aW9uIHJlZ2lvbmFsU3ViTGFiZWwocHJlZml4LCBwYXJlbnRDb2RlKXsKICBpZiAoIXByZWZpeCB8fCAhcGFyZW50Q29kZSkgcmV0dXJuICIiOwogIGlmIChwcmVmaXggPT09IHBhcmVudENvZGUpIHJldHVybiAiIjsKICBjb25zdCByID0gUkVHSU9OQUxfTkFNRVtwcmVmaXhdIHx8IHByZWZpeDsKICBpZiAocGFyZW50Q29kZSA9PT0gIkFBTCIpIHJldHVybiBgRUFHTEUg4oCiICR7cn1gOwogIGlmIChwYXJlbnRDb2RlID09PSAiREFMIikgcmV0dXJuIGBDT05ORUNUSU9OIOKAoiAke3J9YDsKICBpZiAocGFyZW50Q29kZSA9PT0gIlVBTCIpIHJldHVybiBgRVhQUkVTUyDigKIgJHtyfWA7CiAgaWYgKHBhcmVudENvZGUgPT09ICJBU0EiKSByZXR1cm4gYEhPUklaT04g4oCiICR7cn1gOwogIHJldHVybiByOwp9CgovLyBSb3VnaCBhaXJjcmFmdCBmYW1pbHkgaGludHMgYnkgY29tbW9uIG9wZXJhdG9yIChiZXN0LWVmZm9ydCBvbmx5KQpjb25zdCBBSVJMSU5FX0ZMRUVUX0hJTlQgPSB7CiAgU1dBOiJCNzM3LWZhbWlseSIsIEFBTDoiQTMyMC9CNzM3IG1peCIsIERBTDoiQTMyMC9CNzM3IG1peCIsIFVBTDoiQTMyMC9CNzM3IG1peCIsCiAgRU5ZOiJFMTc1L0NSSiIsIEpJQToiQ1JKIiwgUlBBOiJFMTc1IiwgU0tXOiJFMTc1L0NSSiIsIEVEVjoiQ1JKIgp9OwoKLy8gQURTQkRCIGxvb2t1cHMgY2FuIGJlIHJhdGUgbGltaXRlZDsgd2UgZG8gT05FIGxvb2t1cCBwZXIgMzBzIG1heCBhbmQgYmFjayBvZmYgb24gNDI5LgpsZXQgYWRzYkNhY2hlID0gbmV3IE1hcCgpOyAvLyBjYWxsc2lnbiAtPiB7dHMsZGF0YX0KbGV0IGFkc2JOZXh0QWxsb3dlZFRzID0gMDsKbGV0IGFkc2JCYWNrb2ZmVW50aWwgPSAwOwoKZnVuY3Rpb24gYWlycG9ydExhYmVsKGNvZGUpewogIGlmICghY29kZSkgcmV0dXJuICLigJQiOwogIGNvbnN0IGMgPSBTdHJpbmcoY29kZSkudG9VcHBlckNhc2UoKTsKICBjb25zdCBjaXR5ID0gQUlSUE9SVF9DSVRZW2NdOwogIHJldHVybiBjaXR5ID8gYCR7Y30gKCR7Y2l0eX0pYCA6IGM7Cn0KCmZ1bmN0aW9uIGFpcmxpbmVDb2RlRnJvbUNhbGxzaWduKGNhbGxzaWduKXsKICBpZiAoIWNhbGxzaWduKSByZXR1cm4gIiI7CiAgY29uc3QgY3MgPSBTdHJpbmcoY2FsbHNpZ24pLnRyaW0oKS50b1VwcGVyQ2FzZSgpOwogIGNvbnN0IG0gPSBjcy5tYXRjaCgvXihbQS1aXXszfSkvKTsKICByZXR1cm4gbSA/IG1bMV0gOiAiIjsKfQogICAgICAgICAgICAKLy8gdjgwOiBwYXNzZW5nZXIgYWlybGluZSBJQ0FPIGNvZGUgYWxsb3dsaXN0ICgzLWxldHRlciBwcmVmaXhlcykKY29uc3QgUEFTU0VOR0VSX0lDQU9fQ09ERVMgPSBuZXcgU2V0KFsKICAiQUFMIiwiREFMIiwiVUFMIiwiU1dBIiwiQVNBIiwiSkJVIiwiRkZUIiwiTktTIiwiQUFZIiwiU0tXIiwiTVhZIiwKICAiRU5ZIiwiSklBIiwiUlBBIiwiUERUIiwiRURWIiwiQVdJIiwiQVNIIiwiQ1BaIiwiR0pTIiwiUVhFIiwKICAiV0pBIiwiQUNBIiwiV0VOIiwiUk9VIiwiQU1YIiwiVk9JIiwiVklWIiwiQ01QIiwKICAiQkFXIiwiVklSIiwiQUZSIiwiRExIIiwiS0xNIiwiSUJFIiwiVEFQIiwiU0FTIiwiU0lBIiwiRVZBIiwiQU5BIiwiSkFMIiwiS0FMIiwiQUFSIiwiUVRSIiwiVUFFIiwiRVREIiwiVEhZIgpdKTsKCgoKICAgIAovLyB2ODk6IG5vbi1wYXNzZW5nZXIgb3BlcmF0b3JzIHRvIGV4Y2x1ZGUgd2hlbiAiUGFzc2VuZ2VyIEFpcmxpbmVzIE9ubHkiIGlzIGVuYWJsZWQKY29uc3QgTk9OX1BBU1NFTkdFUl9JQ0FPID0gbmV3IFNldChbCiAgIkNBUCIsIC8vIENpdmlsIEFpciBQYXRyb2wKICAiVFJGIiwgLy8gVHJhZGVmbGlnaHQgKGNhcmdvL2NoYXJ0ZXIpCiAgIkZEWCIsIC8vIEZlZEV4CiAgIlVQUyIsIC8vIFVQUwogICJBQlgiLCAvLyBBaXJib3JuZSBFeHByZXNzCiAgIkdUSSIsIC8vIEF0bGFzIEFpcgogICJDS1MiLCAvLyBLYWxpdHRhIEFpcgogICJBSlQiLCAvLyBBbWVyaWpldAogICJLT1ciLCAvLyBjb21tb24gY2FyZ28vY2hhcnRlciBpbiBhcmVhCgogICJKVFoiLCAvLyBub24tc2NoZWR1bGVkL2NoYXJ0ZXIKICAiSlRMIiwgLy8gbm9uLXNjaGVkdWxlZC9jaGFydGVyCiAgIkVKQSIsIC8vIG5vbi1zY2hlZHVsZWQvY2hhcnRlcgogICJYT0oiLCAvLyBub24tc2NoZWR1bGVkL2NoYXJ0ZXIKICAiTFhKIiwgLy8gbm9uLXNjaGVkdWxlZC9jaGFydGVyCiAgIk5KRSIsIC8vIG5vbi1zY2hlZHVsZWQvY2hhcnRlcgpdKTsKLy8gdjY2OiBjb21tZXJjaWFsIGZpbHRlcmluZyAoa2VlcCBwYXNzZW5nZXIvcmVnaW9uYWwvY2FyZ287IGRyb3AgcHJpdmF0ZS9HQS9taWwpCi8vIE5PVEU6IFRoaXMgaXMgaGV1cmlzdGljOiBpdCB1c2VzIGNhbGxzaWduIHByZWZpeGVzLCB3aGljaCBpcyB3aGF0IHdlIHJlbGlhYmx5IGhhdmUuCmNvbnN0IENPTU1FUkNJQUxfQ0FSUklFUl9DT0RFUyA9IG5ldyBTZXQoWwogICJTV0EiLCJBQUwiLCJEQUwiLCJVQUwiLCJBU0EiLCJKQlUiLCJGRlQiLCJOS1MiLCJBQVkiLAogIC8vIFJlZ2lvbmFsCiAgIkVOWSIsIlNLVyIsIkpJQSIsIlJQQSIsIkVEViIsIlVDQSIsIkdKUyIsIkFTUSIsIlBEVCIsIkFTSCIsCiAgLy8gQ2FyZ28KICAiRkRYIiwiVVBTIiwiQUJYIgpdKTsKCmNvbnN0IFBSSVZBVEVfUFJFRklYRVMgPSBuZXcgU2V0KFsiQ0FQIiwiS09XIiwiRUpBIl0pOyAvLyBDQVA9Q2l2aWwgQWlyIFBhdHJvbCwgRUpBPU5ldEpldHMgKHByaXZhdGUpCmZ1bmN0aW9uIGlzQ29tbWVyY2lhbENhbGxzaWduKGNhbGxzaWduKXsKICBpZiAoIWNhbGxzaWduKSByZXR1cm4gZmFsc2U7CiAgY29uc3QgY3MgPSBTdHJpbmcoY2FsbHNpZ24pLnRyaW0oKS50b1VwcGVyQ2FzZSgpOwogIGlmICgvXk5cZC8udGVzdChjcykpIHJldHVybiBmYWxzZTsgLy8gR0EvcHJpdmF0ZSB0YWlsIG51bWJlcnMKICBjb25zdCBucyA9IGNzLnJlcGxhY2UoL1xzKy9nLCAiIik7CiAgY29uc3QgbSA9IG5zLm1hdGNoKC9eKFtBLVpdezN9KVxkLyk7CiAgaWYgKCFtKSByZXR1cm4gZmFsc2U7CiAgY29uc3QgcHJlZiA9IG1bMV07CiAgaWYgKE5PTl9QQVNTRU5HRVJfSUNBTy5oYXMocHJlZikpIHJldHVybiBmYWxzZTsKICAvLyBQYXNzZW5nZXIgYWlybGluZXMgYWxsb3dsaXN0IChtYXkgYmUgQ09NTUVSQ0lBTF9DQVJSSUVSX0NPREVTIGluIG9sZGVyIGJ1aWxkcykKICBpZiAodHlwZW9mIFBBU1NFTkdFUl9JQ0FPX0NPREVTICE9PSAidW5kZWZpbmVkIikgcmV0dXJuIFBBU1NFTkdFUl9JQ0FPX0NPREVTLmhhcyhwcmVmKTsKICBpZiAodHlwZW9mIENPTU1FUkNJQUxfQ0FSUklFUl9DT0RFUyAhPT0gInVuZGVmaW5lZCIpIHJldHVybiBDT01NRVJDSUFMX0NBUlJJRVJfQ09ERVMuaGFzKHByZWYpOwogIHJldHVybiBmYWxzZTsKfQoKZnVuY3Rpb24gb3BlcmF0b3JCcmFuZFNWRyhjcyl7CiAgY29uc3QgY29kZSA9IGFpcmxpbmVDb2RlRnJvbUNhbGxzaWduKGNzKSB8fCAi4pyIIjsKICBjb25zdCBuYW1lID0gQUlSTElORV9OQU1FW2NvZGVdIHx8IGNvZGU7CiAgcmV0dXJuIGA8c3ZnIHZpZXdCb3g9IjAgMCAxMDAgMTAwIiBhcmlhLWxhYmVsPSIke25hbWV9Ij4KICAgIDxyZWN0IHg9IjYiIHk9IjYiIHdpZHRoPSI4OCIgaGVpZ2h0PSI4OCIgcng9IjE4IiBmaWxsPSJub25lIiBzdHJva2U9ImN1cnJlbnRDb2xvciIgc3Ryb2tlLXdpZHRoPSI2Ii8+CiAgICA8dGV4dCB4PSI1MCIgeT0iNTYiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZvbnQtc2l6ZT0iMzQiIGZvbnQtd2VpZ2h0PSI5NTAiIGZpbGw9ImN1cnJlbnRDb2xvciI+JHtjb2RlLnNsaWNlKDAsMyl9PC90ZXh0PgogICAgPHRleHQgeD0iNTAiIHk9Ijc4IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmb250LXNpemU9IjEyIiBmb250LXdlaWdodD0iODAwIiBmaWxsPSJjdXJyZW50Q29sb3IiPiR7bmFtZS5yZXBsYWNlKC8mL2csImFuZCIpLnNsaWNlKDAsMTQpfTwvdGV4dD4KICA8L3N2Zz5gOwp9CgpmdW5jdGlvbiBsb2dvU1ZHRnJvbUNhbGxzaWduKGNzKXsKICBjb25zdCBjb2RlID0gYWlybGluZUNvZGVGcm9tQ2FsbHNpZ24oY3MpOwogIGlmIChjb2RlICYmIEFJUkxJTkVfU1ZHW2NvZGVdKSByZXR1cm4gQUlSTElORV9TVkdbY29kZV07CiAgY29uc3QgbGFiZWwgPSBjb2RlIHx8ICLinIgiOwogIHJldHVybiBgPHN2ZyB2aWV3Qm94PSIwIDAgMTAwIDEwMCIgYXJpYS1sYWJlbD0iJHtsYWJlbH0iPjxyZWN0IHg9IjYiIHk9IjYiIHdpZHRoPSI4OCIgaGVpZ2h0PSI4OCIgcng9IjE4IiBmaWxsPSJub25lIiBzdHJva2U9ImN1cnJlbnRDb2xvciIgc3Ryb2tlLXdpZHRoPSI2Ii8+PHRleHQgeD0iNTAiIHk9IjYwIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmb250LXNpemU9IjM0IiBmb250LXdlaWdodD0iOTUwIiBmaWxsPSJjdXJyZW50Q29sb3IiPiR7bGFiZWx9PC90ZXh0Pjwvc3ZnPmA7Cn0KCmZ1bmN0aW9uIGxvZ29UZXh0RnJvbUNhbGxzaWduKGNzKXsKICBjb25zdCBjb2RlID0gYWlybGluZUNvZGVGcm9tQ2FsbHNpZ24oY3MpOwogIHJldHVybiBjb2RlIHx8ICLinIgiOwp9CgpmdW5jdGlvbiBtb2RlbEhpbnRGcm9tQ2FsbHNpZ24oY3MpewogIGNvbnN0IGNvZGUgPSBhaXJsaW5lQ29kZUZyb21DYWxsc2lnbihjcyk7CiAgaWYgKCFjb2RlKSByZXR1cm4gIuKAlCI7CiAgY29uc3QgaGludFJhdyA9IEFJUkxJTkVfRkxFRVRfSElOVFtjb2RlXSB8fCAiIjsKICBjb25zdCBoaW50ID0gU3RyaW5nKGhpbnRSYXcpLnJlcGxhY2UoIi9FUkoiLCIiKS50cmltKCk7IC8vIHYxNDk6IGF2b2lkIEVSSiBub2lzZQogIC8vIFByZWZlciBhaXJjcmFmdCBoaW50OyBmYWxsIGJhY2sgdG8gYWlybGluZSBjb2RlIGlmIHdlIGhhdmUgbm90aGluZwogIHJldHVybiBoaW50IHx8IChBSVJMSU5FX05BTUVbY29kZV0gfHwgY29kZSk7Cn0KCmFzeW5jIGZ1bmN0aW9uIGZldGNoQWRzYmRiRm9yQ2FsbHNpZ24oY2FsbHNpZ24pewogIGNvbnN0IG5vdyA9IERhdGUubm93KCk7CiAgY29uc3Qga2V5ID0gKGNhbGxzaWdufHwiIikudHJpbSgpLnRvVXBwZXJDYXNlKCk7CiAgaWYgKCFrZXkpIHJldHVybiBudWxsOwoKICAvLyBjYWNoZSAxMCBtaW51dGVzCiAgY29uc3QgY2FjaGVkID0gYWRzYkNhY2hlLmdldChrZXkpOwogIGlmIChjYWNoZWQgJiYgKG5vdyAtIGNhY2hlZC50cykgPCAxMCo2MCoxMDAwKSByZXR1cm4gY2FjaGVkLmRhdGE7CgogIGlmIChub3cgPCBhZHNiQmFja29mZlVudGlsKSByZXR1cm4gbnVsbDsKICBpZiAobm93IDwgYWRzYk5leHRBbGxvd2VkVHMpIHJldHVybiBudWxsOwoKICBhZHNiTmV4dEFsbG93ZWRUcyA9IG5vdyArIDMwKjEwMDA7IC8vIG9uZSBjYWxsIHBlciAzMHMKCiAgY29uc3QgdXJsID0gYCR7UFJPWFl9YWRzYi8ke2VuY29kZVVSSUNvbXBvbmVudChrZXkpfWA7CgogIHRyeXsKICAgIGNvbnN0IHJlcyA9IGF3YWl0IGZldGNoV2l0aFRpbWVvdXQodXJsLCA2NTAwKTsKICAgIGlmIChyZXMuc3RhdHVzID09PSA0MjkpewogICAgICBhZHNiQmFja29mZlVudGlsID0gbm93ICsgNSo2MCoxMDAwOwogICAgICByZXR1cm4gbnVsbDsKICAgIH0KICAgIGlmICghcmVzLm9rKSByZXR1cm4gbnVsbDsKICAgIGNvbnN0IGpzID0gYXdhaXQgcmVzLmpzb24oKTsKCiAgICAvLyB2MTQ5OiBub3JtYWxpemUgcm91dGUvYWlycG9ydCBmaWVsZHMgZnJvbSBXb3JrZXIgKC9hZHNiLyogYWthIC9hZXJvLyopCiAgICB0cnl7CiAgICAgIGlmIChqcyAmJiB0eXBlb2YganMgPT09ICJvYmplY3QiKXsKICAgICAgICBpZiAoIWpzLnJvdXRlICYmIGpzLnJvdXRlUHJldHR5KSBqcy5yb3V0ZSA9IGpzLnJvdXRlUHJldHR5OwogICAgICAgIGlmICghanMub3JpZ2luICYmIGpzLmRlcGFydHVyZSkganMub3JpZ2luID0ganMuZGVwYXJ0dXJlOwogICAgICAgIGlmICghanMuZGVzdGluYXRpb24gJiYganMuYXJyaXZhbCkganMuZGVzdGluYXRpb24gPSBqcy5hcnJpdmFsOwogICAgICAgIGlmICghanMucm91dGUgJiYganMub3JpZ2luICYmIGpzLmRlc3RpbmF0aW9uKXsKICAgICAgICAgIGNvbnN0IG9pID0ganMub3JpZ2luLmlhdGEgfHwganMub3JpZ2luLmljYW8gfHwgIiI7CiAgICAgICAgICBjb25zdCBkaSA9IGpzLmRlc3RpbmF0aW9uLmlhdGEgfHwganMuZGVzdGluYXRpb24uaWNhbyB8fCAiIjsKICAgICAgICAgIGlmIChvaSAmJiBkaSl7CiAgICAgICAgICAgIGpzLnJvdXRlID0gYCR7YWlycG9ydExhYmVsKG9pKX0g4oaSICR7YWlycG9ydExhYmVsKGRpKX1gOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICAvLyBBbHdheXMgcHJvdmlkZSB0aGUgZmllbGQgdGhlIFVJIHVzZXMKICAgICAgICBpZiAoanMucm91dGUpIGpzLnJvdXRlUHJldHR5ID0ganMucm91dGU7CiAgICAgIH0KICAgIH1jYXRjaChfZSl7fQoKICAgIGFkc2JDYWNoZS5zZXQoa2V5LCB7dHM6IG5vdywgZGF0YToganN9KTsKICAgIHJldHVybiBqczsKICB9Y2F0Y2goZSl7CiAgICByZXR1cm4gbnVsbDsKICB9Cn0KCmNvbnN0IFhOQV9GQUxMQkFDSyA9IHsgbGF0OiAzNi4yODE5LCBsb246IC05NC4zMDY4IH07CgpsZXQgSE9NRV9MQVQgPSBYTkFfRkFMTEJBQ0subGF0OwpsZXQgSE9NRV9MT04gPSBYTkFfRkFMTEJBQ0subG9uOwoKLy8gdjk4OiBJZiBsb2NhdGlvbiBwZXJtaXNzaW9uIGlzIGJsb2NrZWQvZmFpbGVkLCBmYWxsIGJhY2sgdG8gWE5BIGFyZWEgc28gcmFkYXIgaXMgbmV2ZXIgIjAiIGp1c3QgZHVlIHRvIGNvb3Jkcy4KY29uc3QgREVGQVVMVF9MQVQgPSAzNi4yODE5OyAgIC8vIFhOQSAoTm9ydGh3ZXN0IEFya2Fuc2FzIE5hdGlvbmFsIEFpcnBvcnQpCmNvbnN0IERFRkFVTFRfTE9OID0gLTk0LjMwNjg7CmZ1bmN0aW9uIGVuc3VyZUhvbWVDb29yZHMoKXsKICBjb25zdCBsYXRPayA9IE51bWJlci5pc0Zpbml0ZShIT01FX0xBVCkgJiYgTWF0aC5hYnMoSE9NRV9MQVQpID4gMTsKICBjb25zdCBsb25PayA9IE51bWJlci5pc0Zpbml0ZShIT01FX0xPTikgJiYgTWF0aC5hYnMoSE9NRV9MT04pID4gMTsKICBpZiAoIWxhdE9rIHx8ICFsb25Payl7CiAgICBIT01FX0xBVCA9IERFRkFVTFRfTEFUOwogICAgSE9NRV9MT04gPSBERUZBVUxUX0xPTjsKICAgIHJldHVybiAiZGVmYXVsdCAoWE5BKSI7CiAgfQogIHJldHVybiAiZ3BzIjsKfQoKCmxldCBSQU5HRV9NSSA9IEluZmluaXR5OwpsZXQgQ09NTUVSQ0lBTF9PTkxZID0gdHJ1ZTsKCmxldCBmbGlnaHRzID0gW107CmxldCBjdXJyZW50SW5kZXggPSAwOwpsZXQgY3VycmVudCA9IG51bGw7CgpsZXQgc2Nyb2xsTW9kZSA9ICJyb3RhdGUiOyAvLyByb3RhdGUgfCBjbG9zZXN0CmxldCByb3RhdGVFdmVyeU1zID0gNzAwMDsKbGV0IHJvdGF0ZVRpbWVyID0gbnVsbDsKbGV0IGxhc3REaXNwbGF5ZWRLZXkgPSBudWxsOwpsZXQgaGFzUmVuZGVyZWRPbmNlID0gZmFsc2U7CgoKZnVuY3Rpb24gc2V0VGV4dChpZCwgdmFsdWUpewogIGNvbnN0IGVsID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoaWQpOwogIGNvbnN0IHYgPSAodmFsdWUgPT09IHVuZGVmaW5lZCB8fCB2YWx1ZSA9PT0gbnVsbCkgPyAiIiA6IFN0cmluZyh2YWx1ZSk7CiAgaWYgKGVsICYmIGVsLnRleHRDb250ZW50ICE9PSB2KSBlbC50ZXh0Q29udGVudCA9IHY7Cn0KCmZ1bmN0aW9uIHNldEhUTUwoaWQsIGh0bWwpewogIGNvbnN0IGVsID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoaWQpOwogIGNvbnN0IGggPSAoaHRtbCA9PT0gdW5kZWZpbmVkIHx8IGh0bWwgPT09IG51bGwpID8gIiIgOiBTdHJpbmcoaHRtbCk7CiAgaWYgKGVsICYmIGVsLmlubmVySFRNTCAhPT0gaCkgZWwuaW5uZXJIVE1MID0gaDsKfQoKZnVuY3Rpb24gc2V0Q2xhc3MoaWQsIGNscyl7CiAgY29uc3QgZWwgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChpZCk7CiAgaWYgKCFlbCkgcmV0dXJuOwogIGlmIChlbC5jbGFzc05hbWUgIT09IGNscykgZWwuY2xhc3NOYW1lID0gY2xzOwp9CgpmdW5jdGlvbiBzZXRTdGF0dXMobXNnKXsKICBjb25zdCBlbCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJmdy1zdGF0dXMiKTsKICBpZiAoZWwgJiYgZWwudGV4dENvbnRlbnQgIT09IG1zZykgZWwudGV4dENvbnRlbnQgPSBtc2c7Cn0KCmZ1bmN0aW9uIGhvbWVQbGFjZUxhYmVsKCl7CiAgY29uc3QgZFRvWE5BID0gaGF2ZXJzaW5lTWkoSE9NRV9MQVQsIEhPTUVfTE9OLCBYTkFfRkFMTEJBQ0subGF0LCBYTkFfRkFMTEJBQ0subG9uKTsKICBpZiAoZFRvWE5BIDw9IDYwKSByZXR1cm4gIkZheWV0dGV2aWxsZS9CZW50b252aWxsZSwgQVIgKFhOQSBhcmVhKSI7CiAgcmV0dXJuIGAke0hPTUVfTEFULnRvRml4ZWQoMyl9LCAke0hPTUVfTE9OLnRvRml4ZWQoMyl9YDsKfQoKZnVuY3Rpb24gc2V0SG9tZUxpbmUoKXsKICBjb25zdCBlbCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJob21lTGluZSIpOwogIGlmICghZWwpIHJldHVybjsKICBlbC50ZXh0Q29udGVudCA9IGBIT01FOiAke2hvbWVQbGFjZUxhYmVsKCl9YDsKfQpmdW5jdGlvbiBzZXRGYWRlKCl7IC8qIGRpc2FibGVkIGluIHY1MiAqLyB9CmZ1bmN0aW9uIGRlZzJyYWQoZCl7IHJldHVybiBkKk1hdGguUEkvMTgwOyB9CmZ1bmN0aW9uIGhhdmVyc2luZU1pKGxhdDEsIGxvbjEsIGxhdDIsIGxvbjIpewogIGNvbnN0IFIgPSAzOTU4Ljc2MTM7CiAgY29uc3QgZExhdCA9IGRlZzJyYWQobGF0Mi1sYXQxKTsKICBjb25zdCBkTG9uID0gZGVnMnJhZChsb24yLWxvbjEpOwogIGNvbnN0IGEgPSBNYXRoLnNpbihkTGF0LzIpKioyICsgTWF0aC5jb3MoZGVnMnJhZChsYXQxKSkqTWF0aC5jb3MoZGVnMnJhZChsYXQyKSkqTWF0aC5zaW4oZExvbi8yKSoqMjsKICByZXR1cm4gMipSKk1hdGguYXNpbihNYXRoLnNxcnQoYSkpOwp9CmZ1bmN0aW9uIGJlYXJpbmcobGF0MSwgbG9uMSwgbGF0MiwgbG9uMil7CiAgY29uc3Qgz4YxPWRlZzJyYWQobGF0MSksIM+GMj1kZWcycmFkKGxhdDIpOwogIGNvbnN0IHk9TWF0aC5zaW4oZGVnMnJhZChsb24yLWxvbjEpKSpNYXRoLmNvcyjPhjIpOwogIGNvbnN0IHg9TWF0aC5jb3Moz4YxKSpNYXRoLnNpbijPhjIpLU1hdGguc2luKM+GMSkqTWF0aC5jb3Moz4YyKSpNYXRoLmNvcyhkZWcycmFkKGxvbjItbG9uMSkpOwogIHJldHVybiAoTWF0aC5hdGFuMih5LHgpKjE4MC9NYXRoLlBJKzM2MCklMzYwOwp9CmZ1bmN0aW9uIGRpclRleHQoZGVnKXsKICBpZiAoIU51bWJlci5pc0Zpbml0ZShkZWcpKSByZXR1cm4gIuKAlCI7CiAgY29uc3QgZGlycz1bIk4iLCJORSIsIkUiLCJTRSIsIlMiLCJTVyIsIlciLCJOVyIsIk4iXTsKICByZXR1cm4gZGlyc1tNYXRoLnJvdW5kKGRlZy80NSldOwp9CmFzeW5jIGZ1bmN0aW9uIGZldGNoV2l0aFRpbWVvdXQodXJsLCBtcz02NTAwKXsKICBjb25zdCBjdHJsID0gbmV3IEFib3J0Q29udHJvbGxlcigpOwogIGNvbnN0IHQgPSBzZXRUaW1lb3V0KCgpPT5jdHJsLmFib3J0KCksIG1zKTsKICB0cnl7CiAgICBjb25zdCByZXMgPSBhd2FpdCBmZXRjaCh1cmwsIHsgc2lnbmFsOiBjdHJsLnNpZ25hbCwgY2FjaGU6ICJuby1zdG9yZSIgfSk7CiAgICBjbGVhclRpbWVvdXQodCk7CiAgICByZXR1cm4gcmVzOwogIH1jYXRjaChlKXsKICAgIGNsZWFyVGltZW91dCh0KTsKICAgIHRocm93IGU7CiAgfQp9CmZ1bmN0aW9uIG1pbGVzVG9EZWdMYXQobWkpeyByZXR1cm4gbWkvNjkuMDsgfQpmdW5jdGlvbiBtaWxlc1RvRGVnTG9uKG1pLCBsYXQpeyByZXR1cm4gbWkvKE1hdGguY29zKGRlZzJyYWQobGF0KSkqNjkuMTcyKTsgfQpmdW5jdGlvbiBsb29rc0NvbW1lcmNpYWwoY3MpewogIGlmICghY3MpIHJldHVybiBmYWxzZTsKICBjb25zdCBzID0gY3MudHJpbSgpLnRvVXBwZXJDYXNlKCk7CiAgaWYgKHMubGVuZ3RoIDwgMykgcmV0dXJuIGZhbHNlOwogIHJldHVybiAvXltBLVpdezIsM31cZHsxLDV9W0EtWl0/JC8udGVzdChzKTsKfQpmdW5jdGlvbiByZWFkU3RhdGVSb3cocm93KXsKICBjb25zdCBjYWxsc2lnbiA9IG5vcm1DYWxsc2lnbihyb3dbMV0pOwogIGNvbnN0IGxhdCA9IHJvd1s2XSwgbG9uID0gcm93WzVdOwogIGlmICghTnVtYmVyLmlzRmluaXRlKGxhdCkgfHwgIU51bWJlci5pc0Zpbml0ZShsb24pKSByZXR1cm4gbnVsbDsKICBjb25zdCBkaXN0ID0gaGF2ZXJzaW5lTWkoSE9NRV9MQVQsIEhPTUVfTE9OLCBsYXQsIGxvbik7CiAgY29uc3QgdmVsTXMgPSByb3dbOV07CiAgY29uc3QgdHJrID0gcm93WzEwXTsKICBjb25zdCBhbHRNID0gKE51bWJlci5pc0Zpbml0ZShyb3dbMTNdKSA/IHJvd1sxM10gOiByb3dbN10pOwogIHJldHVybiB7CiAgICBjYWxsc2lnbiwKICAgIGxhdCwgbG9uLAogICAgZGlzdCwKICAgIHRyaywKICAgIHNwZE1waDogTnVtYmVyLmlzRmluaXRlKHZlbE1zKSA/IHZlbE1zKjIuMjM2OTM2IDogbnVsbCwKICAgIGFsdEZ0OiBOdW1iZXIuaXNGaW5pdGUoYWx0TSkgPyBhbHRNKjMuMjgwODQgOiBudWxsLAogICAgb3JpZ2luQ291bnRyeTogcm93WzJdIHx8ICIiLAogICAgaWNhbzI0OiByb3dbMF0gfHwgIiIKICB9Owp9CgpmdW5jdGlvbiB1cGRhdGVUaWNrZXIoKXsgLyogdjY4OiB0aWNrZXIgcmVtb3ZlZCAqLyB9CgpmdW5jdGlvbiBwaWNrQ3VycmVudCgpewogIGlmICghZmxpZ2h0cy5sZW5ndGgpIHJldHVybiBudWxsOwogIGlmIChzY3JvbGxNb2RlID09PSAiY2xvc2VzdCIpIHJldHVybiBmbGlnaHRzWzBdOwogIGN1cnJlbnRJbmRleCA9IChjdXJyZW50SW5kZXggJSBmbGlnaHRzLmxlbmd0aCArIGZsaWdodHMubGVuZ3RoKSAlIGZsaWdodHMubGVuZ3RoOwogIHJldHVybiBmbGlnaHRzW2N1cnJlbnRJbmRleF07Cn0KCmZ1bmN0aW9uIHJlbmRlcigpewogIHRyeXsgdXBkYXRlTGFzdFVwZGF0ZSgpOyB9Y2F0Y2goZSl7fQoKICBzZXRIb21lTGluZSgpOwoKICBjb25zdCBjc0VsID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoImNzIik7CiAgY29uc3Qgcm91dGVFbCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJyb3V0ZSIpOwogIGNvbnN0IG1vZGVsRWwgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgibW9kZWwiKTsKICBjb25zdCBhbHRFbCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJhbHQiKTsKICBjb25zdCBzcGRFbCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJzcGQiKTsKICBjb25zdCBkaXN0RWwgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgiZGlzdCIpOwogIGNvbnN0IGRpckVsID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoImRpciIpOwogIGNvbnN0IG1ldGFFbCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJtZXRhIik7CiAgY29uc3QgYWlybGluZU5hbWVFbCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJhaXJsaW5lLW5hbWUiKTsKICBjb25zdCBhaXJsaW5lU3ViRWwgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgiYWlybGluZS1zdWIiKTsKICBjb25zdCBsb2dvRWwgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgibG9nbyIpOwoKICBpZiAoIWN1cnJlbnQpewogICAgc2V0VGV4dCgiY3MiLCLigJQiKTsKICAgIHNldFRleHQoInJvdXRlIiwiTk8gTkVBUkJZIEZMSUdIVFMiKTsKICAgIHNldFRleHQoIm1vZGVsIiwi4oCUIik7CiAgICBzZXRUZXh0KCJhbHQiLCLigJQiKTsKICAgIHNldFRleHQoInNwZCIsIuKAlCIpOwogICAgc2V0VGV4dCgiZGlzdCIsIuKAlCIpOwogICAgc2V0VGV4dCgiZGlyIiwi4oCUIik7CiAgICBzZXRUZXh0KCJtZXRhIiwiQWRqdXN0IHJhbmdlIG9yIHR1cm4gb2ZmIGNvbW1lcmNpYWwtb25seSB0byBzZWUgbW9yZSB0cmFmZmljLiIpOzsKICAgIGlmIChsb2dvRWwpewogICAgICBpZiAobG9nb0VsLmdldEF0dHJpYnV0ZSgiZGF0YS1haXJsaW5lIikgIT09ICIiKSBsb2dvRWwuc2V0QXR0cmlidXRlKCJkYXRhLWFpcmxpbmUiLCIiKTsKICAgICAgc2V0SFRNTCgibG9nbyIsIGxvZ29TVkdGcm9tQ2FsbHNpZ24oIiIpKTsgCiAgICB9CiAgICByZXR1cm47CiAgfQoKICBjb25zdCBvcCA9IGFpcmxpbmVDb2RlRnJvbUNhbGxzaWduKGN1cnJlbnQuY2FsbHNpZ24pOwogIGNvbnN0IHBhcmVudCA9IHBhcmVudEJyYW5kQ29kZUZyb21QcmVmaXgob3ApOwogIGNvbnN0IGFpcmxpbmVOYW1lID0gcGFyZW50QnJhbmROYW1lRnJvbUNvZGUocGFyZW50KTsKICBpZiAoYWlybGluZU5hbWVFbCkgc2V0VGV4dCgiYWlybGluZS1uYW1lIiwgYWlybGluZU5hbWUpOwogIGlmIChhaXJsaW5lU3ViRWwpIHNldFRleHQoImFpcmxpbmUtc3ViIiwgcmVnaW9uYWxTdWJMYWJlbChvcCwgcGFyZW50KSB8fCAiICIpOwogIHNldFRleHQoImNzIiwoY3VycmVudC5jYWxsc2lnbiB8fCAiVU5LTk9XTiIpKTsKICB0cnl7IHVwZGF0ZVNlY29uZGFyeUJveGVzKGZsaWdodHMsIGN1cnJlbnRJbmRleCk7IH1jYXRjaChlKXt9CiAgaWYgKGxvZ29FbCl7CiAgICBjb25zdCBvcENvZGUgPSBhaXJsaW5lQ29kZUZyb21DYWxsc2lnbihjdXJyZW50LmNhbGxzaWduKSB8fCAiIjsKICAgIGNvbnN0IGNvZGUgPSBwYXJlbnRCcmFuZENvZGVGcm9tUHJlZml4KG9wQ29kZSkgfHwgb3BDb2RlOwogICAgaWYgKGxvZ29FbC5nZXRBdHRyaWJ1dGUoImRhdGEtYWlybGluZSIpICE9PSBjb2RlKSBsb2dvRWwuc2V0QXR0cmlidXRlKCJkYXRhLWFpcmxpbmUiLCBjb2RlKTsKICAgIHNldEhUTUwoImxvZ28iLCBsb2dvU1ZHRnJvbUNhbGxzaWduKGN1cnJlbnQuY2FsbHNpZ24pKTsKICB9CiAgaWYgKGN1cnJlbnQuZXhhY3RNb2RlbDEpewogICAgc2V0TW9kZWxMaW5lc1YxMTQoY3VycmVudC5leGFjdE1vZGVsMSwgY3VycmVudC5leGFjdE1vZGVsMnx8IiIpOwogIH0gZWxzZSB7CiAgICBzZXRUZXh0KCJtb2RlbCIsIG1vZGVsSGludEZyb21DYWxsc2lnbihjdXJyZW50LmNhbGxzaWduKSk7CiAgfQogIHNldFRleHQoInJvdXRlIiwgY3VycmVudC5yb3V0ZVByZXR0eSB8fCAi4oCUIik7CgogIHNldFRleHQoImFsdCIsIGN1cnJlbnQuYWx0RnQgPyBgJHtNYXRoLnJvdW5kKGN1cnJlbnQuYWx0RnQpLnRvTG9jYWxlU3RyaW5nKCl9IEZUYCA6ICLigJQiKTsKICBzZXRUZXh0KCJzcGQiLCBjdXJyZW50LnNwZE1waCA/IGAke01hdGgucm91bmQoY3VycmVudC5zcGRNcGgpfSBNUEhgIDogIuKAlCIpOwogIHNldFRleHQoImRpc3QiLCBgJHtjdXJyZW50LmRpc3QudG9GaXhlZCgxKX0gTUlgKTsKCiAgY29uc3QgYiA9IGJlYXJpbmcoSE9NRV9MQVQsIEhPTUVfTE9OLCBjdXJyZW50LmxhdCwgY3VycmVudC5sb24pOwogIHNldFRleHQoImRpciIsIGAke2RpclRleHQoYil9ICR7TWF0aC5yb3VuZChiKX3CsGApOwoKICBzZXRUZXh0KCJtZXRhIiwgY3VycmVudC5tZXRhUHJldHR5IHx8IGBDT1VOVFJZOiAke2N1cnJlbnQub3JpZ2luQ291bnRyeSB8fCAi4oCUIn0g4oCiIElDQU8yNDogJHtjdXJyZW50LmljYW8yNCB8fCAi4oCUIn1gKTsKICBpZiAod2luZG93Ll9fRldfVVBEQVRFX1JPVVRFX18pIHdpbmRvdy5fX0ZXX1VQREFURV9ST1VURV9fKCk7CiAgaWYgKHdpbmRvdy5fX0ZXX1VQREFURV9BSVJDUkFGVF9fKSB3aW5kb3cuX19GV19VUERBVEVfQUlSQ1JBRlRfXygpOwp9CgoKCmFzeW5jIGZ1bmN0aW9uIGxvYWRGbGlnaHRzKCl7CiAgLy8gdjk1OiBSQU5HRV9NSSBjYW4gYmUgSW5maW5pdHkgKCJhbnkiKS4gT3BlblNreSBuZWVkcyBhIGZpbml0ZSBiYm94LgogIGNvbnN0IGNvb3JkU291cmNlID0gZW5zdXJlSG9tZUNvb3JkcygpOwogIGNvbnN0IHF1ZXJ5UmFkaXVzTWkgPSBOdW1iZXIuaXNGaW5pdGUoUkFOR0VfTUkpID8gUkFOR0VfTUkgOiAyNTA7IC8vIHF1ZXJ5IH4yNTBtaSBib3gsIHN0aWxsIHNob3cgY2xvc2VzdCBvdmVyYWxsCgogIC8vIHYxMTg6IGZpeGVkLXNpemUgYmJveCBhcm91bmQgY3VycmVudCBsb2NhdGlvbiAocGVyZm9ybWFuY2UpOyBubyByYW5nZSBsb2dpYwogIGNvbnN0IGJiID0gZndHZXRCYm94VjEyNShIT01FX0xBVCwgSE9NRV9MT04pOwogIGNvbnN0IGxhbWluID0gYmIubGFtaW4udG9GaXhlZCg0KTsKICBjb25zdCBsYW1heCA9IGJiLmxhbWF4LnRvRml4ZWQoNCk7CiAgY29uc3QgbG9taW4gPSBiYi5sb21pbi50b0ZpeGVkKDQpOwogIGNvbnN0IGxvbWF4ID0gYmIubG9tYXgudG9GaXhlZCg0KTsKCiAgY29uc3QgdXJsID0gYCR7UFJPWFl9b3BlbnNreS9zdGF0ZXM/bGFtaW49JHtsYW1pbn0mbG9taW49JHtsb21pbn0mbGFtYXg9JHtsYW1heH0mbG9tYXg9JHtsb21heH1gOwogIGNvbnN0IHJlcyA9IGF3YWl0IGZldGNoV2l0aFRpbWVvdXQodXJsLCA2NTAwKTsKICBpZiAoIXJlcy5vaykgdGhyb3cgbmV3IEVycm9yKGBPcGVuU2t5ICR7cmVzLnN0YXR1c31gKTsKICBjb25zdCBqcyA9IGF3YWl0IHJlcy5qc29uKCk7CgogIGNvbnN0IHJvd3MgPSBBcnJheS5pc0FycmF5KGpzPy5zdGF0ZXMpID8ganMuc3RhdGVzIDogW107CiAgY29uc3QgcmF3Q291bnQgPSByb3dzLmxlbmd0aDsKICBjb25zdCBwYXJzZWQgPSBbXTsKICBmb3IgKGNvbnN0IHIgb2Ygcm93cyl7CiAgICBjb25zdCBmID0gcmVhZFN0YXRlUm93KHIpOwogICAgaWYgKCFmKSBjb250aW51ZTsKICAgIC8vIElmIFJBTkdFX01JIGlzIGZpbml0ZSwgZmlsdGVyIGJ5IGl0LiBJZiAiYW55IiAoSW5maW5pdHkpLCBkbyBub3QgZmlsdGVyIGJ5IGRpc3RhbmNlLgogICAgaWYgKE51bWJlci5pc0Zpbml0ZShSQU5HRV9NSSkgJiYgZi5kaXN0ID4gUkFOR0VfTUkpIGNvbnRpbnVlOwogICAgaWYgKENPTU1FUkNJQUxfT05MWSAmJiAhaXNDb21tZXJjaWFsQ2FsbHNpZ24oZi5jYWxsc2lnbikpIGNvbnRpbnVlOwogICAgcGFyc2VkLnB1c2goZik7CiAgfQogIHBhcnNlZC5zb3J0KChhLGIpPT5hLmRpc3QtYi5kaXN0KTsKICBmbGlnaHRzID0gcGFyc2VkLnNsaWNlKDAsIDUpOwogIHRyeXsgc2V0U3RhdHVzTGluZShgUmFkYXI6ICR7cmF3Q291bnR9IGZsaWdodHMg4oCiIFNob3dpbmc6ICR7ZmxpZ2h0cy5sZW5ndGh9IOKAoiBMb2M6ICR7Y29vcmRTb3VyY2V9ICgke0hPTUVfTEFULnRvRml4ZWQoMyl9LCAke0hPTUVfTE9OLnRvRml4ZWQoMyl9KWApOyB9Y2F0Y2goZSl7fQogIGN1cnJlbnQgPSBwaWNrQ3VycmVudCgpOwogIHdpbmRvdy5fX0ZXX0NVUlJFTlRfRkxJR0hUID0gY3VycmVudDsKICB0cnl7IF9fZndNYXJrU3RhYmxlS2V5KGN1cnJlbnQgJiYgY3VycmVudC5jYWxsc2lnbiwgY3VycmVudCAmJiBjdXJyZW50LmljYW8yNCk7IH1jYXRjaChlKXt9CiAgLy8gdjEyMDogcmUta2ljayBlbnJpY2hlcnMgc2hvcnRseSBhZnRlciB0byBhdm9pZCByYWNlIG9uIGZhc3QgcmVmcmVzaAogIHRyeXsKICAgIGNvbnN0IF9jcyA9IFN0cmluZygoY3VycmVudCAmJiBjdXJyZW50LmNhbGxzaWduKSA/IGN1cnJlbnQuY2FsbHNpZ24gOiAiIik7CiAgICBjb25zdCBfaHggPSBTdHJpbmcoKGN1cnJlbnQgJiYgY3VycmVudC5pY2FvMjQpID8gY3VycmVudC5pY2FvMjQgOiAiIik7CiAgICBzZXRUaW1lb3V0KCgpPT57CiAgICAgIHRyeXsgaWYgKHdpbmRvdy5fX0ZXX0NVUlJFTlRfRkxJR0hUICYmIFN0cmluZyh3aW5kb3cuX19GV19DVVJSRU5UX0ZMSUdIVC5jYWxsc2lnbnx8IiIpPT09X2NzICYmIHdpbmRvdy5fX0ZXX0ZPUkNFX1JPVVRFX18pIHdpbmRvdy5fX0ZXX0ZPUkNFX1JPVVRFX18oKTsgfWNhdGNoKGUpe30KICAgICAgdHJ5eyBpZiAod2luZG93Ll9fRldfQ1VSUkVOVF9GTElHSFQgJiYgU3RyaW5nKHdpbmRvdy5fX0ZXX0NVUlJFTlRfRkxJR0hULmljYW8yNHx8IiIpPT09X2h4ICYmIHdpbmRvdy5fX0ZXX1VQREFURV9BSVJDUkFGVF9fKSB3aW5kb3cuX19GV19VUERBVEVfQUlSQ1JBRlRfXygpOyB9Y2F0Y2goZSl7fQogICAgfSwgODUwKTsKICB9Y2F0Y2goZSl7fQogIC8vIHYxMTc6IGtpY2sgb2ZmIGVucmljaGVycyBpbW1lZGlhdGVseSBvbiBtYWluLXRpbGUgY2hhbmdlCiAgdHJ5eyBpZiAod2luZG93Ll9fRldfRk9SQ0VfUk9VVEVfXykgd2luZG93Ll9fRldfRk9SQ0VfUk9VVEVfXygpOyB9Y2F0Y2goZSl7fQogIHRyeXsgaWYgKHdpbmRvdy5fX0ZXX1VQREFURV9BSVJDUkFGVF9fKSB3aW5kb3cuX19GV19VUERBVEVfQUlSQ1JBRlRfXygpOyB9Y2F0Y2goZSl7fQogIGlmICh3aW5kb3cuX19GV19VUERBVEVfQUlSQ1JBRlRfXykgd2luZG93Ll9fRldfVVBEQVRFX0FJUkNSQUZUX18oKTsKICBpZiAod2luZG93Ll9fRldfVVBEQVRFX1JPVVRFX18pIHdpbmRvdy5fX0ZXX1VQREFURV9ST1VURV9fKCk7CiAgdHJ5eyBzZXRTdGF0dXNMaW5lKGBSYWRhcjogJHtyYXdDb3VudH0gZmxpZ2h0cyDigKIgU2hvd2luZzogJHtmbGlnaHRzLmxlbmd0aH0g4oCiIExvYzogJHtjb29yZFNvdXJjZX0gKCR7SE9NRV9MQVQudG9GaXhlZCgzKX0sICR7SE9NRV9MT04udG9GaXhlZCgzKX0pYCk7IH1jYXRjaChlKXt9CiAgaWYgKGN1cnJlbnQpeyBjdXJyZW50LnJvdXRlUHJldHR5ID0gbnVsbDsgY3VycmVudC5tZXRhUHJldHR5ID0gbnVsbDsgfQogIHVwZGF0ZVRpY2tlcigpOwogIHdpbmRvdy5fX0ZXX0NVUlJFTlRfRkxJR0hUID0gY3VycmVudDsKICB0cnl7IF9fZndNYXJrU3RhYmxlS2V5KGN1cnJlbnQgJiYgY3VycmVudC5jYWxsc2lnbiwgY3VycmVudCAmJiBjdXJyZW50LmljYW8yNCk7IH1jYXRjaChlKXt9CiAgLy8gdjEyMDogcmUta2ljayBlbnJpY2hlcnMgc2hvcnRseSBhZnRlciB0byBhdm9pZCByYWNlIG9uIGZhc3QgcmVmcmVzaAogIHRyeXsKICAgIGNvbnN0IF9jcyA9IFN0cmluZygoY3VycmVudCAmJiBjdXJyZW50LmNhbGxzaWduKSA/IGN1cnJlbnQuY2FsbHNpZ24gOiAiIik7CiAgICBjb25zdCBfaHggPSBTdHJpbmcoKGN1cnJlbnQgJiYgY3VycmVudC5pY2FvMjQpID8gY3VycmVudC5pY2FvMjQgOiAiIik7CiAgICBzZXRUaW1lb3V0KCgpPT57CiAgICAgIHRyeXsgaWYgKHdpbmRvdy5fX0ZXX0NVUlJFTlRfRkxJR0hUICYmIFN0cmluZyh3aW5kb3cuX19GV19DVVJSRU5UX0ZMSUdIVC5jYWxsc2lnbnx8IiIpPT09X2NzICYmIHdpbmRvdy5fX0ZXX0ZPUkNFX1JPVVRFX18pIHdpbmRvdy5fX0ZXX0ZPUkNFX1JPVVRFX18oKTsgfWNhdGNoKGUpe30KICAgICAgdHJ5eyBpZiAod2luZG93Ll9fRldfQ1VSUkVOVF9GTElHSFQgJiYgU3RyaW5nKHdpbmRvdy5fX0ZXX0NVUlJFTlRfRkxJR0hULmljYW8yNHx8IiIpPT09X2h4ICYmIHdpbmRvdy5fX0ZXX1VQREFURV9BSVJDUkFGVF9fKSB3aW5kb3cuX19GV19VUERBVEVfQUlSQ1JBRlRfXygpOyB9Y2F0Y2goZSl7fQogICAgfSwgODUwKTsKICB9Y2F0Y2goZSl7fQogIC8vIHYxMTc6IGtpY2sgb2ZmIGVucmljaGVycyBpbW1lZGlhdGVseSBvbiBtYWluLXRpbGUgY2hhbmdlCiAgdHJ5eyBpZiAod2luZG93Ll9fRldfRk9SQ0VfUk9VVEVfXykgd2luZG93Ll9fRldfRk9SQ0VfUk9VVEVfXygpOyB9Y2F0Y2goZSl7fQogIHRyeXsgaWYgKHdpbmRvdy5fX0ZXX1VQREFURV9BSVJDUkFGVF9fKSB3aW5kb3cuX19GV19VUERBVEVfQUlSQ1JBRlRfXygpOyB9Y2F0Y2goZSl7fQogIGlmICh3aW5kb3cuX19GV19VUERBVEVfQUlSQ1JBRlRfXykgd2luZG93Ll9fRldfVVBEQVRFX0FJUkNSQUZUX18oKTsKICBpZiAod2luZG93Ll9fRldfVVBEQVRFX1JPVVRFX18pIHdpbmRvdy5fX0ZXX1VQREFURV9ST1VURV9fKCk7Cn0KCmZ1bmN0aW9uIGRldGVjdExvY2F0aW9uKCl7CiAgaWYgKCFuYXZpZ2F0b3IuZ2VvbG9jYXRpb24pIHJldHVybjsKICBsZXQgZG9uZSA9IGZhbHNlOwogIGNvbnN0IHQgPSBzZXRUaW1lb3V0KCgpPT57IGRvbmU9dHJ1ZTsgfSwgMzAwMCk7CiAgbmF2aWdhdG9yLmdlb2xvY2F0aW9uLmdldEN1cnJlbnRQb3NpdGlvbigKICAgIChwb3MpPT57CiAgICAgIGlmIChkb25lKSByZXR1cm47CiAgICAgIGRvbmUgPSB0cnVlOyBjbGVhclRpbWVvdXQodCk7CiAgICAgIEhPTUVfTEFUID0gcG9zLmNvb3Jkcy5sYXRpdHVkZTsKICAgICAgSE9NRV9MT04gPSBwb3MuY29vcmRzLmxvbmdpdHVkZTsKICAgICAgc2V0SG9tZUxpbmUoKTsKICAgIH0sCiAgICAoKT0+eyBkb25lPXRydWU7IGNsZWFyVGltZW91dCh0KTsgfSwKICAgIHsgZW5hYmxlSGlnaEFjY3VyYWN5OmZhbHNlLCBtYXhpbXVtQWdlOjYwMDAwMCwgdGltZW91dDozMDAwIH0KICApOwp9CgpmdW5jdGlvbiBob29rQ29udHJvbHMoKXsKICBjb25zdCBycyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJyYW5nZVNlbGVjdCIpOwogIGNvbnN0IG1zID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoIm1vZGVTZWxlY3QiKTsKICBjb25zdCBoaW50ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoInJhbmdlLWhpbnQiKTsKICBjb25zdCBjID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoImNvbW1lcmNpYWxPbmx5Iik7CgogIGZ1bmN0aW9uIGFwcGx5UmFuZ2UoKXsKICAgIGlmICghcnMpIHJldHVybjsKICAgIGNvbnN0IHYgPSBycy52YWx1ZTsKICAgIFJBTkdFX01JID0gKHYgPT09ICJhbnkiKSA/IEluZmluaXR5IDogTnVtYmVyKHYpOwogICAgaWYgKGhpbnQpIGhpbnQudGV4dENvbnRlbnQgPSAodiA9PT0gImFueSIpID8gIkFOWTogc2hvd2luZyB0aGUgY2xvc2VzdCBhaXJjcmFmdCBhbnl3aGVyZSIgOiAiIjsKICAgIHNldFN0YXR1cygiU0NBTk5JTkcgQUlSU1BBQ0XigKYiKTsKICAgIHNldEhvbWVMaW5lKCk7CiAgfQoKICBmdW5jdGlvbiBhcHBseU1vZGUoKXsKICAgIGlmICghbXMpIHJldHVybjsKICAgIHNjcm9sbE1vZGUgPSAobXMudmFsdWUgPT09ICJyb3RhdGU1IikgPyAicm90YXRlIiA6ICJjbG9zZXN0IjsKICAgIGN1cnJlbnRJbmRleCA9IDA7CiAgICBjdXJyZW50ID0gcGlja0N1cnJlbnQoKTsKICAgIHJlbmRlcigpOwogICAgcmVzdGFydFJvdGF0ZSgpOwogIH0KCiAgaWYgKHJzKSBycy5hZGRFdmVudExpc3RlbmVyKCJjaGFuZ2UiLCAoKT0+eyBhcHBseVJhbmdlKCk7IH0pOwogIGlmIChtcykgbXMuYWRkRXZlbnRMaXN0ZW5lcigiY2hhbmdlIiwgKCk9PnsgYXBwbHlNb2RlKCk7IH0pOwoKICBpZiAoYyl7CiAgICBjLmNoZWNrZWQgPSBDT01NRVJDSUFMX09OTFk7CiAgICBjLmFkZEV2ZW50TGlzdGVuZXIoImNoYW5nZSIsICgpPT57CiAgICAgIENPTU1FUkNJQUxfT05MWSA9ICEhYy5jaGVja2VkOwogICAgICBzZXRTdGF0dXMoIlNDQU5OSU5HIEFJUlNQQUNF4oCmIik7CiAgICB9KTsKICB9CgogIC8vIGRlZmF1bHRzCiAgaWYgKHJzKXsgcnMudmFsdWUgPSAiMjUiOyB9CiAgaWYgKG1zKXsgbXMudmFsdWUgPSAiY2xvc2VzdCI7IH0KICBhcHBseVJhbmdlKCk7CiAgYXBwbHlNb2RlKCk7Cn0KCmZ1bmN0aW9uIHJlc3RhcnRSb3RhdGUoKXsKICB0cnl7IGlmIChyb3RhdGVUaW1lcikgeyBjbGVhckludGVydmFsKHJvdGF0ZVRpbWVyKTsgcm90YXRlVGltZXIgPSBudWxsOyB9IH1jYXRjaChlKXt9CiAgdHJ5eyByZW5kZXIoKTsgfWNhdGNoKGUpe30KICBpZiAoc2Nyb2xsTW9kZSA9PT0gInJvdGF0ZSIpewogICAgcm90YXRlVGltZXIgPSBzZXRJbnRlcnZhbCgoKT0+ewogICAgICBpZiAoIWZsaWdodHMgfHwgIWZsaWdodHMubGVuZ3RoKSByZXR1cm47CiAgICAgIGN1cnJlbnRJbmRleCA9IChjdXJyZW50SW5kZXggKyAxKSAlIGZsaWdodHMubGVuZ3RoOwogICAgICByZW5kZXIoKTsKICAgIH0sIHJvdGF0ZUV2ZXJ5TXMpOwogIH0KfQoKbGV0IHRpY2tpbmcgPSBmYWxzZTsKYXN5bmMgZnVuY3Rpb24gdGljaygpewogIGlmICh0aWNraW5nKSByZXR1cm47CiAgdGlja2luZyA9IHRydWU7CiAgdHJ5ewogICAgYXdhaXQgbG9hZEZsaWdodHMoKTsKCiAgICAvLyBPcHRpb25hbDogZW5yaWNoIE9OTFkgdGhlIGRpc3BsYXllZCBmbGlnaHQgKHJvdXRlICsgZXhhY3QgbW9kZWwpIHdpdGggYmFja29mZi1zYWZlIGxvb2t1cAogICAgaWYgKGN1cnJlbnQgJiYgY3VycmVudC5jYWxsc2lnbil7CiAgICAgIGNvbnN0IGV4dHJhID0gYXdhaXQgZmV0Y2hBZHNiZGJGb3JDYWxsc2lnbihjdXJyZW50LmNhbGxzaWduKTsKICAgICAgaWYgKGV4dHJhICYmIChleHRyYS5vcmlnaW4gfHwgZXh0cmEuZGVzdGluYXRpb24gfHwgZXh0cmEucm91dGUpKXsKICAgICAgICBjb25zdCBvID0gZXh0cmEub3JpZ2luPy5pYXRhIHx8IGV4dHJhLm9yaWdpbj8uaWNhbyB8fCAiIjsKICAgICAgICBjb25zdCBkID0gZXh0cmEuZGVzdGluYXRpb24/LmlhdGEgfHwgZXh0cmEuZGVzdGluYXRpb24/LmljYW8gfHwgIiI7CiAgICAgICAgaWYgKG8gJiYgZCl7CiAgICAgICAgICBjb25zdCBvTGJsID0gYWlycG9ydExhYmVsKG8pOwogICAgICAgICAgY29uc3QgZExibCA9IGFpcnBvcnRMYWJlbChkKTsKICAgICAgICAgIGN1cnJlbnQucm91dGVQcmV0dHkgPSBgJHtvTGJsfSDihpIgJHtkTGJsfWA7CiAgICAgICAgICBjb25zdCByZWcgPSBleHRyYS5yZWdpc3RyYXRpb24gPyBgUkVHOiAke2V4dHJhLnJlZ2lzdHJhdGlvbn0g4oCiIGAgOiAiIjsKICAgICAgICAgIGNvbnN0IG1kbCA9IGV4dHJhLm1vZGVsID8gYE1PREVMOiAke2V4dHJhLm1vZGVsfWAgOiAiIjsKICAgICAgICAgIGN1cnJlbnQubWV0YVByZXR0eSA9IGBTT1VSQ0U6IEFEU0JEQiDigKIgJHtyZWd9JHttZGx9YC50cmltKCk7CiAgICAgICAgICBpZiAoZXh0cmEubW9kZWwpIHNldFRleHQoIm1vZGVsIiwgZXh0cmEubW9kZWwpOwogICAgICAgIH0KICAgICAgfQogICAgfQoKICAgIC8vIE9ubHkgYW5pbWF0ZSB3aGVuIHRoZSBkaXNwbGF5ZWQgZmxpZ2h0IGNoYW5nZXMgKHByZXZlbnRzIGZsYXNoaW5nKQogICAgY29uc3Qga2V5ID0gKGN1cnJlbnQgJiYgY3VycmVudC5jYWxsc2lnbikgPyBjdXJyZW50LmNhbGxzaWduIDogU3RyaW5nKGN1cnJlbnRJbmRleCk7CiAgICBpZiAoa2V5ICE9PSBsYXN0RGlzcGxheWVkS2V5KXsgbGFzdERpc3BsYXllZEtleSA9IGtleTsgaWYgKGhhc1JlbmRlcmVkT25jZSkgc2V0RmFkZSgpOyB9CgogICAgaWYgKGZsaWdodHMubGVuZ3RoKXsKICAgICAgc2V0U3RhdHVzKGBUUkFDS0lORyAke2ZsaWdodHMubGVuZ3RofSBDTE9TRVNUIEZMSUdIVCR7ZmxpZ2h0cy5sZW5ndGg9PT0xPyIiOiJTIn3igKZgKTsKICAgIH0gZWxzZSB7CiAgICAgIHNldFN0YXR1cygiTk8gTkVBUkJZIEZMSUdIVFMiKTsKICAgIH0KICAgIHNldEZhZGUoKTsKICAgIHJlbmRlcigpOwogICAgaGFzUmVuZGVyZWRPbmNlID0gdHJ1ZTsKICB9Y2F0Y2goZSl7CiAgICBzZXRTdGF0dXMoIlJBREFSIFRFTVBPUkFSSUxZIFVOQVZBSUxBQkxFIik7CiAgICB0cnl7CiAgICAgIGNvbnN0IGN1ciA9ICh3aW5kb3cuX19GV19DVVJSRU5UX0ZMSUdIVHx8bnVsbCk7CiAgICAgIGlmIChjdXIgJiYgY3VyLmNhbGxzaWduKXsKICAgICAgICBjb25zdCBleHRyYSA9IGF3YWl0IGZldGNoQWRzYmRiRm9yQ2FsbHNpZ24oY3VyLmNhbGxzaWduKTsKICAgICAgICBpZiAoZXh0cmEgJiYgKGV4dHJhLm9yaWdpbiB8fCBleHRyYS5kZXN0aW5hdGlvbiB8fCBleHRyYS5yb3V0ZSkpewogICAgICAgICAgY29uc3QgbyA9IGV4dHJhLm9yaWdpbj8uaWF0YSB8fCBleHRyYS5vcmlnaW4/LmljYW8gfHwgIiI7CiAgICAgICAgICBjb25zdCBkID0gZXh0cmEuZGVzdGluYXRpb24/LmlhdGEgfHwgZXh0cmEuZGVzdGluYXRpb24/LmljYW8gfHwgIiI7CiAgICAgICAgICBpZiAobyAmJiBkKXsKICAgICAgICAgICAgY29uc3Qgb0xibCA9IGFpcnBvcnRMYWJlbChvKTsKICAgICAgICAgICAgY29uc3QgZExibCA9IGFpcnBvcnRMYWJlbChkKTsKICAgICAgICAgICAgY3VyLnJvdXRlUHJldHR5ID0gYCR7b0xibH0g4oaSICR7ZExibH1gOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgICBpZiAodHlwZW9mIHdpbmRvdy5fX0ZXX1VQREFURV9BSVJDUkFGVF9SQVdfXyA9PT0gImZ1bmN0aW9uIil7CiAgICAgICAgYXdhaXQgd2luZG93Ll9fRldfVVBEQVRFX0FJUkNSQUZUX1JBV19fKCk7CiAgICAgIH0KICAgIH1jYXRjaChfZSl7fQogICAgcmVuZGVyKCk7CiAgfWZpbmFsbHl7CiAgICB0aWNraW5nID0gZmFsc2U7CiAgfQp9CgpmdW5jdGlvbiBzdGFydCgpewogIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJmdy12ZXJzaW9uIikudGV4dENvbnRlbnQgPSAidjE0OSI7CiAgaG9va0NvbnRyb2xzKCk7CiAgZGV0ZWN0TG9jYXRpb24oKTsgLy8gZG9lc24ndCBibG9jawogIHNldFN0YXR1cygiU0NBTk5JTkcgQUlSU1BBQ0XigKYiKTsKICByZW5kZXIoKTsKICB0aWNrKCk7CiAgc2V0SW50ZXJ2YWwodGljaywgMzAwMCk7CiAgcmVzdGFydFJvdGF0ZSgpOwp9Cgpkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCJET01Db250ZW50TG9hZGVkIiwgc3RhcnQpOwoKCi8vIHY2MjogaGlnaGxpZ2h0IEFOWSBsYWJlbCB3aGVuIG1heCBzZWxlY3RlZAooZnVuY3Rpb24oKXsKICBjb25zdCBzbGlkZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgicmFuZ2UiKTsKICBjb25zdCBsYWJlbHMgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgicmFuZ2UtbGFiZWxzIik7CiAgaWYgKCFzbGlkZXIgfHwgIWxhYmVscykgcmV0dXJuOwogIGNvbnN0IGFueUVsID0gbGFiZWxzLnF1ZXJ5U2VsZWN0b3IoIi5hbnkiKTsKICBmdW5jdGlvbiB1cGRhdGUoKXsKICAgIGlmIChOdW1iZXIoc2xpZGVyLnZhbHVlKSA+PSBOdW1iZXIoc2xpZGVyLm1heCkpIHsKICAgICAgYW55RWwuc3R5bGUub3BhY2l0eSA9ICIxIjsKICAgIH0gZWxzZSB7CiAgICAgIGFueUVsLnN0eWxlLm9wYWNpdHkgPSAiLjciOwogICAgfQogIH0KICBzbGlkZXIuYWRkRXZlbnRMaXN0ZW5lcigiaW5wdXQiLCB1cGRhdGUpOwogIHVwZGF0ZSgpOwp9KSgpOwoKCi8vIHY2Mzogc2hvdyBoaW50IHdoZW4gcmFuZ2UgaXMgQU5ZCihmdW5jdGlvbigpewogIGNvbnN0IHNsaWRlciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJyYW5nZSIpOwogIGNvbnN0IGhpbnQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgicmFuZ2UtaGludCIpOwogIGlmICghc2xpZGVyIHx8ICFoaW50KSByZXR1cm47CiAgZnVuY3Rpb24gdXBkYXRlKCl7CiAgICBpZiAoTnVtYmVyKHNsaWRlci52YWx1ZSkgPj0gTnVtYmVyKHNsaWRlci5tYXgpKSB7CiAgICAgIGhpbnQudGV4dENvbnRlbnQgPSAiQU5ZOiBzaG93aW5nIHRoZSBjbG9zZXN0IGFpcmNyYWZ0IGFueXdoZXJlIjsKICAgIH0gZWxzZSB7CiAgICAgIGhpbnQudGV4dENvbnRlbnQgPSAiIjsKICAgIH0KICB9CiAgc2xpZGVyLmFkZEV2ZW50TGlzdGVuZXIoImlucHV0IiwgdXBkYXRlKTsKICB1cGRhdGUoKTsKfSkoKTsKCgovLyB2NjY6IHJhbmdlIFVJIChBTlkgbGFiZWwgKyBoaW50KQpmdW5jdGlvbiB1cGRhdGVSYW5nZVVJKCl7IC8qIHY4MCByZW1vdmVkICovIH0KCgovLyB2Njg6IHNob3cgbmV4dCA0IGZsaWdodHMgYXMgYm94ZXMgdW5kZXIgbWFpbiBjYXJkIChubyB0aWNrZXIpCmZ1bmN0aW9uIHVwZGF0ZVNlY29uZGFyeUJveGVzKHF1ZXVlLCBjdXJyZW50SW5kZXgpewogIGNvbnN0IGlkcyA9IFsic2VjMSIsInNlYzIiLCJzZWMzIiwic2VjNCJdOwogIGZvciAobGV0IGk9MDtpPDQ7aSsrKXsKICAgIGNvbnN0IGVsID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoaWRzW2ldKTsKICAgIGlmICghZWwpIGNvbnRpbnVlOwogICAgY29uc3QgY3NFbCA9IGVsLnF1ZXJ5U2VsZWN0b3IoIi5zZWNDUyIpOwogICAgY29uc3QgbWluaUVsID0gZWwucXVlcnlTZWxlY3RvcigiLnNlY01pbmkiKTsKCiAgICBpZiAoIXF1ZXVlIHx8IHF1ZXVlLmxlbmd0aCA8IDIpewogICAgICBpZiAoY3NFbCkgY3NFbC50ZXh0Q29udGVudCA9ICLigJQiOwogICAgICBpZiAobWluaUVsKSBtaW5pRWwudGV4dENvbnRlbnQgPSAi4oCUIjsKICAgICAgY29udGludWU7CiAgICB9CiAgICBjb25zdCBmID0gcXVldWVbKGN1cnJlbnRJbmRleCArIDEgKyBpKSAlIHF1ZXVlLmxlbmd0aF07CiAgICBpZiAoIWYpewogICAgICBpZiAoY3NFbCkgY3NFbC50ZXh0Q29udGVudCA9ICLigJQiOwogICAgICBpZiAobWluaUVsKSBtaW5pRWwudGV4dENvbnRlbnQgPSAi4oCUIjsKICAgICAgY29udGludWU7CiAgICB9CiAgICBjb25zdCBjcyA9IGYuY2FsbHNpZ24gfHwgIuKAlCI7CiAgICBjb25zdCBkaXN0ID0gTnVtYmVyLmlzRmluaXRlKGYuZGlzdCkgPyBgJHtNYXRoLnJvdW5kKGYuZGlzdCl9TUlgIDogIuKAlCI7CiAgICBjb25zdCBicmcgPSBOdW1iZXIuaXNGaW5pdGUoZi50cmspID8gZGlyVGV4dChmLnRyaykgOiAi4oCUIjsKICAgIGNvbnN0IGFsdCA9IE51bWJlci5pc0Zpbml0ZShmLmFsdEZ0KSA/IGAke01hdGgucm91bmQoZi5hbHRGdCl9RlRgIDogIuKAlCI7CiAgICBjb25zdCBzcGQgPSBOdW1iZXIuaXNGaW5pdGUoZi5zcGRNcGgpID8gYCR7TWF0aC5yb3VuZChmLnNwZE1waCl9TVBIYCA6ICLigJQiOwogICAgY29uc3QgbWluaSA9IGAke2Rpc3R9ICR7YnJnfSDigKIgJHthbHR9IOKAoiAke3NwZH1gOwoKICAgIGlmIChjc0VsICYmIGNzRWwudGV4dENvbnRlbnQgIT09IGNzKSBjc0VsLnRleHRDb250ZW50ID0gY3M7CiAgICBpZiAobWluaUVsICYmIG1pbmlFbC50ZXh0Q29udGVudCAhPT0gbWluaSkgbWluaUVsLnRleHRDb250ZW50ID0gbWluaTsKICB9Cn0KCgovLyB2Njk6IGJlYXJpbmcgdG8gY29tcGFzcwpmdW5jdGlvbiBjb21wYXNzRnJvbUJlYXJpbmcoZGVnKXsKICBpZiAoIWlzRmluaXRlKGRlZykpIHJldHVybiAi4oCUIjsKICBjb25zdCBkaXJzID0gWyJOIiwiTkUiLCJFIiwiU0UiLCJTIiwiU1ciLCJXIiwiTlciXTsKICBjb25zdCBpZHggPSBNYXRoLnJvdW5kKCgoZGVnICUgMzYwKSAvIDQ1KSkgJSA4OwogIHJldHVybiBkaXJzW2lkeF07Cn0KCgpmdW5jdGlvbiByb3RhdGVTdGVwKCl7CiAgaWYgKCFxdWV1ZSB8fCAhcXVldWUubGVuZ3RoKSByZXR1cm47CiAgY3VycmVudEluZGV4ID0gKGN1cnJlbnRJbmRleCArIDEpICUgcXVldWUubGVuZ3RoOwogIHJlbmRlckN1cnJlbnQoKTsKfQoKCi8vIHY4MDogdG9nZ2xlcyAocGFzc2VuZ2VyIGFpcmxpbmVzIG9ubHkgKyBzY3JvbGw1KQooZnVuY3Rpb24oKXsKICBjb25zdCBjID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoImNvbW1lcmNpYWxPbmx5Iik7CiAgY29uc3QgcyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJzY3JvbGw1Iik7CiAgZnVuY3Rpb24gc3luYygpewogICAgQ09NTUVSQ0lBTF9PTkxZID0gYyA/ICEhYy5jaGVja2VkIDogdHJ1ZTsKICAgIFNDUk9MTDUgPSBzID8gISFzLmNoZWNrZWQgOiBmYWxzZTsKICAgIHNjcm9sbE1vZGUgPSBTQ1JPTEw1ID8gInJvdGF0ZSIgOiAiY2xvc2VzdCI7CiAgICBjdXJyZW50SW5kZXggPSAwOwogICAgcmVzdGFydFJvdGF0ZSgpOwogIH0KICBpZiAoYykgYy5hZGRFdmVudExpc3RlbmVyKCJjaGFuZ2UiLCBzeW5jKTsKICBpZiAocykgcy5hZGRFdmVudExpc3RlbmVyKCJjaGFuZ2UiLCBzeW5jKTsKICBzeW5jKCk7Cn0pKCk7CgoKZnVuY3Rpb24gYXBwbHlGaWx0ZXJzQW5kTGltaXQoKXsKICAvLyB2OTQ6IHNob3cgY291bnRzICsgZmFsbGJhY2sgc28gdGhlIHNjcmVlbiBuZXZlciBnb2VzIGJsYW5rIGR1ZSB0byBmaWx0ZXJpbmcKICBjb25zdCBzdGF0dXNFbCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJzdGF0dXMiKTsKICBjb25zdCByYXcgPSAodHlwZW9mIHdpbmRvdy5fX2Z3X3Jhd0ZsaWdodHMgIT09ICJ1bmRlZmluZWQiICYmIHdpbmRvdy5fX2Z3X3Jhd0ZsaWdodHMpID8gd2luZG93Ll9fZndfcmF3RmxpZ2h0cyA6ICh3aW5kb3cuX19md19yYXdGbGlnaHRzIHx8IFtdKTsKICB3aW5kb3cuX19md19yYXdGbGlnaHRzID0gcmF3OwoKICBjb25zdCBwYXNzZW5nZXJPbmx5ID0gISEod2luZG93LkZXX1NUQVRFICYmIHdpbmRvdy5GV19TVEFURS5wYXNzZW5nZXJPbmx5KTsKICBsZXQgZmlsdGVyZWQgPSByYXc7CgogIGlmIChwYXNzZW5nZXJPbmx5KSB7CiAgICBjb25zdCBwYXNzZW5nZXJNYXRjaGVzID0gcmF3LmZpbHRlcihmID0+IGlzQ29tbWVyY2lhbENhbGxzaWduKGYgJiYgZi5jYWxsc2lnbikpOwogICAgZmlsdGVyZWQgPSBwYXNzZW5nZXJNYXRjaGVzOwoKICAgIGlmIChwYXNzZW5nZXJNYXRjaGVzLmxlbmd0aCA9PT0gMCAmJiByYXcubGVuZ3RoID4gMCkgewogICAgICAvLyBmYWxsYmFjayBzbyB1c2VyIHNlZXMgKnNvbWV0aGluZyogKGNhbGxzaWducyBtYXkgYmUgbWlzc2luZyBvciBtaXggaXMgbm9uLXBhc3NlbmdlcikKICAgICAgZmlsdGVyZWQgPSByYXc7CiAgICAgIGlmIChzdGF0dXNFbCkgc3RhdHVzRWwudGV4dENvbnRlbnQgPSBgUmFkYXI6ICR7cmF3Lmxlbmd0aH0gZmxpZ2h0cyAobm8gcGFzc2VuZ2VyIG1hdGNoZXMg4oCUIHNob3dpbmcgY2xvc2VzdCBvdmVyYWxsKWA7CiAgICB9IGVsc2UgewogICAgICBpZiAoc3RhdHVzRWwpIHN0YXR1c0VsLnRleHRDb250ZW50ID0gYFJhZGFyOiAke3Jhdy5sZW5ndGh9IGZsaWdodHMg4oCiIFNob3dpbmcgcGFzc2VuZ2VyOiAke01hdGgubWluKDUsIHBhc3Nlbmdlck1hdGNoZXMubGVuZ3RoKX1gOwogICAgfQogIH0gZWxzZSB7CiAgICBpZiAoc3RhdHVzRWwpIHN0YXR1c0VsLnRleHRDb250ZW50ID0gYFJhZGFyOiAke3Jhdy5sZW5ndGh9IGZsaWdodHMg4oCiIFNob3dpbmc6ICR7TWF0aC5taW4oNSwgcmF3Lmxlbmd0aCl9YDsKICB9CgogIC8vIFNvcnQgYnkgZGlzdGFuY2UgaWYgcHJlc2VudAogIGZpbHRlcmVkID0gZmlsdGVyZWQuc2xpY2UoKS5zb3J0KChhLGIpPT4gKGE/LmRpc3RhbmNlX21pID8/IGE/LmRpc3RhbmNlID8/IDFlOSkgLSAoYj8uZGlzdGFuY2VfbWkgPz8gYj8uZGlzdGFuY2UgPz8gMWU5KSk7CgogIGZsaWdodHMgPSBmaWx0ZXJlZC5zbGljZSgwLCA1KTsKfQoKLy8gdjgzOiByZWdpb25hbCBhaXJsaW5lIGdyb3VwaW5nCmNvbnN0IFJFR0lPTkFMX1BBUkVOVF9NQVAgPSB7CiAgJ0VOWSc6J0FtZXJpY2FuJywgJ0pJQSc6J0FtZXJpY2FuJywgJ1BEVCc6J0FtZXJpY2FuJywgJ1JQQSc6J0FtZXJpY2FuJywKICAnRURWJzonRGVsdGEnLCAnR0pTJzonRGVsdGEnLCAnU0tXJzonRGVsdGEnLAogICdBU0gnOidVbml0ZWQnLCAnQVdJJzonVW5pdGVkJywgJ0NQWic6J1VuaXRlZCcsCiAgJ1FYRSc6J0FsYXNrYScKfTsKCmZ1bmN0aW9uIHJlc29sdmVBaXJsaW5lTmFtZShmKXsKICBjb25zdCBjcyA9IChmLmNhbGxzaWdufHwnJykudG9VcHBlckNhc2UoKTsKICBjb25zdCBwcmVmID0gY3Muc2xpY2UoMCwzKTsKICBpZiAoUkVHSU9OQUxfUEFSRU5UX01BUFtwcmVmXSkgcmV0dXJuIFJFR0lPTkFMX1BBUkVOVF9NQVBbcHJlZl07CiAgcmV0dXJuIGYuYWlybGluZSB8fCBwcmVmIHx8ICfigJQnOwp9CgoKZnVuY3Rpb24gdXBkYXRlTGFzdFVwZGF0ZSgpewogIGNvbnN0IGVsID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoImxhc3RVcGRhdGUiKTsKICBjb25zdCBkb3QgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgibGl2ZUluZGljYXRvciIpOwogIGlmICghZWwpIHJldHVybjsKICBjb25zdCBkID0gbmV3IERhdGUoKTsKICBlbC50ZXh0Q29udGVudCA9ICJMQVNUIFVQREFURTogIiArIGQudG9Mb2NhbGVUaW1lU3RyaW5nKFtdLCB7aG91cjonMi1kaWdpdCcsIG1pbnV0ZTonMi1kaWdpdCcsIHNlY29uZDonMi1kaWdpdCd9KTsKICBpZiAoZG90KXsKICAgIGRvdC5jbGFzc0xpc3QucmVtb3ZlKCJwdWxzZSIpOwogICAgdm9pZCBkb3Qub2Zmc2V0V2lkdGg7IC8vIHJlc3RhcnQgYW5pbWF0aW9uCiAgICBkb3QuY2xhc3NMaXN0LmFkZCgicHVsc2UiKTsKICB9Cn0=";

function b64DecodeUtf8(b64) {
  const bin = atob(b64);
  // Convert binary string to Uint8Array then decode
  const bytes = new Uint8Array(bin.length);
  for (let i = 0; i < bin.length; i++) bytes[i] = bin.charCodeAt(i);
  return new TextDecoder("utf-8").decode(bytes);
}


function pickBestFlight(data){
  if (!Array.isArray(data)) return data;
  // Prefer entries that contain both departure & arrival airport objects.
  const withAirports = data.filter(f => f?.departure?.airport && f?.arrival?.airport);
  const pool = withAirports.length ? withAirports : data;
  const score = (f) => {
    const s = String(f?.status || f?.flightStatus || "").toLowerCase();
    const active = (s.includes("enroute") || s.includes("en route") || s.includes("active") || s.includes("airborne")) ? 1000 : 0;
    const t =
      Date.parse(f?.lastUpdatedUtc || f?.lastUpdated || "") ||
      Date.parse(f?.departure?.actualTimeUtc || "") ||
      Date.parse(f?.departure?.scheduledTimeUtc || "") ||
      Date.parse(f?.departure?.scheduledTimeLocal || "") ||
      0;
    return active + (t/1000);
  };
  let best = pool[0];
  let bestScore = -1;
  for (const f of pool){
    const sc = score(f);
    if (sc > bestScore){
      bestScore = sc;
      best = f;
    }
  }
  return best;
}
function fmtEnd(airport){
  if (!airport || typeof airport !== "object") return "";
  const city = (airport.municipalityName || airport.city || "").toString().trim();
  const code = (airport.iata || airport.icao || "").toString().trim();
  const name = (airport.name || "").toString().trim();
  const bestCity = city || (name ? name.split(" ")[0] : "");
  if (bestCity && code) return `${bestCity} (${code})`;
  return bestCity || code || "";
}

export default {
  async fetch(request, env, ctx) {
    const url = new URL(request.url);
    const parts = url.pathname.split("/").filter(Boolean);
    const cache = caches.default;

    const corsHeaders = {
      "Access-Control-Allow-Origin": "*",
      "Access-Control-Allow-Methods": "GET,HEAD,OPTIONS",
      "Access-Control-Allow-Headers": "Content-Type, Authorization",
      "Access-Control-Max-Age": "86400",
      "Vary": "Origin"
    };

    if (request.method === "OPTIONS") {
      return new Response(null, { status: 204, headers: corsHeaders });
    }

    // ---------- Static UI ----------
    if (url.pathname === "/" || url.pathname === "/index.html") {
      return new Response(b64DecodeUtf8(__B64_INDEX), {
        status: 200,
        headers: {
          "Content-Type": "text/html; charset=utf-8",
          "Cache-Control": "no-store"
        }
      });
    }
    if (url.pathname === "/style.css") {
      return new Response(b64DecodeUtf8(__B64_CSS), {
        status: 200,
        headers: {
          "Content-Type": "text/css; charset=utf-8",
          "Cache-Control": "public, max-age=3600"
        }
      });
    }
    if (url.pathname === "/app.js") {
      return new Response(b64DecodeUtf8(__B64_JS), {
        status: 200,
        headers: {
          "Content-Type": "application/javascript; charset=utf-8",
          "Cache-Control": "public, max-age=3600"
        }
      });
    }

    // ---------- Health ----------
    if (url.pathname === "/health") {
      return json({ ok: true, ts: new Date().toISOString(), version: "v149" }, 200, corsHeaders);
    }

    // ---------- OpenSky proxy ----------
    if (parts[0] === "opensky" && parts[1] === "states") {
      const lamin = url.searchParams.get("lamin");
      const lomin = url.searchParams.get("lomin");
      const lamax = url.searchParams.get("lamax");
      const lomax = url.searchParams.get("lomax");

      if (!lamin || !lomin || !lamax || !lomax) {
        return json({ ok:false, error:"missing bbox params", hint:"lamin,lomin,lamax,lomax required" }, 400, corsHeaders);
      }

      const upstream = new URL("https://opensky-network.org/api/states/all");
      upstream.searchParams.set("lamin", lamin);
      upstream.searchParams.set("lomin", lomin);
      upstream.searchParams.set("lamax", lamax);
      upstream.searchParams.set("lomax", lomax);

      const headers = { "Accept": "application/json" };

      try {
        if (env.OPENSKY_CLIENT_ID && env.OPENSKY_CLIENT_SECRET) {
          const bearer = await getOpenSkyBearer(env);
          headers["Authorization"] = `Bearer ${bearer}`;
        }
      } catch (e) {
        return json({ ok:false, error:"opensky_token_fetch_failed", detail: (e && e.message) ? e.message : "unknown" }, 502, corsHeaders);
      }

      try {
        const res = await fetch(upstream.toString(), { method:"GET", headers });
        const text = await res.text();
        if (!res.ok) {
          return json({ ok:false, error:"opensky_upstream_error", status: res.status, detail: text.slice(0,300) }, 502, corsHeaders);
        }

        return new Response(text, {
          status: 200,
          headers: {
            ...corsHeaders,
            "Content-Type": "application/json; charset=utf-8",
            "Cache-Control": "public, max-age=2, s-maxage=8"
          }
        });
      } catch (err) {
        return json({ ok:false, error:"opensky_fetch_failed", detail: (err && err.message) ? err.message : "unknown" }, 502, corsHeaders);
      }
    }

    // ---------- AeroDataBox route lookup (EDGE CACHED) ----------
    if (parts[0] === "aero") {
      const callsign = (parts[1] || url.searchParams.get("callsign") || "").trim().toUpperCase();
      if (!callsign) {
        return json({ ok:false, error:"missing callsign", hint:"Use /aero/ENY3861" }, 400, corsHeaders);
      }
      if (!env.AERODATA_KEY || !env.AERODATA_HOST) {
        return json({ ok:false, error:"aerodata_not_configured", hint:"Set AERODATA_KEY and AERODATA_HOST" }, 500, corsHeaders);
      }

      const cacheKey = new Request(`https://edgecache/route/${callsign}`);
      const hit = await cache.match(cacheKey);
      if (hit) return hit;

      const upstreamUrl = `https://${env.AERODATA_HOST}/flights/callsign/${encodeURIComponent(callsign)}`;
      try {
        const res = await fetch(upstreamUrl, {
          method: "GET",
          headers: {
            "Accept": "application/json",
            "X-RapidAPI-Key": String(env.AERODATA_KEY),
            "X-RapidAPI-Host": String(env.AERODATA_HOST),
          }
        });

        const text = await res.text();
        if (res.status === 429) {
          return json({ ok:false, callsign, error:"rate_limited", status: 429 }, 429, corsHeaders);
        }
        if (!res.ok) {
          return json({ ok:false, callsign, error:"aerodata_upstream_error", status: res.status, detail: text.slice(0,200) }, 502, corsHeaders);
        }

        let data;
        try { data = JSON.parse(text); }
        catch { return json({ ok:false, callsign, error:"aerodata_non_json" }, 502, corsHeaders); }

        const f = pickBestFlight(data);
        const origin = f?.departure?.airport || null;
        const destination = f?.arrival?.airport || null;

        const body = JSON.stringify({
          ok: true,
          callsign,
          origin,
          destination,
          route: ((origin && destination) ? (fmtEnd(origin) + " \u2192 " + fmtEnd(destination)) : "unavailable"),
          source: "aerodatabox"
        });

        const resp = new Response(body, {
          status: 200,
          headers: {
            ...corsHeaders,
            "Content-Type": "application/json; charset=utf-8",
            "Cache-Control": `private, max-age=${ROUTE_TTL}`
          }
        });

        ctx.waitUntil(cache.put(cacheKey, resp.clone()));
        return resp;

      } catch (err) {
        return json({ ok:false, callsign, error:"aerodata_fetch_failed", detail: (err && err.message) ? err.message : "unknown" }, 502, corsHeaders);
      }
    }

    // ---------- AeroDataBox aircraft details (EDGE CACHED) ----------
    if (parts[0] === "aircraft" && parts[1] === "icao24") {
      const hex = (parts[2] || "").trim().toLowerCase();
      if (!hex) {
        return json({ ok:false, error:"missing icao24", hint:"Use /aircraft/icao24/a26b4a" }, 400, corsHeaders);
      }
      if (!env.AERODATA_KEY || !env.AERODATA_HOST) {
        return json({ ok:false, error:"aerodata_not_configured", hint:"Set AERODATA_KEY and AERODATA_HOST" }, 500, corsHeaders);
      }

      const cacheKey = new Request(`https://edgecache/aircraft/${hex}`);
      const hit = await cache.match(cacheKey);
      if (hit) return hit;

      const upstreamUrl = `https://${env.AERODATA_HOST}/aircrafts/icao24/${encodeURIComponent(hex)}`;

      try {
        const res = await fetch(upstreamUrl, {
          method: "GET",
          headers: {
            "Accept": "application/json",
            "X-RapidAPI-Key": String(env.AERODATA_KEY),
            "X-RapidAPI-Host": String(env.AERODATA_HOST),
          }
        });

        if (res.status === 204) {
          const resp = new Response(JSON.stringify({ ok: true, found: false, icao24: hex }), {
            status: 200,
            headers: {
              ...corsHeaders,
              "Content-Type": "application/json; charset=utf-8",
              "Cache-Control": `private, max-age=${60*60}`
            }
          });
          ctx.waitUntil(cache.put(cacheKey, resp.clone()));
          return resp;
        }

        const text = await res.text();

        if (res.status === 429) {
          return json({ ok:false, icao24: hex, error:"rate_limited", status: 429 }, 429, corsHeaders);
        }
        if (!res.ok) {
          return json({ ok:false, icao24: hex, error:"aerodata_upstream_error", status: res.status, detail: text.slice(0,200) }, 502, corsHeaders);
        }

        let raw = null;
        try { raw = JSON.parse(text); } catch { raw = null; }
        const a = raw?.aircraft ? raw.aircraft : raw;

        const payload = {
          ok: true,
          found: true,
          icao24: hex,
          model: a?.model || a?.typeName || a?.aircraftModel || null,
          modelCode: a?.modelCode || null,
          registration: a?.registration || a?.reg || null,
          manufacturer: a?.manufacturer || null,
          source: "aerodatabox"
        };

        const resp = new Response(JSON.stringify(payload), {
          status: 200,
          headers: {
            ...corsHeaders,
            "Content-Type": "application/json; charset=utf-8",
            "Cache-Control": `private, max-age=${AIRCRAFT_TTL}`
          }
        });

        ctx.waitUntil(cache.put(cacheKey, resp.clone()));
        return resp;

      } catch (err) {
        return json({ ok:false, icao24: hex, error:"aerodata_fetch_failed", detail: (err && err.message) ? err.message : "unknown" }, 502, corsHeaders);
      }
    }

    return new Response("not found", { status: 404, headers: corsHeaders });
  }
};

async function getOpenSkyBearer(env) {
  const now = Date.now();
  if (__openskyTokenCache.token && now < (__openskyTokenCache.expMs - 60_000)) {
    return __openskyTokenCache.token;
  }

  const tokenUrl = "https://auth.opensky-network.org/auth/realms/opensky-network/protocol/openid-connect/token";

  const body = new URLSearchParams();
  body.set("grant_type", "client_credentials");
  body.set("client_id", String(env.OPENSKY_CLIENT_ID));
  body.set("client_secret", String(env.OPENSKY_CLIENT_SECRET));

  const res = await fetch(tokenUrl, {
    method: "POST",
    headers: { "Content-Type": "application/x-www-form-urlencoded" },
    body
  });

  const text = await res.text();
  if (!res.ok) {
    throw new Error(`opensky_token_error ${res.status}: ${text.slice(0,200)}`);
  }

  const data = JSON.parse(text);
  __openskyTokenCache.token = data.access_token;
  __openskyTokenCache.expMs = now + Number(data.expires_in || 1800) * 1000;
  return __openskyTokenCache.token;
}

function json(obj, status, corsHeaders) {
  return new Response(JSON.stringify(obj), {
    status,
    headers: {
      ...corsHeaders,
      "Content-Type": "application/json; charset=utf-8",
      "Cache-Control": "no-store"
    }
  });
}
