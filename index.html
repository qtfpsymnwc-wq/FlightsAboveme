<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>FlightWall - Overhead Tracker</title>
  <meta name="apple-mobile-web-app-capable" content="yes"/>
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
  <style>
    body {
      margin: 0;
      padding: 0;
      height: 100vh;
      background: #000;
      color: #ffffff;
      font-family: 'Courier New', Courier, monospace;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
    }
    h1 {
      font-size: 8vw;
      margin: 1vh 0;
      text-shadow: 0 0 15px #00ff41, 0 0 30px #00ff41;
      letter-spacing: 0.5vw;
      color: #ffffff;
    }
    #status {
      font-size: 4vw;
      margin: 2vh 0 4vh;
      text-shadow: 0 0 12px #00ff41;
      min-height: 8vh;
      color: #ffffff;
    }
    #flights {
      width: 100%;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .flight {
      display: flex;
      flex-direction: column;
      align-items: center;
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid #00ff41;
      border-radius: 6px;
      padding: 2vh 4vw;
      margin: 1vh auto;
      width: 90%;
      font-size: 3.5vw;
      box-shadow: 0 0 20px rgba(0,255,65,0.3);
      transition: opacity 2s ease-out;
    }
    .flight.faded {
      opacity: 0.5;
      border-color: #666;
      background: rgba(255, 255, 255, 0.01);
    }
    .flight.fading-out {
      opacity: 0;
    }
    .callsign {
      font-size: 6vw;
      font-weight: bold;
      color: #ffffff;
      text-shadow: 0 0 20px #00ff41;
      margin-bottom: 1vh;
      letter-spacing: 0.3vw;
      display: flex;
      align-items: center;
      gap: 2vw;
      flex-wrap: wrap;
      justify-content: center;
    }
    .heading-arrow {
      font-size: 5vw;
      transform-origin: center;
      display: inline-block;
    }
    .icon { font-size: 5vw; }
    .details {
      font-size: 3vw;
      line-height: 1.5;
      color: #f0f0f0;
      text-align: center;
    }
    .last-seen {
      font-size: 2.5vw;
      color: #aaa;
      margin-top: 0.5vh;
    }
    .empty {
      font-size: 5vw;
      opacity: 0.8;
      text-shadow: 0 0 20px #00ff41;
      color: #ffffff;
    }
    @media (orientation: landscape) {
      h1 { font-size: 6vw; }
      #status { font-size: 3vw; }
      .callsign { font-size: 5vw; }
      .details { font-size: 2.5vw; }
      .flight { padding: 1.5vh 3vw; }
    }
  </style>
</head>
<body>
  <h1>FLIGHTWALL</h1>
  <div id="status">Scanning for overhead traffic...</div>
  <div id="flights"></div>

  <script>
    const PERSIST_SECONDS = 300; // 5 minutes
    const proxy = 'https://corsproxy.io/?';

    const params = new URLSearchParams(window.location.search);
    let bboxStr = params.get('bounds') || '35.8,-94.74,37.08,-94.05'; // New widened default
    let [south, west, north, east] = bboxStr.split(',').map(Number);

    const minLat = Math.min(south, north);
    const maxLat = Math.max(south, north);
    const minLon = Math.min(west, east);
    const maxLon = Math.max(west, east);

    const fr24Url = `https://data-live.flightradar24.com/zones/fcgi/feed.js?bounds=${minLat},${minLon},${maxLat},${maxLon}&faa=1&mlat=1&flarm=1&adsb=1&gnd=0&air=1&limit=0&maxage=14400`;
    const openSkyUrl = `https://opensky-network.org/api/states/all?lamin=${minLat}&lomin=${minLon}&lamax=${maxLat}&lomax=${maxLon}`;

    const aircraftMap = new Map();

    const airportCities = {
      'KORD': 'Chicago, IL',
      'KDFW': 'Dallas, TX',
      // ... (keep the full map from before)
    };

    function getCityFromIcao(icao) {
      return airportCities[icao] || icao;
    }

    function getHeadingArrow(heading) {
      if (!heading || isNaN(heading)) return 'âž¤ ?Â°';
      const arrows = ['â†‘', 'â†—', 'â†’', 'â†˜', 'â†“', 'â†™', 'â†', 'â†–'];
      const index = Math.round(heading / 45) % 8;
      return arrows[index];
    }

    function getCategoryDescription(code) {
      const desc = {
        0: 'Unknown / No Info',
        1: 'No ADS-B Category Info',
        2: 'Light (Small GA)',
        3: 'Small (Regional Jets/Props)',
        4: 'Large',
        5: 'High Vortex Jet',
        6: 'Heavy (e.g., A380, B747, B777)',
        7: 'High Performance / Rotorcraft',
        8: 'Glider',
        9: 'Lighter than Air (Balloons)',
        10: 'Parachute / Ultralight'
      };
      return desc[code] || 'Unknown';
    }

    function getCategoryIcon(code) {
      const icons = { 0:'â“',1:'â“',2:'âœˆï¸',3:'âœˆï¸',4:'ðŸ›«',5:'ðŸ›«',6:'ðŸ›«',7:'ðŸš',8:'ðŸª‚',9:'ðŸŽˆ',10:'ðŸª‚' };
      return icons[code] || 'âœˆï¸';
    }

    async function fetchFlights() {
      const now = Date.now();
      let dataSource = 'FR24';
      let data;
      try {
        const res = await fetch(proxy + encodeURIComponent(fr24Url));
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const text = await res.text();

        let cleaned = text.trim();
        if (cleaned.startsWith('var data = ')) cleaned = cleaned.replace('var data = ', '');
        if (cleaned.endsWith(';')) cleaned = cleaned.slice(0, -1);
        data = eval('(' + cleaned + ')');
      } catch (err) {
        console.error('FR24 error:', err);
        dataSource = 'OpenSky';
        try {
          const res = await fetch(openSkyUrl);
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          data = await res.json();
        } catch (openErr) {
          console.error('OpenSky error:', openErr);
          document.getElementById('status').textContent = `ERROR: ${openErr.message} (retrying soon)`;
          return;
        }
      }

      const currentIcao24s = new Set();

      if (dataSource === 'FR24') {
        for (const key in data) {
          if (key === 'full_count' || key === 'version' || key === 'stats') continue;
          const flight = data[key];
          if (!Array.isArray(flight)) continue;

          const icao24 = key;
          const callsign = flight[0] || 'N/A';
          const type = flight[9] || 'Unknown';
          const originIcao = flight[11] || 'N/A';
          const destIcao = flight[12] || 'N/A';
          const originCity = getCityFromIcao(originIcao);
          const destCity = getCityFromIcao(destIcao);
          const heading = flight[3] || null;
          const alt = flight[4] ? Math.round(flight[4]) + ' FT' : 'N/A';
          const spd = flight[5] ? Math.round(flight[5]) + ' KTS' : 'N/A';
          const vspeed = flight[17] ? Math.round(flight[17]) + ' FT/MIN' : 'N/A';
          const squawk = flight[14] || 'N/A';
          const lat = flight[6];
          const lon = flight[7];
          const pos = lat && lon ? lat.toFixed(4) + 'Â°N ' + lon.toFixed(4) + 'Â°W' : 'N/A';
          const arrow = getHeadingArrow(heading);
          const icon = 'âœˆï¸'; // Default for FR24

          currentIcao24s.add(icao24);

          aircraftMap.set(icao24, {
            data: { callsign, type, originCity, destCity, alt, spd, heading, arrow, vspeed, pos, squawk, icon },
            lastSeenTime: now,
            isLive: true,
            element: null
          });
        }
      } else { // OpenSky
        if (data.states) {
          data.states.forEach(state => {
            const [
              icao24, callsign, origin_country, time_position, last_contact,
              longitude, latitude, baro_altitude, on_ground, velocity,
              true_track, vertical_rate, sensors, geo_altitude, squawk,
              spi, position_source, category
            ] = state;

            if (!callsign?.trim() || on_ground) return;

            const type = getCategoryDescription(category);
            const originCity = 'N/A';
            const destCity = 'N/A';
            const heading = true_track ? Math.round(true_track) : null;
            const alt = baro_altitude ? Math.round(baro_altitude * 3.28084) + ' FT' : 'N/A';
            const spd = velocity ? Math.round(velocity * 1.94384) + ' KTS' : 'N/A';
            const vspeed = vertical_rate ? Math.round(vertical_rate * 196.85) + ' FT/MIN' : 'N/A';
            const pos = (latitude && longitude) ? `${latitude.toFixed(4)}Â°N ${longitude.toFixed(4)}Â°W` : 'N/A';
            const arrow = getHeadingArrow(heading);
            const icon = getCategoryIcon(category);

            currentIcao24s.add(icao24);

            aircraftMap.set(icao24, {
              data: { callsign, type, originCity, destCity, alt, spd, heading, arrow, vspeed, pos, squawk, icon },
              lastSeenTime: now,
              isLive: true,
              element: null
            });
          });
        }
      }

      const statusEl = document.getElementById('status');
      statusEl.textContent = 'Last update: ' + new Date().toLocaleTimeString('en-US', {timeZone: 'America/Chicago'}) + ' CST' + ` (Source: ${dataSource})`;

      const flightsDiv = document.getElementById('flights');

      aircraftMap.forEach((entry, icao24) => {
        if (!currentIcao24s.has(icao24)) {
          entry.isLive = false;
        } else {
          entry.isLive = true;
          entry.lastSeenTime = now;
        }
      });

      aircraftMap.forEach((entry, icao24) => {
        const age = now - entry.lastSeenTime;
        if (age > PERSIST_SECONDS * 1000) {
          if (entry.element) {
            entry.element.classList.add('fading-out');
            setTimeout(() => {
              if (entry.element && entry.element.parentNode) {
                entry.element.parentNode.removeChild(entry.element);
              }
              aircraftMap.delete(icao24);
            }, 2000);
          } else {
            aircraftMap.delete(icao24);
          }
          return;
        }
      });

      flightsDiv.innerHTML = '';

      let foundLive = false;
      aircraftMap.forEach((entry, icao24) => {
        const age = now - entry.lastSeenTime;
        const div = document.createElement('div');
        div.className = 'flight' + (entry.isLive ? '' : ' faded');
        div.innerHTML = `
          <div class="callsign">
            <span class="icon">${entry.data.icon}</span>
            ${entry.data.callsign.trim()}
            <span class="heading-arrow" style="transform: rotate(${entry.data.heading || 0}deg);">
              ${entry.data.arrow}
            </span>
          </div>
          <div class="details">
            Type: ${entry.data.type}<br>
            ALT: ${entry.data.alt} â€¢ VSPD: ${entry.data.vspeed}<br>
            SPD: ${entry.data.spd} â€¢ HDG: ${entry.data.heading ? entry.data.heading + 'Â°' : 'N/A'}<br>
            POS: ${entry.data.pos}<br>
            SQUAWK: ${entry.data.squawk}<br>
            Orig: ${entry.data.originCity} â†’ Dest: ${entry.data.destCity}
          </div>
          ${!entry.isLive ? `<div class="last-seen">Last seen: ${Math.round(age / 1000)}s ago</div>` : ''}
        `;
        flightsDiv.appendChild(div);
        entry.element = div;

        if (entry.isLive) foundLive = true;
      });

      if (aircraftMap.size === 0) {
        statusEl.innerHTML = '<span class="empty">NO FLIGHTS OVERHEAD RIGHT NOW</span>';
      } else if (!foundLive) {
        statusEl.textContent += ' â€” Showing recent exits';
      }
    }

    fetchFlights();
    setInterval(fetchFlights, 20000);
  </script>
</body>
</html>