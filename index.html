<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>FlightWall - Overhead Tracker</title>
  <meta name="apple-mobile-web-app-capable" content="yes"/>
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
  <style>
    body {
      margin: 0;
      padding: 0;
      height: 100vh;
      background: #000;
      color: #ffffff;
      font-family: 'Courier New', Courier, monospace;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
    }
    h1 {
      font-size: 8vw;
      margin: 1vh 0;
      text-shadow: 0 0 15px #00ff41, 0 0 30px #00ff41;
      letter-spacing: 0.5vw;
      color: #ffffff;
    }
    #status {
      font-size: 4vw;
      margin: 2vh 0 4vh;
      text-shadow: 0 0 12px #00ff41;
      min-height: 8vh;
      color: #ffffff;
    }
    #flights {
      width: 100%;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .flight {
      display: flex;
      flex-direction: column;
      align-items: center;
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid #00ff41;
      border-radius: 6px;
      padding: 2vh 4vw;
      margin: 1vh auto;
      width: 90%;
      font-size: 3.5vw;
      box-shadow: 0 0 20px rgba(0,255,65,0.3);
      transition: opacity 2s ease-out;
    }
    .flight.faded {
      opacity: 0.5;
      border-color: #666;
      background: rgba(255, 255, 255, 0.01);
    }
    .flight.fading-out {
      opacity: 0;
    }
    .callsign {
      font-size: 6vw;
      font-weight: bold;
      color: #ffffff;
      text-shadow: 0 0 20px #00ff41;
      margin-bottom: 1vh;
      letter-spacing: 0.3vw;
      display: flex;
      align-items: center;
      gap: 2vw;
      flex-wrap: wrap;
      justify-content: center;
    }
    .heading-arrow {
      font-size: 5vw;
      transform-origin: center;
      display: inline-block;
    }
    .icon { font-size: 5vw; }
    .details {
      font-size: 3vw;
      line-height: 1.5;
      color: #f0f0f0;
      text-align: center;
    }
    .last-seen {
      font-size: 2.5vw;
      color: #aaa;
      margin-top: 0.5vh;
    }
    .empty {
      font-size: 5vw;
      opacity: 0.8;
      text-shadow: 0 0 20px #00ff41;
      color: #ffffff;
    }
    @media (orientation: landscape) {
      h1 { font-size: 6vw; }
      #status { font-size: 3vw; }
      .callsign { font-size: 5vw; }
      .details { font-size: 2.5vw; }
      .flight { padding: 1.5vh 3vw; }
    }
  </style>
</head>
<body>
  <h1>FLIGHTWALL</h1>
  <div id="status">Scanning for overhead traffic...</div>
  <div id="flights"></div>

  <script>
    const PERSIST_SECONDS = 300; // 5 minutes
    const proxy = 'https://api.allorigins.win/get?url=';

    const params = new URLSearchParams(window.location.search);
    let bboxStr = params.get('bounds') || '35.4,-95.0,36.8,-93.3'; // Slightly widened default
    let [south, west, north, east] = bboxStr.split(',').map(Number);

    const minLat = Math.min(south, north);
    const maxLat = Math.max(south, north);
    const minLon = Math.min(west, east);
    const maxLon = Math.max(west, east);

    const apiUrl = `https://data-live.flightradar24.com/zones/fcgi/feed.js?bounds=${minLat},${minLon},${maxLat},${maxLon}&faa=1&mlat=1&flarm=1&adsb=1&gnd=0&air=1&limit=0&maxage=14400`;

    const aircraftMap = new Map();

    const airportCities = {
      'KORD': 'Chicago, IL',
      'KDFW': 'Dallas, TX',
      // ... (keep the full map from previous response)
      // Add any missing ones if needed
    };

    function getCityFromIcao(icao) {
      return airportCities[icao] || icao; // Fallback to code if unknown
    }

    async function fetchFlights() {
      const now = Date.now();
      try {
        const res = await fetch(proxy + encodeURIComponent(apiUrl));
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const json = await res.json();
        const text = json.contents; // Parse from allorigins response

        let cleaned = text.trim();
        if (cleaned.startsWith('var data = ')) cleaned = cleaned.replace('var data = ', '');
        if (cleaned.endsWith(';')) cleaned = cleaned.slice(0, -1);
        const data = eval('(' + cleaned + ')');

        const currentIcao24s = new Set();

        for (const key in data) {
          if (key === 'full_count' || key === 'version' || key === 'stats') continue;
          const flight = data[key];
          if (!Array.isArray(flight)) continue;

          const icao24 = key;
          const callsign = flight[0] || 'N/A';
          const type = flight[9] || 'Unknown';
          const originIcao = flight[11] || 'N/A';
          const destIcao = flight[12] || 'N/A';
          const originCity = getCityFromIcao(originIcao);
          const destCity = getCityFromIcao(destIcao);
          const heading = flight[3] || null;
          const alt = flight[4] ? Math.round(flight[4]) + ' FT' : 'N/A';
          const spd = flight[5] ? Math.round(flight[5]) + ' KTS' : 'N/A';
          const vspeed = flight[17] ? Math.round(flight[17]) + ' FT/MIN' : 'N/A';
          const squawk = flight[14] || 'N/A';
          const lat = flight[6];
          const lon = flight[7];
          const pos = lat && lon ? lat.toFixed(4) + '°N ' + lon.toFixed(4) + '°W' : 'N/A';
          const arrow = getHeadingArrow(heading);

          currentIcao24s.add(icao24);

          aircraftMap.set(icao24, {
            data: { callsign, type, originCity, destCity, alt, spd, heading, arrow, vspeed, pos, squawk },
            lastSeenTime: now,
            isLive: true,
            element: null
          });
        }

        const statusEl = document.getElementById('status');
        statusEl.textContent = 'Last update: ' + new Date().toLocaleTimeString('en-US', {timeZone: 'America/Chicago'}) + ' CST';

        // ... (keep the rest of the fetchFlights function from previous code - cleanup, render, etc.)

      } catch (err) {
        console.error('Fetch error:', err); // Log for debug
        document.getElementById('status').textContent = `ERROR: ${err.message} (retrying soon)`;
      }
    }

    // ... (keep getHeadingArrow, setInterval, etc.)

    fetchFlights();
    setInterval(fetchFlights, 20000);
  </script>
</body>
</html>