<!-- Inspired by https://github.com/smartbutnot/flightportal/tree/main -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
      <!-- Auto refresh once an hour just to load new HTML in case it changed during a deployment -->
    <meta http-equiv="refresh" content="3600">

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="Flight Board">
    <link rel="apple-touch-icon" href="/api/placeholder/180/180">
    <link rel="apple-touch-icon" sizes="152x152" href="/api/placeholder/152/152">
    <link rel="apple-touch-icon" sizes="180x180" href="/api/placeholder/180/180">
    <link rel="apple-touch-icon" sizes="167x167" href="/api/placeholder/167/167">
    <link rel="apple-touch-startup-image" media="screen and (device-width: 430px) and (device-height: 932px) and (-webkit-device-pixel-ratio: 3)" href="/api/placeholder/1290/2796">
    <link rel="apple-touch-startup-image" media="screen and (device-width: 393px) and (device-height: 852px) and (-webkit-device-pixel-ratio: 3)" href="/api/placeholder/1179/2556">
    <link rel="apple-touch-startup-image" media="screen and (device-width: 428px) and (device-height: 926px) and (-webkit-device-pixel-ratio: 3)" href="/api/placeholder/1284/2778">

    <!-- Web app manifest -->
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIkZsaWdodCBCb2FyZCIsCiAgInNob3J0X25hbWUiOiAiRmxpZ2h0IEJvYXJkIiwKICAic3RhcnRfdXJsIjogIi4iLAogICJkaXNwbGF5IjogInN0YW5kYWxvbmUiLAogICJiYWNrZ3JvdW5kX2NvbG9yIjogIiMwMDAwMDAiLAogICJ0aGVtZV9jb2xvciI6ICIjMDAwMDAwIgp9">


    <title>Flight LED Display</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.6.2/axios.min.js"></script>
    <style>
  body {
            margin: 0;
            padding: 0;
            background-color: black;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: monospace;
        }

        .display-container {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 2vh;
            padding: 20px;
            box-sizing: border-box;
        }

        .led-text {
            text-align: center;
            white-space: nowrap;
            letter-spacing: 0.1em;
            text-shadow: 0 0 10px currentColor;
            font-weight: bold;
            width: 100%;
        }

        #registration, #route {
            color: rgb(100, 149, 237);
        }

        #altitude {
            color: rgb(0, 255, 0);
        }

        #speed {
            color: rgb(255, 165, 0);
        }

        #aircraft {
            color: rgb(255, 223, 0);
        }

        /* Laptop (1366x768 and up) */
        @media (min-width: 1366px) {
            .led-text {
                font-size: 12vw;
            }
        }

        /* iPad in landscape (1024x768) */
        @media (min-width: 1024px) and (max-width: 1365px) {
            .led-text {
                font-size: 12vw;
            }
        }

        /* iPhone and similar (up to 1023px) */
        @media (max-width: 1023px) {
            .led-text {
                font-size: 12vw;
            }
        }

    </style>
</head>
<body>
      <div class="display-container">
    <div id="registration" class="led-text">...</div>
    <div id="route" class="led-text">...</div>
    <div id="altitude" class="led-text">...</div>
    <div id="speed" class="led-text">...</div>
    <div id="aircraft" class="led-text">...</div>
      </div>

    <script>
        async function fetchAndDisplayFlightData() {
            try {
              // Get URL parameters
              const urlParams = new URLSearchParams(window.location.search);

              // Get bounds from URL or use default
              const parts = urlParams.get('bounds')?.split(',').map(Number);
              // Expanded default to cover a much larger area including all of northwest Arkansas and surrounding regions
              const bounds = parts ? [parts[0], parts[2], parts[1], parts[3]].join(',') : '37,35,-95,-93';

              console.log(bounds);
              const corskey = urlParams.get('corskey');

              // Hardcode airport for fallback (Northwest Arkansas National Airport)
              const airportCode = 'XNA';

              const baseUrl = 'https://data-cloud.flightradar24.com/zones/fcgi/feed.js?bounds=' + bounds;
              const otherParams = 'faa=1&satellite=1&mlat=1&flarm=1&adsb=1&gnd=0&air=1&vehicles=0&estimated=0&maxage=14400&gliders=0&stats=0&ems=1&limit=1&webpriv=0';

              // Construct the corsproxy URL with optional corskey
              let corsProxyUrl = 'https://corsproxy.io/';
              if (corskey) {
                corsProxyUrl += `?corskey=${corskey}&`;
              } else {
                corsProxyUrl += '?';
              }

              const feedUrl = corsProxyUrl + `url=${encodeURIComponent(`${baseUrl}&${otherParams}`)}`;

              const feedResponse = await axios.get(feedUrl);
              const feedData = feedResponse.data;

              let dynamicKey = Object.keys(feedData).find(key => 
                  key !== 'full_count' && key !== 'version'
              );

              let flightData = null;
              let isLive = true;

              if (!dynamicKey) {
                // Fallback to most recent arrival at local airport
                console.log('No active flights, falling back to recent arrival at ' + airportCode);
                const airportUrl = corsProxyUrl + `url=${encodeURIComponent(`https://api.flightradar24.com/common/v1/airport.json?code=${airportCode}&plugin[]=schedule&plugin[schedule][mode]=arrivals&page=1&limit=50`)}`;
                const airportResponse = await axios.get(airportUrl);
                const arrivalsData = airportResponse.data.result.response.airport.pluginData.schedule.arrivals.data;

                if (!arrivalsData || arrivalsData.length === 0) {
                  throw new Error('No recent arrival data found');
                }

                // Find the most recent arrived flight
                const currentTime = Math.floor(Date.now() / 1000);
                let recentFlight = null;
                let latestArrivalTime = 0;

                for (let arrival of arrivalsData) {
                  const flight = arrival.flight;
                  const realArrival = flight.time?.real?.arrival;
                  if (realArrival && realArrival < currentTime && realArrival > latestArrivalTime) {
                    recentFlight = flight;
                    latestArrivalTime = realArrival;
                  }
                }

                if (!recentFlight) {
                  throw new Error('No recently arrived flights found');
                }

                dynamicKey = recentFlight.identification.id;
                isLive = false;
              } else {
                flightData = feedData[dynamicKey];
              }

              const detailsUrl = corsProxyUrl + `url=${encodeURIComponent(`https://data-live.flightradar24.com/clickhandler/?flight=${dynamicKey}`)}`;
              const detailsResponse = await axios.get(detailsUrl);
              
              console.log(detailsResponse);
                // Update the display with real data
                document.getElementById('registration').textContent = detailsResponse.data.identification.number.default || 'N/A';
                document.getElementById('route').textContent = `${detailsResponse.data.airport.origin.code.iata || 'N/A'}-${detailsResponse.data.airport.destination.code.iata || 'N/A'}`;
                document.getElementById('aircraft').textContent = detailsResponse.data.aircraft.model.code || 'N/A';

                if (isLive) {
                  document.getElementById('altitude').textContent = `${flightData[3] || 'N/A'} ft`;
                  document.getElementById('speed').textContent = `${flightData[4] || 'N/A'} kts`;
                } else {
                  document.getElementById('altitude').textContent = '0 ft';
                  document.getElementById('speed').textContent = '0 kts';
                }
                
            } catch (error) {
                console.error('Error fetching flight data:', error);
                // Optionally reset to ... on error
                document.getElementById('registration').textContent = '...';
                document.getElementById('route').textContent = '...';
                document.getElementById('altitude').textContent = '...';
                document.getElementById('speed').textContent = '...';
                document.getElementById('aircraft').textContent = '...';
            }
        }

        // Initial fetch
        fetchAndDisplayFlightData();
        setInterval(fetchAndDisplayFlightData, 60000);
    </script>
</body>
</html>